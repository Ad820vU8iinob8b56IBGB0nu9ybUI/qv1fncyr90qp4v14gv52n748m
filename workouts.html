<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitTrack AI | Workouts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --background: #000000;
            --primary-text: #eaeaea;
            --secondary-text: #888888;
            --card-bg: #111111;
            --input-bg: #191919;
            --border-color: #222222;
            --accent: #FFFFFF;
            --accent-hover: #DDDDDD;
            --danger: #E53E3E;
        }

        body {
            background-color: var(--background);
            color: var(--primary-text);
            font-family: 'Manrope', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .nav-link {
            transition: color 0.3s ease, border-color 0.3s ease;
            border-bottom: 2px solid transparent;
            color: var(--secondary-text);
            padding-bottom: 4px;
        }

        .nav-link:hover {
            color: var(--primary-text);
        }

        .nav-link.active {
            color: var(--primary-text);
            border-bottom-color: var(--primary-text);
        }

        .content-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 2rem;
        }

        .form-input {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--primary-text);
            padding: 0.75rem 1rem;
            width: 100%;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        .form-label {
            color: var(--secondary-text);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .btn {
            border-radius: 0.5rem;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            transition: all 0.2s ease-in-out;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transform: translateY(0);
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: translateY(0);
        }

        .btn-primary {
            background-color: var(--accent);
            color: var(--background);
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--accent-hover);
        }
        
        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--primary-text);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: var(--border-color);
            border-color: var(--accent);
        }
        
        .btn-danger {
            color: var(--danger);
        }
        
        .btn-danger:hover:not(:disabled) {
             background-color: rgba(229, 62, 62, 0.1);
        }

        /* FIX: Ensure dropdown is positioned relative to its container */
        #workout-actions-dropdown {
            z-index: 50;
            background-color: var(--card-bg);
            position: absolute;
        }

        .modal-backdrop {
            display: none;
            position: fixed;
            z-index: 100;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        .modal-content {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .loader {
            border: 2px solid #333;
            border-top: 2px solid var(--accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--input-bg); border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #666; }
        
        .exercise-item-controls { display: none; }
        .exercise-item:hover .exercise-item-controls { display: inline-flex; }
        
        .log-workout-btn:disabled {
            opacity: 0.5;
            pointer-events: none;
            cursor: not-allowed;
        }

        .status-btn {
            border: 1px solid var(--border-color);
            background-color: transparent;
            color: var(--secondary-text);
        }

        .status-btn.selected-full {
            background-color: #10b981; /* green-500 */
            color: var(--background);
            border-color: #10b981;
        }
        .status-btn.selected-partial {
            background-color: #fbbf24; /* amber-400 */
            color: var(--background);
            border-color: #fbbf24;
        }
        .status-btn.selected-none {
            background-color: #f87171; /* red-400 */
            color: var(--background);
            border-color: #f87171;
        }

    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto max-w-7xl px-4 py-8">

        <header class="flex flex-col sm:flex-row items-center justify-between mb-16 pb-4 border-b border-gray-900">
            <a href="index.html" class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m6 2 4 4"/><path d="m3 10.5 4.5-4.5"/><path d="m13.5 21 4.5-4.5"/></svg>
                <h1 class="text-2xl font-bold">FitTrack AI</h1>
            </a>
            <nav class="mt-4 sm:mt-0">
                <ul class="flex items-center space-x-4 sm:space-x-6 text-base font-medium">
                    <li><a href="index.html" class="nav-link">Dashboard</a></li>
                    <li><a href="nutrition.html" class="nav-link">Nutrition</a></li>
                    <li><a href="workouts.html" class="nav-link active">Workouts</a></li>
                    <li><a href="goals.html" class="nav-link">Goals</a></li>
                    <li><a href="sleep.html" class="nav-link">Sleep</a></li>
                    <li><a href="settings.html" class="nav-link">Settings</a></li>
                </ul>
            </nav>
        </header>

        <main>
             <div class="text-center mb-8">
                <h2 class="text-3xl font-bold">Your Workout Plan</h2>
                <p class="text-gray-400 mt-2">Push, Pull, Legs split.</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                <div class="lg:col-span-2 content-card">
                    <div class="flex justify-between items-center mb-4">
                         <div class="flex-1">
                             <button id="day-view-date-display-btn" class="text-left hover:bg-input-bg px-4 py-2 rounded-lg transition-colors">
                                <span id="day-view-title-span" class="text-2xl font-semibold block"></span>
                                <span id="day-view-date-span" class="text-base text-secondary-text"></span>
                            </button>
                        </div>
                        <div class="flex items-center gap-2">
                             <div class="relative">
                                <button id="workout-actions-btn" class="btn btn-secondary !p-2">
                                    <i data-lucide="more-horizontal" class="w-5 h-5"></i>
                                </button>
                                <!-- FIX: Dropdown is inside its relative container -->
                                <div id="workout-actions-dropdown" class="absolute right-0 mt-2 w-48 border border-border-color rounded-md shadow-lg hidden">
                                    <button id="manage-warmups-btn" class="w-full text-left px-4 py-2 text-sm text-primary-text hover:bg-input-bg flex items-center gap-2 rounded-t-md">
                                        <i data-lucide="flame" class="w-4 h-4"></i> Manage Warm-ups
                                    </button>
                                    <button id="add-exercise-btn" class="w-full text-left px-4 py-2 text-sm text-primary-text hover:bg-input-bg flex items-center gap-2">
                                        <i data-lucide="plus-circle" class="w-4 h-4"></i> Add Exercise
                                    </button>
                                    <button id="clear-history-btn" class="w-full text-left px-4 py-2 text-sm btn-danger hover:bg-input-bg flex items-center gap-2 rounded-b-md">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i> Clear All History
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-center gap-4 mb-6">
                        <button id="prev-day-btn" class="btn btn-secondary !p-2"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                            <span id="day-view-status" class="text-sm font-bold text-secondary-text"></span>
                            <div id="workout-status-controls" class="flex gap-2 text-sm">
                                <button class="status-btn btn !p-2 !py-1" data-status="full">Full</button>
                                <button class="status-btn btn !p-2 !py-1" data-status="partial">Partial</button>
                                <button class="status-btn btn !p-2 !py-1" data-status="none">None</button>
                            </div>
                        </div>
                        <button id="next-day-btn" class="btn btn-secondary !p-2"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                    </div>
                    <div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 mt-4">
                            <div>
                                <h5 class="font-semibold text-lg mb-2 border-b border-border-color pb-1">Plan</h5>
                                <div id="workout-plan-for-day" class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar pr-2"></div>
                            </div>
                            <div>
                                <h5 class="font-semibold text-lg mb-2 border-b border-border-color pb-1">History</h5>
                                <div id="history-day-content" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar pr-2">
                                    <p class="text-secondary-text">No workouts logged.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="content-card lg:col-span-2">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <h3 class="text-2xl font-semibold">Progression Chart</h3>
                        <!-- FIX: Progression dropdown is now inside the card and styled correctly -->
                        <select id="progress-exercise-select" class="w-full sm:w-auto form-input">
                            </select>
                    </div>
                    <div class="w-full h-80 flex items-center justify-center">
                        <canvas id="progress-chart"></canvas>
                    </div>
                </div>
                 <div class="content-card">
                    <h3 class="text-2xl font-semibold mb-4 text-center">AI Coach</h3>
                    
                    <div class="flex border-b border-border-color mb-4">
                        <button id="ai-tab-specific" class="flex-1 py-2 text-center font-semibold border-b-2 border-accent text-primary-text">Specific Advice</button>
                        <button id="ai-tab-general" class="flex-1 py-2 text-center font-semibold border-b-2 border-transparent text-secondary-text">General Chat</button>
                    </div>

                    <div id="ai-panel-specific">
                        <p class="text-gray-400 text-sm mb-3 text-center">Select an exercise to get science-based advice on when to add weight or reps.</p>
                        <div class="flex gap-2">
                            <select id="ai-advice-exercise-select" class="w-full form-input">
                                <option value="">Select an exercise...</option>
                            </select>
                            <button id="get-ai-advice-btn" class="btn btn-secondary">
                                <span class="btn-text">Get Advice</span>
                                <div class="loader hidden ml-2"></div>
                            </button>
                        </div>
                        <div id="ai-advice-output" class="mt-4 p-3 bg-black/30 rounded-md text-sm min-h-[50px]"></div>
                    </div>

                    <div id="ai-panel-general" class="hidden">
                        <p class="text-gray-400 text-sm mb-3 text-center">Ask the AI anything about your workout data. It will use your recent history to give a personalized answer.</p>
                        <textarea id="ai-general-prompt" class="form-input" rows="3" placeholder="e.g., 'Am I doing enough volume for my back?' or 'Suggest a different bicep exercise.'"></textarea>
                        <button id="get-ai-general-advice-btn" class="btn btn-secondary w-full mt-2">
                            <span class="btn-text">Ask AI</span>
                            <div class="loader hidden ml-2"></div>
                        </button>
                        <div id="ai-general-output" class="mt-4 p-3 bg-black/30 rounded-md text-sm min-h-[50px]"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="exercise-detail-modal" class="modal-backdrop"><div class="modal-content !max-w-xl"><div class="flex justify-between items-center mb-4"><h2 id="exercise-detail-title" class="text-2xl font-bold">Exercise Details</h2><button id="close-exercise-detail-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><div class="space-y-4"><div class="w-full aspect-video bg-black rounded-lg flex items-center justify-center overflow-hidden border border-gray-800"><img id="exercise-detail-video" src="" alt="Video placeholder" class="w-full h-full object-contain"></div><div><h3 class="font-bold text-lg text-blue-400 mb-2">Instructions</h3><ul id="exercise-detail-instructions" class="list-disc list-inside space-y-1 text-gray-300"></ul></div><div><h3 class="font-bold text-lg text-blue-400 mb-2">Rep Range</h3><p id="exercise-detail-rep-range" class="text-gray-300"></p></div><div><h3 class="font-bold text-lg text-blue-400 mb-2">Personal Notes & Advice</h3><textarea id="exercise-detail-notes" rows="4" class="form-input mt-1" placeholder="Add your personal cues, weight progression goals, etc."></textarea><button id="save-exercise-notes-btn" class="mt-2 w-full btn btn-secondary">Save Notes</button></div><button id="log-from-detail-btn" class="w-full btn btn-primary mt-4">Log This Exercise</button></div></div></div>
    <div id="warmup-manage-modal" class="modal-backdrop"><div class="modal-content !max-w-xl"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Manage Warm-ups</h2><button id="close-warmup-manage-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><div class="space-y-4"><div><label for="warmup-day-select" class="form-label">Workout Day</label><select id="warmup-day-select" class="form-input mt-1"><option value="Push">Push</option><option value="Pull">Pull</option><option value="Legs">Legs</option></select></div><div id="warmup-list" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2"></div><hr class="border-gray-800"><form id="warmup-form" class="space-y-3"><h3 id="warmup-form-title" class="font-bold text-lg text-blue-400">Add New Warm-up</h3><div><label for="warmup-name" class="form-label">Name</label><input type="text" id="warmup-name" class="form-input mt-1" required></div><div><label for="warmup-instructions" class="form-label">Instructions (one per line)</label><textarea id="warmup-instructions" rows="4" class="form-input mt-1"></textarea></div><button type="submit" id="save-warmup-btn" class="w-full btn btn-primary">Add Warm-up</button></form></div></div></div>
    <div id="workout-modal" class="modal-backdrop"><div class="modal-content"><div class="flex justify-between items-center mb-4"><h2 id="modal-title" class="text-2xl font-bold">Log Exercise</h2><button id="close-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><form id="workout-log-form"><div class="space-y-4"><div id="sets-container"></div><button type="button" id="add-set-btn" class="w-full btn btn-secondary">Add Set</button><button type="submit" id="save-workout-btn" class="w-full btn btn-primary mt-2">Save Workout</button></div></form></div></div>
    <div id="exercise-modal" class="modal-backdrop"><div class="modal-content"><div class="flex justify-between items-center mb-4"><h2 id="exercise-modal-title" class="text-2xl font-bold">Add Exercise</h2><button id="close-exercise-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><form id="exercise-form" class="space-y-4"><div><label for="exercise-name" class="form-label">Exercise Name</label><input type="text" id="exercise-name" class="form-input mt-1" required></div><div><label for="exercise-group" class="form-label">Muscle Group</label><select id="exercise-group" class="form-input mt-1"></select></div><div><label for="exercise-type" class="form-label">Equipment Type</label><select id="exercise-type" class="form-input mt-1"><option>Barbell</option><option>Dumbbell</option><option>Machine</option><option>Bodyweight</option><option>Other</option></select></div><button type="submit" id="save-exercise-btn" class="w-full btn btn-primary">Save Exercise</button></form></div></div>
    <div id="confirm-modal" class="modal-backdrop"><div class="modal-content"><h2 id="confirm-modal-title" class="text-xl font-bold mb-4">Are you sure?</h2><p id="confirm-modal-text" class="text-gray-300 mb-6">This action cannot be undone.</p><div class="flex justify-end gap-4"><button id="confirm-modal-cancel-btn" class="btn btn-secondary">Cancel</button><button id="confirm-modal-confirm-btn" class="btn btn-danger">Confirm</button></div></div></div>
    <div id="alert-modal" class="modal-backdrop"><div class="modal-content"><h2 id="alert-modal-title" class="text-xl font-bold mb-4">Alert</h2><p id="alert-modal-text" class="text-gray-300 mb-6"></p><div class="flex justify-end"><button id="alert-modal-ok-btn" class="btn btn-primary">OK</button></div></div></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let workoutHistory = [];
            let exerciseDB = [];
            let warmups = {};
            let workoutStatusHistory = {}; // New state for manual status: 'full', 'partial', 'none'
            let currentlyLoggingExercise = null;
            let editingWorkoutLogIndex = null;
            let editingExerciseName = null;
            let editingWarmupIndex = null;
            let confirmCallback = null;
            let viewDate = new Date(); // Central state for the currently viewed date
            let isLogging = false; 
            
            // --- Set viewDate to today, ignoring time
            viewDate.setHours(0,0,0,0);


            // --- DATABASES (Using default values from original file) ---
             const defaultWarmups = {
                "Push": [
                    { name: "Arm Circles", instructions: ["Stand with feet shoulder-width apart.", "Extend your arms to the sides.", "Make small circles, gradually increasing to large circles.", "Perform for 30 seconds forward, then 30 seconds backward."], repRange: "1 minute total", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" },
                    { name: "Torso Twists", instructions: ["Stand with feet slightly wider than shoulder-width, knees slightly bent.", "Hold your arms out or cross them over your chest.", "Gently twist your torso from side to side.", "Perform for 30-60 seconds."], repRange: "1 minute total", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" },
                    { name: "Dynamic Chest Stretches", instructions: ["Stand tall.", "Swing both arms outwards and backwards, feeling a stretch in your chest.", "Return arms to the front, crossing them over each other.", "Repeat for 10-15 repetitions."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" }
                ],
                "Pull": [
                    { name: "Cat-Cow", instructions: ["Start on your hands and knees.", "Inhale as you drop your belly towards the mat (Cow).", "Exhale as you round your spine upwards (Cat).", "Repeat for 10-15 repetitions."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" },
                    { name: "Scapular Pull-ups", instructions: ["Hang from a pull-up bar with an overhand grip.", "Without bending your arms, pull your shoulder blades down and together.", "Hold for a second, then relax.", "Repeat for 8-12 repetitions."], repRange: "8-12 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" },
                    { name: "Band Pull-Aparts", instructions: ["Hold a light resistance band with both hands, shoulder-width apart.", "Keeping your arms straight, pull the band apart by squeezing your shoulder blades.", "Return to the start with control.", "Repeat for 15-20 repetitions."], repRange: "15-20 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" }
                ],
                "Legs": [
                    { name: "Front-to-back Leg Swings", instructions: ["Hold onto a stable surface for balance.", "Swing one leg forward and backward in a controlled motion.", "Keep your core engaged and torso upright.", "Perform 10-15 swings per leg."], repRange: "10-15 reps per leg", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" },
                    { name: "Side-to-side Leg Swings", instructions: ["Face a stable surface and hold on for balance.", "Swing one leg out to the side, then across the front of your body.", "Keep the movement controlled.", "Perform 10-15 swings per leg."], repRange: "10-15 reps per leg", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" },
                    { name: "Side Lying Twists", instructions: ["Lie on your side with your knees bent at 90 degrees.", "Extend your top arm and rotate your torso, trying to touch your top shoulder blade to the floor.", "Follow your hand with your eyes.", "Perform 8-10 twists per side."], repRange: "8-10 twists per side", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" },
                    { name: "Step Throughs", instructions: ["Start in a push-up position.", "Bring your right foot forward and place it outside your right hand, sinking your hips.", "Hold for a moment, then step back to the start.", "Repeat with the left leg.", "Alternate for 5-8 repetitions per side."], repRange: "5-8 reps per side", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" }
                ]
            };

            const defaultExerciseDB = [
                { name: "Seated leg curl", group: "Hamstrings", type: "Machine", instructions: ["Sit in the machine with your back against the pad and the ankle pad just above your heels.", "Adjust the lap pad to fit snugly on your thighs.", "Curl your legs down as far as possible, squeezing your hamstrings.", "Slowly return to the starting position."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "Straight Calf extension", group: "Calves", type: "Machine", instructions: ["Use a standing or seated calf raise machine.", "Place the balls of your feet on the platform, with your heels hanging off.", "Press through the balls of your feet to raise your heels as high as possible.", "Hold the peak contraction, then slowly lower your heels below the platform level."], repRange: "10-20 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "Barbell Squats", group: "Quads", type: "Barbell", instructions: ["Set a barbell in a squat rack at shoulder height.", "Step under the bar and rest it across your upper back.", "Lift the bar off the rack, take a step back, and stand with feet shoulder-width apart.", "Keeping your chest up and back straight, lower your hips as if sitting in a chair.", "Go as deep as you comfortably can, ideally until your thighs are parallel to the floor.", "Push through your heels to return to the starting position."], repRange: "6-12 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false }, // Group changed from Abductors to Quads
                { name: "Smith Machine squats", group: "Quads", type: "Machine", instructions: ["Set the bar on the Smith machine to shoulder height.", "Position yourself under the bar with feet shoulder-width apart.", "Un-rack the bar and lower down by bending your knees and hips.", "Keep your back straight and chest up.", "Push through your heels to return to the start."], repRange: "8-12 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false }, // Group changed from Abductors to Quads
                { name: "Romanian Deadlift", group: "Glutes", type: "Barbell", instructions: ["Hold a barbell with an overhand grip, hands just outside your thighs.", "Stand tall with a slight bend in your knees.", "Hinge at your hips, pushing your butt back while keeping your back straight.", "Lower the bar down your shins until you feel a deep stretch in your hamstrings.", "Squeeze your glutes to return to the starting position."], repRange: "8-12 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "Hip thrusts", group: "Glutes", type: "Barbell", instructions: ["Sit on the floor with your upper back against a bench.", "Roll a barbell over your legs and position it in the crease of your hips.", "Place your feet flat on the floor, shoulder-width apart.", "Drive through your heels to lift your hips until your body forms a straight line from shoulders to knees.", "Squeeze your glutes at the top, then lower your hips back down."], repRange: "8-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "Leg Extension", group: "Quads", type: "Machine", instructions: ["Sit in the leg extension machine with your legs under the pad.", "Align your knees with the machine's pivot point.", "Extend your legs to lift the weight until they are straight.", "Squeeze your quads at the top.", "Slowly lower the weight back to the starting position."], repRange: "12-20 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "Cable Crunch", group: "Abs", type: "Machine", instructions: ["Kneel below a high pulley with a rope attachment.", "Grab the rope and pull it down until your hands are placed on either side of your head.", "Flex your hips slightly and allow the weight to hyperextend your lower back.", "Keeping your hips stationary, flex your waist as you contract your abs so that your elbows travel towards the middle of your thighs.", "Hold the contraction for a second and then slowly return to the starting position."], repRange: "10-20 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "Bent Knee Raises", group: "Abs", type: "Bodyweight", instructions: ["Lie flat on your back on a mat with your legs straight.", "Place your hands under your lower back for support.", "Bend your knees and pull your upper thighs into your midsection.", "Hold the contraction for a second and then slowly lower your legs back to the starting position."], repRange: "15-25 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "High-to-low crossover", group: "Chest", type: "Machine", instructions: ["Set pulleys to the highest position.","Grab handles with palms facing down, step forward to create tension.","With a slight bend in your elbows, pull handles down and across your body until they meet in front of your lower chest.","Squeeze your chest muscles at the peak contraction.","Slowly return to the starting position."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "Dumbbell Press", group: "Chest", type: "Dumbbell", instructions: ["Lie on a flat bench with a dumbbell in each hand, resting on your thighs.","Use your thighs to help push the dumbbells up one at a time so you can hold them at shoulder-width.","Rotate your wrists so your palms are facing away from you.","Press the dumbbells up until your arms are fully extended, but not locked at the elbow.","Slowly lower the dumbbells back to the starting position."], repRange: "6-12 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "Machine Chest Press", group: "Chest", type: "Machine", instructions: ["Sit on the machine with your back flat against the pad.","Adjust the seat height so the handles are level with your mid-chest.","Grab the handles with a full grip, keeping your wrists straight.","Press the handles forward until your arms are fully extended, but not locked at the elbow.","Slowly return to the starting position, feeling a stretch in your chest."], repRange: "8-12 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "Cable overhead extension", group: "Triceps", type: "Machine", instructions: ["Attach a rope handle to a low pulley.","Face away from the machine, grab the rope, and extend your arms fully overhead.","Keeping your upper arms stationary, lower the rope behind your head by bending your elbows.","Extend your arms to lift the rope back to the starting position, flexing your triceps."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "Cable kickback", group: "Triceps", type: "Machine", instructions: ["Set a pulley to a low position. Hinge at your hips so your torso is nearly parallel to the floor.","Grab the handle and pull your elbow up so your upper arm is parallel to the floor.","Keeping your upper arm still, extend your forearm back until your arm is straight.","Squeeze your tricep at the top, then slowly return to the start."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "Cable lateral raises/ lateral crossover", group: "Shoulders", type: "Machine", instructions: ["Set pulleys on both sides to the lowest position.","Stand in the middle and grab the left handle with your right hand, and the right handle with your left hand.","With a slight bend in your elbows, raise your arms out to your sides until they are parallel to the floor.","Control the weight as you slowly lower your arms back down."], repRange: "12-20 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "Reverse Pec deck", group: "Shoulders", type: "Machine", instructions: ["Sit facing the machine, with your chest against the pad.","Set the handles to the rearmost position.","Grab the handles with a neutral or overhand grip.","Keeping your arms slightly bent, squeeze your shoulder blades together to pull the handles back.","Slowly return to the starting position."], repRange: "12-20 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "Close Grip Lat Pulldown", group: "Back", type: "Machine", instructions: ["Sit at a lat pulldown machine and grab the bar with a close, underhand grip (palms facing you).","Keep your chest up and your back straight.","Pull the bar down to your upper chest, squeezing your back muscles.","Hold the contraction for a moment before slowly returning the bar to the starting position."], repRange: "8-12 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "Chest Supported Rows", group: "Back", type: "Machine", instructions: ["Set up on a chest-supported row machine, with your chest firmly against the pad.","Grab the handles with a neutral or overhand grip.","Pull the handles towards your torso, squeezing your shoulder blades together.","Focus on using your back muscles, not your biceps.","Slowly extend your arms back to the starting position."], repRange: "8-12 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "Seated Cable Rows", group: "Back", type: "Machine", instructions: ["Sit at a cable row machine with your feet on the platform and knees slightly bent.","Grab the handle with a neutral grip.","Keeping your back straight, pull the handle towards your lower abdomen.","Squeeze your back muscles at the peak of the movement.","Slowly return to the starting position."], repRange: "8-12 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "Wide Grip Cable Rows", group: "Back", type: "Machine", instructions: ["Attach a long bar to the seated row machine.","Grab the bar with a wide, overhand grip.","Pull the bar towards your upper abdomen/lower chest, keeping your elbows flared out.","Focus on squeezing your upper back and rear delts.","Slowly return to the starting position."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "Bayesian Cable Curls", group: "Biceps", type: "Machine", instructions: ["Stand facing a cable machine with the pulley set to the lowest position.","Hold a straight bar attachment with an underhand grip, hands shoulder-width apart.","Step back to create tension. Keep your elbows pinned to your sides.","Curl the bar up towards your chest, squeezing your biceps.","Slowly lower the bar back down."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "Cable Hammer Curls", group: "Biceps", type: "Machine", instructions: ["Attach a rope handle to a low pulley on a cable machine.","Grab the rope with a neutral (hammer) grip, palms facing each other.","Keep your elbows close to your body and curl the rope up.","Squeeze your biceps and forearms at the top.","Slowly lower the rope back to the starting position."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "Straight Bar Curl", group: "Forearms", type: "Barbell", instructions: ["Stand holding a barbell with an underhand grip, hands shoulder-width apart.","Keep your elbows close to your torso.","Curl the weight forward while contracting your biceps. Only your forearms should move.","Continue until your biceps are fully contracted and the bar is at shoulder level.","Slowly bring the barbell back to starting position."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false },
                { name: "Reverse Arm Curl", group: "Forearms", type: "Dumbbell", instructions: ["Stand holding a dumbbell in each hand with an overhand grip (palms facing down).","Keep your elbows close to your torso.","Curl the weight up, keeping your palms facing down. Focus on using your forearm muscles.","Slowly lower the dumbbells back to the starting position."], repRange: "12-20 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "", favorite: false }
            ];

            // --- UI ELEMENTS ---
            const ui = {
                workoutModal: document.getElementById('workout-modal'),
                modalTitle: document.getElementById('modal-title'),
                closeModalBtn: document.getElementById('close-modal-btn'),
                workoutLogForm: document.getElementById('workout-log-form'),
                setsContainer: document.getElementById('sets-container'),
                addSetBtn: document.getElementById('add-set-btn'),
                saveWorkoutBtn: document.getElementById('save-workout-btn'),
                confirmModal: document.getElementById('confirm-modal'),
                confirmModalTitle: document.getElementById('confirm-modal-title'),
                confirmModalText: document.getElementById('confirm-modal-text'),
                confirmModalCancelBtn: document.getElementById('confirm-modal-cancel-btn'),
                confirmModalConfirmBtn: document.getElementById('confirm-modal-confirm-btn'),
                alertModal: document.getElementById('alert-modal'),
                alertModalTitle: document.getElementById('alert-modal-title'),
                alertModalText: document.getElementById('alert-modal-text'),
                alertModalOkBtn: document.getElementById('alert-modal-ok-btn'),
                exerciseModal: document.getElementById('exercise-modal'),
                closeExerciseModalBtn: document.getElementById('close-exercise-modal-btn'),
                exerciseForm: document.getElementById('exercise-form'),
                exerciseModalTitle: document.getElementById('exercise-modal-title'),
                progressExerciseSelect: document.getElementById('progress-exercise-select'),
                clearHistoryBtn: document.getElementById('clear-history-btn'),
                addExerciseBtn: document.getElementById('add-exercise-btn'),
                aiAdviceExerciseSelect: document.getElementById('ai-advice-exercise-select'),
                getAIAdviceBtn: document.getElementById('get-ai-advice-btn'),
                aiAdviceOutput: document.getElementById('ai-advice-output'),
                exerciseDetailModal: document.getElementById('exercise-detail-modal'),
                closeExerciseDetailModalBtn: document.getElementById('close-exercise-detail-modal-btn'),
                exerciseDetailTitle: document.getElementById('exercise-detail-title'),
                exerciseDetailVideo: document.getElementById('exercise-detail-video'),
                exerciseDetailInstructions: document.getElementById('exercise-detail-instructions'),
                exerciseDetailRepRange: document.getElementById('exercise-detail-rep-range'),
                exerciseDetailNotes: document.getElementById('exercise-detail-notes'),
                saveExerciseNotesBtn: document.getElementById('save-exercise-notes-btn'),
                logFromDetailBtn: document.getElementById('log-from-detail-btn'),
                manageWarmupsBtn: document.getElementById('manage-warmups-btn'),
                warmupManageModal: document.getElementById('warmup-manage-modal'),
                closeWarmupManageModalBtn: document.getElementById('close-warmup-manage-modal-btn'),
                warmupDaySelect: document.getElementById('warmup-day-select'),
                warmupListDiv: document.getElementById('warmup-list'),
                warmupForm: document.getElementById('warmup-form'),
                warmupFormTitle: document.getElementById('warmup-form-title'),
                warmupNameInput: document.getElementById('warmup-name'),
                warmupInstructionsInput: document.getElementById('warmup-instructions'),
                saveWarmupBtn: document.getElementById('save-warmup-btn'),
                dayViewDateDisplayBtn: document.getElementById('day-view-date-display-btn'),
                dayViewStatus: document.getElementById('day-view-status'),
                dayViewDateDisplay: document.getElementById('day-view-date-display-btn'),
                workoutPlanForDay: document.getElementById('workout-plan-for-day'),
                historyDayContent: document.getElementById('history-day-content'),
                workoutActionsBtn: document.getElementById('workout-actions-btn'),
                workoutActionsDropdown: document.getElementById('workout-actions-dropdown'),
                prevDayBtn: document.getElementById('prev-day-btn'),
                nextDayBtn: document.getElementById('next-day-btn'),
                aiTabSpecific: document.getElementById('ai-tab-specific'),
                aiTabGeneral: document.getElementById('ai-tab-general'),
                aiPanelSpecific: document.getElementById('ai-panel-specific'),
                aiPanelGeneral: document.getElementById('ai-panel-general'),
                aiGeneralPrompt: document.getElementById('ai-general-prompt'),
                getAIGeneralAdviceBtn: document.getElementById('get-ai-general-advice-btn'),
                aiGeneralOutput: document.getElementById('ai-general-output'),
                workoutStatusControls: document.getElementById('workout-status-controls'),
            };

            // --- CHART.JS SETUP ---
            Chart.defaults.color = '#FFFFFF';
            const progressCtx = document.getElementById('progress-chart').getContext('2d');
            let progressChart = new Chart(progressCtx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#FFFFFF' }, grid: { color: 'rgba(255, 255, 255, 0.2)' } },
                        x: { ticks: { color: '#FFFFFF' }, grid: { color: 'rgba(255, 255, 255, 0.2)' } }
                    },
                    plugins: { legend: { labels: { color: '#FFFFFF' } } }
                }
            });

            // --- CORE & HELPER FUNCTIONS ---
            const getApiUrl = (model, action = 'generateContent') => {
                const apiKey = "AIzaSyDY48xF1byvU05kS9qKvN8iyrIR3hheP8w"; 
                return `https://generativelanguage.googleapis.com/v1beta/models/${model}:${action}?key=${apiKey}`;
            };
            
            function dateToKey(date) {
                return date.toISOString().split('T')[0];
            }

            function saveData() {
                localStorage.setItem('fitTrackAI_workoutHistory', JSON.stringify(workoutHistory));
                localStorage.setItem('fitTrackAI_exerciseDB', JSON.stringify(exerciseDB));
                localStorage.setItem('fitTrackAI_warmups', JSON.stringify(warmups));
                localStorage.setItem('fitTrackAI_workoutStatus', JSON.stringify(workoutStatusHistory));
            };
            
            function loadData() {
                workoutHistory = JSON.parse(localStorage.getItem('fitTrackAI_workoutHistory')) || [];
                workoutStatusHistory = JSON.parse(localStorage.getItem('fitTrackAI_workoutStatus')) || {};
                const loadedExerciseDB = JSON.parse(localStorage.getItem('fitTrackAI_exerciseDB'));
                if (loadedExerciseDB) {
                    exerciseDB = loadedExerciseDB.map(ex => ({ ...ex, favorite: ex.favorite || false }));
                } else {
                    exerciseDB = JSON.parse(JSON.stringify(defaultExerciseDB));
                }
                warmups = JSON.parse(localStorage.getItem('fitTrackAI_warmups')) || JSON.parse(JSON.stringify(defaultWarmups));
            }

            function showModal(modalElement) { modalElement.style.display = 'flex'; }
            function hideModal(modalElement) { modalElement.style.display = 'none'; }
            
            function showConfirmModal(title, text, onConfirm) {
                ui.confirmModalTitle.textContent = title;
                ui.confirmModalText.textContent = text;
                confirmCallback = onConfirm;
                showModal(ui.confirmModal);
            };

            function showCustomAlert(title, text) {
                ui.alertModalTitle.textContent = title;
                ui.alertModalText.textContent = text;
                showModal(ui.alertModal);
            };

            function updateUI() {
                updateDayView(viewDate);
                populateProgressSelect();
                renderProgressionChart(ui.progressExerciseSelect.value || 'general');
                lucide.createIcons();
            }

            // --- WORKOUT SPECIFIC FUNCTIONS ---
            
            function openWorkoutModal(exerciseName) {
                isLogging = true; 
                editingWorkoutLogIndex = null;
                currentlyLoggingExercise = exerciseName;
                ui.modalTitle.textContent = `Log: ${exerciseName}`;
                ui.saveWorkoutBtn.textContent = 'Save Workout';
                ui.setsContainer.innerHTML = '';
                addSetRow();
                addSetRow();
                addSetRow();
                showModal(ui.workoutModal);
            };

            function addSetRow(setParts = [{weight: '', reps: '', partial: false}]) {
                const setNumber = ui.setsContainer.children.length + 1;
                const row = document.createElement('div');
                row.className = 'set-row border border-gray-800 p-3 rounded-lg space-y-2';
                
                row.innerHTML = `<div class="flex justify-between items-center"><label class="font-bold text-lg">Set ${setNumber}</label><div><button type="button" class="add-part-btn text-blue-400 hover:text-blue-300 p-1" title="Add drop set / pyramid"><i data-lucide="plus-circle" class="w-5 h-5"></i></button><button type="button" class="remove-set-btn text-red-500 hover:text-red-400 p-1" title="Delete set"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div></div><div class="parts-container space-y-2"></div>`;

                ui.setsContainer.appendChild(row);
                lucide.createIcons();
                
                const partsContainer = row.querySelector('.parts-container');
                setParts.forEach(part => addWeightRepPart(partsContainer, part.weight, part.reps, part.partial));

                row.querySelector('.add-part-btn').addEventListener('click', () => addWeightRepPart(partsContainer));
            };

            function addWeightRepPart(container, weight='', reps='', isPartial=false) {
                const partHtml = `<div class="set-part-row grid grid-cols-12 gap-2 items-center"><input type="number" step="any" min="0" placeholder="Weight (kg)" value="${weight}" class="form-input !py-2 col-span-5 set-weight"><span class="text-center col-span-1">x</span><input type="number" min="1" step="1" placeholder="Reps" value="${reps}" class="form-input !py-2 col-span-2 set-reps"><div class="col-span-3 flex items-center justify-center"><input type="checkbox" ${isPartial ? 'checked' : ''} class="form-checkbox h-5 w-5 bg-input-bg border-border-color rounded text-blue-500 focus:ring-blue-500 set-partial"><label class="ml-2 text-sm">Partial</label></div><button type="button" class="remove-part-btn text-gray-500 hover:text-red-400 p-1 col-span-1"><i data-lucide="x-circle" class="w-4 h-4"></i></button></div>`;
                container.insertAdjacentHTML('beforeend', partHtml);
                lucide.createIcons();
            };

            // --- DAY VIEW FUNCTIONS ---

            function updateDayView(date) {
                viewDate = date; // Update central state
                renderWorkoutPlanForDate(date);
                renderHistoryForDate(date);
                updateWorkoutStatusControls(date);

                const today = new Date();
                today.setHours(0,0,0,0);
                const isToday = dateToKey(date) === dateToKey(today);

                const titleSpan = ui.dayViewDateDisplay.querySelector('#day-view-title-span');
                const dateSpan = ui.dayViewDateDisplay.querySelector('#day-view-date-span');
                
                titleSpan.textContent = date.toLocaleDateString(undefined, { weekday: 'long' }) + (isToday ? ' (Today)' : '');
                dateSpan.textContent = date.toLocaleDateString(undefined, { month: 'long', day: 'numeric' });

                // Disable future day next button
                const nextDay = new Date(date);
                nextDay.setDate(nextDay.getDate() + 1);
                ui.nextDayBtn.disabled = nextDay > today;

                lucide.createIcons();
            }

            function getWorkoutDayType(date) {
                const schedule = [ { day: "Monday", type: "Push" }, { day: "Tuesday", type: "Pull" }, { day: "Wednesday", type: "Legs" }, { day: "Thursday", type: "Push" }, { day: "Friday", type: "Pull" }, { day: "Saturday", type: "Legs" }, { day: "Sunday", type: "Rest" }];
                const dayIndex = date.getDay(); 
                return schedule[(dayIndex + 6) % 7]; // Convert Sunday (0) to Monday (0) schedule index logic
            }

            function calculateAutoStatus(date) {
                const dateKey = dateToKey(date);
                const dayInfo = getWorkoutDayType(date);
                
                if (dayInfo.type === 'Rest') return 'full'; // Always full on rest days
                
                const targetGroups = { "Push": ['Chest', 'Shoulders', 'Triceps'], "Pull": ['Back', 'Biceps', 'Forearms'], "Legs": ['Quads', 'Glutes', 'Hamstrings', 'Calves', 'Abs'] };
                const groupsForDay = targetGroups[dayInfo.type] || [];
                const loggedExercises = workoutHistory.filter(log => dateToKey(new Date(log.date)) === dateKey);
                
                let coveredGroups = {};
                
                // Collect all planned exercise names by group for the day
                const plannedExercises = {};
                groupsForDay.forEach(group => {
                    plannedExercises[group] = exerciseDB.filter(ex => ex.group === group).map(ex => ex.name);
                });

                // Count exercises logged per planned group
                const loggedExercisesByGroup = {};
                loggedExercises.forEach(log => {
                    const exercise = exerciseDB.find(ex => ex.name === log.name);
                    if (exercise && groupsForDay.includes(exercise.group)) {
                        if (!loggedExercisesByGroup[exercise.group]) {
                            loggedExercisesByGroup[exercise.group] = new Set();
                        }
                        loggedExercisesByGroup[exercise.group].add(log.name);
                    }
                });

                let totalPlannedGroups = 0;
                let groupsMeetingTarget = 0;
                let groupsWithSomeActivity = 0;

                groupsForDay.forEach(group => {
                    const plannedCount = plannedExercises[group].length;
                    const loggedCount = loggedExercisesByGroup[group]?.size || 0;
                    
                    if (plannedCount > 0) {
                        totalPlannedGroups++;

                        // Define targets based on day type
                        const requiredExercises = (dayInfo.type === 'Legs' ? 1 : 2);
                        
                        if (loggedCount >= requiredExercises) {
                            groupsMeetingTarget++;
                        }
                        if (loggedCount > 0) {
                            groupsWithSomeActivity++;
                        }
                    }
                });

                if (totalPlannedGroups === 0) return 'none'; // No planned exercises for the day

                if (groupsMeetingTarget === totalPlannedGroups) {
                    return 'full';
                } else if (groupsWithSomeActivity > 0) {
                    return 'partial';
                } else {
                    return 'none';
                }
            }

            function updateWorkoutStatusControls(date) {
                const dateKey = dateToKey(date);
                const today = new Date();
                today.setHours(0,0,0,0);
                const isFutureDay = date > today;
                
                // Get the status manually logged, or calculate auto status if not logged
                let currentStatus = workoutStatusHistory[dateKey];
                let isManual = true;

                if (currentStatus === undefined || currentStatus === 'auto') {
                    currentStatus = calculateAutoStatus(date);
                    isManual = false;
                }
                
                // Store the final calculated status for display purposes (but don't save to history unless explicitly set)
                // This ensures manual overrides stick, but auto-status is recalculated on load/log/delete.
                workoutStatusHistory[dateKey] = currentStatus; 

                ui.workoutStatusControls.classList.toggle('hidden', isFutureDay);
                ui.workoutStatusControls.querySelectorAll('.status-btn').forEach(btn => {
                    btn.classList.remove('selected-full', 'selected-partial', 'selected-none');
                    if (btn.dataset.status === currentStatus) {
                        btn.classList.add(`selected-${currentStatus}`);
                    }
                    // For the UI, show the "auto" status as active if no manual status was set.
                    // The click handler will set the manual status.
                });

                let statusText;
                let statusClass;
                
                if (isFutureDay) {
                    statusText = 'Plan for the Future';
                    statusClass = 'text-secondary-text';
                } else {
                    switch(currentStatus) {
                        case 'full':
                            statusText = 'Workout Status: Full';
                            statusClass = 'text-green-400';
                            break;
                        case 'partial':
                            statusText = 'Workout Status: Partial';
                            statusClass = 'text-yellow-400';
                            break;
                        case 'none':
                            statusText = 'Workout Status: None';
                            statusClass = 'text-red-400';
                            break;
                        default:
                            statusText = 'Status Not Logged';
                            statusClass = 'text-secondary-text';
                    }
                }
                ui.dayViewStatus.textContent = statusText;
                ui.dayViewStatus.className = `text-sm font-bold ${statusClass}`;
            }

            function renderWorkoutPlanForDate(date) {
                const dayInfo = getWorkoutDayType(date);
                const exerciseGroups = { "Push": ['Chest', 'Shoulders', 'Triceps'], "Pull": ['Back', 'Biceps', 'Forearms'], "Legs": ['Quads', 'Glutes', 'Hamstrings', 'Calves', 'Abs'] };
                
                const today = new Date();
                today.setHours(0,0,0,0);
                const isFutureDay = date > today;

                let exercisesHtml = '';

                const renderExerciseList = (exercises) => {
                    return exercises.map(ex => `<li class="text-base text-gray-300 exercise-item flex justify-between items-center group">
                        <div class="flex-grow flex items-center">
                            <button class="p-1 favorite-toggle-btn" data-name="${ex.name}" title="Toggle Favorite">
                                <i data-lucide="star" class="w-4 h-4 pointer-events-none ${ex.favorite ? 'text-yellow-400 fill-yellow-400' : 'text-gray-500 hover:text-yellow-400'}"></i>
                            </button>
                            <button class="flex-grow text-left p-1 rounded hover:bg-black/30 log-workout-btn" data-name="${ex.name}" ${isFutureDay ? 'disabled' : ''}>${ex.name}</button>
                        </div>
                        <span class="exercise-item-controls items-center gap-1 pl-1">
                            <button class="edit-exercise-btn p-1" data-name="${ex.name}" title="Edit Exercise"><i data-lucide="pencil" class="w-4 h-4 text-gray-500 hover:text-yellow-400 pointer-events-none"></i></button>
                            <button class="delete-exercise-btn p-1" data-name="${ex.name}" title="Delete Exercise"><i data-lucide="trash-2" class="w-4 h-4 text-gray-500 hover:text-red-500 pointer-events-none"></i></button>
                        </span>
                    </li>`).join('');
                };

                if (dayInfo.type === 'Rest') {
                    exercisesHtml = `<div class="flex flex-col items-center justify-center h-full text-center p-4"><i data-lucide="bed-double" class="w-12 h-12 text-gray-500 mb-2"></i><p class="text-gray-500 italic mt-2">Rest Day</p></div>`;
                } else {
                    const groupsForDay = exerciseGroups[dayInfo.type];
                    const warmupExercises = warmups[dayInfo.type] || [];
                    
                    if (warmupExercises.length > 0) {
                        exercisesHtml += `<div><h5 class="font-semibold text-green-400 text-sm mb-1">Warm-up</h5><ul class="space-y-1">${warmupExercises.map(w => `<li class="text-base text-gray-300 exercise-item flex justify-between items-center group"><button class="flex-grow text-left p-1 rounded hover:bg-black/30 warmup-detail-btn" data-name="${w.name}" data-day-type="${dayInfo.type}">${w.name}</button><span class="exercise-item-controls items-center gap-1 pl-1"><button class="edit-warmup-btn p-1" data-name="${w.name}" data-day-type="${dayInfo.type}" title="Edit Warmup"><i data-lucide="pencil" class="w-4 h-4 text-gray-500 hover:text-yellow-400 pointer-events-none"></i></button><button class="delete-warmup-btn p-1" data-name="${w.name}" data-day-type="${dayInfo.type}" title="Delete Warmup"><i data-lucide="trash-2" class="w-4 h-4 text-gray-500 hover:text-red-500 pointer-events-none"></i></button></span></li>`).join('')}</ul></div>`;
                    }
                    
                    for(const group of groupsForDay) {
                        // Filter exercises planned for this muscle group, prioritizing favorites
                        const exercisesForGroup = exerciseDB.filter(ex => ex.group === group).sort((a, b) => (b.favorite ? 1 : 0) - (a.favorite ? 1 : 0));
                        if(exercisesForGroup.length > 0) {
                            exercisesHtml += `<div><h5 class="font-semibold text-blue-400 text-sm mb-1">${group}</h5><ul class="space-y-1">${renderExerciseList(exercisesForGroup)}</ul></div>`;
                        }
                    }
                }
                ui.workoutPlanForDay.innerHTML = exercisesHtml;
                lucide.createIcons();
            }

            function renderHistoryForDate(date) {
                const dateKey = dateToKey(date);
                const logsForDay = workoutHistory
                    .map((log, index) => ({ ...log, originalIndex: index })) 
                    .filter(log => dateToKey(new Date(log.date)) === dateKey);

                if (logsForDay.length === 0) {
                    ui.historyDayContent.innerHTML = `<p class="text-secondary-text">No workouts logged.</p>`;
                    return;
                }

                ui.historyDayContent.innerHTML = logsForDay.map(log => {
                     const setsHtml = log.sets.map((setParts, i) => `<span><strong>Set ${i+1}:</strong> ${setParts.map(p => `${p.weight}kg x ${p.reps}r ${p.partial ? '(P)' : ''}`).join(', ')}</span>`).join('<br>');
                     return `<div class="bg-black/30 p-2 rounded-md">
                        <div class="flex justify-between items-start">
                             <strong class="text-primary-text">${log.name}</strong>
                             <div class="flex items-center gap-1">
                                <button class="edit-history-btn p-1 text-gray-500 hover:text-yellow-400 rounded-md" data-index="${log.originalIndex}" title="Edit Log"><i data-lucide="pencil" class="w-4 h-4 pointer-events-none"></i></button>
                                <button class="delete-history-btn p-1 text-gray-500 hover:text-red-400 rounded-md" data-index="${log.originalIndex}" title="Delete Log"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                             </div>
                        </div>
                        <div class="text-sm text-secondary-text mt-1">${setsHtml}</div>
                     </div>`;
                }).join('');
                lucide.createIcons();
            }


            // --- EVENT LISTENERS ---
            ui.addExerciseBtn.addEventListener('click', () => populateExerciseModal());
            ui.closeExerciseModalBtn.addEventListener('click', () => hideModal(ui.exerciseModal));
            ui.getAIAdviceBtn.addEventListener('click', getAIWorkoutAdvice);
            ui.closeModalBtn.addEventListener('click', () => {
                hideModal(ui.workoutModal);
                isLogging = false;
            });
            ui.addSetBtn.addEventListener('click', () => addSetRow());
            ui.alertModalOkBtn.addEventListener('click', () => hideModal(ui.alertModal));
            ui.confirmModalCancelBtn.addEventListener('click', () => hideModal(ui.confirmModal));
            ui.confirmModalConfirmBtn.addEventListener('click', () => { if(confirmCallback) confirmCallback(); hideModal(ui.confirmModal); });
            ui.progressExerciseSelect.addEventListener('change', (e) => renderProgressionChart(e.target.value));
            
            ui.dayViewDateDisplayBtn.addEventListener('click', () => {
                const today = new Date();
                today.setHours(0,0,0,0);
                viewDate = today;
                updateUI();
            });

            ui.prevDayBtn.addEventListener('click', () => {
                viewDate.setDate(viewDate.getDate() - 1);
                updateUI();
            });

            ui.nextDayBtn.addEventListener('click', () => {
                const today = new Date();
                today.setHours(0,0,0,0);
                const nextDay = new Date(viewDate);
                nextDay.setDate(nextDay.getDate() + 1);
                
                if (nextDay.getTime() <= today.getTime()) {
                    viewDate.setDate(viewDate.getDate() + 1);
                    updateUI();
                }
            });

            ui.workoutStatusControls.addEventListener('click', (e) => {
                const btn = e.target.closest('.status-btn');
                if (btn) {
                    const status = btn.dataset.status;
                    const dateKey = dateToKey(viewDate);
                    
                    // Explicitly set the manual status
                    workoutStatusHistory[dateKey] = status;
                    
                    saveData();
                    updateWorkoutStatusControls(viewDate);
                }
            });

            function populateProgressSelect() {
                const currentSelection = ui.progressExerciseSelect.value;
                const exercisedNames = [...new Set(workoutHistory.map(log => log.name))].sort();
                const singleExerciseOptions = exercisedNames.map(name => `<option value="${name}">${name}</option>`).join('');
                
                ui.progressExerciseSelect.innerHTML = `
                    <option value="general">General Progression</option>
                    <optgroup label="Specific Exercises">
                        ${singleExerciseOptions}
                    </optgroup>
                `;
                ui.progressExerciseSelect.value = currentSelection || 'general';

                ui.aiAdviceExerciseSelect.innerHTML = '<option value="">Select an exercise...</option>' + singleExerciseOptions;
            };

            // FIX: Graph date issue fix by using toLocaleDateString() on date object created from YYYY-MM-DD
            function renderProgressionChart(exerciseName) {
                if (exerciseName === "general") {
                    renderGeneralProgressionChart();
                    return;
                }
                if (!exerciseName) {
                    progressChart.data.labels = [];
                    progressChart.data.datasets = [];
                    progressChart.update();
                    return;
                }
                const exerciseLogs = workoutHistory.filter(log => log.name === exerciseName).sort((a,b) => new Date(a.date) - new Date(b.date));
                
                const labels = exerciseLogs.map(log => {
                    // Fix: Use Date object created from date string to ensure correct day is displayed
                    // Replacing hyphens with slashes makes it more robust for date parsing
                    return new Date(log.date.replace(/-/g, '/')).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                });
                const maxWeightData = exerciseLogs.map(log => Math.max(...log.sets.flatMap(set => set.map(s => s.weight || 0))));
                const volumeData = exerciseLogs.map(log => log.sets.flat().reduce((total, s) => total + (s.weight * s.reps), 0));

                progressChart.data.labels = labels;
                progressChart.data.datasets = [
                    { label: 'Max Weight (kg)', data: maxWeightData, borderColor: '#60a5fa', backgroundColor: '#60a5fa', tension: 0.1 },
                    { label: 'Total Volume (kg)', data: volumeData, borderColor: '#4ade80', backgroundColor: '#4ade80', tension: 0.1 }
                ];
                progressChart.update();
            };

            // FIX: Graph date issue fix by using toLocaleDateString() on date object created from YYYY-MM-DD
            function renderGeneralProgressionChart() {
                if (workoutHistory.length === 0) {
                    progressChart.data.labels = [];
                    progressChart.data.datasets = [];
                    progressChart.update();
                    return;
                }

                const volumeByDay = {};
                workoutHistory.forEach(log => {
                    const dateKey = log.date;
                    const logVolume = log.sets.flat().reduce((total, s) => total + (s.weight * s.reps), 0);
                    if (!volumeByDay[dateKey]) {
                        volumeByDay[dateKey] = 0;
                    }
                    volumeByDay[dateKey] += logVolume;
                });

                const sortedDates = Object.keys(volumeByDay).sort((a, b) => new Date(a) - new Date(b));
                
                const labels = sortedDates.map(dateStr => {
                     // Fix: Use Date object created from date string to ensure correct day is displayed
                     return new Date(dateStr.replace(/-/g, '/')).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                });
                const volumeData = sortedDates.map(date => volumeByDay[date]);

                progressChart.data.labels = labels;
                progressChart.data.datasets = [
                    {
                        label: 'Total Daily Volume (kg)',
                        data: volumeData,
                        borderColor: '#a78bfa',
                        backgroundColor: '#a78bfa',
                        tension: 0.1
                    }
                ];
                progressChart.update();
            }
            
            function openEditWorkoutModal(index) {
                isLogging = true;
                editingWorkoutLogIndex = index;
                const logEntry = workoutHistory[index];
                currentlyLoggingExercise = logEntry.name;
                ui.modalTitle.textContent = `Edit: ${logEntry.name}`;
                ui.saveWorkoutBtn.textContent = 'Update Workout';
                ui.setsContainer.innerHTML = '';
                logEntry.sets.forEach(set => addSetRow(set));
                showModal(ui.workoutModal);
            };

             async function getAIWorkoutAdvice() {
                const exerciseName = ui.aiAdviceExerciseSelect.value;
                if (!exerciseName) {
                    ui.aiAdviceOutput.innerHTML = `<p class="text-yellow-400">Please select an exercise first.</p>`;
                    return;
                }

                const btn = ui.getAIAdviceBtn;
                btn.disabled = true;
                btn.querySelector('.btn-text').style.display = 'none';
                btn.querySelector('.loader').classList.remove('hidden');
                ui.aiAdviceOutput.innerHTML = '';

                const exerciseLogs = workoutHistory.filter(log => log.name === exerciseName).slice(-3);

                const prompt = `Act as an expert fitness coach grounded in science. A user has performed these recent sessions for ${exerciseName}:
                ${exerciseLogs.map((log, i) => {
                    const logDate = new Date(log.date.replace(/-/g, '/')).toLocaleDateString();
                    return `Session ${i+1} (${logDate}): ${log.sets.map(set => set.map(part => `${part.weight}kg x ${part.reps} reps`).join(' + ')).join(', ')}`
                }).join('\n')}
                Based on progressive overload, give a clear, actionable recommendation for their *next* session. Be specific (e.g., "Aim for 6-8 reps with 52.5kg"). Keep it under 75 words.`;

                const apiUrl = getApiUrl('gemini-2.5-flash-preview-05-20');

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    let text = result.candidates[0].content.parts[0].text;
                    ui.aiAdviceOutput.innerHTML = `<p>${text}</p>`;
                } catch (error) {
                    console.error("AI Workout Advice Error:", error);
                    ui.aiAdviceOutput.innerHTML = `<p class="text-red-400">Could not get AI advice.</p>`;
                } finally {
                    btn.disabled = false;
                    btn.querySelector('.btn-text').style.display = 'inline';
                    btn.querySelector('.loader').classList.add('hidden');
                }
            }

            async function getAIGeneralAdvice() {
                const userPrompt = ui.aiGeneralPrompt.value.trim();
                if (!userPrompt) {
                    ui.aiGeneralOutput.innerHTML = `<p class="text-yellow-400">Please enter a question.</p>`;
                    return;
                }

                const btn = ui.getAIGeneralAdviceBtn;
                btn.disabled = true;
                btn.querySelector('.btn-text').style.display = 'none';
                btn.querySelector('.loader').classList.remove('hidden');
                ui.aiGeneralOutput.innerHTML = '';

                const twoWeeksAgo = new Date();
                twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
                const recentHistory = workoutHistory
                    .filter(log => new Date(log.date) >= twoWeeksAgo)
                    .map(log => {
                        const logDate = new Date(log.date.replace(/-/g, '/')).toLocaleDateString();
                        return `On ${logDate}: ${log.name} - ${log.sets.map(s => s.map(p => `${p.weight}kg x ${p.reps}r`).join('/')).join(', ')}`;
                    })
                    .join('; ');
                
                const fullExerciseList = exerciseDB.map(ex => `${ex.name} (${ex.group})`).join(', ');

                const systemPrompt = `You are FitTrack AI, an expert fitness coach. Your answers must be encouraging, evidence-based, and concise.
                Here is a summary of the user's workout data from the last 14 days:
                ${recentHistory || "No workouts logged in the last 14 days."}
                
                Here is the user's full list of available exercises:
                ${fullExerciseList}

                Use this data to answer the user's question precisely and personally. Do not mention that you are using their data unless it is necessary to explain your reasoning. Keep responses under 150 words.`;
                
                const apiUrl = getApiUrl('gemini-2.5-flash-preview-05-20');
                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    let text = result.candidates[0].content.parts[0].text;
                    ui.aiGeneralOutput.innerHTML = `<p>${text.replace(/\n/g, '<br>')}</p>`;
                } catch (error) {
                    console.error("AI General Advice Error:", error);
                    ui.aiGeneralOutput.innerHTML = `<p class="text-red-400">Could not get AI advice.</p>`;
                } finally {
                    btn.disabled = false;
                    btn.querySelector('.btn-text').style.display = 'inline';
                    btn.querySelector('.loader').classList.add('hidden');
                }
            }

            function openExerciseDetailModal(itemName, itemType, dayType = null) {
                let item;
                if (itemType === 'warmup') {
                    if (!dayType || !warmups[dayType]) return;
                    item = warmups[dayType].find(w => w.name === itemName);
                } else {
                    item = exerciseDB.find(ex => ex.name === itemName);
                }

                if (!item) return;
                currentlyLoggingExercise = item.name;
                ui.exerciseDetailTitle.textContent = item.name;
                ui.exerciseDetailVideo.src = item.videoPlaceholder || "https://placehold.co/400x225/111111/FFFFFF?text=No+Video";
                const instructions = Array.isArray(item.instructions) ? item.instructions : (item.instructions || "").split('\n');
                ui.exerciseDetailInstructions.innerHTML = instructions.map(step => `<li>${step}</li>`).join('');
                ui.exerciseDetailRepRange.textContent = item.repRange ? `Aim for ${item.repRange}.` : 'No specific rep range.';
                ui.exerciseDetailNotes.value = item.notes || '';
                ui.logFromDetailBtn.style.display = itemType === 'warmup' ? 'none' : 'block';
                showModal(ui.exerciseDetailModal);
            }
            
            function populateExerciseModal(exercise = null) {
                const groupSelect = document.getElementById('exercise-group');
                // Use a consistent list of all possible muscle groups from defaults 
                const muscleGroups = [...new Set(defaultExerciseDB.map(ex => ex.group))].sort();
                groupSelect.innerHTML = muscleGroups.map(g => `<option value="${g}">${g}</option>`).join('');
                if (exercise) {
                    ui.exerciseModalTitle.textContent = "Edit Exercise";
                    document.getElementById('exercise-name').value = exercise.name;
                    groupSelect.value = exercise.group;
                    document.getElementById('exercise-type').value = exercise.type;
                    editingExerciseName = exercise.name;
                } else {
                    ui.exerciseModalTitle.textContent = "Add New Exercise";
                    ui.exerciseForm.reset();
                    editingExerciseName = null;
                }
                showModal(ui.exerciseModal);
            };

            function renderWarmupManagementList() {
                const dayType = ui.warmupDaySelect.value;
                const currentWarmups = warmups[dayType] || [];
                ui.warmupListDiv.innerHTML = currentWarmups.map((warmup, index) => `<div class="flex justify-between items-center bg-black/30 p-2 rounded-md"><span>${warmup.name}</span><div class="flex gap-2"><button class="edit-warmup-btn p-1" data-index="${index}" data-day-type="${dayType}" title="Edit"><i data-lucide="pencil" class="w-4 h-4 text-gray-500 hover:text-yellow-400 pointer-events-none"></i></button><button class="delete-warmup-btn p-1" data-index="${index}" data-day-type="${dayType}" title="Delete"><i data-lucide="trash-2" class="w-4 h-4 text-gray-500 hover:text-red-500 pointer-events-none"></i></button></div></div>`).join('');
                lucide.createIcons();
            }

            // Event Listeners
            ui.workoutPlanForDay.addEventListener('click', (e) => {
                const logBtn = e.target.closest('.log-workout-btn'), editBtn = e.target.closest('.edit-exercise-btn'),
                      deleteBtn = e.target.closest('.delete-exercise-btn'), warmupBtn = e.target.closest('.warmup-detail-btn'),
                      editWarmupBtn = e.target.closest('.edit-warmup-btn'), deleteWarmupBtn = e.target.closest('.delete-warmup-btn'),
                      favBtn = e.target.closest('.favorite-toggle-btn');
                
                if (favBtn) {
                    const exName = favBtn.dataset.name;
                    const exercise = exerciseDB.find(ex => ex.name === exName);
                    if (exercise) {
                        exercise.favorite = !exercise.favorite;
                        saveData();
                        updateDayView(viewDate);
                    }
                }
                else if (logBtn && !logBtn.disabled) openExerciseDetailModal(logBtn.dataset.name, 'exercise');
                else if (warmupBtn) openExerciseDetailModal(warmupBtn.dataset.name, 'warmup', warmupBtn.dataset.dayType);
                else if (editBtn) { const ex = exerciseDB.find(e => e.name === editBtn.dataset.name); if(ex) populateExerciseModal(ex); }
                else if (deleteBtn) { const name = deleteBtn.dataset.name; showConfirmModal('Delete Exercise?', `This will remove "${name}".`, () => { const i = exerciseDB.findIndex(ex => ex.name === name); if (i > -1) { exerciseDB.splice(i, 1); saveData(); updateUI(); } }); }
                else if (editWarmupBtn) { const day = editWarmupBtn.dataset.dayType, name = editWarmupBtn.dataset.name, i = warmups[day]?.findIndex(w => w.name === name); if(i > -1) { showModal(ui.warmupManageModal); ui.warmupDaySelect.value = day; renderWarmupManagementList(); editingWarmupIndex = i; ui.warmupNameInput.value = warmups[day][i].name; ui.warmupInstructionsInput.value = Array.isArray(warmups[day][i].instructions) ? warmups[day][i].instructions.join('\n') : ''; ui.warmupFormTitle.textContent = "Edit Warm-up"; ui.saveWarmupBtn.textContent = "Update"; } }
                else if (deleteWarmupBtn) { const day = deleteWarmupBtn.dataset.dayType, name = deleteWarmupBtn.dataset.name; showConfirmModal('Delete Warm-up?', `Delete "${name}"?`, () => { if(warmups[day]) { const i = warmups[day].findIndex(w => w.name === name); if (i > -1) { warmups[day].splice(i, 1); saveData(); updateUI(); }} }); }
            });
           
            ui.historyDayContent.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-history-btn');
                const deleteBtn = e.target.closest('.delete-history-btn');

                if (editBtn) {
                    const index = parseInt(editBtn.dataset.index, 10);
                    openEditWorkoutModal(index);
                }
                if (deleteBtn) {
                    const index = parseInt(deleteBtn.dataset.index, 10);
                    showConfirmModal('Delete Log?', 'Are you sure you want to delete this workout log entry?', () => {
                        workoutHistory.splice(index, 1);
                        saveData();
                        updateUI();
                    });
                }
            });

            ui.closeExerciseDetailModalBtn.addEventListener('click', () => hideModal(ui.exerciseDetailModal));
            ui.logFromDetailBtn.addEventListener('click', () => { hideModal(ui.exerciseDetailModal); openWorkoutModal(currentlyLoggingExercise); });
            ui.saveExerciseNotesBtn.addEventListener('click', () => { const ex = exerciseDB.find(e => e.name === currentlyLoggingExercise); if (ex) { ex.notes = ui.exerciseDetailNotes.value; saveData(); const btn = ui.saveExerciseNotesBtn; btn.textContent = 'Saved!'; setTimeout(() => { btn.textContent = 'Save Notes'; }, 2000); }});
            ui.manageWarmupsBtn.addEventListener('click', () => { editingWarmupIndex = null; ui.warmupForm.reset(); ui.warmupFormTitle.textContent = "Add New Warm-up"; ui.saveWarmupBtn.textContent = "Add"; renderWarmupManagementList(); showModal(ui.warmupManageModal); });
            ui.closeWarmupManageModalBtn.addEventListener('click', () => hideModal(ui.warmupManageModal));
            ui.warmupDaySelect.addEventListener('change', () => { editingWarmupIndex = null; ui.warmupForm.reset(); ui.warmupFormTitle.textContent = "Add"; ui.saveWarmupBtn.textContent = "Add"; renderWarmupManagementList(); });
            ui.warmupListDiv.addEventListener('click', (e) => { /* Logic handled by workoutPlanForDay listener */ });
            ui.warmupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const day = ui.warmupDaySelect.value, name = ui.warmupNameInput.value.trim(), instructions = ui.warmupInstructionsInput.value.split('\n').filter(l => l.trim() !== '');
                if (!name) return;
                const newWarmup = { name, instructions, repRange: "As needed", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" };
                if (!warmups[day]) warmups[day] = [];
                if (editingWarmupIndex !== null) { warmups[day][editingWarmupIndex] = newWarmup; } else { warmups[day].push(newWarmup); }
                saveData(); renderWarmupManagementList(); updateUI(); ui.warmupForm.reset(); editingWarmupIndex = null; ui.warmupFormTitle.textContent = "Add"; ui.saveWarmupBtn.textContent = "Add";
            });
            ui.exerciseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('exercise-name').value.trim(), group = document.getElementById('exercise-group').value, type = document.getElementById('exercise-type').value;
                if (!name || !group) return showCustomAlert('Error', 'Please enter a name and group.');
                if (editingExerciseName) {
                    const i = exerciseDB.findIndex(ex => ex.name === editingExerciseName);
                    if (i > -1) {
                        if (name.toLowerCase() !== editingExerciseName.toLowerCase() && exerciseDB.some(ex => ex.name.toLowerCase() === name.toLowerCase())) return showCustomAlert('Error', 'Name already exists.');
                        exerciseDB[i] = { ...exerciseDB[i], name, group, type };
                    }
                } else {
                    if (exerciseDB.some(ex => ex.name.toLowerCase() === name.toLowerCase())) return showCustomAlert('Error', 'Name already exists.');
                    exerciseDB.push({ name, group, type, instructions: ["No instructions added."], repRange: "N/A", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=No+Video", notes: "", favorite: false });
                }
                editingExerciseName = null; hideModal(ui.exerciseModal); saveData(); updateUI();
            });
             ui.workoutLogForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const sets = [];
                let formIsValid = true;

                document.querySelectorAll('.set-row').forEach(row => {
                    row.querySelectorAll('.set-part-row').forEach(partRow => {
                        partRow.querySelectorAll('input').forEach(input => input.classList.remove('!border-red-500'));
                        const weightInput = partRow.querySelector('.set-weight');
                        const repsInput = partRow.querySelector('.set-reps');
                        const weight = parseFloat(weightInput.value);
                        const reps = parseFloat(repsInput.value);

                        let setPartIsValid = true;
                        if ( (isNaN(weight) || weight < 0) && (isNaN(reps) || reps < 1) ) return;
                        if (isNaN(weight) || weight < 0) {
                            weightInput.classList.add('!border-red-500');
                            setPartIsValid = false;
                        }
                        if (isNaN(reps) || reps < 1 || !Number.isInteger(reps) ) {
                             repsInput.classList.add('!border-red-500');
                             setPartIsValid = false;
                        }
                        if(!setPartIsValid) {
                            formIsValid = false;
                        }
                    });
                });

                if(!formIsValid){
                     showCustomAlert("Invalid Input", "Weight must be a positive number and reps must be a positive whole number.");
                     return;
                }
                
                document.querySelectorAll('.set-row').forEach(row => {
                    const setParts = [];
                     row.querySelectorAll('.set-part-row').forEach(partRow => {
                        const rawWeight = parseFloat(partRow.querySelector('.set-weight').value) || 0;
                        const weight = parseFloat(rawWeight.toFixed(2));
                        const reps = parseInt(partRow.querySelector('.set-reps').value) || 0;
                        const partial = partRow.querySelector('.set-partial').checked;
                        if(reps > 0) setParts.push({ weight, reps, partial });
                    });
                    if (setParts.length > 0) sets.push(setParts);
                });

                if(sets.length === 0) return showCustomAlert('Empty Workout', 'Please log at least one valid set.');
                
                const dateString = dateToKey(viewDate);

                const newLog = { name: currentlyLoggingExercise, date: dateString, sets: sets };
                
                if (editingWorkoutLogIndex !== null) {
                    workoutHistory[editingWorkoutLogIndex] = newLog;
                } else {
                    workoutHistory.push(newLog);
                }

                editingWorkoutLogIndex = null;
                // Important: clear any manual status override to let the auto-status calculate 
                // based on the new/updated log, only if a log was successful.
                if (workoutStatusHistory[dateString] !== undefined && workoutStatusHistory[dateString] !== 'auto') {
                    delete workoutStatusHistory[dateString];
                }
                
                saveData(); 
                updateUI(); 
                hideModal(ui.workoutModal);
                isLogging = false;
            });
            ui.setsContainer.addEventListener('click', (e) => {
                const removeSetBtn = e.target.closest('.remove-set-btn'), removePartBtn = e.target.closest('.remove-part-btn');
                if (removeSetBtn) { removeSetBtn.closest('.set-row').remove(); document.querySelectorAll('.set-row').forEach((row, index) => { row.querySelector('label').textContent = `Set ${index + 1}`; }); }
                else if (removePartBtn) { const partRow = removePartBtn.closest('.set-part-row'), partsContainer = partRow.parentElement; if (partsContainer.children.length > 1) { partRow.remove(); } else { showCustomAlert("Action blocked", "A set must have at least one part."); } }
            });
            ui.clearHistoryBtn.addEventListener('click', () => { showConfirmModal('Clear History?', 'This will delete all workout logs.', () => { workoutHistory = []; workoutStatusHistory = {}; saveData(); updateUI(); }) });

            ui.workoutActionsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                ui.workoutActionsDropdown.classList.toggle('hidden');
            });

            document.addEventListener('click', (e) => {
                if (!ui.workoutActionsBtn.contains(e.target) && !ui.workoutActionsDropdown.contains(e.target)) {
                    ui.workoutActionsDropdown.classList.add('hidden');
                }
            });

            // AI Coach Tab Listeners
            ui.aiTabSpecific.addEventListener('click', () => {
                ui.aiTabSpecific.classList.add('border-accent', 'text-primary-text');
                ui.aiTabSpecific.classList.remove('border-transparent', 'text-secondary-text');
                ui.aiTabGeneral.classList.add('border-transparent', 'text-secondary-text');
                ui.aiTabGeneral.classList.remove('border-accent', 'text-primary-text');
                ui.aiPanelSpecific.classList.remove('hidden');
                ui.aiPanelGeneral.classList.add('hidden');
            });
            ui.aiTabGeneral.addEventListener('click', () => {
                ui.aiTabGeneral.classList.add('border-accent', 'text-primary-text');
                ui.aiTabGeneral.classList.remove('border-transparent', 'text-secondary-text');
                ui.aiTabSpecific.classList.add('border-transparent', 'text-secondary-text');
                ui.aiTabSpecific.classList.remove('border-accent', 'text-primary-text');
                ui.aiPanelGeneral.classList.remove('hidden');
                ui.aiPanelSpecific.classList.add('hidden');
            });
            ui.getAIGeneralAdviceBtn.addEventListener('click', getAIGeneralAdvice);

            // Unload protection
            window.addEventListener('beforeunload', (event) => {
                if (isLogging) {
                    event.preventDefault();
                    event.returnValue = 'You have an unsaved workout. Are you sure you want to leave?';
                }
            });

            // --- INITIALIZATION ---
            loadData();
            updateUI();
        });
    </script>
</body>
</html>
