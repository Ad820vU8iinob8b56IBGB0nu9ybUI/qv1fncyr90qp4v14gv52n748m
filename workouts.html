<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitTrack AI | Workouts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --background: #000000;
            --primary-text: #eaeaea;
            --secondary-text: #888888;
            --card-bg: #111111;
            --input-bg: #191919;
            --border-color: #222222;
            --accent: #FFFFFF;
            --accent-hover: #DDDDDD;
            --danger: #E53E3E;
        }

        body {
            background-color: var(--background);
            color: var(--primary-text);
            font-family: 'Manrope', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .nav-link {
            transition: color 0.3s ease, border-color 0.3s ease;
            border-bottom: 2px solid transparent;
            color: var(--secondary-text);
            padding-bottom: 4px;
        }

        .nav-link:hover {
            color: var(--primary-text);
        }

        .nav-link.active {
            color: var(--primary-text);
            border-bottom-color: var(--primary-text);
        }

        .content-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 2rem;
        }

        .form-input {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--primary-text);
            padding: 0.75rem 1rem;
            width: 100%;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        .form-label {
            color: var(--secondary-text);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .btn {
            border-radius: 0.5rem;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            transition: all 0.2s ease-in-out;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transform: translateY(0);
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: translateY(0);
        }

        .btn-primary {
            background-color: var(--accent);
            color: var(--background);
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--accent-hover);
        }
        
        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--primary-text);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: var(--border-color);
            border-color: var(--accent);
        }
        
        .btn-danger {
            color: var(--danger);
        }
        
        .btn-danger:hover:not(:disabled) {
             background-color: rgba(229, 62, 62, 0.1);
        }

        #workout-actions-dropdown {
            z-index: 50;
            background-color: var(--card-bg);
        }

        .modal-backdrop {
            display: none;
            position: fixed;
            z-index: 100;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        .modal-content {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .loader {
            border: 2px solid #333;
            border-top: 2px solid var(--accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--input-bg); border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #666; }
        
        .exercise-item-controls { display: none; }
        .exercise-item:hover .exercise-item-controls { display: inline-flex; }
        
        .calendar-day {
            padding: 0.25rem 0;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid transparent;
        }
        .calendar-day:hover:not(.is-future) {
            background-color: var(--input-bg);
        }
        .calendar-day.is-today {
            border-color: var(--accent);
            color: var(--accent);
        }
        .calendar-day.is-selected {
            background-color: var(--accent);
            color: var(--background);
            font-weight: 700;
        }
        .calendar-day.has-workout {
            position: relative;
        }
        .calendar-day.has-workout::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background-color: #3b82f6; /* Blue dot */
        }
        .calendar-day.is-selected.has-workout::after {
            background-color: var(--background);
        }
        .calendar-day.is-future {
            color: var(--secondary-text);
            opacity: 0.5;
            cursor: default;
            pointer-events: none;
        }
        
        .log-workout-btn:disabled {
            opacity: 0.5;
            pointer-events: none;
            cursor: not-allowed;
        }

    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto max-w-7xl px-4 py-8">

        <!-- Header -->
        <header class="flex flex-col sm:flex-row items-center justify-between mb-16 pb-4 border-b border-gray-900">
            <a href="index.html" class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m6 2 4 4"/><path d="m3 10.5 4.5-4.5"/><path d="m13.5 21 4.5-4.5"/></svg>
                <h1 class="text-2xl font-bold">FitTrack AI</h1>
            </a>
            <nav class="mt-4 sm:mt-0">
                <ul class="flex items-center space-x-4 sm:space-x-6 text-base font-medium">
                    <li><a href="index.html" class="nav-link">Dashboard</a></li>
                    <li><a href="nutrition.html" class="nav-link">Nutrition</a></li>
                    <li><a href="workouts.html" class="nav-link active">Workouts</a></li>
                    <li><a href="goals.html" class="nav-link">Goals</a></li>
                    <li><a href="sleep.html" class="nav-link">Sleep</a></li>
                    <li><a href="settings.html" class="nav-link">Settings</a></li>
                </ul>
            </nav>
        </header>

        <!-- Main Content -->
        <main>
             <div class="text-center mb-8">
                <h2 class="text-3xl font-bold">Your Workout Plan</h2>
                <p class="text-gray-400 mt-2">Push, Pull, Legs split.</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column: Main Interactive View -->
                <div class="lg:col-span-2 content-card">
                    <div class="flex justify-between items-center mb-4">
                         <div class="flex-1">
                             <h4 id="day-view-title" class="text-2xl font-semibold">Select a day</h4>
                        </div>
                        <div class="flex items-center gap-2">
                             <button id="back-to-today-btn" class="btn btn-secondary !p-2" title="Go to Today">
                                <i data-lucide="calendar-check" class="w-5 h-5"></i>
                            </button>
                             <div class="relative">
                                <button id="workout-actions-btn" class="btn btn-secondary !p-2">
                                    <i data-lucide="more-horizontal" class="w-5 h-5"></i>
                                </button>
                                <div id="workout-actions-dropdown" class="absolute right-0 mt-2 w-48 border border-border-color rounded-md shadow-lg hidden">
                                    <button id="manage-warmups-btn" class="w-full text-left px-4 py-2 text-sm text-primary-text hover:bg-input-bg flex items-center gap-2 rounded-t-md">
                                        <i data-lucide="flame" class="w-4 h-4"></i> Manage Warm-ups
                                    </button>
                                    <button id="add-exercise-btn" class="w-full text-left px-4 py-2 text-sm text-primary-text hover:bg-input-bg flex items-center gap-2">
                                        <i data-lucide="plus-circle" class="w-4 h-4"></i> Add Exercise
                                    </button>
                                    <button id="clear-history-btn" class="w-full text-left px-4 py-2 text-sm btn-danger hover:bg-input-bg flex items-center gap-2 rounded-b-md">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i> Clear All History
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-center gap-4 mb-6">
                        <button id="prev-day-btn" class="btn btn-secondary !p-2"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                        <button id="day-view-date-display-btn" class="text-lg font-semibold text-center w-48 hover:bg-input-bg px-4 py-2 rounded-lg transition-colors"></button>
                        <button id="next-day-btn" class="btn btn-secondary !p-2"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                    </div>

                    <div>
                        <div class="flex justify-end items-baseline mb-2">
                            <span id="day-view-status" class="text-sm font-bold"></span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 mt-4">
                            <div>
                                <h5 class="font-semibold text-lg mb-2 border-b border-border-color pb-1">Plan</h5>
                                <div id="workout-plan-for-day" class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar pr-2"></div>
                            </div>
                            <div>
                                <h5 class="font-semibold text-lg mb-2 border-b border-border-color pb-1">History</h5>
                                <div id="history-day-content" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar pr-2">
                                    <p class="text-secondary-text">No workouts logged.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Supporting Info -->
                <div class="space-y-8">
                    <div class="content-card">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                            <h3 class="text-2xl font-semibold">Progression</h3>
                            <select id="progress-exercise-select" class="w-full sm:w-auto form-input">
                                <option value="">Select an exercise</option>
                            </select>
                        </div>
                        <div class="w-full h-80 flex items-center justify-center">
                            <canvas id="progress-chart"></canvas>
                        </div>
                    </div>
                     <div class="content-card">
                        <h3 class="text-2xl font-semibold mb-4 text-center">AI Coach: Progression Advice</h3>
                        <div class="max-w-md mx-auto">
                             <p class="text-gray-400 text-sm mb-3 text-center">Select an exercise to get science-based advice on when to add weight or reps.</p>
                             <div class="flex gap-2">
                                <select id="ai-advice-exercise-select" class="w-full form-input">
                                    <option value="">Select an exercise...</option>
                                </select>
                                <button id="get-ai-advice-btn" class="btn btn-secondary">
                                    <span class="btn-text">Get Advice</span>
                                     <div class="loader hidden ml-2"></div>
                                </button>
                             </div>
                             <div id="ai-advice-output" class="mt-4 p-3 bg-black/30 rounded-md text-sm min-h-[50px]"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="date-picker-modal" class="modal-backdrop">
        <div class="modal-content !max-w-sm">
             <div class="flex justify-between items-center mb-4">
                <button id="modal-prev-month-btn" class="btn btn-secondary !p-2"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                <h4 id="modal-month-year-display" class="text-lg font-semibold"></h4>
                <button id="modal-next-month-btn" class="btn btn-secondary !p-2"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
            </div>
            <div id="modal-calendar-grid" class="grid grid-cols-7 gap-1 text-center text-sm"></div>
        </div>
    </div>
    <div id="exercise-detail-modal" class="modal-backdrop"><div class="modal-content !max-w-xl"><div class="flex justify-between items-center mb-4"><h2 id="exercise-detail-title" class="text-2xl font-bold">Exercise Details</h2><button id="close-exercise-detail-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><div class="space-y-4"><div class="w-full aspect-video bg-black rounded-lg flex items-center justify-center overflow-hidden border border-gray-800"><img id="exercise-detail-video" src="" alt="Video placeholder" class="w-full h-full object-contain"></div><div><h3 class="font-bold text-lg text-blue-400 mb-2">Instructions</h3><ul id="exercise-detail-instructions" class="list-disc list-inside space-y-1 text-gray-300"></ul></div><div><h3 class="font-bold text-lg text-blue-400 mb-2">Rep Range</h3><p id="exercise-detail-rep-range" class="text-gray-300"></p></div><div><h3 class="font-bold text-lg text-blue-400 mb-2">Personal Notes & Advice</h3><textarea id="exercise-detail-notes" rows="4" class="form-input mt-1" placeholder="Add your personal cues, weight progression goals, etc."></textarea><button id="save-exercise-notes-btn" class="mt-2 w-full btn btn-secondary">Save Notes</button></div><button id="log-from-detail-btn" class="w-full btn btn-primary mt-4">Log This Exercise</button></div></div></div>
    <div id="warmup-manage-modal" class="modal-backdrop"><div class="modal-content !max-w-xl"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Manage Warm-ups</h2><button id="close-warmup-manage-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><div class="space-y-4"><div><label for="warmup-day-select" class="form-label">Workout Day</label><select id="warmup-day-select" class="form-input mt-1"><option value="Push">Push</option><option value="Pull">Pull</option><option value="Legs">Legs</option></select></div><div id="warmup-list" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2"></div><hr class="border-gray-800"><form id="warmup-form" class="space-y-3"><h3 id="warmup-form-title" class="font-bold text-lg text-blue-400">Add New Warm-up</h3><div><label for="warmup-name" class="form-label">Name</label><input type="text" id="warmup-name" class="form-input mt-1" required></div><div><label for="warmup-instructions" class="form-label">Instructions (one per line)</label><textarea id="warmup-instructions" rows="4" class="form-input mt-1"></textarea></div><button type="submit" id="save-warmup-btn" class="w-full btn btn-primary">Add Warm-up</button></form></div></div></div>
    <div id="workout-modal" class="modal-backdrop"><div class="modal-content"><div class="flex justify-between items-center mb-4"><h2 id="modal-title" class="text-2xl font-bold">Log Exercise</h2><button id="close-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><form id="workout-log-form"><div class="space-y-4"><div id="sets-container"></div><button type="button" id="add-set-btn" class="w-full btn btn-secondary">Add Set</button><button type="submit" id="save-workout-btn" class="w-full btn btn-primary mt-2">Save Workout</button></div></form></div></div>
    <div id="exercise-modal" class="modal-backdrop"><div class="modal-content"><div class="flex justify-between items-center mb-4"><h2 id="exercise-modal-title" class="text-2xl font-bold">Add Exercise</h2><button id="close-exercise-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><form id="exercise-form" class="space-y-4"><div><label for="exercise-name" class="form-label">Exercise Name</label><input type="text" id="exercise-name" class="form-input mt-1" required></div><div><label for="exercise-group" class="form-label">Muscle Group</label><select id="exercise-group" class="form-input mt-1"></select></div><div><label for="exercise-type" class="form-label">Equipment Type</label><select id="exercise-type" class="form-input mt-1"><option>Barbell</option><option>Dumbbell</option><option>Machine</option><option>Bodyweight</option><option>Other</option></select></div><button type="submit" id="save-exercise-btn" class="w-full btn btn-primary">Save Exercise</button></form></div></div>
    <div id="confirm-modal" class="modal-backdrop"><div class="modal-content"><h2 id="confirm-modal-title" class="text-xl font-bold mb-4">Are you sure?</h2><p id="confirm-modal-text" class="text-gray-300 mb-6">This action cannot be undone.</p><div class="flex justify-end gap-4"><button id="confirm-modal-cancel-btn" class="btn btn-secondary">Cancel</button><button id="confirm-modal-confirm-btn" class="btn btn-danger">Confirm</button></div></div></div>
    <div id="alert-modal" class="modal-backdrop"><div class="modal-content"><h2 id="alert-modal-title" class="text-xl font-bold mb-4">Alert</h2><p id="alert-modal-text" class="text-gray-300 mb-6"></p><div class="flex justify-end"><button id="alert-modal-ok-btn" class="btn btn-primary">OK</button></div></div></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let workoutHistory = [];
            let exerciseDB = [];
            let warmups = {};
            let currentlyLoggingExercise = null;
            let editingWorkoutLogIndex = null;
            let editingExerciseName = null;
            let editingWarmupIndex = null;
            let confirmCallback = null;
            let viewDate = new Date(); // Central state for the currently viewed date
            let modalCalendarDate = new Date();
            
            // --- Set viewDate to today, ignoring time
            viewDate.setHours(0,0,0,0);
            modalCalendarDate.setHours(0,0,0,0);


            // --- DATABASES ---
             const defaultWarmups = {
                "Push": [
                    { name: "Arm Circles", instructions: ["Stand with feet shoulder-width apart.", "Extend your arms to the sides.", "Make small circles, gradually increasing to large circles.", "Perform for 30 seconds forward, then 30 seconds backward."], repRange: "1 minute total", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" },
                    { name: "Torso Twists", instructions: ["Stand with feet slightly wider than shoulder-width, knees slightly bent.", "Hold your arms out or cross them over your chest.", "Gently twist your torso from side to side.", "Perform for 30-60 seconds."], repRange: "1 minute total", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" },
                    { name: "Dynamic Chest Stretches", instructions: ["Stand tall.", "Swing both arms outwards and backwards, feeling a stretch in your chest.", "Return arms to the front, crossing them over each other.", "Repeat for 10-15 repetitions."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" }
                ],
                "Pull": [
                    { name: "Cat-Cow", instructions: ["Start on your hands and knees.", "Inhale as you drop your belly towards the mat (Cow).", "Exhale as you round your spine upwards (Cat).", "Repeat for 10-15 repetitions."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" },
                    { name: "Scapular Pull-ups", instructions: ["Hang from a pull-up bar with an overhand grip.", "Without bending your arms, pull your shoulder blades down and together.", "Hold for a second, then relax.", "Repeat for 8-12 repetitions."], repRange: "8-12 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" },
                    { name: "Band Pull-Aparts", instructions: ["Hold a light resistance band with both hands, shoulder-width apart.", "Keeping your arms straight, pull the band apart by squeezing your shoulder blades.", "Return to the start with control.", "Repeat for 15-20 repetitions."], repRange: "15-20 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" }
                ],
                "Legs": [
                    { name: "Front-to-back Leg Swings", instructions: ["Hold onto a stable surface for balance.", "Swing one leg forward and backward in a controlled motion.", "Keep your core engaged and torso upright.", "Perform 10-15 swings per leg."], repRange: "10-15 reps per leg", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" },
                    { name: "Side-to-side Leg Swings", instructions: ["Face a stable surface and hold on for balance.", "Swing one leg out to the side, then across the front of your body.", "Keep the movement controlled.", "Perform 10-15 swings per leg."], repRange: "10-15 reps per leg", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" },
                    { name: "Side Lying Twists", instructions: ["Lie on your side with your knees bent at 90 degrees.", "Extend your top arm and rotate your torso, trying to touch your top shoulder blade to the floor.", "Follow your hand with your eyes.", "Perform 8-10 twists per side."], repRange: "8-10 reps per side", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" },
                    { name: "Step Throughs", instructions: ["Start in a push-up position.", "Bring your right foot forward and place it outside your right hand, sinking your hips.", "Hold for a moment, then step back to the start.", "Repeat with the left leg.", "Alternate for 5-8 repetitions per side."], repRange: "5-8 reps per side", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" }
                ]
            };

            const defaultExerciseDB = [
                { name: "Seated leg curl", group: "Hamstrings", type: "Machine", instructions: ["Sit in the machine with your back against the pad and the ankle pad just above your heels.", "Adjust the lap pad to fit snugly on your thighs.", "Curl your legs down as far as possible, squeezing your hamstrings.", "Slowly return to the starting position."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Straight Calf extension", group: "Calves", type: "Machine", instructions: ["Use a standing or seated calf raise machine.", "Place the balls of your feet on the platform, with your heels hanging off.", "Press through the balls of your feet to raise your heels as high as possible.", "Hold the peak contraction, then slowly lower your heels below the platform level."], repRange: "10-20 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Barbell Squats", group: "Abductors", type: "Barbell", instructions: ["Set a barbell in a squat rack at shoulder height.", "Step under the bar and rest it across your upper back.", "Lift the bar off the rack, take a step back, and stand with feet shoulder-width apart.", "Keeping your chest up and back straight, lower your hips as if sitting in a chair.", "Go as deep as you comfortably can, ideally until your thighs are parallel to the floor.", "Push through your heels to return to the starting position."], repRange: "6-12 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Smith Machine squats", group: "Abductors", type: "Machine", instructions: ["Set the bar on the Smith machine to shoulder height.", "Position yourself under the bar with feet shoulder-width apart.", "Un-rack the bar and lower down by bending your knees and hips.", "Keep your back straight and chest up.", "Push through your heels to return to the start."], repRange: "8-12 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Romanian Deadlift", group: "Glutes", type: "Barbell", instructions: ["Hold a barbell with an overhand grip, hands just outside your thighs.", "Stand tall with a slight bend in your knees.", "Hinge at your hips, pushing your butt back while keeping your back straight.", "Lower the bar down your shins until you feel a deep stretch in your hamstrings.", "Squeeze your glutes to return to the starting position."], repRange: "8-12 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Hip thrusts", group: "Glutes", type: "Barbell", instructions: ["Sit on the floor with your upper back against a bench.", "Roll a barbell over your legs and position it in the crease of your hips.", "Place your feet flat on the floor, shoulder-width apart.", "Drive through your heels to lift your hips until your body forms a straight line from shoulders to knees.", "Squeeze your glutes at the top, then lower your hips back down."], repRange: "8-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Leg Extension", group: "Quads", type: "Machine", instructions: ["Sit in the leg extension machine with your legs under the pad.", "Align your knees with the machine's pivot point.", "Extend your legs to lift the weight until they are straight.", "Squeeze your quads at the top.", "Slowly lower the weight back to the starting position."], repRange: "12-20 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Cable Crunch", group: "Abs", type: "Machine", instructions: ["Kneel below a high pulley with a rope attachment.", "Grab the rope and pull it down until your hands are placed on either side of your head.", "Flex your hips slightly and allow the weight to hyperextend your lower back.", "Keeping your hips stationary, flex your waist as you contract your abs so that your elbows travel towards the middle of your thighs.", "Hold the contraction for a second and then slowly return to the starting position."], repRange: "10-20 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Bent Knee Raises", group: "Abs", type: "Bodyweight", instructions: ["Lie flat on your back on a mat with your legs straight.", "Place your hands under your lower back for support.", "Bend your knees and pull your upper thighs into your midsection.", "Hold the contraction for a second and then slowly lower your legs back to the starting position."], repRange: "15-25 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "High-to-low crossover", group: "Chest", type: "Machine", instructions: ["Set pulleys to the highest position.","Grab handles with palms facing down, step forward to create tension.","With a slight bend in your elbows, pull handles down and across your body until they meet in front of your lower chest.","Squeeze your chest muscles at the peak contraction.","Slowly return to the starting position."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Dumbbell Press", group: "Chest", type: "Dumbbell", instructions: ["Lie on a flat bench with a dumbbell in each hand, resting on your thighs.","Use your thighs to help push the dumbbells up one at a time so you can hold them at shoulder-width.","Rotate your wrists so your palms are facing away from you.","Press the dumbbells up until your arms are fully extended, but not locked at the elbow.","Slowly lower the dumbbells back to the starting position."], repRange: "6-12 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Machine Chest Press", group: "Chest", type: "Machine", instructions: ["Sit on the machine with your back flat against the pad.","Adjust the seat height so the handles are level with your mid-chest.","Grab the handles with a full grip, keeping your wrists straight.","Press the handles forward until your arms are fully extended, but not locked at the elbow.","Slowly return to the starting position, feeling a stretch in your chest."], repRange: "8-12 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Cable overhead extension", group: "Triceps", type: "Machine", instructions: ["Attach a rope handle to a low pulley.","Face away from the machine, grab the rope, and extend your arms fully overhead.","Keeping your upper arms stationary, lower the rope behind your head by bending your elbows.","Extend your arms to lift the rope back to the starting position, flexing your triceps."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Cable kickback", group: "Triceps", type: "Machine", instructions: ["Set a pulley to a low position. Hinge at your hips so your torso is nearly parallel to the floor.","Grab the handle and pull your elbow up so your upper arm is parallel to the floor.","Keeping your upper arm still, extend your forearm back until your arm is straight.","Squeeze your tricep at the top, then slowly return to the start."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Cable lateral raises/ lateral crossover", group: "Shoulders", type: "Machine", instructions: ["Set pulleys on both sides to the lowest position.","Stand in the middle and grab the left handle with your right hand, and the right handle with your left hand.","With a slight bend in your elbows, raise your arms out to your sides until they are parallel to the floor.","Control the weight as you slowly lower your arms back down."], repRange: "12-20 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Reverse Pec deck", group: "Shoulders", type: "Machine", instructions: ["Sit facing the machine, with your chest against the pad.","Set the handles to the rearmost position.","Grab the handles with a neutral or overhand grip.","Keeping your arms slightly bent, squeeze your shoulder blades together to pull the handles back.","Slowly return to the starting position."], repRange: "12-20 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Close Grip Lat Pulldown", group: "Back", type: "Machine", instructions: ["Sit at a lat pulldown machine and grab the bar with a close, underhand grip (palms facing you).","Keep your chest up and your back straight.","Pull the bar down to your upper chest, squeezing your back muscles.","Hold the contraction for a moment before slowly returning the bar to the starting position."], repRange: "8-12 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Chest Supported Rows", group: "Back", type: "Machine", instructions: ["Set up on a chest-supported row machine, with your chest firmly against the pad.","Grab the handles with a neutral or overhand grip.","Pull the handles towards your torso, squeezing your shoulder blades together.","Focus on using your back muscles, not your biceps.","Slowly extend your arms back to the starting position."], repRange: "8-12 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Seated Cable Rows", group: "Back", type: "Machine", instructions: ["Sit at a cable row machine with your feet on the platform and knees slightly bent.","Grab the handle with a neutral grip.","Keeping your back straight, pull the handle towards your lower abdomen.","Squeeze your back muscles at the peak of the movement.","Slowly return to the starting position."], repRange: "8-12 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Wide Grip Cable Rows", group: "Back", type: "Machine", instructions: ["Attach a long bar to the seated row machine.","Grab the bar with a wide, overhand grip.","Pull the bar towards your upper abdomen/lower chest, keeping your elbows flared out.","Focus on squeezing your upper back and rear delts.","Slowly return to the starting position."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Bayesian Cable Curls", group: "Biceps", type: "Machine", instructions: ["Stand facing a cable machine with the pulley set to the lowest position.","Hold a straight bar attachment with an underhand grip, hands shoulder-width apart.","Step back to create tension. Keep your elbows pinned to your sides.","Curl the bar up towards your chest, squeezing your biceps.","Slowly lower the bar back down."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Cable Hammer Curls", group: "Biceps", type: "Machine", instructions: ["Attach a rope handle to a low pulley on a cable machine.","Grab the rope with a neutral (hammer) grip, palms facing each other.","Keep your elbows close to your body and curl the rope up.","Squeeze your biceps and forearms at the top.","Slowly lower the rope back to the starting position."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Straight Bar Curl", group: "Forearms", type: "Barbell", instructions: ["Stand holding a barbell with an underhand grip, hands shoulder-width apart.","Keep your elbows close to your torso.","Curl the weight forward while contracting your biceps. Only your forearms should move.","Continue until your biceps are fully contracted and the bar is at shoulder level.","Slowly bring the barbell back to starting position."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Reverse Arm Curl", group: "Forearms", type: "Dumbbell", instructions: ["Stand holding a dumbbell in each hand with an overhand grip (palms facing down).","Keep your elbows close to your torso.","Curl the weight up, keeping your palms facing down. Focus on using your forearm muscles.","Slowly lower the dumbbells back to the starting position."], repRange: "12-20 reps", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Video+Demonstration", notes: "" }
            ];

            // --- UI ELEMENTS ---
            const ui = {
                workoutModal: document.getElementById('workout-modal'),
                modalTitle: document.getElementById('modal-title'),
                closeModalBtn: document.getElementById('close-modal-btn'),
                workoutLogForm: document.getElementById('workout-log-form'),
                setsContainer: document.getElementById('sets-container'),
                addSetBtn: document.getElementById('add-set-btn'),
                saveWorkoutBtn: document.getElementById('save-workout-btn'),
                confirmModal: document.getElementById('confirm-modal'),
                confirmModalTitle: document.getElementById('confirm-modal-title'),
                confirmModalText: document.getElementById('confirm-modal-text'),
                confirmModalCancelBtn: document.getElementById('confirm-modal-cancel-btn'),
                confirmModalConfirmBtn: document.getElementById('confirm-modal-confirm-btn'),
                alertModal: document.getElementById('alert-modal'),
                alertModalTitle: document.getElementById('alert-modal-title'),
                alertModalText: document.getElementById('alert-modal-text'),
                alertModalOkBtn: document.getElementById('alert-modal-ok-btn'),
                exerciseModal: document.getElementById('exercise-modal'),
                closeExerciseModalBtn: document.getElementById('close-exercise-modal-btn'),
                exerciseForm: document.getElementById('exercise-form'),
                exerciseModalTitle: document.getElementById('exercise-modal-title'),
                progressExerciseSelect: document.getElementById('progress-exercise-select'),
                clearHistoryBtn: document.getElementById('clear-history-btn'),
                addExerciseBtn: document.getElementById('add-exercise-btn'),
                aiAdviceExerciseSelect: document.getElementById('ai-advice-exercise-select'),
                getAIAdviceBtn: document.getElementById('get-ai-advice-btn'),
                aiAdviceOutput: document.getElementById('ai-advice-output'),
                exerciseDetailModal: document.getElementById('exercise-detail-modal'),
                closeExerciseDetailModalBtn: document.getElementById('close-exercise-detail-modal-btn'),
                exerciseDetailTitle: document.getElementById('exercise-detail-title'),
                exerciseDetailVideo: document.getElementById('exercise-detail-video'),
                exerciseDetailInstructions: document.getElementById('exercise-detail-instructions'),
                exerciseDetailRepRange: document.getElementById('exercise-detail-rep-range'),
                exerciseDetailNotes: document.getElementById('exercise-detail-notes'),
                saveExerciseNotesBtn: document.getElementById('save-exercise-notes-btn'),
                logFromDetailBtn: document.getElementById('log-from-detail-btn'),
                manageWarmupsBtn: document.getElementById('manage-warmups-btn'),
                warmupManageModal: document.getElementById('warmup-manage-modal'),
                closeWarmupManageModalBtn: document.getElementById('close-warmup-manage-modal-btn'),
                warmupDaySelect: document.getElementById('warmup-day-select'),
                warmupListDiv: document.getElementById('warmup-list'),
                warmupForm: document.getElementById('warmup-form'),
                warmupFormTitle: document.getElementById('warmup-form-title'),
                warmupNameInput: document.getElementById('warmup-name'),
                warmupInstructionsInput: document.getElementById('warmup-instructions'),
                saveWarmupBtn: document.getElementById('save-warmup-btn'),
                backToTodayBtn: document.getElementById('back-to-today-btn'),
                dayViewTitleBtn: document.getElementById('day-view-date-display-btn'),
                dayViewTitle: document.getElementById('day-view-title'),
                dayViewStatus: document.getElementById('day-view-status'),
                dayViewDateDisplay: document.getElementById('day-view-date-display-btn'),
                workoutPlanForDay: document.getElementById('workout-plan-for-day'),
                historyDayContent: document.getElementById('history-day-content'),
                workoutActionsBtn: document.getElementById('workout-actions-btn'),
                workoutActionsDropdown: document.getElementById('workout-actions-dropdown'),
                datePickerModal: document.getElementById('date-picker-modal'),
                modalCalendarGrid: document.getElementById('modal-calendar-grid'),
                modalMonthYearDisplay: document.getElementById('modal-month-year-display'),
                modalPrevMonthBtn: document.getElementById('modal-prev-month-btn'),
                modalNextMonthBtn: document.getElementById('modal-next-month-btn'),
                prevDayBtn: document.getElementById('prev-day-btn'),
                nextDayBtn: document.getElementById('next-day-btn'),
            };

            // --- CHART.JS SETUP ---
            Chart.defaults.color = '#FFFFFF';
            const progressCtx = document.getElementById('progress-chart').getContext('2d');
            let progressChart = new Chart(progressCtx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#FFFFFF' }, grid: { color: 'rgba(255, 255, 255, 0.2)' } },
                        x: { ticks: { color: '#FFFFFF' }, grid: { color: 'rgba(255, 255, 255, 0.2)' } }
                    },
                    plugins: { legend: { labels: { color: '#FFFFFF' } } }
                }
            });

            // --- CORE & HELPER FUNCTIONS ---
            const getApiUrl = (model, action = 'generateContent') => {
                const apiKey = ""; // Injected by environment
                return `https://generativelanguage.googleapis.com/v1beta/models/${model}:${action}?key=${apiKey}`;
            };
            
            function saveData() {
                localStorage.setItem('fitTrackAI_workoutHistory', JSON.stringify(workoutHistory));
                localStorage.setItem('fitTrackAI_exerciseDB', JSON.stringify(exerciseDB));
                localStorage.setItem('fitTrackAI_warmups', JSON.stringify(warmups));
            };
            
            function loadData() {
                workoutHistory = JSON.parse(localStorage.getItem('fitTrackAI_workoutHistory')) || [];
                exerciseDB = JSON.parse(localStorage.getItem('fitTrackAI_exerciseDB')) || JSON.parse(JSON.stringify(defaultExerciseDB));
                warmups = JSON.parse(localStorage.getItem('fitTrackAI_warmups')) || JSON.parse(JSON.stringify(defaultWarmups));
            }

            function showModal(modalElement) { modalElement.style.display = 'flex'; }
            function hideModal(modalElement) { modalElement.style.display = 'none'; }
            
            function showConfirmModal(title, text, onConfirm) {
                ui.confirmModalTitle.textContent = title;
                ui.confirmModalText.textContent = text;
                confirmCallback = onConfirm;
                showModal(ui.confirmModal);
            };

            function showCustomAlert(title, text) {
                ui.alertModalTitle.textContent = title;
                ui.alertModalText.textContent = text;
                showModal(ui.alertModal);
            };

            function updateUI() {
                updateDayView(viewDate);
                populateProgressSelect();
                renderProgressionChart(ui.progressExerciseSelect.value);
            }

            // --- WORKOUT SPECIFIC FUNCTIONS ---
            
            function openWorkoutModal(exerciseName) {
                editingWorkoutLogIndex = null;
                currentlyLoggingExercise = exerciseName;
                ui.modalTitle.textContent = `Log: ${exerciseName}`;
                ui.saveWorkoutBtn.textContent = 'Save Workout';
                ui.setsContainer.innerHTML = '';
                addSetRow();
                addSetRow();
                addSetRow();
                showModal(ui.workoutModal);
            };

            function addSetRow(setParts = [{weight: '', reps: '', partial: false}]) {
                const setNumber = ui.setsContainer.children.length + 1;
                const row = document.createElement('div');
                row.className = 'set-row border border-gray-800 p-3 rounded-lg space-y-2';
                
                row.innerHTML = `<div class="flex justify-between items-center"><label class="font-bold text-lg">Set ${setNumber}</label><div><button type="button" class="add-part-btn text-blue-400 hover:text-blue-300 p-1" title="Add drop set / pyramid"><i data-lucide="plus-circle" class="w-5 h-5"></i></button><button type="button" class="remove-set-btn text-red-500 hover:text-red-400 p-1" title="Delete set"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div></div><div class="parts-container space-y-2"></div>`;

                ui.setsContainer.appendChild(row);
                lucide.createIcons();
                
                const partsContainer = row.querySelector('.parts-container');
                setParts.forEach(part => addWeightRepPart(partsContainer, part.weight, part.reps, part.partial));

                row.querySelector('.add-part-btn').addEventListener('click', () => addWeightRepPart(partsContainer));
            };

            function addWeightRepPart(container, weight='', reps='', isPartial=false) {
                const partHtml = `<div class="set-part-row grid grid-cols-12 gap-2 items-center"><input type="number" step="0.25" min="0" placeholder="Weight (kg)" value="${weight}" class="form-input !py-2 col-span-5 set-weight"><span class="text-center col-span-1">x</span><input type="number" min="1" step="1" placeholder="Reps" value="${reps}" class="form-input !py-2 col-span-2 set-reps"><div class="col-span-3 flex items-center justify-center"><input type="checkbox" ${isPartial ? 'checked' : ''} class="form-checkbox h-5 w-5 bg-input-bg border-border-color rounded text-blue-500 focus:ring-blue-500 set-partial"><label class="ml-2 text-sm">Partial</label></div><button type="button" class="remove-part-btn text-gray-500 hover:text-red-400 p-1 col-span-1"><i data-lucide="x-circle" class="w-4 h-4"></i></button></div>`;
                container.insertAdjacentHTML('beforeend', partHtml);
                lucide.createIcons();
            };

            // --- CALENDAR & DAY VIEW FUNCTIONS ---
            function renderCalendar(container, date, isModal = false) {
                container.innerHTML = '';
                const year = date.getFullYear();
                const month = date.getMonth();
                const today = new Date();
                today.setHours(0,0,0,0);
                
                if(isModal) {
                    ui.modalMonthYearDisplay.textContent = `${date.toLocaleString('default', { month: 'long' })} ${year}`;
                }

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                const dayHeaders = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
                dayHeaders.forEach(day => {
                    const dayEl = document.createElement('div');
                    dayEl.textContent = day;
                    dayEl.className = 'font-bold text-secondary-text';
                    container.appendChild(dayEl);
                });

                const dayOffset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1; 

                for (let i = 0; i < dayOffset; i++) {
                    const emptyCell = document.createElement('div');
                    container.appendChild(emptyCell);
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    const dayDate = new Date(year, month, i);
                    dayEl.textContent = i;
                    dayEl.classList.add('calendar-day');
                    dayEl.dataset.date = dayDate.toISOString().split('T')[0];
                    
                    if (dayDate.getTime() === today.getTime()) dayEl.classList.add('is-today');
                    if (viewDate && dayDate.toDateString() === viewDate.toDateString()) dayEl.classList.add('is-selected');
                    if (dayDate > today) dayEl.classList.add('is-future');
                    
                    const hasWorkout = workoutHistory.some(log => new Date(log.date).toDateString() === dayDate.toDateString());
                    if (hasWorkout) dayEl.classList.add('has-workout');

                    container.appendChild(dayEl);
                }
            }

            function updateDayView(date) {
                viewDate = date; // Update central state
                renderWorkoutPlanForDate(date);
                renderHistoryForDate(date);
                ui.dayViewTitle.textContent = date.toLocaleDateString(undefined, { weekday: 'long' });
                ui.dayViewDateDisplay.textContent = date.toLocaleDateString(undefined, { month: 'long', day: 'numeric' });

                lucide.createIcons();
            }
            
            function renderWorkoutPlanForDate(date) {
                const schedule = [ { day: "Monday", type: "Push" }, { day: "Tuesday", type: "Pull" }, { day: "Wednesday", type: "Legs" }, { day: "Thursday", type: "Push" }, { day: "Friday", type: "Pull" }, { day: "Saturday", type: "Legs" }, { day: "Sunday", type: "Rest" }];
                const exerciseGroups = { "Push": ['Chest', 'Shoulders', 'Triceps'], "Pull": ['Back', 'Biceps', 'Forearms'], "Legs": ['Quads', 'Abductors', 'Glutes', 'Hamstrings',  'Calves', 'Abs'] };
                
                const dayIndex = (date.getDay() + 6) % 7;
                const item = schedule[dayIndex];
                
                const today = new Date();
                today.setHours(0,0,0,0);
                const isFutureDay = date > today;

                let exercisesHtml = '';
                if (item.type === 'Rest') {
                    exercisesHtml = `<div class="flex flex-col items-center justify-center h-full text-center p-4"><i data-lucide="bed-double" class="w-12 h-12 text-gray-500 mb-2"></i><p class="text-gray-500 italic mt-2">Rest Day</p></div>`;
                } else {
                    const groupsForDay = exerciseGroups[item.type];
                    const warmupExercises = warmups[item.type] || [];
                    
                    if (warmupExercises.length > 0) {
                        exercisesHtml += `<div><h5 class="font-semibold text-green-400 text-sm mb-1">Warm-up</h5><ul class="space-y-1">${warmupExercises.map(w => `<li class="text-base text-gray-300 exercise-item flex justify-between items-center group"><button class="flex-grow text-left p-1 rounded hover:bg-black/30 warmup-detail-btn" data-name="${w.name}" data-day-type="${item.type}">${w.name}</button><span class="exercise-item-controls items-center gap-1 pl-1"><button class="edit-warmup-btn p-1" data-name="${w.name}" data-day-type="${item.type}" title="Edit Warmup"><i data-lucide="pencil" class="w-4 h-4 text-gray-500 hover:text-yellow-400 pointer-events-none"></i></button><button class="delete-warmup-btn p-1" data-name="${w.name}" data-day-type="${item.type}" title="Delete Warmup"><i data-lucide="trash-2" class="w-4 h-4 text-gray-500 hover:text-red-500 pointer-events-none"></i></button></span></li>`).join('')}</ul></div>`;
                    }
                    
                    for(const group of groupsForDay) {
                        const exercisesForGroup = exerciseDB.filter(ex => ex.group === group);
                        if(exercisesForGroup.length > 0) {
                            exercisesHtml += `<div><h5 class="font-semibold text-blue-400 text-sm mb-1">${group}</h5><ul class="space-y-1">${exercisesForGroup.map(ex => `<li class="text-base text-gray-300 exercise-item flex justify-between items-center group"><button class="flex-grow text-left p-1 rounded hover:bg-black/30 log-workout-btn" data-name="${ex.name}" ${isFutureDay ? 'disabled' : ''}>${ex.name}</button><span class="exercise-item-controls items-center gap-1 pl-1"><button class="edit-exercise-btn p-1" data-name="${ex.name}" title="Edit Exercise"><i data-lucide="pencil" class="w-4 h-4 text-gray-500 hover:text-yellow-400 pointer-events-none"></i></button><button class="delete-exercise-btn p-1" data-name="${ex.name}" title="Delete Exercise"><i data-lucide="trash-2" class="w-4 h-4 text-gray-500 hover:text-red-500 pointer-events-none"></i></button></span></li>`).join('')}</ul></div>`;
                        }
                    }
                }
                ui.workoutPlanForDay.innerHTML = exercisesHtml;
            }

            function renderHistoryForDate(date) {
                const logsForDay = workoutHistory.filter(log => new Date(log.date.replace(/-/g, '/')).toDateString() === date.toDateString());

                if (logsForDay.length === 0) {
                    ui.historyDayContent.innerHTML = `<p class="text-secondary-text">No workouts logged.</p>`;
                    ui.dayViewStatus.textContent = '';
                    return;
                }

                ui.historyDayContent.innerHTML = logsForDay.map(log => {
                     const setsHtml = log.sets.map((setParts, i) => `<span><strong>Set ${i+1}:</strong> ${setParts.map(p => `${p.weight}kg x ${p.reps}r ${p.partial ? '(P)' : ''}`).join(', ')}</span>`).join('<br>');
                     return `<div class="bg-black/30 p-2 rounded-md"><strong class="text-primary-text">${log.name}</strong><div class="text-sm text-secondary-text mt-1">${setsHtml}</div></div>`;
                }).join('');

                const schedule = [ { day: "Monday", type: "Push" }, { day: "Tuesday", type: "Pull" }, { day: "Wednesday", type: "Legs" }, { day: "Thursday", type: "Push" }, { day: "Friday", type: "Pull" }, { day: "Saturday", type: "Legs" }, { day: "Sunday", type: "Rest" }];
                const exerciseGroups = { "Push": ['Chest', 'Shoulders', 'Triceps'], "Pull": ['Back', 'Biceps', 'Forearms'], "Legs": ['Quads', 'Abductors', 'Glutes', 'Hamstrings',  'Calves', 'Abs'] };

                const dayIndex = (date.getDay() + 6) % 7;
                const workoutType = schedule[dayIndex].type;

                if (workoutType !== 'Rest') {
                    const requiredGroups = exerciseGroups[workoutType];
                    
                    const loggedGroupCounts = {};
                    logsForDay.forEach(log => {
                        const exercise = exerciseDB.find(ex => ex.name === log.name);
                        if (exercise && exercise.group) {
                            if (!loggedGroupCounts[exercise.group]) {
                                loggedGroupCounts[exercise.group] = 0;
                            }
                            loggedGroupCounts[exercise.group]++;
                        }
                    });

                    let allDone = true;
                    if (requiredGroups.length === 0) {
                        allDone = false;
                    } else {
                        for (const group of requiredGroups) {
                            const loggedCount = loggedGroupCounts[group] || 0;
                            const requiredCount = (workoutType === 'Legs') ? 1 : 2;
                            
                            const exercisesInPlanForGroup = exerciseDB.filter(ex => ex.group === group).length;
                            if (exercisesInPlanForGroup > 0 && loggedCount < requiredCount) {
                                allDone = false;
                                break;
                            }
                        }
                    }

                    if (allDone) {
                        ui.dayViewStatus.textContent = "Complete";
                        ui.dayViewStatus.className = 'text-sm font-bold text-green-400';
                    } else {
                        ui.dayViewStatus.textContent = "Incomplete";
                        ui.dayViewStatus.className = 'text-sm font-bold text-yellow-400';
                    }
                } else {
                     ui.dayViewStatus.textContent = "Rest Day";
                     ui.dayViewStatus.className = 'text-sm font-bold text-secondary-text';
                }
            }


            // --- EVENT LISTENERS ---
            ui.addExerciseBtn.addEventListener('click', () => populateExerciseModal());
            ui.closeExerciseModalBtn.addEventListener('click', () => hideModal(ui.exerciseModal));
            ui.getAIAdviceBtn.addEventListener('click', getAIWorkoutAdvice);
            ui.closeModalBtn.addEventListener('click', () => hideModal(ui.workoutModal));
            ui.addSetBtn.addEventListener('click', () => addSetRow());
            ui.alertModalOkBtn.addEventListener('click', () => hideModal(ui.alertModal));
            ui.confirmModalCancelBtn.addEventListener('click', () => hideModal(ui.confirmModal));
            ui.confirmModalConfirmBtn.addEventListener('click', () => { if(confirmCallback) confirmCallback(); hideModal(ui.confirmModal); });
            ui.progressExerciseSelect.addEventListener('change', (e) => renderProgressionChart(e.target.value));
            
            function populateProgressSelect() {
                const exercisedNames = [...new Set(workoutHistory.map(log => log.name))].sort();
                const options = '<option value="">Select an exercise...</option>' + exercisedNames.map(name => `<option value="${name}">${name}</option>`).join('');
                ui.progressExerciseSelect.innerHTML = options;
                ui.aiAdviceExerciseSelect.innerHTML = options;
            };
            function renderProgressionChart(exerciseName) {
                if (!exerciseName) {
                    progressChart.data.labels = [];
                    progressChart.data.datasets = [];
                    progressChart.update();
                    return;
                }
                const exerciseLogs = workoutHistory.filter(log => log.name === exerciseName).sort((a,b) => new Date(a.date) - new Date(b.date));
                
                const labels = exerciseLogs.map(log => new Date(log.date.replace(/-/g, '/')).toLocaleDateString());
                const maxWeightData = exerciseLogs.map(log => Math.max(...log.sets.flatMap(set => set.map(s => s.weight || 0))));
                const volumeData = exerciseLogs.map(log => log.sets.flat().reduce((total, s) => total + (s.weight * s.reps), 0));

                progressChart.data.labels = labels;
                progressChart.data.datasets = [
                    { label: 'Max Weight (kg)', data: maxWeightData, borderColor: '#60a5fa', backgroundColor: '#60a5fa', tension: 0.1 },
                    { label: 'Total Volume (kg)', data: volumeData, borderColor: '#4ade80', backgroundColor: '#4ade80', tension: 0.1 }
                ];
                progressChart.update();
            };
            
            function openEditWorkoutModal(index) {
                editingWorkoutLogIndex = index;
                const logEntry = workoutHistory[index];
                currentlyLoggingExercise = logEntry.name;
                ui.modalTitle.textContent = `Edit: ${logEntry.name}`;
                ui.saveWorkoutBtn.textContent = 'Update Workout';
                ui.setsContainer.innerHTML = '';
                logEntry.sets.forEach(set => addSetRow(set));
                showModal(ui.workoutModal);
            };

             async function getAIWorkoutAdvice() {
                const exerciseName = ui.aiAdviceExerciseSelect.value;
                if (!exerciseName) {
                    ui.aiAdviceOutput.innerHTML = `<p class="text-yellow-400">Please select an exercise first.</p>`;
                    return;
                }

                const btn = ui.getAIAdviceBtn;
                btn.disabled = true;
                btn.querySelector('.btn-text').style.display = 'none';
                btn.querySelector('.loader').classList.remove('hidden');
                ui.aiAdviceOutput.innerHTML = '';

                const exerciseLogs = workoutHistory.filter(log => log.name === exerciseName).slice(-3);

                const prompt = `Act as an expert fitness coach grounded in science. A user has performed these recent sessions for ${exerciseName}:
                ${exerciseLogs.map((log, i) => `Session ${i+1} (${new Date(log.date.replace(/-/g, '/')).toLocaleDateString()}): ${log.sets.map(set => set.map(part => `${part.weight}kg x ${part.reps} reps`).join(' + ')).join(', ')}`).join('\n')}
                Based on progressive overload, give a clear, actionable recommendation for their *next* session. Be specific (e.g., "Aim for 6-8 reps with 52.5kg"). Keep it under 75 words.`;

                const apiUrl = getApiUrl('gemini-2.5-flash-preview-05-20');

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    let text = result.candidates[0].content.parts[0].text;
                    ui.aiAdviceOutput.innerHTML = `<p>${text}</p>`;
                } catch (error) {
                    console.error("AI Workout Advice Error:", error);
                    ui.aiAdviceOutput.innerHTML = `<p class="text-red-400">Could not get AI advice.</p>`;
                } finally {
                    btn.disabled = false;
                    btn.querySelector('.btn-text').style.display = 'inline';
                    btn.querySelector('.loader').classList.add('hidden');
                }
            }

            function openExerciseDetailModal(itemName, itemType, dayType = null) {
                let item;
                if (itemType === 'warmup') {
                    if (!dayType || !warmups[dayType]) return;
                    item = warmups[dayType].find(w => w.name === itemName);
                } else {
                    item = exerciseDB.find(ex => ex.name === itemName);
                }

                if (!item) return;
                currentlyLoggingExercise = item.name;
                ui.exerciseDetailTitle.textContent = item.name;
                ui.exerciseDetailVideo.src = item.videoPlaceholder || "https://placehold.co/400x225/111111/FFFFFF?text=No+Video";
                const instructions = Array.isArray(item.instructions) ? item.instructions : (item.instructions || "").split('\n');
                ui.exerciseDetailInstructions.innerHTML = instructions.map(step => `<li>${step}</li>`).join('');
                ui.exerciseDetailRepRange.textContent = item.repRange ? `Aim for ${item.repRange}.` : 'No specific rep range.';
                ui.exerciseDetailNotes.value = item.notes || '';
                ui.logFromDetailBtn.style.display = itemType === 'warmup' ? 'none' : 'block';
                showModal(ui.exerciseDetailModal);
            }
            
            function populateExerciseModal(exercise = null) {
                const groupSelect = document.getElementById('exercise-group');
                const muscleGroups = [...new Set(defaultExerciseDB.map(ex => ex.group))].sort();
                groupSelect.innerHTML = muscleGroups.map(g => `<option value="${g}">${g}</option>`).join('');
                if (exercise) {
                    ui.exerciseModalTitle.textContent = "Edit Exercise";
                    document.getElementById('exercise-name').value = exercise.name;
                    groupSelect.value = exercise.group;
                    document.getElementById('exercise-type').value = exercise.type;
                    editingExerciseName = exercise.name;
                } else {
                    ui.exerciseModalTitle.textContent = "Add New Exercise";
                    ui.exerciseForm.reset();
                    editingExerciseName = null;
                }
                showModal(ui.exerciseModal);
            };

            function renderWarmupManagementList() {
                const dayType = ui.warmupDaySelect.value;
                const currentWarmups = warmups[dayType] || [];
                ui.warmupListDiv.innerHTML = currentWarmups.map((warmup, index) => `<div class="flex justify-between items-center bg-black/30 p-2 rounded-md"><span>${warmup.name}</span><div class="flex gap-2"><button class="edit-warmup-btn p-1" data-index="${index}" data-day-type="${dayType}" title="Edit"><i data-lucide="pencil" class="w-4 h-4 text-gray-500 hover:text-yellow-400 pointer-events-none"></i></button><button class="delete-warmup-btn p-1" data-index="${index}" data-day-type="${dayType}" title="Delete"><i data-lucide="trash-2" class="w-4 h-4 text-gray-500 hover:text-red-500 pointer-events-none"></i></button></div></div>`).join('');
                lucide.createIcons();
            }

            // Event Listeners
            ui.workoutPlanForDay.addEventListener('click', (e) => {
                const logBtn = e.target.closest('.log-workout-btn'), editBtn = e.target.closest('.edit-exercise-btn'),
                      deleteBtn = e.target.closest('.delete-exercise-btn'), warmupBtn = e.target.closest('.warmup-detail-btn'),
                      editWarmupBtn = e.target.closest('.edit-warmup-btn'), deleteWarmupBtn = e.target.closest('.delete-warmup-btn');

                if (logBtn && !logBtn.disabled) openExerciseDetailModal(logBtn.dataset.name, 'exercise');
                else if (warmupBtn) openExerciseDetailModal(warmupBtn.dataset.name, 'warmup', warmupBtn.dataset.dayType);
                else if (editBtn) { const ex = exerciseDB.find(e => e.name === editBtn.dataset.name); if(ex) populateExerciseModal(ex); }
                else if (deleteBtn) { const name = deleteBtn.dataset.name; showConfirmModal('Delete Exercise?', `This will remove "${name}".`, () => { const i = exerciseDB.findIndex(ex => ex.name === name); if (i > -1) { exerciseDB.splice(i, 1); saveData(); updateUI(); } }); }
                else if (editWarmupBtn) { const day = editWarmupBtn.dataset.dayType, name = editWarmupBtn.dataset.name, i = warmups[day]?.findIndex(w => w.name === name); if(i > -1) { showModal(ui.warmupManageModal); ui.warmupDaySelect.value = day; renderWarmupManagementList(); editingWarmupIndex = i; ui.warmupNameInput.value = warmups[day][i].name; ui.warmupInstructionsInput.value = Array.isArray(warmups[day][i].instructions) ? warmups[day][i].instructions.join('\n') : ''; ui.warmupFormTitle.textContent = "Edit Warm-up"; ui.saveWarmupBtn.textContent = "Update"; } }
                else if (deleteWarmupBtn) { const day = deleteWarmupBtn.dataset.dayType, name = deleteWarmupBtn.dataset.name; showConfirmModal('Delete Warm-up?', `Delete "${name}"?`, () => { if(warmups[day]) { const i = warmups[day].findIndex(w => w.name === name); if (i > -1) { warmups[day].splice(i, 1); saveData(); updateUI(); }} }); }
            });
           
            ui.closeExerciseDetailModalBtn.addEventListener('click', () => hideModal(ui.exerciseDetailModal));
            ui.logFromDetailBtn.addEventListener('click', () => { hideModal(ui.exerciseDetailModal); openWorkoutModal(currentlyLoggingExercise); });
            ui.saveExerciseNotesBtn.addEventListener('click', () => { const ex = exerciseDB.find(e => e.name === currentlyLoggingExercise); if (ex) { ex.notes = ui.exerciseDetailNotes.value; saveData(); const btn = ui.saveExerciseNotesBtn; btn.textContent = 'Saved!'; setTimeout(() => { btn.textContent = 'Save Notes'; }, 2000); }});
            ui.manageWarmupsBtn.addEventListener('click', () => { editingWarmupIndex = null; ui.warmupForm.reset(); ui.warmupFormTitle.textContent = "Add New Warm-up"; ui.saveWarmupBtn.textContent = "Add"; renderWarmupManagementList(); showModal(ui.warmupManageModal); });
            ui.closeWarmupManageModalBtn.addEventListener('click', () => hideModal(ui.warmupManageModal));
            ui.warmupDaySelect.addEventListener('change', () => { editingWarmupIndex = null; ui.warmupForm.reset(); ui.warmupFormTitle.textContent = "Add"; ui.saveWarmupBtn.textContent = "Add"; renderWarmupManagementList(); });
            ui.warmupListDiv.addEventListener('click', (e) => { /* Logic handled by workoutPlanForDay listener */ });
            ui.warmupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const day = ui.warmupDaySelect.value, name = ui.warmupNameInput.value.trim(), instructions = ui.warmupInstructionsInput.value.split('\n').filter(l => l.trim() !== '');
                if (!name) return;
                const newWarmup = { name, instructions, repRange: "As needed", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=Warm-up" };
                if (!warmups[day]) warmups[day] = [];
                if (editingWarmupIndex !== null) { warmups[day][editingWarmupIndex] = newWarmup; } else { warmups[day].push(newWarmup); }
                saveData(); renderWarmupManagementList(); updateUI(); ui.warmupForm.reset(); editingWarmupIndex = null; ui.warmupFormTitle.textContent = "Add"; ui.saveWarmupBtn.textContent = "Add";
            });
            ui.exerciseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('exercise-name').value.trim(), group = document.getElementById('exercise-group').value, type = document.getElementById('exercise-type').value;
                if (!name || !group) return showCustomAlert('Error', 'Please enter a name and group.');
                if (editingExerciseName) {
                    const i = exerciseDB.findIndex(ex => ex.name === editingExerciseName);
                    if (i > -1) {
                        if (name.toLowerCase() !== editingExerciseName.toLowerCase() && exerciseDB.some(ex => ex.name.toLowerCase() === name.toLowerCase())) return showCustomAlert('Error', 'Name already exists.');
                        exerciseDB[i] = { ...exerciseDB[i], name, group, type };
                    }
                } else {
                    if (exerciseDB.some(ex => ex.name.toLowerCase() === name.toLowerCase())) return showCustomAlert('Error', 'Name already exists.');
                    exerciseDB.push({ name, group, type, instructions: ["No instructions added."], repRange: "N/A", videoPlaceholder: "https://placehold.co/400x225/111111/FFFFFF?text=No+Video", notes: "" });
                }
                editingExerciseName = null; hideModal(ui.exerciseModal); saveData(); updateUI();
            });
             ui.workoutLogForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const sets = [];
                let formIsValid = true;

                document.querySelectorAll('.set-row').forEach(row => {
                    row.querySelectorAll('.set-part-row').forEach(partRow => {
                        partRow.querySelectorAll('input').forEach(input => input.classList.remove('!border-red-500'));
                        const weightInput = partRow.querySelector('.set-weight');
                        const repsInput = partRow.querySelector('.set-reps');
                        const weight = parseFloat(weightInput.value);
                        const reps = parseFloat(repsInput.value);

                        let setPartIsValid = true;
                        if ( (isNaN(weight) || weight < 0) && (isNaN(reps) || reps < 1) ) return;
                        if (isNaN(weight) || weight < 0) {
                            weightInput.classList.add('!border-red-500');
                            setPartIsValid = false;
                        }
                        if (isNaN(reps) || reps < 1 || !Number.isInteger(reps) ) {
                             repsInput.classList.add('!border-red-500');
                             setPartIsValid = false;
                        }
                        if(!setPartIsValid) {
                            formIsValid = false;
                        }
                    });
                });

                if(!formIsValid){
                     showCustomAlert("Invalid Input", "Weight must be a positive number and reps must be a positive whole number.");
                     return;
                }
                
                document.querySelectorAll('.set-row').forEach(row => {
                    const setParts = [];
                     row.querySelectorAll('.set-part-row').forEach(partRow => {
                        const weight = parseFloat(partRow.querySelector('.set-weight').value) || 0;
                        const reps = parseInt(partRow.querySelector('.set-reps').value) || 0;
                        const partial = partRow.querySelector('.set-partial').checked;
                        if(reps > 0) setParts.push({ weight, reps, partial });
                    });
                    if (setParts.length > 0) sets.push(setParts);
                });

                if(sets.length === 0) return showCustomAlert('Empty Workout', 'Please log at least one valid set.');
                
                const year = viewDate.getFullYear();
                const month = String(viewDate.getMonth() + 1).padStart(2, '0');
                const day = String(viewDate.getDate()).padStart(2, '0');
                const dateString = `${year}-${month}-${day}`;

                const newLog = { name: currentlyLoggingExercise, date: dateString, sets: sets };
                workoutHistory.push(newLog);
                saveData(); updateUI(); hideModal(ui.workoutModal);
            });
            ui.setsContainer.addEventListener('click', (e) => {
                const removeSetBtn = e.target.closest('.remove-set-btn'), removePartBtn = e.target.closest('.remove-part-btn');
                if (removeSetBtn) { removeSetBtn.closest('.set-row').remove(); document.querySelectorAll('.set-row').forEach((row, index) => { row.querySelector('label').textContent = `Set ${index + 1}`; }); }
                else if (removePartBtn) { const partRow = removePartBtn.closest('.set-part-row'), partsContainer = partRow.parentElement; if (partsContainer.children.length > 1) { partRow.remove(); } else { showCustomAlert("Action blocked", "A set must have at least one part."); } }
            });
            ui.clearHistoryBtn.addEventListener('click', () => { showConfirmModal('Clear History?', 'This will delete all workout logs.', () => { workoutHistory = []; saveData(); updateUI(); }) });

            ui.backToTodayBtn.addEventListener('click', () => {
                viewDate = new Date();
                viewDate.setHours(0,0,0,0);
                updateUI();
                ui.workoutActionsDropdown.classList.add('hidden');
            });

            ui.prevDayBtn.addEventListener('click', () => {
                viewDate.setDate(viewDate.getDate() - 1);
                updateUI();
            });

            ui.nextDayBtn.addEventListener('click', () => {
                viewDate.setDate(viewDate.getDate() + 1);
                updateUI();
            });

            ui.workoutActionsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                ui.workoutActionsDropdown.classList.toggle('hidden');
            });

            document.addEventListener('click', (e) => {
                if (!ui.workoutActionsBtn.contains(e.target) && !ui.workoutActionsDropdown.contains(e.target)) {
                    ui.workoutActionsDropdown.classList.add('hidden');
                }
            });

            ui.dayViewDateDisplay.addEventListener('click', () => {
                modalCalendarDate = new Date(viewDate);
                renderCalendar(ui.modalCalendarGrid, modalCalendarDate, true);
                showModal(ui.datePickerModal);
            });
            ui.modalPrevMonthBtn.addEventListener('click', () => {
                modalCalendarDate.setMonth(modalCalendarDate.getMonth() - 1);
                renderCalendar(ui.modalCalendarGrid, modalCalendarDate, true);
            });

            ui.modalNextMonthBtn.addEventListener('click', () => {
                modalCalendarDate.setMonth(modalCalendarDate.getMonth() + 1);
                renderCalendar(ui.modalCalendarGrid, modalCalendarDate, true);
            });
            
            ui.modalCalendarGrid.addEventListener('click', (e) => {
                const dayEl = e.target.closest('.calendar-day');
                if (dayEl && dayEl.dataset.date) {
                    const newDate = new Date(dayEl.dataset.date.replace(/-/g, '/'));
                    viewDate = newDate;
                    updateUI();
                    hideModal(ui.datePickerModal);
                }
            });


            // --- INITIALIZATION ---
            loadData();
            updateUI();
        });
    </script>
</body>
</html>
