<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitTrack AI | Nutrition & Workout Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .nav-active {
            color: #3b82f6; /* blue-500 */
            border-bottom: 2px solid #3b82f6;
        }
        .page {
            display: none;
        }
        .page-active {
            display: block;
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal styles */
        .modal-backdrop {
            display: none;
            position: fixed;
            z-index: 50;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #1f2937; /* gray-800 */
            padding: 1.5rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        #total-calories:hover {
            cursor: pointer;
            background-color: #374151; /* gray-700 */
            border-radius: 0.375rem;
        }
        .star-rating > span {
            cursor: pointer;
            font-size: 2rem;
            color: #4b5563; /* gray-600 */
        }
         .star-rating > span.selected, .star-rating > span:hover, .star-rating > span:hover ~ span {
            color: #f59e0b; /* amber-500 */
        }
        #barcode-scanner-video {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
        }
        /* Custom scrollbar for workout planner exercises */
        .planner-exercises::-webkit-scrollbar {
            width: 6px;
        }
        .planner-exercises::-webkit-scrollbar-track {
            background: #374151; /* gray-700 */
            border-radius: 3px;
        }
        .planner-exercises::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 3px;
        }
        .planner-exercises::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        .exercise-item-controls {
            display: none;
        }
        .exercise-item:hover .exercise-item-controls {
            display: inline-flex;
        }
        .prose {
            color: #d1d5db;
        }
        .prose strong {
            color: #93c5fd;
        }
        .prose h3 {
            color: white;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div class="container mx-auto max-w-7xl p-4"> <!-- Increased max-width for weekly planner -->
        <!-- Header -->
        <header class="flex items-center justify-center text-center my-6">
             <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dumbbell text-blue-500 mr-3"><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m6 2 4 4"/><path d="m3 10.5 4.5-4.5"/><path d="m13.5 21 4.5-4.5"/></svg>
            <h1 class="text-3xl font-bold text-white">FitTrack AI</h1>
        </header>

        <!-- Navigation -->
        <nav class="flex justify-center border-b border-gray-700 mb-8">
            <button id="nav-nutrition" class="nav-btn py-4 px-6 text-lg font-medium text-gray-400 hover:text-blue-500 transition-colors nav-active">Nutrition</button>
            <button id="nav-workouts" class="nav-btn py-4 px-6 text-lg font-medium text-gray-400 hover:text-blue-500 transition-colors">Workouts</button>
            <button id="nav-goals" class="nav-btn py-4 px-6 text-lg font-medium text-gray-400 hover:text-blue-500 transition-colors">Goals</button>
            <button id="nav-sleep" class="nav-btn py-4 px-6 text-lg font-medium text-gray-400 hover:text-blue-500 transition-colors">Sleep</button>
        </nav>

        <!-- Main Content -->
        <main>
            <!-- Nutrition Page -->
            <div id="page-nutrition" class="page page-active">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-5xl mx-auto">
                    <!-- Left Column -->
                    <div class="space-y-8">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Log Your Meal</h2>
                            <form id="log-meal-form" class="space-y-4">
                                <div>
                                    <label for="food-name-input" class="block text-sm font-medium text-gray-400">Food Name</label>
                                    <input type="text" id="food-name-input" list="saved-foods-datalist" placeholder="e.g., Chicken Breast" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1 focus:ring-blue-500 focus:border-blue-500 text-white">
                                    <datalist id="saved-foods-datalist"></datalist>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="food-grams-input" class="block text-sm font-medium text-gray-400">Grams (g)</label>
                                        <input type="number" id="food-grams-input" placeholder="e.g., 150" value="100" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1 focus:ring-blue-500 focus:border-blue-500 text-white">
                                    </div>
                                    <div>
                                        <label for="food-servings-input" class="block text-sm font-medium text-gray-400">Servings</label>
                                        <input type="number" id="food-servings-input" value="1" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                     <div>
                                        <label for="food-calories-input" class="block text-sm font-medium text-gray-400">Calories (kcal)</label>
                                        <input type="number" step="0.1" id="food-calories-input" placeholder="per serving" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                                    </div>
                                    <div>
                                        <label for="food-protein-input" class="block text-sm font-medium text-gray-400">Protein (g)</label>
                                        <input type="number" step="0.1" id="food-protein-input" placeholder="per serving" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="food-carbs-input" class="block text-sm font-medium text-gray-400">Carbs (g)</label>
                                        <input type="number" step="0.1" id="food-carbs-input" placeholder="per serving" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                                    </div>
                                    <div>
                                        <label for="food-fat-input" class="block text-sm font-medium text-gray-400">Fat (g)</label>
                                        <input type="number" step="0.1" id="food-fat-input" placeholder="per serving" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                                    </div>
                                </div>

                                <button id="ai-get-macros-btn" type="button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-all duration-300 flex items-center justify-center">
                                    <span class="btn-text">Get Macros with AI</span>
                                    <div class="loader hidden ml-2"></div>
                                </button>
                                
                                <div class="flex gap-2 pt-2">
                                    <button id="add-food-btn" type="button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-all duration-300 flex items-center justify-center">
                                        <span class="btn-text">Add Food to Log</span>
                                    </button>
                                     <button id="scan-barcode-btn" type="button" class="p-2 bg-gray-600 hover:bg-gray-500 text-white rounded-md" title="Scan Barcode">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-scan-barcode"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M8 7v10"/><path d="M12 7v10"/><path d="M16 7v10"/></svg>
                                    </button>
                                </div>
                                <div id="add-food-error" class="text-red-400 text-sm mt-2 h-4"></div>
                            </form>
                        </div>
                         <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                             <div class="flex items-center justify-between">
                                <h2 class="text-2xl font-semibold">AI Meal Suggestions</h2>
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles text-yellow-400"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
                            </div>
                            <p class="text-gray-400 mb-2 mt-1 text-sm">Enter ingredients you have, and the AI will suggest a quick, easy-prep meal.</p>
                             <div>
                                <label for="ai-ingredients" class="block text-sm font-medium text-gray-400">Your Ingredients</label>
                                <textarea id="ai-ingredients" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" placeholder="e.g., chicken breast, rice, broccoli, olive oil"></textarea>
                            </div>
                            <button id="ai-suggestion-btn" class="w-full mt-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                                 <span class="btn-text">Generate Ideas</span>
                                 <div class="loader hidden ml-2"></div>
                            </button>
                            <div id="ai-suggestions-output" class="mt-4 space-y-3">
                            </div>
                        </div>
                    </div>
                    <!-- Right Column -->
                    <div class="space-y-8">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Today's Log</h2>
                            <div id="daily-log" class="space-y-2 max-h-60 overflow-y-auto">
                                <p class="text-gray-500">No food logged yet.</p>
                            </div>
                        </div>

                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Daily Summary</h2>
                            <div class="w-full h-40 flex items-center justify-center">
                                <canvas id="macro-chart"></canvas>
                            </div>
                            <div id="total-calories" class="text-center text-2xl font-bold mt-4 p-1" title="Click to edit daily calorie goal">0 / 2000 kcal</div>
                             <div class="space-y-4 mt-6">
                                <div>
                                     <div class="flex justify-between mb-1 text-sm font-medium">
                                         <span class="text-blue-400 font-bold">Protein</span>
                                         <span class="text-gray-400"><span id="total-protein">0</span>g / <span id="goal-protein">0</span>g</span>
                                     </div>
                                     <div class="w-full bg-gray-700 rounded-full h-2.5">
                                         <div id="protein-progress" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
                                     </div>
                                </div>
                                <div>
                                     <div class="flex justify-between mb-1 text-sm font-medium">
                                         <span class="text-green-400 font-bold">Carbs</span>
                                         <span class="text-gray-400"><span id="total-carbs">0</span>g / <span id="goal-carbs">0</span>g</span>
                                     </div>
                                     <div class="w-full bg-gray-700 rounded-full h-2.5">
                                         <div id="carb-progress" class="bg-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                                     </div>
                                </div>
                                <div>
                                     <div class="flex justify-between mb-1 text-sm font-medium">
                                         <span class="text-red-400 font-bold">Fat</span>
                                         <span class="text-gray-400"><span id="total-fat">0</span>g / <span id="goal-fat">0</span>g</span>
                                     </div>
                                     <div class="w-full bg-gray-700 rounded-full h-2.5">
                                         <div id="fat-progress" class="bg-red-500 h-2.5 rounded-full" style="width: 0%"></div>
                                     </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workouts Page -->
            <div id="page-workouts" class="page">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold">Your Workout Plan</h2>
                    <p class="text-gray-400 mt-2">Push, Pull, Legs split. Log your sessions and track your progress.</p>
                </div>
                
                 <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-semibold text-center flex-grow">This Week's Schedule</h3>
                        <button id="add-exercise-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md flex items-center gap-2">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                           Add Exercise
                        </button>
                    </div>
                    <div id="workout-planner" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-7 gap-4">
                        <!-- Planner will be injected here by JS -->
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg lg:col-span-2">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                            <h3 class="text-2xl font-semibold mb-4 sm:mb-0">Progression Chart</h3>
                            <select id="progress-exercise-select" class="w-full sm:w-auto bg-gray-700 border border-gray-600 rounded-md p-2">
                                <option value="">Select an exercise to see progress</option>
                            </select>
                        </div>
                        <div class="w-full h-80 flex items-center justify-center">
                            <canvas id="progress-chart"></canvas>
                        </div>
                    </div>
                     <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                           <h3 class="text-2xl font-semibold">Workout History</h3>
                           <button id="clear-history-btn" class="text-sm bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-md">Clear History</button>
                        </div>
                        <div id="workout-history" class="space-y-4 max-h-[22.5rem] overflow-y-auto"></div>
                    </div>
                </div>

                 <div class="bg-gray-800 p-6 rounded-lg shadow-lg mt-8">
                    <h3 class="text-2xl font-semibold mb-4 text-center">AI Coach: Weekly Volume & Progression</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h4 class="font-bold text-lg text-blue-400 mb-2">Weekly Volume Analysis</h4>
                            <div id="volume-analysis" class="space-y-2">
                                <p class="text-gray-400">Log some workouts to see your weekly volume analysis.</p>
                            </div>
                        </div>
                        <div>
                             <h4 class="font-bold text-lg text-blue-400 mb-2">Progression Advice</h4>
                             <p class="text-gray-400 text-sm mb-3">Select an exercise to get science-based advice on when to add weight or reps.</p>
                             <div class="flex gap-2">
                                <select id="ai-advice-exercise-select" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                                    <option value="">Select an exercise...</option>
                                </select>
                                <button id="get-ai-advice-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center">
                                    <span class="btn-text">Get Advice</span>
                                     <div class="loader hidden ml-2"></div>
                                </button>
                             </div>
                             <div id="ai-advice-output" class="mt-4 p-3 bg-gray-900 rounded-md text-sm"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Goals Page -->
            <div id="page-goals" class="page">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-5xl mx-auto">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-semibold mb-4">Your Profile</h2>
                        <form id="profile-form" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="age" class="block text-sm font-medium text-gray-400">Age</label><input type="number" id="age" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                                <div><label for="gender" class="block text-sm font-medium text-gray-400">Gender</label><select id="gender" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"><option value="male">Male</option><option value="female">Female</option></select></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="height" class="block text-sm font-medium text-gray-400">Height (cm)</label><input type="number" id="height" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                                <div><label for="weight" class="block text-sm font-medium text-gray-400">Weight (kg)</label><input type="number" id="weight" step="0.1" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                            </div>
                             <div><label for="body-fat" class="block text-sm font-medium text-gray-400">Body Fat % (Optional)</label><input type="number" id="body-fat" step="0.1" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"></div>
                            <div>
                                <label for="activity-level" class="block text-sm font-medium text-gray-400">Activity Level</label>
                                <select id="activity-level" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                                    <option value="1.2">Sedentary</option><option value="1.375">Lightly active</option><option value="1.55">Moderately active</option><option value="1.725">Very active</option><option value="1.9">Extra active</option>
                                </select>
                            </div>
                            <div>
                                <label for="user-goal" class="block text-sm font-medium text-gray-400">Your Goal</label>
                                <select id="user-goal" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                                    <option value="lose">Lose Fat</option>
                                    <option value="maintain">Maintain Weight</option>
                                    <option value="gain">Gain Muscle</option>
                                    <option value="recomposition" selected>Recomposition (Fat Loss, Muscle Gain)</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Save & Calculate Goals</button>
                        </form>
                        <div class="mt-6 space-y-2">
                             <div class="flex items-center justify-center gap-2">
                                <label for="bmr-input" class="font-bold text-gray-300">BMR:</label>
                                <input type="number" id="bmr-input" class="bg-gray-700 border border-gray-600 rounded-md p-1 w-24 text-center">
                                <span class="text-gray-400">kcal</span>
                            </div>
                             <div class="flex items-center justify-center gap-2 mt-2">
                                <label for="bmi-input" class="font-bold text-gray-300">BMI:</label>
                                <input type="number" step="0.1" id="bmi-input" class="bg-gray-700 border border-gray-600 rounded-md p-1 w-24 text-center">
                            </div>
                        </div>
                    </div>
                    <div class="space-y-8">
                         <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Data Management</h2>
                            <p class="text-sm text-gray-400 mb-4">Save your data to a file to transfer between devices or create a backup.</p>
                            <div class="flex gap-4">
                                <button id="backup-data-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Backup Data</button>
                                <label for="restore-data-input" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md text-center cursor-pointer">
                                    Restore Data
                                </label>
                                <input type="file" id="restore-data-input" class="hidden" accept=".json">
                            </div>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                             <h2 class="text-2xl font-semibold mb-4">Weight Progression</h2>
                            <div class="w-full h-64 flex items-center justify-center">
                                <canvas id="weight-chart"></canvas>
                            </div>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">AI Adaptive Calorie Plan</h2>
                            <div id="calorie-plan-output" class="text-gray-300"><p>Please fill out your profile to generate a plan.</p></div>
                        </div>
                         <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Daily Check-in</h2>
                            <p class="text-gray-400 text-sm mb-4">Log your weight daily to help the AI adapt your calorie goals for better results.</p>
                            <form id="check-in-form" class="flex gap-4">
                                <input type="number" step="0.1" id="check-in-weight" placeholder="Current weight (kg)" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                                <button type="submit" id="check-in-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center">
                                    <span class="btn-text">Check In</span>
                                    <div class="loader hidden ml-2"></div>
                                </button>
                            </form>
                            <div id="check-in-feedback" class="mt-4 text-sm"></div>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">InBody Scan Analysis</h2>
                            <p class="text-gray-400 text-sm mb-4">Enter your monthly InBody scan data for a deep AI analysis and plan adjustment.</p>
                            <button id="open-inbody-modal-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md">Enter InBody Scan Data</button>
                        </div>
                    </div>
                </div>
            </div>
            
             <!-- Sleep Page -->
            <div id="page-sleep" class="page">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-5xl mx-auto">
                    <div class="space-y-8">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Sleep Cycle Calculator</h2>
                            <p class="text-gray-400 mb-4">If you go to bed right now, you should aim to wake up at one of the following times for the best results:</p>
                            <div id="sleep-wake-times" class="grid grid-cols-2 sm:grid-cols-3 gap-3 text-center">
                                <!-- Wake up times will be injected here -->
                            </div>
                            <p class="text-xs text-gray-500 mt-4">Calculations are based on 90-minute sleep cycles and an average of 14 minutes to fall asleep.</p>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Log Your Sleep</h2>
                            <form id="sleep-log-form" class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="sleep-start-time" class="block text-sm font-medium text-gray-400">Went to bed</label><input type="time" id="sleep-start-time" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                                    <div><label for="sleep-end-time" class="block text-sm font-medium text-gray-400">Woke up</label><input type="time" id="sleep-end-time" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Sleep Quality</label>
                                    <div id="sleep-quality-rating" class="star-rating flex flex-row-reverse justify-end items-center">
                                        <span data-value="5">&starf;</span><span data-value="4">&starf;</span><span data-value="3">&starf;</span><span data-value="2">&starf;</span><span data-value="1">&starf;</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="sleep-notes" class="block text-sm font-medium text-gray-400">Notes</label>
                                    <textarea id="sleep-notes" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" placeholder="e.g., Meditated before bed, drank coffee late, etc."></textarea>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Log Sleep</button>
                            </form>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-semibold mb-4">Sleep History</h2>
                        <div id="sleep-history" class="space-y-4 max-h-[40rem] overflow-y-auto">
                            <p class="text-gray-500">No sleep logged yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="workout-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h2 id="modal-title" class="text-2xl font-bold">Log Exercise</h2><button id="close-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
            <form id="workout-log-form"><div class="space-y-4"><div id="sets-container"></div><button type="button" id="add-set-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Add Set</button><button type="submit" id="save-workout-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md mt-2">Save Workout</button></div></form>
        </div>
    </div>
    
    <div id="edit-sleep-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Edit Sleep Log</h2><button id="close-edit-sleep-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
            <form id="edit-sleep-log-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="edit-sleep-start-time" class="block text-sm font-medium text-gray-400">Went to bed</label><input type="time" id="edit-sleep-start-time" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                    <div><label for="edit-sleep-end-time" class="block text-sm font-medium text-gray-400">Woke up</label><input type="time" id="edit-sleep-end-time" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Sleep Quality</label>
                    <div id="edit-sleep-quality-rating" class="star-rating flex flex-row-reverse justify-end items-center">
                        <span data-value="5">&starf;</span><span data-value="4">&starf;</span><span data-value="3">&starf;</span><span data-value="2">&starf;</span><span data-value="1">&starf;</span>
                    </div>
                </div>
                <div>
                    <label for="edit-sleep-notes" class="block text-sm font-medium text-gray-400">Notes</label>
                    <textarea id="edit-sleep-notes" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Update Sleep</button>
            </form>
        </div>
    </div>

    <div id="inbody-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">InBody 570 Scan Data</h2><button id="close-inbody-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
            <form id="inbody-form" class="space-y-3">
                 <div class="grid grid-cols-2 gap-3">
                    <div><label for="inbody-weight" class="text-sm">Weight (kg)</label><input type="number" step="0.1" id="inbody-weight" class="w-full bg-gray-700 p-2 rounded-md mt-1" required></div>
                    <div><label for="inbody-smm" class="text-sm">Skeletal Muscle Mass (kg)</label><input type="number" step="0.1" id="inbody-smm" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                    <div><label for="inbody-bfm" class="text-sm">Body Fat Mass (kg)</label><input type="number" step="0.1" id="inbody-bfm" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                    <div><label for="inbody-pbf" class="text-sm">Percent Body Fat (%)</label><input type="number" step="0.1" id="inbody-pbf" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                 </div>
                 <button type="submit" id="analyze-inbody-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center">
                    <span class="btn-text">Analyze & Update Plan</span>
                    <div class="loader hidden ml-2"></div>
                </button>
            </form>
        </div>
    </div>
    
     <div id="barcode-scanner-modal" class="modal-backdrop">
        <div class="modal-content">
             <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Scan Food Barcode</h2><button id="close-barcode-scanner-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
             <div id="barcode-scanner-container" class="w-full aspect-square bg-gray-900 rounded-lg overflow-hidden">
                <div id="barcode-reader" class="w-full h-full"></div>
             </div>
             <p id="barcode-scanner-status" class="text-center text-sm text-gray-400 mt-3 h-5"></p>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 id="confirm-modal-title" class="text-xl font-bold mb-4">Are you sure?</h2>
            <p id="confirm-modal-text" class="text-gray-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Cancel</button>
                <button id="confirm-modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Delete</button>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 id="alert-modal-title" class="text-xl font-bold mb-4">Alert</h2>
            <p id="alert-modal-text" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end">
                <button id="alert-modal-ok-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">OK</button>
            </div>
        </div>
    </div>

    <div id="exercise-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h2 id="exercise-modal-title" class="text-2xl font-bold">Add Exercise</h2><button id="close-exercise-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
            <form id="exercise-form" class="space-y-4">
                <div>
                    <label for="exercise-name" class="block text-sm font-medium text-gray-400">Exercise Name</label>
                    <input type="text" id="exercise-name" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required>
                </div>
                <div>
                    <label for="exercise-group" class="block text-sm font-medium text-gray-400">Muscle Group</label>
                    <select id="exercise-group" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div>
                    <label for="exercise-type" class="block text-sm font-medium text-gray-400">Equipment Type</label>
                    <select id="exercise-type" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                         <option>Barbell</option>
                         <option>Dumbbell</option>
                         <option>Machine</option>
                         <option>Bodyweight</option>
                    </select>
                </div>
                <button type="submit" id="save-exercise-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Save Exercise</button>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let dailyLog = [];
            let goals = { calories: 2000, protein: 150, carbs: 225, fat: 60 };
            let userProfile = { weightHistory: [], inbodyHistory: [], sleepHistory: [] };
            let workoutHistory = [];
            let exerciseDB = [];
            let savedFoods = [];
            let currentlyLoggingExercise = null;
            let editingWorkoutLogIndex = null;
            let editingSleepLogIndex = null;
            let editingExerciseName = null;
            let editingFoodLogIndex = null;
            let barcodeScanner = null;

            // --- DATABASES ---
            const defaultExerciseDB = [
                // Chest (Push)
                { name: "Flat Press", group: "Chest", type: "Barbell" },
                { name: "Incline Press", group: "Chest", type: "Dumbbell" },
                { name: "Chest Fly", group: "Chest", type: "Machine" },
                
                // Back (Pull)
                { name: "Pull-ups", group: "Back", type: "Bodyweight" },
                { name: "Lat Pulldowns", group: "Back", type: "Machine" },
                { name: "Rows", group: "Back", type: "Barbell" },
                { name: "Deadlifts", group: "Back", type: "Barbell" },
                { name: "Flexion Rows", group: "Back", type: "Dumbbell" },
                { name: "Pullovers", group: "Back", type: "Machine" },

                // Biceps (Pull)
                { name: "Bayesian Cable Curls", group: "Biceps", type: "Machine" },
                { name: "Incline Cable Curls", group: "Biceps", type: "Machine" },
                { name: "Preacher Curls", group: "Biceps", type: "Machine" },
                { name: "Regular Curls", group: "Biceps", type: "Dumbbell" },

                // Triceps (Push)
                { name: "Overhead Extensions", group: "Triceps", type: "Dumbbell" },
                { name: "Cable Pushdowns", group: "Triceps", type: "Machine" },
                { name: "Close Grip Pressing", group: "Triceps", type: "Barbell" },
                { name: "Dips", group: "Triceps", type: "Bodyweight" },

                // Shoulders (Push)
                { name: "Dumbbell Lateral Raises", group: "Shoulders", type: "Dumbbell" },
                { name: "Upright Rows", group: "Shoulders", type: "Barbell" },
                { name: "Cable Lateral Raises", group: "Shoulders", type: "Machine" },

                // Calves (Legs)
                { name: "Straight Leg Calf Raises", group: "Calves", type: "Machine" },
                
                // Quads (Legs)
                { name: "Barbell Squats", group: "Quads", type: "Barbell" },
                { name: "Smith Machine Squats", group: "Quads", type: "Machine" },
                { name: "Leg Press", group: "Quads", type: "Machine" },
                { name: "Hack Squats", group: "Quads", type: "Machine" },
                { name: "Leg Extensions", group: "Quads", type: "Machine" },

                // Hamstrings (Legs)
                { name: "Stiff Legged Deadlift", group: "Hamstrings", type: "Barbell" },
                { name: "Lying Leg Curls", group: "Hamstrings", type: "Machine" },
                { name: "Seated Leg Curls", group: "Hamstrings", type: "Machine" },

                // Glutes (Legs)
                { name: "Front Foot Elevated Lunges", group: "Glutes", type: "Dumbbell" },
                { name: "Hip Thrust", group: "Glutes", type: "Barbell" },
                { name: "Deep Squats (Sumo)", group: "Glutes", type: "Barbell" },
                
                // Abs (Pull)
                { name: "Ab Crunch Machine", group: "Abs", type: "Machine" },
                { name: "Cable Crunches", group: "Abs", type: "Machine" },
                { name: "Captain's Chair Leg Raise", group: "Abs", type: "Machine" },
                
                // Forearms (Push)
                { name: "Dumbbell Wrist Curls", group: "Forearms", type: "Dumbbell"},
                { name: "Dumbbell Reverse Wrist Curls", group: "Forearms", type: "Dumbbell"}
            ];

            // --- UI ELEMENTS ---
            const navNutrition = document.getElementById('nav-nutrition'), navWorkouts = document.getElementById('nav-workouts'), navGoals = document.getElementById('nav-goals'), navSleep = document.getElementById('nav-sleep'),
                pageNutrition = document.getElementById('page-nutrition'), pageWorkouts = document.getElementById('page-workouts'), pageGoals = document.getElementById('page-goals'), pageSleep = document.getElementById('page-sleep'),
                logMealForm = document.getElementById('log-meal-form'), foodNameInput = document.getElementById('food-name-input'), foodGramsInput = document.getElementById('food-grams-input'), addFoodBtn = document.getElementById('add-food-btn'),
                addFoodError = document.getElementById('add-food-error'), dailyLogDiv = document.getElementById('daily-log'), totalCaloriesEl = document.getElementById('total-calories'),
                totalProteinEl = document.getElementById('total-protein'), totalCarbsEl = document.getElementById('total-carbs'), totalFatEl = document.getElementById('total-fat'),
                aiSuggestionBtn = document.getElementById('ai-suggestion-btn'), aiSuggestionsOutput = document.getElementById('ai-suggestions-output'),
                aiGetMacrosBtn = document.getElementById('ai-get-macros-btn'),
                workoutHistoryDiv = document.getElementById('workout-history'), profileForm = document.getElementById('profile-form'),
                caloriePlanOutput = document.getElementById('calorie-plan-output'), checkInForm = document.getElementById('check-in-form'), checkInBtn = document.getElementById('check-in-btn'), checkInFeedback = document.getElementById('check-in-feedback'),
                bmrInput = document.getElementById('bmr-input'), bmiInput = document.getElementById('bmi-input'), workoutModal = document.getElementById('workout-modal'),
                modalTitle = document.getElementById('modal-title'), closeModalBtn = document.getElementById('close-modal-btn'), workoutLogForm = document.getElementById('workout-log-form'),
                setsContainer = document.getElementById('sets-container'), addSetBtn = document.getElementById('add-set-btn'), saveWorkoutBtn = document.getElementById('save-workout-btn'),
                openInBodyModalBtn = document.getElementById('open-inbody-modal-btn'), inbodyModal = document.getElementById('inbody-modal'),
                closeInbodyModalBtn = document.getElementById('close-inbody-modal-btn'), inbodyForm = document.getElementById('inbody-form'), analyzeInbodyBtn = document.getElementById('analyze-inbody-btn'),
                confirmModal = document.getElementById('confirm-modal'), confirmModalTitle = document.getElementById('confirm-modal-title'), confirmModalText = document.getElementById('confirm-modal-text'),
                confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn'), confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn'),
                alertModal = document.getElementById('alert-modal'), alertModalTitle = document.getElementById('alert-modal-title'), alertModalText = document.getElementById('alert-modal-text'), alertModalOkBtn = document.getElementById('alert-modal-ok-btn'),
                exerciseModal = document.getElementById('exercise-modal'), closeExerciseModalBtn = document.getElementById('close-exercise-modal-btn'), exerciseForm = document.getElementById('exercise-form'), exerciseModalTitle = document.getElementById('exercise-modal-title'),
                sleepWakeTimesDiv = document.getElementById('sleep-wake-times'), sleepLogForm = document.getElementById('sleep-log-form'), sleepQualityRatingDiv = document.getElementById('sleep-quality-rating'),
                sleepHistoryDiv = document.getElementById('sleep-history'), progressExerciseSelect = document.getElementById('progress-exercise-select'),
                editSleepModal = document.getElementById('edit-sleep-modal'), closeEditSleepModalBtn = document.getElementById('close-edit-sleep-modal-btn'), editSleepLogForm = document.getElementById('edit-sleep-log-form'), editSleepQualityRatingDiv = document.getElementById('edit-sleep-quality-rating'),
                scanBarcodeBtn = document.getElementById('scan-barcode-btn'), barcodeScannerModal = document.getElementById('barcode-scanner-modal'), closeBarcodeScannerModalBtn = document.getElementById('close-barcode-scanner-modal-btn'),
                barcodeReaderDiv = document.getElementById('barcode-reader'), barcodeScannerStatus = document.getElementById('barcode-scanner-status'),
                weightChartCanvas = document.getElementById('weight-chart'), workoutPlannerDiv = document.getElementById('workout-planner'), clearHistoryBtn = document.getElementById('clear-history-btn'),
                addExerciseBtn = document.getElementById('add-exercise-btn'),
                volumeAnalysisDiv = document.getElementById('volume-analysis'),
                aiAdviceExerciseSelect = document.getElementById('ai-advice-exercise-select'),
                getAIAdviceBtn = document.getElementById('get-ai-advice-btn'),
                aiAdviceOutput = document.getElementById('ai-advice-output'),
                backupDataBtn = document.getElementById('backup-data-btn'),
                restoreDataInput = document.getElementById('restore-data-input');

            let confirmCallback = null;
            
            // --- CHART.JS SETUP ---
            const macroCtx = document.getElementById('macro-chart').getContext('2d');
            let macroChart = new Chart(macroCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Protein', 'Carbs', 'Fat'],
                    datasets: [{
                        data: [1, 1, 1],
                        backgroundColor: ['#60a5fa', '#4ade80', '#f87171'],
                        borderColor: '#1f2937',
                        borderWidth: 4,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                           display: false
                        }
                    }
                }
            });

            const progressCtx = document.getElementById('progress-chart').getContext('2d');
            let progressChart = new Chart(progressCtx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#d1d5db' }, grid: { color: '#374151' } },
                        x: { ticks: { color: '#d1d5db' }, grid: { color: '#374151' } }
                    },
                    plugins: { legend: { labels: { color: '#d1d5db' } } }
                }
            });
            
            const weightCtx = weightChartCanvas.getContext('2d');
            let weightChart = new Chart(weightCtx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { ticks: { color: '#d1d5db' }, grid: { color: '#374151' } },
                        x: { ticks: { color: '#d1d5db' }, grid: { color: '#374151' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // --- ALL FUNCTIONS (defined with `function` for hoisting) ---
            
            function getApiUrl(model, action = 'generateContent') {
                const apiKey = "AIzaSyDY48xF1byvU05kS9qKvN8iyrIR3hheP8w"; // IMPORTANT: Replace with your actual API key for local use
                let baseUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:${action}`;
                if (apiKey) {
                    baseUrl += `?key=${apiKey}`;
                }
                return baseUrl;
            };
            
            function saveData() {
                localStorage.setItem('fitTrackAI_dailyLog', JSON.stringify(dailyLog));
                localStorage.setItem('fitTrackAI_userProfile', JSON.stringify(userProfile));
                localStorage.setItem('fitTrackAI_workoutHistory', JSON.stringify(workoutHistory));
                localStorage.setItem('fitTrackAI_exerciseDB', JSON.stringify(exerciseDB));
                localStorage.setItem('fitTrackAI_savedFoods', JSON.stringify(savedFoods));
                localStorage.setItem('fitTrackAI_goals', JSON.stringify(goals));
            };
            
            function loadData() {
                const savedLog = localStorage.getItem('fitTrackAI_dailyLog');
                const savedProfile = localStorage.getItem('fitTrackAI_userProfile');
                const savedHistory = localStorage.getItem('fitTrackAI_workoutHistory');
                const savedExerciseDB = localStorage.getItem('fitTrackAI_exerciseDB');
                const savedFoodsData = localStorage.getItem('fitTrackAI_savedFoods');
                const savedGoals = localStorage.getItem('fitTrackAI_goals');

                if (savedLog) dailyLog = JSON.parse(savedLog);
                if (savedProfile) {
                    userProfile = JSON.parse(savedProfile);
                }
                 if (savedGoals) {
                    goals = JSON.parse(savedGoals);
                } else if (userProfile.calorieTarget) { // Fallback for older data structure
                    goals.calories = userProfile.calorieTarget;
                }
                if (savedHistory) workoutHistory = JSON.parse(savedHistory);
                
                exerciseDB = savedExerciseDB ? JSON.parse(savedExerciseDB) : defaultExerciseDB;
                savedFoods = savedFoodsData ? JSON.parse(savedFoodsData) : [];

                if (!userProfile) userProfile = {};
                if (!userProfile.weightHistory) userProfile.weightHistory = [];
                if (!userProfile.inbodyHistory) userProfile.inbodyHistory = [];
                if (!userProfile.sleepHistory) userProfile.sleepHistory = [];
            }

            function updateSummary() {
                 const totals = dailyLog.reduce((acc, item) => ({
                    calories: acc.calories + item.calories, protein: acc.protein + item.protein, carbs: acc.carbs + item.carbs, fat: acc.fat + item.fat
                }), { calories: 0, protein: 0, carbs: 0, fat: 0 });

                totalCaloriesEl.innerHTML = `<span id="current-cals">${Math.round(totals.calories)}</span> / <span id="goal-cals">${Math.round(goals.calories)}</span> kcal`;
                
                totalProteinEl.textContent = Math.round(totals.protein);
                totalCarbsEl.textContent = Math.round(totals.carbs);
                totalFatEl.textContent = Math.round(totals.fat);

                document.getElementById('goal-protein').textContent = Math.round(goals.protein);
                document.getElementById('goal-carbs').textContent = Math.round(goals.carbs);
                document.getElementById('goal-fat').textContent = Math.round(goals.fat);

                const proteinPercent = goals.protein > 0 ? Math.min(100, (totals.protein / goals.protein) * 100) : 0;
                const carbPercent = goals.carbs > 0 ? Math.min(100, (totals.carbs / goals.carbs) * 100) : 0;
                const fatPercent = goals.fat > 0 ? Math.min(100, (totals.fat / goals.fat) * 100) : 0;

                document.getElementById('protein-progress').style.width = `${proteinPercent}%`;
                document.getElementById('carb-progress').style.width = `${carbPercent}%`;
                document.getElementById('fat-progress').style.width = `${fatPercent}%`;
                
                const macroSum = totals.protein + totals.carbs + totals.fat;
                if(macroSum > 0) {
                    macroChart.data.datasets[0].data = [totals.protein, totals.carbs, totals.fat];
                } else {
                    macroChart.data.datasets[0].data = [1, 1, 1];
                }
                macroChart.update();
            };
            function renderDailyLog() {
                 if (dailyLog.length === 0) {
                    dailyLogDiv.innerHTML = '<p class="text-gray-500">No food logged yet.</p>';
                    return;
                }
                dailyLogDiv.innerHTML = dailyLog.map((item, index) => `
                    <div class="flex justify-between items-center bg-gray-700 p-2 rounded-md">
                        <div>
                            <span>${item.name} (${item.grams}g)</span>
                        </div>
                        <div class="flex items-center gap-2">
                           <span class="text-sm text-gray-400">${Math.round(item.calories)} kcal</span>
                           <button class="edit-food-btn p-1 hover:bg-gray-600 rounded" data-index="${index}" title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil text-gray-400 hover:text-yellow-400"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                           </button>
                           <button class="remove-item-btn text-red-500 hover:text-red-400" data-index="${index}" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                           </button>
                        </div>
                    </div>
                `).join('');
            };

            function populateSavedFoodsDatalist() {
                const datalist = document.getElementById('saved-foods-datalist');
                datalist.innerHTML = savedFoods.map(food => `<option value="${food.name}"></option>`).join('');
            };

            function autoPopulateMacros() {
                const foodName = foodNameInput.value;
                const grams = parseFloat(foodGramsInput.value) || 100;
                const foundFood = savedFoods.find(f => f.name.toLowerCase() === foodName.toLowerCase());

                if (foundFood) {
                    document.getElementById('food-calories-input').value = (foundFood.caloriesPerGram * grams).toFixed(1);
                    document.getElementById('food-protein-input').value = (foundFood.proteinPerGram * grams).toFixed(1);
                    document.getElementById('food-carbs-input').value = (foundFood.carbsPerGram * grams).toFixed(1);
                    document.getElementById('food-fat-input').value = (foundFood.fatPerGram * grams).toFixed(1);
                }
            };
            
            function openEditFoodModal(index) {
                const foodItem = dailyLog[index];
                editingFoodLogIndex = index;
                
                foodNameInput.value = foodItem.name;
                foodGramsInput.value = foodItem.grams;
                document.getElementById('food-servings-input').value = 1;
                document.getElementById('food-calories-input').value = foodItem.calories;
                document.getElementById('food-protein-input').value = foodItem.protein;
                document.getElementById('food-carbs-input').value = foodItem.carbs;
                document.getElementById('food-fat-input').value = foodItem.fat;

                addFoodBtn.querySelector('.btn-text').textContent = "Update Food";
                foodNameInput.focus();
            };

             async function getAIWorkoutAdvice() {
                const exerciseName = aiAdviceExerciseSelect.value;
                if (!exerciseName) {
                    aiAdviceOutput.innerHTML = `<p class="text-yellow-400">Please select an exercise first.</p>`;
                    return;
                }

                const btn = getAIAdviceBtn;
                btn.disabled = true;
                btn.querySelector('.btn-text').style.display = 'none';
                btn.querySelector('.loader').classList.remove('hidden');
                aiAdviceOutput.innerHTML = '';

                const exerciseLogs = workoutHistory.filter(log => log.name === exerciseName).slice(-3); // Get last 3 sessions

                const prompt = `Act as an expert fitness coach grounded in science (citing sources like Jeff Nippard, Dr. Mike Israetel, Jeremy Ethier). A user has performed the following recent sessions for ${exerciseName}:
                ${exerciseLogs.map((log, i) => `Session ${i+1} (${new Date(log.date).toLocaleDateString()}): ${log.sets.map(set => set.map(part => `${part.weight}kg x ${part.reps} reps`).join(' + ')).join(', ')}`).join('\n')}

                Based on the principles of progressive overload, analyze this data. Provide a clear, actionable recommendation for the user's *next* session. Should they increase weight, reps, or sets? Be specific (e.g., "Aim for 6-8 reps with 52.5kg"). Give a concise rationale based on performance trends. Keep the entire response under 75 words.`;

                const apiUrl = getApiUrl('gemini-2.5-flash-preview-05-20');

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    let text = result.candidates[0].content.parts[0].text;
                    aiAdviceOutput.innerHTML = `<p>${text}</p>`;

                } catch (error) {
                    console.error("AI Workout Advice Error:", error);
                    aiAdviceOutput.innerHTML = `<p class="text-red-400">Could not get AI advice at this time.</p>`;
                } finally {
                    btn.disabled = false;
                    btn.querySelector('.btn-text').style.display = 'inline';
                    btn.querySelector('.loader').classList.add('hidden');
                }
            }
            function calculateWakeUpTimes() {
                const now = new Date();
                const fallAsleepTime = 14 * 60 * 1000; 
                sleepWakeTimesDiv.innerHTML = '';

                for(let i = 1; i <= 6; i++) {
                    const cycleDuration = (90 * i * 60 * 1000) + fallAsleepTime;
                    const wakeUpDate = new Date(now.getTime() + cycleDuration);
                    const timeString = wakeUpDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const timeEl = document.createElement('div');
                    timeEl.className = 'bg-gray-700 p-2 rounded-md font-bold text-lg';
                    timeEl.textContent = timeString;
                    sleepWakeTimesDiv.appendChild(timeEl);
                }
            };
            
            function renderSleepHistory() {
                 if (!userProfile.sleepHistory || userProfile.sleepHistory.length === 0) {
                    sleepHistoryDiv.innerHTML = '<p class="text-gray-500">No sleep logged yet.</p>';
                    return;
                }
                sleepHistoryDiv.innerHTML = [...userProfile.sleepHistory].map((log, index) => {
                    const startDate = new Date(`1970-01-01T${log.startTime}`);
                    const endDate = new Date(`1970-01-01T${log.endTime}`);
                    if(endDate < startDate) endDate.setDate(endDate.getDate() + 1);
                    const durationMs = endDate - startDate;
                    const hours = Math.floor(durationMs / (1000 * 60 * 60));
                    const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
                    
                    return `
                    <div class="bg-gray-700 p-4 rounded-md">
                        <div class="flex justify-between items-start mb-2">
                             <div>
                                <h4 class="font-bold text-lg text-blue-400">${new Date(log.date).toLocaleDateString()}</h4>
                                <div class="flex items-center gap-1 mt-1">${'&#9733;'.repeat(log.quality)}<span class="text-gray-400">${'&#9734;'.repeat(5 - log.quality)}</span></div>
                            </div>
                             <div class="flex gap-2">
                                <button class="edit-sleep-btn p-1 hover:bg-gray-600 rounded" data-index="${index}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><line x1="18" y1="2" x2="22" y2="6"/><path d="M7.5 20.5 19 9l-4-4L3.5 16.5 2 22z"/></svg>
                                </button>
                                <button class="delete-sleep-btn p-1 hover:bg-gray-600 rounded" data-index="${index}">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                </button>
                            </div>
                        </div>
                        <p class="text-sm"><strong>Duration:</strong> ${hours}h ${minutes}m</p>
                        <p class="text-sm"><strong>Time:</strong> ${log.startTime} - ${log.endTime}</p>
                        ${log.notes ? `<p class="text-sm mt-2 pt-2 border-t border-gray-600"><strong>Notes:</strong> ${log.notes}</p>` : ''}
                    </div>
                `}).reverse().join('');
            };
            function openEditSleepModal(index) {
                const log = userProfile.sleepHistory[index];
                editingSleepLogIndex = index;
                document.getElementById('edit-sleep-start-time').value = log.startTime;
                document.getElementById('edit-sleep-end-time').value = log.endTime;
                document.getElementById('edit-sleep-notes').value = log.notes;
                currentEditSleepQuality = log.quality;
                Array.from(editSleepQualityRatingDiv.children).forEach(span => {
                    span.classList.toggle('selected', parseInt(span.dataset.value, 10) <= currentEditSleepQuality);
                });
                editSleepModal.style.display = 'flex';
            };
            function renderWorkoutPlanner() {
                const schedule = [
                    { day: "Monday", type: "Pull" },
                    { day: "Tuesday", type: "Legs" },
                    { day: "Wednesday", type: "Rest" },
                    { day: "Thursday", type: "Push" },
                    { day: "Friday", type: "Pull" },
                    { day: "Saturday", type: "Legs" },
                    { day: "Sunday", type: "Push" },
                ];
                
                const exerciseGroups = {
                    "Push": ['Chest', 'Shoulders', 'Triceps', 'Forearms'],
                    "Pull": ['Back', 'Biceps', 'Abs'],
                    "Legs": ['Quads', 'Hamstrings', 'Glutes', 'Calves']
                };

                const todayIndex = (new Date().getDay() + 6) % 7; // Monday is 0, Sunday is 6

                workoutPlannerDiv.innerHTML = schedule.map((item, index) => {
                    const isToday = index === todayIndex;
                    let exercisesHtml = '';
                    if (item.type === 'Rest') {
                        exercisesHtml = `<div class="flex flex-col items-center justify-center h-full text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bed-double text-gray-400 mb-2"><path d="M2 3v16a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V3"/><path d="M2 8h20"/><path d="M12 8v13"/></svg>
                            <p class="text-gray-400 italic mt-2">Rest Day</p>
                        </div>`;
                    } else {
                        const groupsForDay = exerciseGroups[item.type];
                        
                        exercisesHtml = '<div class="planner-exercises space-y-3 pr-2 overflow-y-auto max-h-64">';
                        
                        for(const group of groupsForDay) {
                            const exercisesForGroup = exerciseDB.filter(ex => ex.group === group);
                            if(exercisesForGroup.length > 0) {
                                exercisesHtml += `<div>
                                    <h5 class="font-semibold text-blue-400 text-sm mb-1">${group}</h5>
                                    <ul class="space-y-1">
                                        ${exercisesForGroup.map(ex => `
                                            <li class="text-sm text-gray-300 exercise-item flex justify-between items-center group">
                                                <button class="flex-grow text-left p-1 rounded hover:bg-gray-600 log-workout-btn" data-name="${ex.name}">${ex.name}</button>
                                                <span class="exercise-item-controls items-center gap-1 pl-1">
                                                    <button class="edit-exercise-btn" data-name="${ex.name}"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil text-gray-400 hover:text-yellow-400"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>
                                                    <button class="delete-exercise-btn" data-name="${ex.name}"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 text-gray-400 hover:text-red-500"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg></button>
                                                </span>
                                            </li>`).join('')}
                                    </ul>
                                </div>`;
                            }
                        }

                        exercisesHtml += '</div>';
                    }
                    
                    return `
                        <div class="flex flex-col ${isToday ? 'border-2 border-blue-500' : 'border-2 border-transparent'} bg-gray-700 p-3 rounded-lg h-full">
                            <h4 class="font-bold text-lg text-center ${isToday ? 'text-blue-400' : 'text-white'}">${item.day}</h4>
                            <p class="text-center font-semibold text-gray-300 mb-3">${item.type}</p>
                            <div class="flex-grow min-h-0">${exercisesHtml}</div>
                        </div>
                    `;
                }).join('');
            };

            function populateProgressSelect() {
                const exercisedNames = [...new Set(workoutHistory.map(log => log.name))].sort();
                const options = '<option value="">Select an exercise...</option>' + exercisedNames.map(name => `<option value="${name}">${name}</option>`).join('');
                progressExerciseSelect.innerHTML = options;
                aiAdviceExerciseSelect.innerHTML = options;
            };
            function renderProgressionChart(exerciseName) {
                if (!exerciseName) {
                    progressChart.data.labels = [];
                    progressChart.data.datasets = [];
                    progressChart.update();
                    return;
                }
                const exerciseLogs = workoutHistory.filter(log => log.name === exerciseName)
                                                  .sort((a,b) => new Date(a.date) - new Date(b.date));
                
                const labels = exerciseLogs.map(log => new Date(log.date).toLocaleDateString());
                const maxWeightData = exerciseLogs.map(log => Math.max(...log.sets.flatMap(set => set.map(s => s.weight || 0))));
                const volumeData = exerciseLogs.map(log => log.sets.flat().reduce((total, s) => total + (s.weight * s.reps), 0));

                progressChart.data.labels = labels;
                progressChart.data.datasets = [
                    {
                        label: 'Max Weight (kg)',
                        data: maxWeightData,
                        borderColor: '#60a5fa',
                        backgroundColor: '#60a5fa',
                        tension: 0.1
                    },
                    {
                        label: 'Total Volume (kg)',
                        data: volumeData,
                        borderColor: '#4ade80',
                        backgroundColor: '#4ade80',
                        tension: 0.1
                    }
                ];
                progressChart.update();
            };
            function renderWeightChart() {
                if (!userProfile.weightHistory || userProfile.weightHistory.length === 0) {
                    weightChart.data.labels = [];
                    weightChart.data.datasets = [];
                    weightChart.update();
                    return;
                }
                const sortedHistory = [...userProfile.weightHistory].sort((a,b) => new Date(a.date) - new Date(b.date));
                const labels = sortedHistory.map(entry => new Date(entry.date).toLocaleDateString());
                const data = sortedHistory.map(entry => entry.weight);
                
                weightChart.data.labels = labels;
                weightChart.data.datasets = [{
                    label: 'Weight (kg)',
                    data: data,
                    borderColor: '#a78bfa', // purple-400
                    backgroundColor: '#a78bfa',
                    tension: 0.1,
                    fill: false
                }];
                weightChart.update();
            };
            function populateProfileForm() {
                if (userProfile.age) {
                    profileForm.age.value = userProfile.age;
                    profileForm.gender.value = userProfile.gender;
                    profileForm.height.value = userProfile.height;
                    profileForm.weight.value = userProfile.weight;
                    profileForm['body-fat'].value = userProfile.bodyFat || '';
                    profileForm['activity-level'].value = userProfile.activityLevel;
                    profileForm['user-goal'].value = userProfile.goal;
                    if(userProfile.bmr) bmrInput.value = Math.round(userProfile.bmr);
                    if(userProfile.bmi) bmiInput.value = userProfile.bmi.toFixed(1);
                }
            };
            function generateCalorieCycle() {
                 if(!userProfile.calorieTarget) {
                    caloriePlanOutput.innerHTML = '<p>Please fill out your profile to generate a plan.</p>';
                    return;
                }
                goals.calories = userProfile.calorieTarget; // This is the key integration point
                const { calorieTarget, tdee, goal } = userProfile;

                let planHtml = `<p class="mb-2">Your estimated maintenance is <strong class="text-blue-400">${Math.round(tdee)} kcal</strong>. Based on your goal to <strong class="text-blue-400">${goal}</strong>, here is your adaptive plan:</p>`;
                
                let proteinGoal, carbGoal, fatGoal;

                
                proteinGoal = userProfile.weight * 2.2;
                fatGoal = userProfile.weight * 0.8;
                carbGoal = (calorieTarget - (proteinGoal * 4 + fatGoal * 9)) / 4;

                goals.protein = proteinGoal;
                goals.carbs = carbGoal;
                goals.fat = fatGoal;

                if (goal === 'recomposition') {
                    planHtml += `<ul class="list-disc list-inside space-y-1">
                        <li><strong>Daily Calories:</strong> ${Math.round(calorieTarget)} kcal</li>
                        <li><strong>Protein:</strong> ~${Math.round(proteinGoal)}g</li>
                        <li><strong>Carbs:</strong> ~${Math.round(carbGoal)}g</li>
                        <li><strong>Fat:</strong> ~${Math.round(fatGoal)}g</li>
                    </ul>`;
                } else {
                     const highDay = calorieTarget + 150;
                     const lowDay = calorieTarget - 150;
                     planHtml += `<ul class="list-disc list-inside space-y-1">
                        <li><strong>Average Daily Target:</strong> ${Math.round(calorieTarget)} kcal</li>
                        <li><strong>Workout Days (Higher Calorie):</strong> ${Math.round(highDay)} kcal</li>
                        <li><strong>Rest Days (Lower Calorie):</strong> ${Math.round(lowDay)} kcal</li>
                    </ul>`;
                }
                planHtml += `<p class="text-sm text-gray-400 mt-3">This plan will adapt based on your daily check-ins and InBody scans.</p>`;
                
                caloriePlanOutput.innerHTML = planHtml;
                updateSummary();
            };
            function calculateAndSaveGoals() {
                const btn = profileForm.querySelector('button[type="submit"]');
                userProfile.age = parseInt(profileForm.age.value);
                userProfile.gender = profileForm.gender.value;
                userProfile.height = parseInt(profileForm.height.value);
                userProfile.weight = parseFloat(profileForm.weight.value);
                userProfile.bodyFat = parseFloat(profileForm['body-fat'].value) || null;
                userProfile.activityLevel = parseFloat(profileForm['activity-level'].value);
                userProfile.goal = profileForm['user-goal'].value;
                
                const today = new Date().toISOString().split('T')[0];
                const lastWeightEntry = userProfile.weightHistory[userProfile.weightHistory.length - 1];
                if(!lastWeightEntry || lastWeightEntry.date !== today) {
                     userProfile.weightHistory.push({ date: today, weight: userProfile.weight });
                } else {
                    lastWeightEntry.weight = userProfile.weight;
                }
                
                let bmr;
                if (userProfile.gender === 'male') bmr = 10 * userProfile.weight + 6.25 * userProfile.height - 5 * userProfile.age + 5;
                else bmr = 10 * userProfile.weight + 6.25 * userProfile.height - 5 * userProfile.age - 161;
                userProfile.bmr = bmr;
                
                const bmi = userProfile.weight / ((userProfile.height / 100) ** 2);
                userProfile.bmi = bmi;

                bmrInput.value = Math.round(bmr);
                bmiInput.value = bmi.toFixed(1);

                const tdee = bmr * userProfile.activityLevel;
                userProfile.tdee = tdee;

                let calorieTarget = tdee;
                if(userProfile.goal === 'lose') calorieTarget -= 400;
                if(userProfile.goal === 'gain') calorieTarget += 300;
                if(userProfile.goal === 'recomposition') calorieTarget = tdee; // Start at maintenance
                
                userProfile.calorieTarget = calorieTarget;

                generateCalorieCycle();
                saveData();

                btn.textContent = "Saved!";
                setTimeout(() => {
                    btn.textContent = "Save & Calculate Goals";
                }, 2000);
            };
            
            function openWorkoutModal(exerciseName) {
                editingWorkoutLogIndex = null;
                currentlyLoggingExercise = exerciseName;
                modalTitle.textContent = `Log: ${exerciseName}`;
                saveWorkoutBtn.textContent = 'Save Workout';
                setsContainer.innerHTML = '';
                addSetRow();
                addSetRow();
                addSetRow();
                workoutModal.style.display = 'flex';
            };
            function openEditWorkoutModal(index) {
                editingWorkoutLogIndex = index;
                const logEntry = workoutHistory[index];
                currentlyLoggingExercise = logEntry.name;
                modalTitle.textContent = `Edit: ${logEntry.name}`;
                saveWorkoutBtn.textContent = 'Update Workout';
                setsContainer.innerHTML = '';
                logEntry.sets.forEach(set => addSetRow(set));
                workoutModal.style.display = 'flex';
            };
            function closeWorkoutModal() {
                workoutModal.style.display = 'none';
                editingWorkoutLogIndex = null;
            };
            function addSetRow(setParts = [{weight: '', reps: '', partial: false}]) {
                const setNumber = setsContainer.children.length + 1;
                const row = document.createElement('div');
                row.className = 'set-row border border-gray-600 p-3 rounded-lg space-y-2';
                
                let content = `<div class="flex justify-between items-center">
                    <label class="font-bold text-lg">Set ${setNumber}</label>
                    <div>
                        <button type="button" class="add-part-btn text-blue-400 hover:text-blue-300 p-1" title="Add drop set / pyramid">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                        </button>
                        <button type="button" class="remove-set-btn text-red-500 hover:text-red-400 p-1" title="Delete set">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </div>
                </div>
                <div class="parts-container space-y-2"></div>`;

                row.innerHTML = content;
                setsContainer.appendChild(row);
                
                const partsContainer = row.querySelector('.parts-container');
                setParts.forEach(part => addWeightRepPart(partsContainer, part.weight, part.reps, part.partial));

                row.querySelector('.add-part-btn').addEventListener('click', () => addWeightRepPart(partsContainer));
            };

            function addWeightRepPart(container, weight='', reps='', isPartial=false) {
                const partHtml = `
                    <div class="set-part-row grid grid-cols-12 gap-2 items-center">
                        <input type="number" step="0.25" placeholder="Weight (kg)" value="${weight}" class="w-full bg-gray-600 border border-gray-500 rounded-md p-2 col-span-5 set-weight">
                        <span class="text-center col-span-1">x</span>
                        <input type="number" placeholder="Reps" value="${reps}" class="w-full bg-gray-600 border border-gray-500 rounded-md p-2 col-span-2 set-reps">
                        <div class="col-span-3 flex items-center justify-center">
                            <input type="checkbox" ${isPartial ? 'checked' : ''} class="form-checkbox h-5 w-5 bg-gray-600 border-gray-500 rounded text-blue-500 focus:ring-blue-500 set-partial">
                            <label class="ml-2 text-sm">Partial</label>
                        </div>
                        <button type="button" class="remove-part-btn text-gray-500 hover:text-red-400 p-1 col-span-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                        </button>
                    </div>`;
                container.insertAdjacentHTML('beforeend', partHtml);
            };


             function renderWorkoutHistory() {
                if (workoutHistory.length === 0) {
                    workoutHistoryDiv.innerHTML = '<p class="text-gray-500 text-center">No workouts logged yet.</p>';
                    return;
                }
                workoutHistoryDiv.innerHTML = workoutHistory.map((log, index) => ({...log, originalIndex: index}))
                .reverse()
                .map(log => {
                    const setsHtml = log.sets.map((setParts, i) => {
                        const partsHtml = setParts.map(part => `${part.weight} kg x ${part.reps} reps ${part.partial ? '<span class="text-yellow-400">(P)</span>' : ''}`).join(', ');
                        return `<span><strong>Set ${i+1}:</strong> ${partsHtml}</span>`;
                    }).join('<br>');
                    
                    return `
                    <div class="bg-gray-700 p-4 rounded-md">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-lg text-blue-400">${log.name}</h4>
                                <span class="text-sm text-gray-400">${new Date(log.date).toLocaleDateString()}</span>
                            </div>
                            <div class="flex gap-2">
                                <button class="edit-log-btn p-1 hover:bg-gray-600 rounded" data-index="${log.originalIndex}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><line x1="18" y1="2" x2="22" y2="6"/><path d="M7.5 20.5 19 9l-4-4L3.5 16.5 2 22z"/></svg>
                                </button>
                                <button class="delete-log-btn p-1 hover:bg-gray-600 rounded" data-index="${log.originalIndex}">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="text-sm space-y-1">
                           ${setsHtml}
                        </div>
                    </div>
                `}).join('');
            };
            function showConfirmModal(title, text, onConfirm) {
                confirmModalTitle.textContent = title;
                confirmModalText.textContent = text;
                confirmCallback = onConfirm;
                confirmModal.style.display = 'flex';
            };
            function showCustomAlert(title, text) {
                alertModalTitle.textContent = title;
                alertModalText.textContent = text;
                alertModal.style.display = 'flex';
            };
            function hideConfirmModal() {
                confirmModal.style.display = 'none';
                confirmCallback = null;
            };

            function populateExerciseModal(exercise = null) {
                const muscleGroups = [...new Set(defaultExerciseDB.map(ex => ex.group))].sort();
                const groupSelect = document.getElementById('exercise-group');
                groupSelect.innerHTML = muscleGroups.map(g => `<option>${g}</option>`).join('');
                
                if (exercise) {
                    exerciseModalTitle.textContent = "Edit Exercise";
                    document.getElementById('exercise-name').value = exercise.name;
                    groupSelect.value = exercise.group;
                    document.getElementById('exercise-type').value = exercise.type;
                    editingExerciseName = exercise.name;
                } else {
                    exerciseModalTitle.textContent = "Add New Exercise";
                    exerciseForm.reset();
                    editingExerciseName = null;
                }
                exerciseModal.style.display = 'flex';
            };
            
            function renderAIWorkoutAnalysis(){
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

                const recentWorkouts = workoutHistory.filter(log => new Date(log.date) >= oneWeekAgo);
                
                const volumeByGroup = {};

                recentWorkouts.forEach(log => {
                    const exercise = exerciseDB.find(ex => ex.name === log.name);
                    if(exercise) {
                        if(!volumeByGroup[exercise.group]) {
                            volumeByGroup[exercise.group] = 0;
                        }
                        volumeByGroup[exercise.group] += log.sets.length;
                    }
                });

                const recommendations = {
                    'Chest': {min: 10, max: 20},
                    'Back': {min: 10, max: 20},
                    'Quads': {min: 8, max: 20},
                    'Hamstrings': {min: 6, max: 16},
                    'Shoulders': {min: 8, max: 20},
                    'Biceps': {min: 8, max: 20},
                    'Triceps': {min: 6, max: 16},
                    'Glutes': {min: 4, max: 12},
                    'Calves': {min: 8, max: 16},
                    'Abs': {min: 8, max: 20},
                    'Forearms': {min: 4, max: 12},
                };
                
                let analysisHtml = '';
                const allGroups = [...new Set(exerciseDB.map(e => e.group))].sort();

                allGroups.forEach(group => {
                    const volume = volumeByGroup[group] || 0;
                    const rec = recommendations[group] || {min: 0, max: 0};
                    let statusColor = 'text-gray-400';
                    let statusText = 'Not trained';

                    if (volume > 0) {
                        if (volume < rec.min) {
                            statusColor = 'text-yellow-400';
                            statusText = 'Low Volume';
                        } else if (volume > rec.max) {
                            statusColor = 'text-red-400';
                            statusText = 'High Volume (Risk of overtraining)';
                        } else {
                            statusColor = 'text-green-400';
                            statusText = 'Good Volume';
                        }
                    }

                    analysisHtml += `
                    <div class="flex justify-between items-center text-sm">
                        <span class="font-bold">${group}</span>
                        <div class="flex items-center gap-3">
                           <span>${volume} sets / week</span>
                           <span class="${statusColor}">${statusText}</span>
                        </div>
                    </div>
                    `;
                });
                
                volumeAnalysisDiv.innerHTML = analysisHtml;
            }

            function switchPage(pageToShow) {
                [pageNutrition, pageWorkouts, pageGoals, pageSleep].forEach(page => page.classList.remove('page-active'));
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('nav-active'));

                const pageMap = { nutrition: pageNutrition, workouts: pageWorkouts, goals: pageGoals, sleep: pageSleep };
                const navMap = { nutrition: navNutrition, workouts: navWorkouts, goals: navGoals, sleep: navSleep };

                if (pageMap[pageToShow]) pageMap[pageToShow].classList.add('page-active');
                if (navMap[pageToShow]) navMap[pageToShow].classList.add('nav-active');
            };

            // --- INITIALIZATION ---
            function fullRender() {
                populateSavedFoodsDatalist();
                populateProfileForm();
                if(userProfile.calorieTarget) generateCalorieCycle();
                updateSummary();
                renderDailyLog();
                renderWorkoutPlanner();
                renderWorkoutHistory();
                populateProgressSelect();
                renderProgressionChart(progressExerciseSelect.value);
                renderWeightChart();
                calculateWakeUpTimes();
                renderSleepHistory();
                renderAIWorkoutAnalysis();
                lucide.createIcons();
            }
            
            loadData();
            fullRender();

             // --- ALL EVENT LISTENERS ---
            foodNameInput.addEventListener('input', autoPopulateMacros);
            foodGramsInput.addEventListener('input', autoPopulateMacros);
            addFoodBtn.addEventListener('click', () => {
                addFoodError.textContent = '';
                const foodName = foodNameInput.value.trim();
                const grams = parseFloat(foodGramsInput.value);
                const servings = parseFloat(document.getElementById('food-servings-input').value);
                const calories = parseFloat(document.getElementById('food-calories-input').value);
                const protein = parseFloat(document.getElementById('food-protein-input').value);
                const carbs = parseFloat(document.getElementById('food-carbs-input').value);
                const fat = parseFloat(document.getElementById('food-fat-input').value);

                if (!foodName || isNaN(grams) || grams <= 0 || isNaN(calories) || isNaN(protein) || isNaN(carbs) || isNaN(fat) || isNaN(servings) || servings <= 0) {
                    addFoodError.textContent = "Please fill in all fields with valid numbers.";
                    return;
                }
                
                const totalGrams = grams * servings;
                const foodItem = { 
                    name: foodName, 
                    grams: totalGrams, 
                    calories: calories * servings, 
                    protein: protein * servings, 
                    carbs: carbs * servings, 
                    fat: fat * servings 
                };

                if (editingFoodLogIndex !== null) {
                    dailyLog[editingFoodLogIndex] = foodItem;
                } else {
                    dailyLog.push(foodItem);
                }

                const isNewFood = !savedFoods.some(f => f.name.toLowerCase() === foodName.toLowerCase());
                if (isNewFood) {
                    savedFoods.push({
                        name: foodName,
                        caloriesPerGram: calories / grams,
                        proteinPerGram: protein / grams,
                        carbsPerGram: carbs / grams,
                        fatPerGram: fat / grams,
                    });
                }
                
                editingFoodLogIndex = null;
                addFoodBtn.querySelector('.btn-text').textContent = "Add Food to Log";

                logMealForm.reset();
                foodGramsInput.value = 100;
                document.getElementById('food-servings-input').value = 1;
                saveData();
                fullRender();
            });
            dailyLogDiv.addEventListener('click', (e) => {
                 const removeBtn = e.target.closest('.remove-item-btn');
                 const editBtn = e.target.closest('.edit-food-btn');

                if (removeBtn) {
                    const index = parseInt(removeBtn.dataset.index, 10);
                    dailyLog.splice(index, 1);
                    saveData();
                    fullRender();
                }

                if(editBtn) {
                    const index = parseInt(editBtn.dataset.index, 10);
                    openEditFoodModal(index);
                }
            });
            aiSuggestionBtn.addEventListener('click', async () => {
                 const btnText = aiSuggestionBtn.querySelector('.btn-text');
                const loader = aiSuggestionBtn.querySelector('.loader');
                const ingredients = document.getElementById('ai-ingredients').value.trim();

                if (!ingredients) {
                    aiSuggestionsOutput.innerHTML = `<p class="text-yellow-400">Please enter some ingredients you have.</p>`;
                    return;
                }
                
                btnText.textContent = 'Generating...';
                loader.classList.remove('hidden');
                aiSuggestionsOutput.innerHTML = '';

                const totals = dailyLog.reduce((acc, item) => ({
                    calories: acc.calories + item.calories, protein: acc.protein + item.protein, carbs: acc.carbs + item.carbs, fat: acc.fat + item.fat
                }), { calories: 0, protein: 0, carbs: 0, fat: 0 });

                const remainingCalories = Math.max(0, goals.calories - totals.calories);

                const prompt = `I have the following ingredients: ${ingredients}. I have about ${remainingCalories} calories left for the day. My primary goal is ${userProfile.goal || 'maintain weight'}. Suggest one simple, healthy, and easy-to-prepare meal idea that uses some of these ingredients. Provide the meal name, estimated prep and cook time, and a simple numbered list of step-by-step instructions. Format the output with clear headings for 'Time' and 'Instructions'.`;

                const apiUrl = getApiUrl('gemini-2.5-flash-preview-05-20');
                
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    let text = result.candidates[0].content.parts[0].text;

                    text = text.replace(/\*\*(.*?)\*\*/g, '<h3>$1</h3>'); 
                    text = text.replace(/\*/g, '');
                    text = text.replace(/(\d+\.)/g, '<br>$1');

                    aiSuggestionsOutput.innerHTML = `<div class="bg-gray-700 p-4 rounded-md prose prose-invert max-w-none text-gray-300">${text}</div>`;
                } catch (error) {
                    console.error("AI Suggestion Error:", error);
                    aiSuggestionsOutput.innerHTML = `<p class="text-red-400">Sorry, couldn't get a suggestion right now.</p>`;
                } finally {
                    btnText.textContent = 'Generate Ideas';
                    loader.classList.add('hidden');
                }
            });
            aiGetMacrosBtn.addEventListener('click', async () => {
                const foodName = foodNameInput.value.trim();
                const grams = parseFloat(foodGramsInput.value);
                if (!foodName || isNaN(grams) || grams <= 0) {
                    addFoodError.textContent = "Please enter a valid food and gram amount first.";
                    return;
                }
                addFoodError.textContent = "";

                const btn = aiGetMacrosBtn;
                btn.disabled = true;
                btn.querySelector('.btn-text').textContent = "Analyzing...";
                btn.querySelector('.loader').classList.remove('hidden');

                const prompt = `Calculate the nutritional information (calories, protein, carbs, fat) for ${grams}g of ${foodName}. Respond with only the JSON object.`;
                const apiUrl = getApiUrl('gemini-2.5-flash-preview-05-20');
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                calories: { type: "NUMBER" },
                                protein: { type: "NUMBER" },
                                carbs: { type: "NUMBER" },
                                fat: { type: "NUMBER" }
                            }
                        }
                    }
                };
                
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    if (!result.candidates || !result.candidates[0].content.parts[0].text) throw new Error("Invalid API response.");

                    const data = JSON.parse(result.candidates[0].content.parts[0].text);
                    document.getElementById('food-calories-input').value = data.calories.toFixed(1);
                    document.getElementById('food-protein-input').value = data.protein.toFixed(1);
                    document.getElementById('food-carbs-input').value = data.carbs.toFixed(1);
                    document.getElementById('food-fat-input').value = data.fat.toFixed(1);

                } catch (error) {
                    console.error("AI Get Macros Error:", error);
                    addFoodError.textContent = "Could not fetch nutrition data.";
                } finally {
                    btn.disabled = false;
                    btn.querySelector('.btn-text').textContent = "Get Macros with AI";
                    btn.querySelector('.loader').classList.add('hidden');
                }
            });
            scanBarcodeBtn.addEventListener('click', () => {
                barcodeScannerModal.style.display = 'flex';
                barcodeScannerStatus.textContent = 'Starting camera...';
                if (!barcodeScanner) {
                    barcodeScanner = new Html5Qrcode("barcode-reader");
                }
                barcodeScanner.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    onBarcodeSuccess,
                    (errorMessage) => { /* console.log(errorMessage) */ }
                ).catch((err) => {
                    barcodeScannerStatus.textContent = "Could not start camera.";
                });
            });
            closeBarcodeScannerModalBtn.addEventListener('click', async () => {
                if(barcodeScanner && barcodeScanner.isScanning) {
                   await barcodeScanner.stop();
                }
                barcodeScannerModal.style.display = 'none';
            });
            document.getElementById('sleep-start-time').addEventListener('change', (e) => {
                const startTime = e.target.value;
                if(startTime) {
                    const [hours, minutes] = startTime.split(':').map(Number);
                    const startDate = new Date();
                    startDate.setHours(hours, minutes, 0, 0);
                    const wakeUpDate = new Date(startDate.getTime() + (6.5 * 60 * 60 * 1000));
                    const wakeHours = wakeUpDate.getHours().toString().padStart(2, '0');
                    const wakeMinutes = wakeUpDate.getMinutes().toString().padStart(2, '0');
                    document.getElementById('sleep-end-time').value = `${wakeHours}:${wakeMinutes}`;
                }
            });
            sleepLogForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const startTime = document.getElementById('sleep-start-time').value;
                const endTime = document.getElementById('sleep-end-time').value;
                const notes = document.getElementById('sleep-notes').value;
                if (!startTime || !endTime || currentSleepQuality === 0) {
                    showCustomAlert('Missing Info', 'Please fill in sleep/wake times and select a quality rating.');
                    return;
                }
                const today = new Date().toISOString().split('T')[0];
                const sleepLog = { date: today, startTime, endTime, quality: currentSleepQuality, notes };
                userProfile.sleepHistory.push(sleepLog);
                saveData();
                renderSleepHistory();
                sleepLogForm.reset();
                currentSleepQuality = 0;
                Array.from(sleepQualityRatingDiv.children).forEach(span => span.classList.remove('selected'));
            });
            editSleepLogForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const updatedLog = {
                    date: userProfile.sleepHistory[editingSleepLogIndex].date,
                    startTime: document.getElementById('edit-sleep-start-time').value,
                    endTime: document.getElementById('edit-sleep-end-time').value,
                    notes: document.getElementById('edit-sleep-notes').value,
                    quality: currentEditSleepQuality
                };
                userProfile.sleepHistory[editingSleepLogIndex] = updatedLog;
                saveData();
                renderSleepHistory();
                editSleepModal.style.display = 'none';
            });
            sleepQualityRatingDiv.addEventListener('click', (e) => {
                if (e.target.tagName === 'SPAN') {
                    currentSleepQuality = parseInt(e.target.dataset.value, 10);
                    Array.from(sleepQualityRatingDiv.children).forEach(span => {
                        span.classList.toggle('selected', parseInt(span.dataset.value, 10) <= currentSleepQuality);
                    });
                }
            });
            editSleepQualityRatingDiv.addEventListener('click', (e) => {
                if (e.target.tagName === 'SPAN') {
                    currentEditSleepQuality = parseInt(e.target.dataset.value, 10);
                    Array.from(editSleepQualityRatingDiv.children).forEach(span => {
                        span.classList.toggle('selected', parseInt(span.dataset.value, 10) <= currentEditSleepQuality);
                    });
                }
            });
            sleepHistoryDiv.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-sleep-btn');
                const deleteBtn = e.target.closest('.delete-sleep-btn');
                if (editBtn) openEditSleepModal(parseInt(editBtn.dataset.index));
                if (deleteBtn) {
                     const indexToDelete = parseInt(deleteBtn.dataset.index);
                     showConfirmModal('Delete Sleep Log?', 'Are you sure?', () => {
                        userProfile.sleepHistory.splice(indexToDelete, 1);
                        saveData();
                        renderSleepHistory();
                    });
                }
            });
            closeEditSleepModalBtn.addEventListener('click', () => editSleepModal.style.display = 'none');
            progressExerciseSelect.addEventListener('change', (e) => renderProgressionChart(e.target.value));
            profileForm.addEventListener('submit', (e) => { e.preventDefault(); calculateAndSaveGoals(); });
            bmrInput.addEventListener('change', (e) => { userProfile.bmr = parseFloat(e.target.value); saveData(); });
            bmiInput.addEventListener('change', (e) => { userProfile.bmi = parseFloat(e.target.value); saveData(); });
            openInBodyModalBtn.addEventListener('click', () => inbodyModal.style.display = 'flex');
            closeInbodyModalBtn.addEventListener('click', () => inbodyModal.style.display = 'none');
            closeModalBtn.addEventListener('click', closeWorkoutModal);
            addSetBtn.addEventListener('click', () => addSetRow());
            alertModalOkBtn.addEventListener('click', () => { alertModal.style.display = 'none'; });
            addExerciseBtn.addEventListener('click', () => populateExerciseModal());
            closeExerciseModalBtn.addEventListener('click', () => exerciseModal.style.display = 'none');
            getAIAdviceBtn.addEventListener('click', getAIWorkoutAdvice);
            backupDataBtn.addEventListener('click', () => {
                const dataToBackup = {
                    dailyLog,
                    userProfile,
                    workoutHistory,
                    exerciseDB,
                    savedFoods,
                    goals
                };
                const dataStr = JSON.stringify(dataToBackup, null, 2);
                const blob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fittrack_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showCustomAlert('Success', 'Your data has been backed up.');
            });
            restoreDataInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const restoredData = JSON.parse(event.target.result);
                        dailyLog = restoredData.dailyLog || [];
                        userProfile = restoredData.userProfile || { weightHistory: [], inbodyHistory: [], sleepHistory: [] };
                        workoutHistory = restoredData.workoutHistory || [];
                        exerciseDB = restoredData.exerciseDB || defaultExerciseDB;
                        savedFoods = restoredData.savedFoods || [];
                        goals = restoredData.goals || { calories: 2000, protein: 150, carbs: 225, fat: 60 };
                        saveData();
                        fullRender();
                        showCustomAlert('Success', 'Your data has been restored.');
                    } catch (err) {
                        showCustomAlert('Error', 'Could not read the backup file. It may be corrupted.');
                        console.error("Restore error: ", err);
                    }
                };
                reader.readAsText(file);
                e.target.value = ''; // Reset input
            });
            navNutrition.addEventListener('click', () => switchPage('nutrition'));
            navWorkouts.addEventListener('click', () => switchPage('workouts'));
            navGoals.addEventListener('click', () => switchPage('goals'));
            navSleep.addEventListener('click', () => switchPage('sleep'));
        });
    </script>
</body>
</html>

