<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitTrack AI | Nutrition & Workout Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .nav-active {
            color: #3b82f6; /* blue-500 */
            border-bottom: 2px solid #3b82f6;
        }
        .page {
            display: none;
        }
        .page-active {
            display: block;
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal styles */
        .modal-backdrop {
            display: none;
            position: fixed;
            z-index: 110; /* Increased z-index */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #1f2937; /* gray-800 */
            padding: 1.5rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        #total-calories:hover {
            cursor: pointer;
            background-color: #374151; /* gray-700 */
            border-radius: 0.375rem;
        }
        .star-rating > span {
            cursor: pointer;
            font-size: 2rem;
            color: #4b5563; /* gray-600 */
        }
         .star-rating > span.selected, .star-rating > span:hover, .star-rating > span:hover ~ span {
            color: #f59e0b; /* amber-500 */
        }
        /* Custom scrollbar for workout planner exercises */
        .planner-exercises::-webkit-scrollbar, #warmup-list::-webkit-scrollbar, #favorite-foods-list::-webkit-scrollbar, #ingredient-list-container::-webkit-scrollbar, #saved-recipes-list::-webkit-scrollbar {
            width: 6px;
        }
        .planner-exercises::-webkit-scrollbar-track, #warmup-list::-webkit-scrollbar-track, #favorite-foods-list::-webkit-scrollbar-track, #ingredient-list-container::-webkit-scrollbar-track, #saved-recipes-list::-webkit-scrollbar-track {
            background: #374151; /* gray-700 */
            border-radius: 3px;
        }
        .planner-exercises::-webkit-scrollbar-thumb, #warmup-list::-webkit-scrollbar-thumb, #favorite-foods-list::-webkit-scrollbar-thumb, #ingredient-list-container::-webkit-scrollbar-thumb, #saved-recipes-list::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 3px;
        }
        .planner-exercises::-webkit-scrollbar-thumb:hover, #warmup-list::-webkit-scrollbar-thumb:hover, #favorite-foods-list::-webkit-scrollbar-thumb:hover, #ingredient-list-container::-webkit-scrollbar-thumb:hover, #saved-recipes-list::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        .exercise-item-controls {
            display: none;
        }
        .exercise-item:hover .exercise-item-controls {
            display: inline-flex;
        }
        .prose {
            color: #d1d5db;
        }
        .prose strong {
            color: #93c5fd;
        }
        .prose h3 {
            color: white;
        }
        /* Styles for expanded workout day */
        .workout-day-card.expanded {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 100;
            background-color: #1f2937;
            padding: 2rem;
            overflow-y: auto;
            border-color: transparent !important;
            cursor: default;
        }
        .workout-day-card.expanded .planner-exercises {
            max-height: calc(100vh - 12rem);
        }
        #exercise-detail-modal .modal-content, #warmup-manage-modal .modal-content {
            max-width: 600px;
        }
        .recipe-ingredients-details {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div class="container mx-auto max-w-7xl p-4"> <!-- Increased max-width for weekly planner -->
        <!-- Header -->
        <header class="flex items-center justify-center text-center my-6">
             <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dumbbell text-blue-500 mr-3"><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m6 2 4 4"/><path d="m3 10.5 4.5-4.5"/><path d="m13.5 21 4.5-4.5"/></svg>
            <h1 class="text-3xl font-bold text-white">FitTrack AI</h1>
        </header>

        <!-- Navigation -->
        <nav class="flex justify-center border-b border-gray-700 mb-8 overflow-x-auto">
            <button id="nav-nutrition" class="nav-btn py-4 px-2 sm:px-6 text-base sm:text-lg font-medium text-gray-400 hover:text-blue-500 transition-colors nav-active whitespace-nowrap">Nutrition</button>
            <button id="nav-workouts" class="nav-btn py-4 px-2 sm:px-6 text-base sm:text-lg font-medium text-gray-400 hover:text-blue-500 transition-colors whitespace-nowrap">Workouts</button>
            <button id="nav-goals" class="nav-btn py-4 px-2 sm:px-6 text-base sm:text-lg font-medium text-gray-400 hover:text-blue-500 transition-colors whitespace-nowrap">Goals</button>
            <button id="nav-sleep" class="nav-btn py-4 px-2 sm:px-6 text-base sm:text-lg font-medium text-gray-400 hover:text-blue-500 transition-colors whitespace-nowrap">Sleep</button>
        </nav>

        <!-- Main Content -->
        <main>
            <!-- Nutrition Page -->
            <div id="page-nutrition" class="page page-active">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-5xl mx-auto">
                    <!-- Left Column -->
                    <div class="space-y-8">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Log Your Meal</h2>
                            <form id="log-meal-form" class="space-y-4">
                                <div>
                                    <label for="food-name-input" class="block text-sm font-medium text-gray-400">Food Name</label>
                                    <input type="text" id="food-name-input" list="favorite-foods-datalist" placeholder="e.g., Chicken Breast" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1 focus:ring-blue-500 focus:border-blue-500 text-white">
                                    <datalist id="favorite-foods-datalist"></datalist>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="food-grams-input" class="block text-sm font-medium text-gray-400">Grams (g) (Optional)</label>
                                        <input type="number" id="food-grams-input" placeholder="e.g., 150" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1 focus:ring-blue-500 focus:border-blue-500 text-white">
                                    </div>
                                    <div>
                                        <label for="food-servings-input" class="block text-sm font-medium text-gray-400">Servings</label>
                                        <input type="number" id="food-servings-input" value="1" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                     <div>
                                        <label for="food-calories-input" class="block text-sm font-medium text-gray-400">Calories (kcal)</label>
                                        <input type="number" step="0.1" id="food-calories-input" placeholder="per serving" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                                    </div>
                                    <div>
                                        <label for="food-protein-input" class="block text-sm font-medium text-gray-400">Protein (g)</label>
                                        <input type="number" step="0.1" id="food-protein-input" placeholder="per serving" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="food-carbs-input" class="block text-sm font-medium text-gray-400">Carbs (g)</label>
                                        <input type="number" step="0.1" id="food-carbs-input" placeholder="per serving" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                                    </div>
                                    <div>
                                        <label for="food-fat-input" class="block text-sm font-medium text-gray-400">Fat (g)</label>
                                        <input type="number" step="0.1" id="food-fat-input" placeholder="per serving" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                                    </div>
                                </div>

                                <button id="ai-get-macros-btn" type="button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-all duration-300 flex items-center justify-center">
                                    <span class="btn-text">Get Macros with AI</span>
                                    <div class="loader hidden ml-2"></div>
                                </button>
                                
                                <div class="flex gap-2 pt-2">
                                    <button id="add-food-btn" type="button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-all duration-300 flex items-center justify-center">
                                        <span class="btn-text">Add Food to Log</span>
                                    </button>
                                    <button id="create-recipe-btn" type="button" class="p-2 bg-green-600 hover:bg-green-500 text-white rounded-md" title="Create Recipe">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-notebook-tabs"><path d="M5 21h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2Z"/><path d="M15 3v14a2 2 0 0 1-2 2H6"/><path d="M21 7V5h-2"/><path d="M21 11V9h-2"/><path d="M21 15v-2h-2"/></svg>
                                    </button>
                                    <!-- Replaced barcode scanner button with food image scanner -->
                                     <button id="scan-food-btn" type="button" class="p-2 bg-teal-600 hover:bg-teal-500 text-white rounded-md" title="Scan Food Image">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-camera"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                                    </button>
                                </div>
                                <div id="add-food-error" class="text-red-400 text-sm mt-2 h-4"></div>
                            </form>
                        </div>
                         <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                             <div class="flex items-center justify-between">
                                <h2 class="text-2xl font-semibold">AI Meal Suggestions</h2>
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles text-yellow-400"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
                            </div>
                            <p class="text-gray-400 mb-2 mt-1 text-sm">Enter ingredients you have, and the AI will suggest a quick, easy-prep meal.</p>
                             <div>
                                <label for="ai-ingredients" class="block text-sm font-medium text-gray-400">Your Ingredients</label>
                                <textarea id="ai-ingredients" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" placeholder="e.g., chicken breast, rice, broccoli, olive oil"></textarea>
                            </div>
                            <button id="ai-suggestion-btn" class="w-full mt-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                                 <span class="btn-text">Generate Ideas</span>
                                 <div class="loader hidden ml-2"></div>
                            </button>
                            <div id="ai-suggestions-output" class="mt-4 space-y-3">
                            </div>
                        </div>
                    </div>
                    <!-- Right Column -->
                    <div class="space-y-8">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Today's Log</h2>
                            <div id="daily-log" class="space-y-2 max-h-40 overflow-y-auto">
                                <p class="text-gray-500">No food logged yet.</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Saved Recipes</h2>
                            <div id="saved-recipes-list" class="space-y-2 max-h-40 overflow-y-auto pr-2">
                                <!-- Recipes will be injected here -->
                            </div>
                        </div>

                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Favorite Foods</h2>
                            <div id="favorite-foods-list" class="space-y-2 max-h-40 overflow-y-auto pr-2">
                                <!-- Favorites will be injected here -->
                            </div>
                        </div>

                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Daily Summary</h2>
                            <div class="w-full h-40 flex items-center justify-center">
                                <canvas id="macro-chart"></canvas>
                            </div>
                            <div id="total-calories" class="text-center text-2xl font-bold mt-4 p-1" title="Click to edit daily calorie goal">0 / 2000 kcal</div>
                             <div class="space-y-4 mt-6">
                                <div>
                                     <div class="flex justify-between mb-1 text-sm font-medium">
                                         <span class="text-blue-400 font-bold">Protein</span>
                                         <span class="text-gray-400"><span id="total-protein">0</span>g / <span id="goal-protein">0</span>g</span>
                                     </div>
                                     <div class="w-full bg-gray-700 rounded-full h-2.5">
                                         <div id="protein-progress" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
                                     </div>
                                </div>
                                <div>
                                     <div class="flex justify-between mb-1 text-sm font-medium">
                                         <span class="text-green-400 font-bold">Carbs</span>
                                         <span class="text-gray-400"><span id="total-carbs">0</span>g / <span id="goal-carbs">0</span>g</span>
                                     </div>
                                     <div class="w-full bg-gray-700 rounded-full h-2.5">
                                         <div id="carb-progress" class="bg-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                                     </div>
                                </div>
                                <div>
                                     <div class="flex justify-between mb-1 text-sm font-medium">
                                         <span class="text-red-400 font-bold">Fat</span>
                                         <span class="text-gray-400"><span id="total-fat">0</span>g / <span id="goal-fat">0</span>g</span>
                                     </div>
                                     <div class="w-full bg-gray-700 rounded-full h-2.5">
                                         <div id="fat-progress" class="bg-red-500 h-2.5 rounded-full" style="width: 0%"></div>
                                     </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workouts Page -->
            <div id="page-workouts" class="page">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold">Your Workout Plan</h2>
                    <p class="text-gray-400 mt-2">Push, Pull, Legs split. Click a day to expand, then click an exercise for details.</p>
                </div>
                
                 <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <h3 class="text-2xl font-semibold text-center sm:text-left">This Week's Schedule</h3>
                        <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                             <button id="manage-warmups-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md flex items-center gap-2 justify-center w-full">
                               <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-flame"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>
                               Manage Warm-ups
                            </button>
                            <button id="add-exercise-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md flex items-center gap-2 justify-center w-full">
                               <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                               Add Exercise
                            </button>
                        </div>
                    </div>
                    <div id="workout-planner" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-7 gap-4">
                        <!-- Planner will be injected here by JS -->
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg lg:col-span-2">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                            <h3 class="text-2xl font-semibold mb-4 sm:mb-0">Progression Chart</h3>
                            <select id="progress-exercise-select" class="w-full sm:w-auto bg-gray-700 border border-gray-600 rounded-md p-2">
                                <option value="">Select an exercise to see progress</option>
                            </select>
                        </div>
                        <div class="w-full h-80 flex items-center justify-center">
                            <canvas id="progress-chart"></canvas>
                        </div>
                    </div>
                     <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                           <h3 class="text-2xl font-semibold">Workout History</h3>
                           <button id="clear-history-btn" class="text-sm bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-md">Clear History</button>
                        </div>
                        <div id="workout-history" class="space-y-4 max-h-[22.5rem] overflow-y-auto"></div>
                    </div>
                </div>

                 <div class="bg-gray-800 p-6 rounded-lg shadow-lg mt-8">
                    <h3 class="text-2xl font-semibold mb-4 text-center">AI Coach: Weekly Volume & Progression</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h4 class="font-bold text-lg text-blue-400 mb-2">Weekly Volume Analysis</h4>
                            <div id="volume-analysis" class="space-y-2">
                                <p class="text-gray-400">Log some workouts to see your weekly volume analysis.</p>
                            </div>
                        </div>
                        <div>
                             <h4 class="font-bold text-lg text-blue-400 mb-2">Progression Advice</h4>
                             <p class="text-gray-400 text-sm mb-3">Select an exercise to get science-based advice on when to add weight or reps.</p>
                             <div class="flex gap-2">
                                <select id="ai-advice-exercise-select" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                                    <option value="">Select an exercise...</option>
                                </select>
                                <button id="get-ai-advice-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center">
                                    <span class="btn-text">Get Advice</span>
                                     <div class="loader hidden ml-2"></div>
                                </button>
                             </div>
                             <div id="ai-advice-output" class="mt-4 p-3 bg-gray-900 rounded-md text-sm"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Goals Page -->
            <div id="page-goals" class="page">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-5xl mx-auto">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-semibold mb-4">Your Profile</h2>
                        <form id="profile-form" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="age" class="block text-sm font-medium text-gray-400">Age</label><input type="number" id="age" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                                <div><label for="gender" class="block text-sm font-medium text-gray-400">Gender</label><select id="gender" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"><option value="male">Male</option><option value="female">Female</option></select></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="height" class="block text-sm font-medium text-gray-400">Height (cm)</label><input type="number" id="height" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                                <div><label for="weight" class="block text-sm font-medium text-gray-400">Weight (kg)</label><input type="number" id="weight" step="0.1" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="body-fat" class="block text-sm font-medium text-gray-400">Body Fat % (Optional)</label><input type="number" id="body-fat" step="0.1" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"></div>
                                <div><label for="smm" class="block text-sm font-medium text-gray-400">SMM (kg) (Optional)</label><input type="number" step="0.1" id="smm" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"></div>
                            </div>
                             <div><label for="bfm" class="block text-sm font-medium text-gray-400">Body Fat Mass (kg) (Optional)</label><input type="number" id="bfm" step="0.1" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"></div>
                            <div>
                                <label for="activity-level" class="block text-sm font-medium text-gray-400">Activity Level</label>
                                <select id="activity-level" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                                    <option value="1.2">Sedentary</option><option value="1.375">Lightly active</option><option value="1.55">Moderately active</option><option value="1.725">Very active</option><option value="1.9">Extra active</option>
                                </select>
                            </div>
                            <div>
                                <label for="user-goal" class="block text-sm font-medium text-gray-400">Your Goal</label>
                                <select id="user-goal" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                                    <option value="lose">Lose Fat</option>
                                    <option value="maintain">Maintain Weight</option>
                                    <option value="gain">Gain Muscle</option>
                                    <option value="recomposition" selected>Recomposition</option>
                                </select>
                            </div>
                            <div id="recomp-deficit-container" class="hidden">
                                <label for="recomp-deficit-input" class="block text-sm font-medium text-gray-400">Calorie Deficit (kcal)</label>
                                <input type="number" id="recomp-deficit-input" value="500" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Save & Calculate Goals</button>
                        </form>
                        <div class="mt-6 space-y-2">
                             <div class="flex items-center justify-center gap-2">
                                <label for="bmr-input" class="font-bold text-gray-300">BMR (Override)</label>
                                <input type="number" id="bmr-input" class="bg-gray-700 border border-gray-600 rounded-md p-1 w-24 text-center" placeholder="Auto">
                                <span class="text-gray-400">kcal</span>
                            </div>
                             <div class="flex items-center justify-center gap-2 mt-2">
                                <label for="bmi-input" class="font-bold text-gray-300">BMI:</label>
                                <input type="number" step="0.1" id="bmi-input" class="bg-gray-700 border border-gray-600 rounded-md p-1 w-24 text-center" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-8">
                         <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Data Management</h2>
                            <p class="text-sm text-gray-400 mb-4">Save your data to a file or restore from a backup. Deleting is permanent.</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <button id="backup-data-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Backup Data</button>
                                <label for="restore-data-input" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md text-center cursor-pointer">
                                    Restore Data
                                </label>
                                <input type="file" id="restore-data-input" class="hidden" accept=".json">
                            </div>
                             <button id="delete-all-data-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md mt-4">Delete All Data</button>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                             <h2 class="text-2xl font-semibold mb-4">Weight Progression</h2>
                            <div class="w-full h-64 flex items-center justify-center">
                                <canvas id="weight-chart"></canvas>
                            </div>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Skeletal Muscle Mass</h2>
                            <div class="w-full h-64 flex items-center justify-center">
                                <canvas id="smm-chart"></canvas>
                            </div>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Body Fat Mass</h2>
                            <div class="w-full h-64 flex items-center justify-center">
                                <canvas id="bfm-chart"></canvas>
                            </div>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">AI Adaptive Calorie Plan</h2>
                            <div id="calorie-plan-output" class="text-gray-300"><p>Please fill out your profile to generate a plan.</p></div>
                        </div>
                         <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Daily Check-in</h2>
                            <p class="text-gray-400 text-sm mb-4">Log your weight daily to help the AI adapt your calorie goals for better results.</p>
                            <form id="check-in-form" class="flex flex-col sm:flex-row gap-4">
                                <input type="number" step="0.1" id="check-in-weight" placeholder="Current weight (kg)" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                                <button type="submit" id="check-in-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center sm:w-auto flex-shrink-0">
                                    <span class="btn-text">Check In</span>
                                    <div class="loader hidden ml-2"></div>
                                </button>
                            </form>
                            <div id="check-in-feedback" class="mt-4 text-sm"></div>
                        </div>
                    </div>
                </div>
            </div>
            
             <!-- Sleep Page -->
            <div id="page-sleep" class="page">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-5xl mx-auto">
                    <div class="space-y-8">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Sleep Cycle Calculator</h2>
                            <p class="text-gray-400 mb-4">If you go to bed right now, you should aim to wake up at one of the following times for the best results:</p>
                            <div id="sleep-wake-times" class="grid grid-cols-2 sm:grid-cols-3 gap-3 text-center">
                                <!-- Wake up times will be injected here -->
                            </div>
                            <p class="text-xs text-gray-500 mt-4">Calculations are based on 90-minute sleep cycles and an average of 14 minutes to fall asleep.</p>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Log Your Sleep</h2>
                            <form id="sleep-log-form" class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="sleep-start-time" class="block text-sm font-medium text-gray-400">Went to bed</label><input type="time" id="sleep-start-time" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                                    <div><label for="sleep-end-time" class="block text-sm font-medium text-gray-400">Woke up</label><input type="time" id="sleep-end-time" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Sleep Quality</label>
                                    <div id="sleep-quality-rating" class="star-rating flex flex-row-reverse justify-end items-center">
                                        <span data-value="5">&starf;</span><span data-value="4">&starf;</span><span data-value="3">&starf;</span><span data-value="2">&starf;</span><span data-value="1">&starf;</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="sleep-notes" class="block text-sm font-medium text-gray-400">Notes</label>
                                    <textarea id="sleep-notes" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" placeholder="e.g., Meditated before bed, drank coffee late, etc."></textarea>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Log Sleep</button>
                            </form>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-semibold mb-4">Sleep History</h2>
                        <div id="sleep-history" class="space-y-4 max-h-[40rem] overflow-y-auto">
                            <p class="text-gray-500">No sleep logged yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="exercise-detail-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 id="exercise-detail-title" class="text-2xl font-bold">Exercise Details</h2>
                <button id="close-exercise-detail-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <img id="exercise-detail-video" src="" alt="Video placeholder" class="w-full rounded-lg mb-4 bg-gray-700">
                </div>
                <div>
                    <h3 class="font-bold text-lg text-blue-400 mb-2">Instructions</h3>
                    <ul id="exercise-detail-instructions" class="list-disc list-inside space-y-1 text-gray-300"></ul>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-blue-400 mb-2">Rep Range</h3>
                    <p id="exercise-detail-rep-range" class="text-gray-300"></p>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-blue-400 mb-2">Personal Notes & Advice</h3>
                    <textarea id="exercise-detail-notes" rows="4" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" placeholder="Add your personal cues, weight progression goals, etc."></textarea>
                    <button id="save-exercise-notes-btn" class="mt-2 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Save Notes</button>
                </div>
                <button id="log-from-detail-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md mt-4">Log This Exercise</button>
            </div>
        </div>
    </div>

    <div id="warmup-manage-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Manage Warm-ups</h2>
                <button id="close-warmup-manage-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="warmup-day-select" class="block text-sm font-medium text-gray-400">Workout Day</label>
                    <select id="warmup-day-select" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                        <option value="Push">Push</option>
                        <option value="Pull">Pull</option>
                        <option value="Legs">Legs</option>
                    </select>
                </div>
                <div id="warmup-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                    <!-- Warm-up list will be injected here -->
                </div>
                <hr class="border-gray-600">
                <form id="warmup-form" class="space-y-3">
                    <h3 id="warmup-form-title" class="font-bold text-lg text-blue-400">Add New Warm-up</h3>
                    <div>
                        <label for="warmup-name" class="text-sm">Name</label>
                        <input type="text" id="warmup-name" class="w-full bg-gray-700 p-2 rounded-md mt-1" required>
                    </div>
                    <div>
                        <label for="warmup-instructions" class="text-sm">Instructions (one per line)</label>
                        <textarea id="warmup-instructions" rows="4" class="w-full bg-gray-700 p-2 rounded-md mt-1"></textarea>
                    </div>
                     <button type="submit" id="save-warmup-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Add Warm-up</button>
                </form>
            </div>
        </div>
    </div>





    <div id="workout-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h2 id="modal-title" class="text-2xl font-bold">Log Exercise</h2><button id="close-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
            <form id="workout-log-form"><div class="space-y-4"><div id="sets-container"></div><button type="button" id="add-set-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Add Set</button><button type="submit" id="save-workout-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md mt-2">Save Workout</button></div></form>
        </div>
    </div>
    
    <div id="edit-sleep-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Edit Sleep Log</h2><button id="close-edit-sleep-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
            <form id="edit-sleep-log-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="edit-sleep-start-time" class="block text-sm font-medium text-gray-400">Went to bed</label><input type="time" id="edit-sleep-start-time" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                    <div><label for="edit-sleep-end-time" class="block text-sm font-medium text-gray-400">Woke up</label><input type="time" id="edit-sleep-end-time" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Sleep Quality</label>
                    <div id="edit-sleep-quality-rating" class="star-rating flex flex-row-reverse justify-end items-center">
                        <span data-value="5">&starf;</span><span data-value="4">&starf;</span><span data-value="3">&starf;</span><span data-value="2">&starf;</span><span data-value="1">&starf;</span>
                    </div>
                </div>
                <div>
                    <label for="edit-sleep-notes" class="block text-sm font-medium text-gray-400">Notes</label>
                    <textarea id="edit-sleep-notes" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Update Sleep</button>
            </form>
        </div>
    </div>

    <div id="inbody-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">InBody 570 Scan Data</h2><button id="close-inbody-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
            <form id="inbody-form" class="space-y-3">
                 <div class="grid grid-cols-2 gap-3">
                    <div><label for="inbody-weight" class="text-sm">Weight (kg)</label><input type="number" step="0.1" id="inbody-weight" class="w-full bg-gray-700 p-2 rounded-md mt-1" required></div>
                    <div><label for="inbody-smm" class="text-sm">Skeletal Muscle Mass (kg)</label><input type="number" step="0.1" id="inbody-smm" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                    <div><label for="inbody-bfm" class="text-sm">Body Fat Mass (kg)</label><input type="number" step="0.1" id="inbody-bfm" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                    <div><label for="inbody-pbf" class="text-sm">Percent Body Fat (%)</label><input type="number" step="0.1" id="inbody-pbf" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                 </div>
                 <button type="submit" id="analyze-inbody-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center">
                    <span class="btn-text">Analyze & Update Plan</span>
                    <div class="loader hidden ml-2"></div>
                </button>
            </form>
        </div>
    </div>
    
    <!-- New Food Scanner Modal -->
    <div id="food-scanner-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Scan Food with AI</h2>
                <button id="close-food-scanner-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div id="image-preview-container" class="w-full aspect-video bg-gray-700 rounded-lg flex items-center justify-center overflow-hidden">
                     <img id="image-preview" src="" class="hidden w-full h-full object-contain">
                     <p id="image-placeholder" class="text-gray-400">Upload or take a photo</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <label for="upload-photo-input" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md text-center cursor-pointer flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-upload"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        Upload
                    </label>
                    <input type="file" id="upload-photo-input" class="hidden" accept="image/*">
                    
                    <label for="take-picture-input" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md text-center cursor-pointer flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-camera"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                        Take Photo
                    </label>
                     <input type="file" id="take-picture-input" class="hidden" accept="image/*" capture="environment">
                </div>

                <div>
                    <label for="scanner-food-name" class="block text-sm font-medium text-gray-400">Food Name (to help AI)</label>
                    <input type="text" id="scanner-food-name" placeholder="e.g., 'bowl of oatmeal with berries'" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required>
                </div>
                 <div>
                    <label for="scanner-food-grams" class="block text-sm font-medium text-gray-400">Grams (g) (Optional)</label>
                    <input type="number" id="scanner-food-grams" placeholder="e.g., 250" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                </div>
                 <div>
                    <label for="scanner-food-details" class="block text-sm font-medium text-gray-400">Optional Details</label>
                    <textarea id="scanner-food-details" rows="2" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" placeholder="e.g., brand name, specific ingredients like 'Chobani greek yogurt', etc."></textarea>
                </div>
                
                <button id="ai-get-macros-from-image-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center">
                    <span class="btn-text">Get Macros with AI</span>
                    <div class="loader hidden ml-2"></div>
                </button>
                <p id="food-scanner-status" class="text-center text-sm text-gray-400 mt-2 h-5"></p>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 id="confirm-modal-title" class="text-xl font-bold mb-4">Are you sure?</h2>
            <p id="confirm-modal-text" class="text-gray-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Cancel</button>
                <button id="confirm-modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Delete</button>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 id="alert-modal-title" class="text-xl font-bold mb-4">Alert</h2>
            <p id="alert-modal-text" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end">
                <button id="alert-modal-ok-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">OK</button>
            </div>
        </div>
    </div>

    <div id="exercise-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h2 id="exercise-modal-title" class="text-2xl font-bold">Add Exercise</h2><button id="close-exercise-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
            <form id="exercise-form" class="space-y-4">
                <div>
                    <label for="exercise-name" class="block text-sm font-medium text-gray-400">Exercise Name</label>
                    <input type="text" id="exercise-name" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required>
                </div>
                <div>
                     <label for="exercise-group" class="block text-sm font-medium text-gray-400">Muscle Group</label>
                    <select id="exercise-group" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"></select>
                </div>
                <div>
                    <label for="exercise-type" class="block text-sm font-medium text-gray-400">Equipment Type</label>
                    <select id="exercise-type" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                         <option>Barbell</option>
                         <option>Dumbbell</option>
                         <option>Machine</option>
                         <option>Bodyweight</option>
                         <option>Other</option>
                    </select>
                </div>
                <button type="submit" id="save-exercise-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Save Exercise</button>
            </form>
        </div>
    </div>

    <div id="compound-food-modal" class="modal-backdrop">
        <div class="modal-content" style="max-width: 800px;">
            <div class="flex justify-between items-center mb-4">
                <h2 id="compound-food-modal-title" class="text-2xl font-bold">Create a Recipe</h2>
                <button id="close-compound-food-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <form id="compound-food-form" class="space-y-4">
                <div>
                    <label for="recipe-name-input" class="block text-sm font-medium text-gray-400">Recipe Name</label>
                    <input type="text" id="recipe-name-input" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required placeholder="e.g., Turkey Sandwich">
                </div>

                <div class="border-t border-b border-gray-600 py-4">
                    <h3 class="text-lg font-semibold mb-2">Ingredients</h3>
                    <div id="ingredient-list-container" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                        <!-- Ingredient rows will be injected here -->
                    </div>
                    <button type="button" id="add-ingredient-btn" class="w-full mt-3 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add Ingredient
                    </button>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-2">Total Macros</h3>
                    <div id="recipe-totals" class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                        <div>
                            <p class="text-sm text-gray-400">Calories</p>
                            <p id="recipe-total-calories" class="font-bold text-xl">0</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Protein</p>
                            <p class="font-bold text-xl"><span id="recipe-total-protein">0</span>g</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Carbs</p>
                            <p class="font-bold text-xl"><span id="recipe-total-carbs">0</span>g</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Fat</p>
                            <p class="font-bold text-xl"><span id="recipe-total-fat">0</span>g</p>
                        </div>
                    </div>
                     <p class="text-center text-sm text-gray-400 mt-2">Total Weight: <span id="recipe-total-grams" class="font-bold">0</span>g</p>
                </div>
                
                <button type="submit" id="save-recipe-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Save Recipe</button>
            </form>
        </div>
    </div>

    <div id="prompt-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 id="prompt-modal-title" class="text-xl font-bold mb-4">Input Required</h2>
            <p id="prompt-modal-text" class="text-gray-300 mb-4"></p>
            <input type="number" id="prompt-modal-input" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mb-6">
            <div class="flex justify-end gap-4">
                <button id="prompt-modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Cancel</button>
                <button id="prompt-modal-ok-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">OK</button>
            </div>
        </div>
    </div>
    
    <div id="edit-favorite-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Edit Favorite Food</h2>
                <button id="close-edit-favorite-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <form id="edit-favorite-form" class="space-y-4">
                <p class="text-sm text-gray-400">All values should be per 100g.</p>
                <div>
                    <label for="edit-fav-food-name" class="block text-sm font-medium text-gray-400">Food Name</label>
                    <input type="text" id="edit-fav-food-name" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label for="edit-fav-food-calories" class="block text-sm font-medium text-gray-400">Calories (kcal)</label>
                        <input type="number" step="0.1" id="edit-fav-food-calories" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required>
                    </div>
                    <div>
                        <label for="edit-fav-food-protein" class="block text-sm font-medium text-gray-400">Protein (g)</label>
                        <input type="number" step="0.1" id="edit-fav-food-protein" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-fav-food-carbs" class="block text-sm font-medium text-gray-400">Carbs (g)</label>
                        <input type="number" step="0.1" id="edit-fav-food-carbs" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required>
                    </div>
                    <div>
                        <label for="edit-fav-food-fat" class="block text-sm font-medium text-gray-400">Fat (g)</label>
                        <input type="number" step="0.1" id="edit-fav-food-fat" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Update Favorite</button>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let dailyLog = [];
            let goals = { calories: 2000, protein: 150, carbs: 225, fat: 60 };
            let userProfile = { weightHistory: [], inbodyHistory: [], sleepHistory: [] };
            let workoutHistory = [];
            let exerciseDB = [];
            let warmups = {};
            let favoriteFoods = [];
            let savedRecipes = [];
            let currentlyLoggingExercise = null;
            let editingWorkoutLogIndex = null;
            let editingSleepLogIndex = null;
            let editingExerciseName = null;
            let editingFoodLogIndex = null;
            let scannedImageData = null; // For the new food scanner
            let currentSleepQuality = 0;
            let currentEditSleepQuality = 0;
            let editingWarmupIndex = null;
            let editingFavoriteFoodName = null;
            let editingRecipeIndex = null;


            // --- DATABASES ---
             const defaultWarmups = {
                "Push": [
                    { name: "Arm Circles", instructions: ["Stand with feet shoulder-width apart.", "Extend your arms to the sides.", "Make small circles, gradually increasing to large circles.", "Perform for 30 seconds forward, then 30 seconds backward."], repRange: "1 minute total", videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Warm-up" },
                    { name: "Torso Twists", instructions: ["Stand with feet slightly wider than shoulder-width, knees slightly bent.", "Hold your arms out or cross them over your chest.", "Gently twist your torso from side to side.", "Perform for 30-60 seconds."], repRange: "1 minute total", videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Warm-up" },
                    { name: "Dynamic Chest Stretches", instructions: ["Stand tall.", "Swing both arms outwards and backwards, feeling a stretch in your chest.", "Return arms to the front, crossing them over each other.", "Repeat for 10-15 repetitions."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Warm-up" }
                ],
                "Pull": [
                    { name: "Cat-Cow", instructions: ["Start on your hands and knees.", "Inhale as you drop your belly towards the mat (Cow).", "Exhale as you round your spine upwards (Cat).", "Repeat for 10-15 repetitions."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Warm-up" },
                    { name: "Scapular Pull-ups", instructions: ["Hang from a pull-up bar with an overhand grip.", "Without bending your arms, pull your shoulder blades down and together.", "Hold for a second, then relax.", "Repeat for 8-12 repetitions."], repRange: "8-12 reps", videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Warm-up" },
                    { name: "Band Pull-Aparts", instructions: ["Hold a light resistance band with both hands, shoulder-width apart.", "Keeping your arms straight, pull the band apart by squeezing your shoulder blades.", "Return to the start with control.", "Repeat for 15-20 repetitions."], repRange: "15-20 reps", videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Warm-up" }
                ],
                "Legs": [
                    { name: "Front-to-back Leg Swings", instructions: ["Hold onto a stable surface for balance.", "Swing one leg forward and backward in a controlled motion.", "Keep your core engaged and torso upright.", "Perform 10-15 swings per leg."], repRange: "10-15 reps per leg", videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Warm-up" },
                    { name: "Side-to-side Leg Swings", instructions: ["Face a stable surface and hold on for balance.", "Swing one leg out to the side, then across the front of your body.", "Keep the movement controlled.", "Perform 10-15 swings per leg."], repRange: "10-15 reps per leg", videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Warm-up" },
                    { name: "Side Lying Twists", instructions: ["Lie on your side with your knees bent at 90 degrees.", "Extend your top arm and rotate your torso, trying to touch your top shoulder blade to the floor.", "Follow your hand with your eyes.", "Perform 8-10 twists per side."], repRange: "8-10 reps per side", videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Warm-up" },
                    { name: "Step Throughs", instructions: ["Start in a push-up position.", "Bring your right foot forward and place it outside your right hand, sinking your hips.", "Hold for a moment, then step back to the start.", "Repeat with the left leg.", "Alternate for 5-8 repetitions per side."], repRange: "5-8 reps per side", videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Warm-up" }
                ]
            };

            let defaultExerciseDB = [
                // Leg Day
                { name: "Seated leg curl", group: "Hamstrings", type: "Machine", instructions: ["Sit in the machine with your back against the pad and the ankle pad just above your heels.", "Adjust the lap pad to fit snugly on your thighs.", "Curl your legs down as far as possible, squeezing your hamstrings.", "Slowly return to the starting position."], repRange: "10-15 reps", videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Straight Calf extension", group: "Calves", type: "Machine", instructions: ["Use a standing or seated calf raise machine.", "Place the balls of your feet on the platform, with your heels hanging off.", "Press through the balls of your feet to raise your heels as high as possible.", "Hold the peak contraction, then slowly lower your heels below the platform level."], repRange: "10-20 reps", videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Barbell Squats", group: "Abductors", type: "Barbell", instructions: ["Set a barbell in a squat rack at shoulder height.", "Step under the bar and rest it across your upper back.", "Lift the bar off the rack, take a step back, and stand with feet shoulder-width apart.", "Keeping your chest up and back straight, lower your hips as if sitting in a chair.", "Go as deep as you comfortably can, ideally until your thighs are parallel to the floor.", "Push through your heels to return to the starting position."], repRange: "6-12 reps", videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Smith Machine squats", group: "Abductors", type: "Machine", instructions: ["Set the bar on the Smith machine to shoulder height.", "Position yourself under the bar with feet shoulder-width apart.", "Un-rack the bar and lower down by bending your knees and hips.", "Keep your back straight and chest up.", "Push through your heels to return to the start."], repRange: "8-12 reps", videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Romanian Deadlift", group: "Glutes", type: "Barbell", instructions: ["Hold a barbell with an overhand grip, hands just outside your thighs.", "Stand tall with a slight bend in your knees.", "Hinge at your hips, pushing your butt back while keeping your back straight.", "Lower the bar down your shins until you feel a deep stretch in your hamstrings.", "Squeeze your glutes to return to the starting position."], repRange: "8-12 reps", videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Hip thrusts", group: "Glutes", type: "Barbell", instructions: ["Sit on the floor with your upper back against a bench.", "Roll a barbell over your legs and position it in the crease of your hips.", "Place your feet flat on the floor, shoulder-width apart.", "Drive through your heels to lift your hips until your body forms a straight line from shoulders to knees.", "Squeeze your glutes at the top, then lower your hips back down."], repRange: "8-15 reps", videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Leg Extension", group: "Quads", type: "Machine", instructions: ["Sit in the leg extension machine with your legs under the pad.", "Align your knees with the machine's pivot point.", "Extend your legs to lift the weight until they are straight.", "Squeeze your quads at the top.", "Slowly lower the weight back to the starting position."], repRange: "12-20 reps", videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Cable Crunch", group: "Abs", type: "Machine", instructions: ["Kneel below a high pulley with a rope attachment.", "Grab the rope and pull it down until your hands are placed on either side of your head.", "Flex your hips slightly and allow the weight to hyperextend your lower back.", "Keeping your hips stationary, flex your waist as you contract your abs so that your elbows travel towards the middle of your thighs.", "Hold the contraction for a second and then slowly return to the starting position."], repRange: "10-20 reps", videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration", notes: "" },
                { name: "Bent Knee Raises", group: "Abs", type: "Bodyweight", instructions: ["Lie flat on your back on a mat with your legs straight.", "Place your hands under your lower back for support.", "Bend your knees and pull your upper thighs into your midsection.", "Hold the contraction for a second and then slowly lower your legs back to the starting position."], repRange: "15-25 reps", videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration", notes: "" },

                // Push Day
                { 
                    name: "High-to-low crossover", group: "Chest", type: "Machine", 
                    instructions: [
                        "Set pulleys to the highest position.",
                        "Grab handles with palms facing down, step forward to create tension.",
                        "With a slight bend in your elbows, pull handles down and across your body until they meet in front of your lower chest.",
                        "Squeeze your chest muscles at the peak contraction.",
                        "Slowly return to the starting position."
                    ],
                    repRange: "10-15 reps",
                    videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration",
                    notes: ""
                },
                { 
                    name: "Dumbbell Press", group: "Chest", type: "Dumbbell",
                    instructions: [
                        "Lie on a flat bench with a dumbbell in each hand, resting on your thighs.",
                        "Use your thighs to help push the dumbbells up one at a time so you can hold them at shoulder-width.",
                        "Rotate your wrists so your palms are facing away from you.",
                        "Press the dumbbells up until your arms are fully extended, but not locked at the elbow.",
                        "Slowly lower the dumbbells back to the starting position."
                    ],
                    repRange: "6-12 reps",
                    videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration",
                    notes: ""
                },
                { 
                    name: "Machine Chest Press", group: "Chest", type: "Machine",
                    instructions: [
                        "Sit on the machine with your back flat against the pad.",
                        "Adjust the seat height so the handles are level with your mid-chest.",
                        "Grab the handles with a full grip, keeping your wrists straight.",
                        "Press the handles forward until your arms are fully extended, but not locked at the elbow.",
                        "Slowly return to the starting position, feeling a stretch in your chest."
                    ],
                    repRange: "8-12 reps",
                    videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration",
                    notes: ""
                },
                 { 
                    name: "Cable overhead extension", group: "Triceps", type: "Machine",
                    instructions: [
                        "Attach a rope handle to a low pulley.",
                        "Face away from the machine, grab the rope, and extend your arms fully overhead.",
                        "Keeping your upper arms stationary, lower the rope behind your head by bending your elbows.",
                        "Extend your arms to lift the rope back to the starting position, flexing your triceps."
                    ],
                    repRange: "10-15 reps",
                    videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration",
                    notes: ""
                },
                { 
                    name: "Cable kickback", group: "Triceps", type: "Machine",
                    instructions: [
                        "Set a pulley to a low position. Hinge at your hips so your torso is nearly parallel to the floor.",
                        "Grab the handle and pull your elbow up so your upper arm is parallel to the floor.",
                        "Keeping your upper arm still, extend your forearm back until your arm is straight.",
                        "Squeeze your tricep at the top, then slowly return to the start."
                    ],
                    repRange: "10-15 reps",
                    videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration",
                    notes: ""
                },
                { 
                    name: "Cable lateral raises/ lateral crossover", group: "Shoulders", type: "Machine",
                    instructions: [
                        "Set pulleys on both sides to the lowest position.",
                        "Stand in the middle and grab the left handle with your right hand, and the right handle with your left hand.",
                        "With a slight bend in your elbows, raise your arms out to your sides until they are parallel to the floor.",
                        "Control the weight as you slowly lower your arms back down."
                    ],
                    repRange: "12-20 reps",
                    videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration",
                    notes: ""
                },
                { 
                    name: "Reverse Pec deck", group: "Shoulders", type: "Machine",
                    instructions: [
                        "Sit facing the machine, with your chest against the pad.",
                        "Set the handles to the rearmost position.",
                        "Grab the handles with a neutral or overhand grip.",
                        "Keeping your arms slightly bent, squeeze your shoulder blades together to pull the handles back.",
                        "Slowly return to the starting position."
                    ],
                    repRange: "12-20 reps",
                    videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration",
                    notes: ""
                },

                // Pull Day
                { 
                    name: "Close Grip Lat Pulldown", group: "Back", type: "Machine",
                    instructions: [
                        "Sit at a lat pulldown machine and grab the bar with a close, underhand grip (palms facing you).",
                        "Keep your chest up and your back straight.",
                        "Pull the bar down to your upper chest, squeezing your back muscles.",
                        "Hold the contraction for a moment before slowly returning the bar to the starting position."
                    ],
                    repRange: "8-12 reps",
                    videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration",
                    notes: ""
                },
                { 
                    name: "Chest Supported Rows", group: "Back", type: "Machine",
                    instructions: [
                        "Set up on a chest-supported row machine, with your chest firmly against the pad.",
                        "Grab the handles with a neutral or overhand grip.",
                        "Pull the handles towards your torso, squeezing your shoulder blades together.",
                        "Focus on using your back muscles, not your biceps.",
                        "Slowly extend your arms back to the starting position."
                    ],
                    repRange: "8-12 reps",
                    videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration",
                    notes: ""
                },
                { 
                    name: "Seated Cable Rows", group: "Back", type: "Machine",
                    instructions: [
                        "Sit at a cable row machine with your feet on the platform and knees slightly bent.",
                        "Grab the handle with a neutral grip.",
                        "Keeping your back straight, pull the handle towards your lower abdomen.",
                        "Squeeze your back muscles at the peak of the movement.",
                        "Slowly return to the starting position."
                    ],
                    repRange: "8-12 reps",
                    videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration",
                    notes: ""
                },
                { 
                    name: "Wide Grip Cable Rows", group: "Back", type: "Machine",
                    instructions: [
                        "Attach a long bar to the seated row machine.",
                        "Grab the bar with a wide, overhand grip.",
                        "Pull the bar towards your upper abdomen/lower chest, keeping your elbows flared out.",
                        "Focus on squeezing your upper back and rear delts.",
                        "Slowly return to the starting position."
                    ],
                    repRange: "10-15 reps",
                    videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration",
                    notes: ""
                },
                { 
                    name: "Bayesian Cable Curls", group: "Biceps", type: "Machine",
                    instructions: [
                        "Stand facing a cable machine with the pulley set to the lowest position.",
                        "Hold a straight bar attachment with an underhand grip, hands shoulder-width apart.",
                        "Step back to create tension. Keep your elbows pinned to your sides.",
                        "Curl the bar up towards your chest, squeezing your biceps.",
                        "Slowly lower the bar back down."
                    ],
                    repRange: "10-15 reps",
                    videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration",
                    notes: ""
                },
                { 
                    name: "Cable Hammer Curls", group: "Biceps", type: "Machine",
                    instructions: [
                        "Attach a rope handle to a low pulley on a cable machine.",
                        "Grab the rope with a neutral (hammer) grip, palms facing each other.",
                        "Keep your elbows close to your body and curl the rope up.",
                        "Squeeze your biceps and forearms at the top.",
                        "Slowly lower the rope back to the starting position."
                    ],
                    repRange: "10-15 reps",
                    videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration",
                    notes: ""
                },
                { 
                    name: "Straight Bar Curl", group: "Forearms", type: "Barbell",
                    instructions: [
                        "Stand holding a barbell with an underhand grip, hands shoulder-width apart.",
                        "Keep your elbows close to your torso.",
                        "Curl the weight forward while contracting your biceps. Only your forearms should move.",
                        "Continue until your biceps are fully contracted and the bar is at shoulder level.",
                        "Slowly bring the barbell back to starting position."
                    ],
                    repRange: "10-15 reps",
                    videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration",
                    notes: ""
                },
                { 
                    name: "Reverse Arm Curl", group: "Forearms", type: "Dumbbell",
                    instructions: [
                        "Stand holding a dumbbell in each hand with an overhand grip (palms facing down).",
                        "Keep your elbows close to your torso.",
                        "Curl the weight up, keeping your palms facing down. Focus on using your forearm muscles.",
                        "Slowly lower the dumbbells back to the starting position."
                    ],
                    repRange: "12-20 reps",
                    videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Video+Demonstration",
                    notes: ""
                }
            ];

            // --- UI ELEMENTS ---
            const navNutrition = document.getElementById('nav-nutrition'), navWorkouts = document.getElementById('nav-workouts'), navGoals = document.getElementById('nav-goals'), navSleep = document.getElementById('nav-sleep'),
                  pageNutrition = document.getElementById('page-nutrition'), pageWorkouts = document.getElementById('page-workouts'), pageGoals = document.getElementById('page-goals'), pageSleep = document.getElementById('page-sleep'),
                  logMealForm = document.getElementById('log-meal-form'), foodNameInput = document.getElementById('food-name-input'), foodGramsInput = document.getElementById('food-grams-input'), addFoodBtn = document.getElementById('add-food-btn'),
                  addFoodError = document.getElementById('add-food-error'), dailyLogDiv = document.getElementById('daily-log'), totalCaloriesEl = document.getElementById('total-calories'),
                  totalProteinEl = document.getElementById('total-protein'), totalCarbsEl = document.getElementById('total-carbs'), totalFatEl = document.getElementById('total-fat'),
                  aiSuggestionBtn = document.getElementById('ai-suggestion-btn'), aiSuggestionsOutput = document.getElementById('ai-suggestions-output'),
                  aiGetMacrosBtn = document.getElementById('ai-get-macros-btn'),
                  workoutHistoryDiv = document.getElementById('workout-history'), profileForm = document.getElementById('profile-form'),
                  caloriePlanOutput = document.getElementById('calorie-plan-output'), checkInForm = document.getElementById('check-in-form'), checkInBtn = document.getElementById('check-in-btn'), checkInFeedback = document.getElementById('check-in-feedback'),
                  bmrInput = document.getElementById('bmr-input'), bmiInput = document.getElementById('bmi-input'), workoutModal = document.getElementById('workout-modal'),
                  modalTitle = document.getElementById('modal-title'), closeModalBtn = document.getElementById('close-modal-btn'), workoutLogForm = document.getElementById('workout-log-form'),
                  setsContainer = document.getElementById('sets-container'), addSetBtn = document.getElementById('add-set-btn'), saveWorkoutBtn = document.getElementById('save-workout-btn'),
                  openInBodyModalBtn = document.getElementById('open-inbody-modal-btn'), inbodyModal = document.getElementById('inbody-modal'),
                  closeInbodyModalBtn = document.getElementById('close-inbody-modal-btn'), inbodyForm = document.getElementById('inbody-form'), analyzeInbodyBtn = document.getElementById('analyze-inbody-btn'),
                  confirmModal = document.getElementById('confirm-modal'), confirmModalTitle = document.getElementById('confirm-modal-title'), confirmModalText = document.getElementById('confirm-modal-text'),
                  confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn'), confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn'),
                  alertModal = document.getElementById('alert-modal'), alertModalTitle = document.getElementById('alert-modal-title'), alertModalText = document.getElementById('alert-modal-text'), alertModalOkBtn = document.getElementById('alert-modal-ok-btn'),
                  exerciseModal = document.getElementById('exercise-modal'), closeExerciseModalBtn = document.getElementById('close-exercise-modal-btn'), exerciseForm = document.getElementById('exercise-form'), exerciseModalTitle = document.getElementById('exercise-modal-title'),
                  sleepWakeTimesDiv = document.getElementById('sleep-wake-times'), sleepLogForm = document.getElementById('sleep-log-form'), sleepQualityRatingDiv = document.getElementById('sleep-quality-rating'),
                  sleepHistoryDiv = document.getElementById('sleep-history'), progressExerciseSelect = document.getElementById('progress-exercise-select'),
                  editSleepModal = document.getElementById('edit-sleep-modal'), closeEditSleepModalBtn = document.getElementById('close-edit-sleep-modal-btn'), editSleepLogForm = document.getElementById('edit-sleep-log-form'), editSleepQualityRatingDiv = document.getElementById('edit-sleep-quality-rating'),
                  // New Food Scanner UI Elements
                  scanFoodBtn = document.getElementById('scan-food-btn'),
                  foodScannerModal = document.getElementById('food-scanner-modal'),
                  closeFoodScannerModalBtn = document.getElementById('close-food-scanner-modal-btn'),
                  uploadPhotoInput = document.getElementById('upload-photo-input'),
                  takePictureInput = document.getElementById('take-picture-input'),
                  imagePreview = document.getElementById('image-preview'),
                  imagePlaceholder = document.getElementById('image-placeholder'),
                  aiGetMacrosFromImageBtn = document.getElementById('ai-get-macros-from-image-btn'),
                  foodScannerStatus = document.getElementById('food-scanner-status'),
                  // End New Food Scanner UI Elements
                  weightChartCanvas = document.getElementById('weight-chart'), 
                  smmChartCanvas = document.getElementById('smm-chart'),
                  bfmChartCanvas = document.getElementById('bfm-chart'),
                  workoutPlannerDiv = document.getElementById('workout-planner'), clearHistoryBtn = document.getElementById('clear-history-btn'),
                  addExerciseBtn = document.getElementById('add-exercise-btn'),
                  volumeAnalysisDiv = document.getElementById('volume-analysis'),
                  aiAdviceExerciseSelect = document.getElementById('ai-advice-exercise-select'),
                  getAIAdviceBtn = document.getElementById('get-ai-advice-btn'),
                  aiAdviceOutput = document.getElementById('ai-advice-output'),
                  backupDataBtn = document.getElementById('backup-data-btn'),
                  restoreDataInput = document.getElementById('restore-data-input'),
                  deleteAllDataBtn = document.getElementById('delete-all-data-btn'),
                  // Exercise Detail Modal Elements
                  exerciseDetailModal = document.getElementById('exercise-detail-modal'),
                  closeExerciseDetailModalBtn = document.getElementById('close-exercise-detail-modal-btn'),
                  exerciseDetailTitle = document.getElementById('exercise-detail-title'),
                  exerciseDetailVideo = document.getElementById('exercise-detail-video'),
                  exerciseDetailInstructions = document.getElementById('exercise-detail-instructions'),
                  exerciseDetailRepRange = document.getElementById('exercise-detail-rep-range'),
                  exerciseDetailNotes = document.getElementById('exercise-detail-notes'),
                  saveExerciseNotesBtn = document.getElementById('save-exercise-notes-btn'),
                  logFromDetailBtn = document.getElementById('log-from-detail-btn'),
                  // Warmup Management Modal Elements
                  manageWarmupsBtn = document.getElementById('manage-warmups-btn'),
                  warmupManageModal = document.getElementById('warmup-manage-modal'),
                  closeWarmupManageModalBtn = document.getElementById('close-warmup-manage-modal-btn'),
                  warmupDaySelect = document.getElementById('warmup-day-select'),
                  warmupListDiv = document.getElementById('warmup-list'),
                  warmupForm = document.getElementById('warmup-form'),
                  warmupFormTitle = document.getElementById('warmup-form-title'),
                  warmupNameInput = document.getElementById('warmup-name'),
                  warmupInstructionsInput = document.getElementById('warmup-instructions'),
                  saveWarmupBtn = document.getElementById('save-warmup-btn'),
                  // Compound Food Modal
                  createRecipeBtn = document.getElementById('create-recipe-btn'),
                  compoundFoodModal = document.getElementById('compound-food-modal'),
                  closeCompoundFoodModalBtn = document.getElementById('close-compound-food-modal-btn'),
                  compoundFoodForm = document.getElementById('compound-food-form'),
                  recipeNameInput = document.getElementById('recipe-name-input'),
                  ingredientListContainer = document.getElementById('ingredient-list-container'),
                  addIngredientBtn = document.getElementById('add-ingredient-btn'),
                  saveRecipeBtn = document.getElementById('save-recipe-btn'),
                  // Favorites & Recipes
                  favoriteFoodsListDiv = document.getElementById('favorite-foods-list'),
                  savedRecipesListDiv = document.getElementById('saved-recipes-list'),
                  
                  // Prompt Modal
                  promptModal = document.getElementById('prompt-modal'),
                  promptModalTitle = document.getElementById('prompt-modal-title'),
                  promptModalText = document.getElementById('prompt-modal-text'),
                  promptModalInput = document.getElementById('prompt-modal-input'),
                  promptModalCancelBtn = document.getElementById('prompt-modal-cancel-btn'),
                  promptModalOkBtn = document.getElementById('prompt-modal-ok-btn'),

                   // Edit Favorite Food Modal
                  editFavoriteModal = document.getElementById('edit-favorite-modal'),
                  closeEditFavoriteModalBtn = document.getElementById('close-edit-favorite-modal-btn'),
                  editFavoriteForm = document.getElementById('edit-favorite-form');


            let confirmCallback = null;
            let promptCallback = null;
            
            // --- CHART.JS SETUP ---
            const macroCtx = document.getElementById('macro-chart').getContext('2d');
            let macroChart = new Chart(macroCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Protein', 'Carbs', 'Fat'],
                    datasets: [{
                        data: [1, 1, 1],
                        backgroundColor: ['#60a5fa', '#4ade80', '#f87171'],
                        borderColor: '#1f2937',
                        borderWidth: 4,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                           display: false
                        }
                    }
                }
            });

            const progressCtx = document.getElementById('progress-chart').getContext('2d');
            let progressChart = new Chart(progressCtx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#d1d5db' }, grid: { color: '#374151' } },
                        x: { ticks: { color: '#d1d5db' }, grid: { color: '#374151' } }
                    },
                    plugins: { legend: { labels: { color: '#d1d5db' } } }
                }
            });
            
            const weightCtx = weightChartCanvas.getContext('2d');
            let weightChart = new Chart(weightCtx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { ticks: { color: '#d1d5db' }, grid: { color: '#374151' } },
                        x: { ticks: { color: '#d1d5db' }, grid: { color: '#374151' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            const smmCtx = smmChartCanvas.getContext('2d');
            let smmChart = new Chart(smmCtx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { ticks: { color: '#d1d5db' }, grid: { color: '#374151' } },
                        x: { ticks: { color: '#d1d5db' }, grid: { color: '#374151' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            const bfmCtx = bfmChartCanvas.getContext('2d');
            let bfmChart = new Chart(bfmCtx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { ticks: { color: '#d1d5db' }, grid: { color: '#374151' } },
                        x: { ticks: { color: '#d1d5db' }, grid: { color: '#374151' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });


            // --- ALL FUNCTIONS (defined with `function` for hoisting) ---
            
            function getApiUrl(model, action = 'generateContent') {
                const apiKey = "AIzaSyDY48xF1byvU05kS9qKvN8iyrIR3hheP8w"; 
                return `https://generativelanguage.googleapis.com/v1beta/models/${model}:${action}?key=${apiKey}`;
            };
            
            function saveData() {
                localStorage.setItem('fitTrackAI_dailyLog', JSON.stringify(dailyLog));
                localStorage.setItem('fitTrackAI_userProfile', JSON.stringify(userProfile));
                localStorage.setItem('fitTrackAI_workoutHistory', JSON.stringify(workoutHistory));
                localStorage.setItem('fitTrackAI_exerciseDB', JSON.stringify(exerciseDB));
                localStorage.setItem('fitTrackAI_favoriteFoods', JSON.stringify(favoriteFoods));
                localStorage.setItem('fitTrackAI_savedRecipes', JSON.stringify(savedRecipes));
                localStorage.setItem('fitTrackAI_goals', JSON.stringify(goals));
                localStorage.setItem('fitTrackAI_warmups', JSON.stringify(warmups));
            };
            
            function loadData() {
                dailyLog = JSON.parse(localStorage.getItem('fitTrackAI_dailyLog')) || [];
                userProfile = JSON.parse(localStorage.getItem('fitTrackAI_userProfile')) || { weightHistory: [], inbodyHistory: [], sleepHistory: [] };
                workoutHistory = JSON.parse(localStorage.getItem('fitTrackAI_workoutHistory')) || [];
                exerciseDB = JSON.parse(localStorage.getItem('fitTrackAI_exerciseDB')) || JSON.parse(JSON.stringify(defaultExerciseDB));
                warmups = JSON.parse(localStorage.getItem('fitTrackAI_warmups')) || JSON.parse(JSON.stringify(defaultWarmups));
                goals = JSON.parse(localStorage.getItem('fitTrackAI_goals')) || { calories: 2000, protein: 150, carbs: 225, fat: 60 };
                savedRecipes = JSON.parse(localStorage.getItem('fitTrackAI_savedRecipes')) || [];
                
                // --- Data Migration from old structure ---
                const oldFavorites = JSON.parse(localStorage.getItem('fitTrackAI_favoriteFoods')) || [];
                const newSingleFavorites = [];
                oldFavorites.forEach(food => {
                    if (food.isCompound) {
                        // If it's a recipe and not already in the new savedRecipes list
                        if (!savedRecipes.some(r => r.name.toLowerCase() === food.name.toLowerCase())) {
                            savedRecipes.push(food);
                        }
                    } else {
                        // If it's a single food and not already in the new list
                        if (!newSingleFavorites.some(f => f.name.toLowerCase() === food.name.toLowerCase())) {
                            newSingleFavorites.push(food);
                        }
                    }
                });
                favoriteFoods = newSingleFavorites;

                // Make sure essential userProfile arrays exist
                if (!userProfile.weightHistory) userProfile.weightHistory = [];
                if (!userProfile.inbodyHistory) userProfile.inbodyHistory = [];
                if (!userProfile.sleepHistory) userProfile.sleepHistory = [];
            }


            function updateSummary() {
                 const totals = dailyLog.reduce((acc, item) => ({
                    calories: acc.calories + item.calories, protein: acc.protein + item.protein, carbs: acc.carbs + item.carbs, fat: acc.fat + item.fat
                }), { calories: 0, protein: 0, carbs: 0, fat: 0 });

                totalCaloriesEl.innerHTML = `<span id="current-cals">${Math.round(totals.calories)}</span> / <span id="goal-cals">${Math.round(goals.calories)}</span> kcal`;
                
                totalProteinEl.textContent = Math.round(totals.protein);
                totalCarbsEl.textContent = Math.round(totals.carbs);
                totalFatEl.textContent = Math.round(totals.fat);

                document.getElementById('goal-protein').textContent = Math.round(goals.protein);
                document.getElementById('goal-carbs').textContent = Math.round(goals.carbs);
                document.getElementById('goal-fat').textContent = Math.round(goals.fat);

                const proteinPercent = goals.protein > 0 ? Math.min(100, (totals.protein / goals.protein) * 100) : 0;
                const carbPercent = goals.carbs > 0 ? Math.min(100, (totals.carbs / goals.carbs) * 100) : 0;
                const fatPercent = goals.fat > 0 ? Math.min(100, (totals.fat / goals.fat) * 100) : 0;

                document.getElementById('protein-progress').style.width = `${proteinPercent}%`;
                document.getElementById('carb-progress').style.width = `${carbPercent}%`;
                document.getElementById('fat-progress').style.width = `${fatPercent}%`;
                
                const macroSum = totals.protein + totals.carbs + totals.fat;
                if(macroSum > 0) {
                    macroChart.data.datasets[0].data = [totals.protein, totals.carbs, totals.fat];
                } else {
                    macroChart.data.datasets[0].data = [1, 1, 1];
                }
                macroChart.update();
            };
            function renderDailyLog() {
                 if (dailyLog.length === 0) {
                    dailyLogDiv.innerHTML = '<p class="text-gray-500">No food logged yet.</p>';
                    return;
                }
                dailyLogDiv.innerHTML = dailyLog.map((item, index) => {
                    const isFavorite = favoriteFoods.some(fav => fav.name.toLowerCase() === item.name.toLowerCase());
                    return `
                    <div class="flex justify-between items-center bg-gray-700 p-2 rounded-md">
                        <div>
                            <span>${item.name} ${item.grams > 0 ? `(${item.grams}g)` : ''}</span>
                        </div>
                        <div class="flex items-center gap-2">
                           <span class="text-sm text-gray-400">${Math.round(item.calories)} kcal</span>
                           <button class="favorite-food-btn p-1 hover:bg-gray-600 rounded" data-index="${index}" title="${isFavorite ? 'Remove from Favorites' : 'Add to Favorites'}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="${isFavorite ? '#f59e0b' : 'none'}" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star text-gray-400 hover:text-amber-400 ${isFavorite ? 'text-amber-400' : ''}"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                           </button>
                           <button class="edit-food-btn p-1 hover:bg-gray-600 rounded" data-index="${index}" title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil text-gray-400 hover:text-yellow-400"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                           </button>
                           <button class="remove-item-btn text-red-500 hover:text-red-400" data-index="${index}" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                           </button>
                        </div>
                    </div>
                `}).join('');
            };

            function populateFavoritesDatalist() {
                const datalist = document.getElementById('favorite-foods-datalist');
                const allFoodNames = [...favoriteFoods, ...savedRecipes];
                datalist.innerHTML = allFoodNames.map(food => `<option value="${food.name}"></option>`).join('');
            };

            function autoPopulateFromFavorites() {
                const foodName = foodNameInput.value;
                const grams = parseFloat(foodGramsInput.value) || 100;
                const allFoods = [...favoriteFoods, ...savedRecipes];
                const foundFood = allFoods.find(f => f.name.toLowerCase() === foodName.toLowerCase());

                if (foundFood) {
                    let cals, prot, carb, fat;
                    if (foundFood.totalGrams) { // It's a recipe
                        const ratio = grams / foundFood.totalGrams;
                        cals = foundFood.calories * ratio;
                        prot = foundFood.protein * ratio;
                        carb = foundFood.carbs * ratio;
                        fat = foundFood.fat * ratio;
                    } else { // It's a single favorite food
                         // Handle older data structures that might not have per-gram values
                        const caloriesPerGram = foundFood.caloriesPerGram || (foundFood.calories / 100);
                        const proteinPerGram = foundFood.proteinPerGram || (foundFood.protein / 100);
                        const carbsPerGram = foundFood.carbsPerGram || (foundFood.carbs / 100);
                        const fatPerGram = foundFood.fatPerGram || (foundFood.fat / 100);
                        cals = caloriesPerGram * grams;
                        prot = proteinPerGram * grams;
                        carb = carbsPerGram * grams;
                        fat = fatPerGram * grams;
                    }

                    document.getElementById('food-calories-input').value = cals.toFixed(1);
                    document.getElementById('food-protein-input').value = prot.toFixed(1);
                    document.getElementById('food-carbs-input').value = carb.toFixed(1);
                    document.getElementById('food-fat-input').value = fat.toFixed(1);
                }
            };
            
            function openEditFoodModal(index) {
                const foodItem = dailyLog[index];
                editingFoodLogIndex = index;
                
                foodNameInput.value = foodItem.name;
                foodGramsInput.value = foodItem.grams;
                document.getElementById('food-servings-input').value = 1;
                document.getElementById('food-calories-input').value = foodItem.calories;
                document.getElementById('food-protein-input').value = foodItem.protein;
                document.getElementById('food-carbs-input').value = foodItem.carbs;
                document.getElementById('food-fat-input').value = foodItem.fat;

                addFoodBtn.querySelector('.btn-text').textContent = "Update Food";
                foodNameInput.focus();
            };

             async function getAIWorkoutAdvice() {
                const exerciseName = aiAdviceExerciseSelect.value;
                if (!exerciseName) {
                    aiAdviceOutput.innerHTML = `<p class="text-yellow-400">Please select an exercise first.</p>`;
                    return;
                }

                const btn = getAIAdviceBtn;
                btn.disabled = true;
                btn.querySelector('.btn-text').style.display = 'none';
                btn.querySelector('.loader').classList.remove('hidden');
                aiAdviceOutput.innerHTML = '';

                const exerciseLogs = workoutHistory.filter(log => log.name === exerciseName).slice(-3); // Get last 3 sessions

                const prompt = `Act as an expert fitness coach grounded in science (citing sources like Jeff Nippard, Dr. Mike Israetel, Jeremy Ethier). A user has performed the following recent sessions for ${exerciseName}:
                ${exerciseLogs.map((log, i) => `Session ${i+1} (${new Date(log.date).toLocaleDateString()}): ${log.sets.map(set => set.map(part => `${part.weight}kg x ${part.reps} reps`).join(' + ')).join(', ')}`).join('\n')}

                Based on the principles of progressive overload, analyze this data. Provide a clear, actionable recommendation for the user's *next* session. Should they increase weight, reps, or sets? Be specific (e.g., "Aim for 6-8 reps with 52.5kg"). Give a concise rationale based on performance trends. Keep the entire response under 75 words.`;

                const apiUrl = getApiUrl('gemini-2.5-flash-preview-05-20');

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    let text = result.candidates[0].content.parts[0].text;
                    aiAdviceOutput.innerHTML = `<p>${text}</p>`;

                } catch (error) {
                    console.error("AI Workout Advice Error:", error);
                    aiAdviceOutput.innerHTML = `<p class="text-red-400">Could not get AI advice at this time.</p>`;
                } finally {
                    btn.disabled = false;
                    btn.querySelector('.btn-text').style.display = 'inline';
                    btn.querySelector('.loader').classList.add('hidden');
                }
            }
            function calculateWakeUpTimes() {
                const now = new Date();
                const fallAsleepTime = 14 * 60 * 1000; 
                sleepWakeTimesDiv.innerHTML = '';

                for(let i = 1; i <= 6; i++) {
                    const cycleDuration = (90 * i * 60 * 1000) + fallAsleepTime;
                    const wakeUpDate = new Date(now.getTime() + cycleDuration);
                    const timeString = wakeUpDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const timeEl = document.createElement('div');
                    timeEl.className = 'bg-gray-700 p-2 rounded-md font-bold text-lg';
                    timeEl.textContent = timeString;
                    sleepWakeTimesDiv.appendChild(timeEl);
                }
            };
            
            function renderSleepHistory() {
                 if (!userProfile.sleepHistory || userProfile.sleepHistory.length === 0) {
                    sleepHistoryDiv.innerHTML = '<p class="text-gray-500">No sleep logged yet.</p>';
                    return;
                }
                sleepHistoryDiv.innerHTML = [...userProfile.sleepHistory].map((log, index) => {
                    const startDate = new Date(`1970-01-01T${log.startTime}`);
                    const endDate = new Date(`1970-01-01T${log.endTime}`);
                    if(endDate < startDate) endDate.setDate(endDate.getDate() + 1);
                    const durationMs = endDate - startDate;
                    const hours = Math.floor(durationMs / (1000 * 60 * 60));
                    const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
                    
                    return `
                    <div class="bg-gray-700 p-4 rounded-md">
                        <div class="flex justify-between items-start mb-2">
                             <div>
                                <h4 class="font-bold text-lg text-blue-400">${new Date(log.date).toLocaleDateString()}</h4>
                                <div class="flex items-center gap-1 mt-1">${'&#9733;'.repeat(log.quality)}<span class="text-gray-400">${'&#9734;'.repeat(5 - log.quality)}</span></div>
                            </div>
                             <div class="flex gap-2">
                                <button class="edit-sleep-btn p-1 hover:bg-gray-600 rounded" data-index="${index}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><line x1="18" y1="2" x2="22" y2="6"/><path d="M7.5 20.5 19 9l-4-4L3.5 16.5 2 22z"/></svg>
                                </button>
                                <button class="delete-sleep-btn p-1 hover:bg-gray-600 rounded" data-index="${index}">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                </button>
                            </div>
                        </div>
                        <p class="text-sm"><strong>Duration:</strong> ${hours}h ${minutes}m</p>
                        <p class="text-sm"><strong>Time:</strong> ${log.startTime} - ${log.endTime}</p>
                        ${log.notes ? `<p class="text-sm mt-2 pt-2 border-t border-gray-600"><strong>Notes:</strong> ${log.notes}</p>` : ''}
                    </div>
                `}).reverse().join('');
            };
            function openEditSleepModal(index) {
                const log = userProfile.sleepHistory[index];
                editingSleepLogIndex = index;
                document.getElementById('edit-sleep-start-time').value = log.startTime;
                document.getElementById('edit-sleep-end-time').value = log.endTime;
                document.getElementById('edit-sleep-notes').value = log.notes;
                currentEditSleepQuality = log.quality;
                Array.from(editSleepQualityRatingDiv.children).forEach(span => {
                    span.classList.toggle('selected', parseInt(span.dataset.value, 10) <= currentEditSleepQuality);
                });
                editSleepModal.style.display = 'flex';
            };
            
            function renderWorkoutPlanner() {
                const schedule = [
                    { day: "Monday", type: "Pull" },
                    { day: "Tuesday", type: "Legs" },
                    { day: "Wednesday", type: "Rest" },
                    { day: "Thursday", type: "Push" },
                    { day: "Friday", type: "Pull" },
                    { day: "Saturday", type: "Legs" },
                    { day: "Sunday", type: "Push" },
                ];
                
                const exerciseGroups = {
                    "Push": ['Chest', 'Shoulders', 'Triceps'],
                    "Pull": ['Back', 'Biceps', 'Forearms'],
                    "Legs": ['Quads', 'Abductors', 'Glutes', 'Hamstrings',  'Calves', 'Abs'] 
                };

                const todayIndex = (new Date().getDay() + 6) % 7; // Monday is 0, Sunday is 6

                workoutPlannerDiv.innerHTML = schedule.map((item, index) => {
                    const isToday = index === todayIndex;
                    let exercisesHtml = '';
                    if (item.type === 'Rest') {
                        exercisesHtml = `<div class="flex flex-col items-center justify-center h-full text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bed-double text-gray-400 mb-2"><path d="M2 3v16a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V3"/><path d="M2 8h20"/><path d="M12 8v13"/></svg>
                            <p class="text-gray-400 italic mt-2">Rest Day</p>
                        </div>`;
                    } else {
                        const groupsForDay = exerciseGroups[item.type];
                        const warmupExercises = warmups[item.type] || [];
                        
                        exercisesHtml = '<div class="planner-exercises space-y-4 pr-2 overflow-y-auto max-h-64">';
                        
                        if (warmupExercises.length > 0) {
                            exercisesHtml += `<div>
                                <h5 class="font-semibold text-green-400 text-sm mb-1">Warm-up</h5>
                                <ul class="space-y-1">
                                    ${warmupExercises.map(w => `
                                        <li class="text-sm text-gray-300 exercise-item flex justify-between items-center group">
                                            <button class="flex-grow text-left p-1 rounded hover:bg-gray-600 warmup-detail-btn" data-name="${w.name}" data-day-type="${item.type}">${w.name}</button>
                                            <span class="exercise-item-controls items-center gap-1 pl-1">
                                                <button class="edit-warmup-btn p-1" data-name="${w.name}" data-day-type="${item.type}" title="Edit Warmup"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil text-gray-400 hover:text-yellow-400 pointer-events-none"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>
                                                <button class="delete-warmup-btn p-1" data-name="${w.name}" data-day-type="${item.type}" title="Delete Warmup"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 text-gray-400 hover:text-red-500 pointer-events-none"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg></button>
                                            </span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>`;
                        }
                        
                        for(const group of groupsForDay) {
                            const exercisesForGroup = exerciseDB.filter(ex => ex.group === group);
                            if(exercisesForGroup.length > 0) {
                                exercisesHtml += `<div>
                                    <h5 class="font-semibold text-blue-400 text-sm mb-1">${group}</h5>
                                    <ul class="space-y-1">
                                        ${exercisesForGroup.map(ex => `
                                            <li class="text-sm text-gray-300 exercise-item flex justify-between items-center group">
                                                <button class="flex-grow text-left p-1 rounded hover:bg-gray-600 log-workout-btn" data-name="${ex.name}">${ex.name}</button>
                                                <span class="exercise-item-controls items-center gap-1 pl-1">
                                                    <button class="edit-exercise-btn p-1" data-name="${ex.name}" title="Edit Exercise"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil text-gray-400 hover:text-yellow-400 pointer-events-none"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>
                                                    <button class="delete-exercise-btn p-1" data-name="${ex.name}" title="Delete Exercise"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 text-gray-400 hover:text-red-500 pointer-events-none"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg></button>
                                                </span>
                                            </li>`).join('')}
                                    </ul>
                                </div>`;
                            }
                        }

                        exercisesHtml += '</div>';
                    }
                    
                    return `
                        <div class="workout-day-card flex flex-col ${isToday ? 'border-2 border-blue-500' : 'border-2 border-transparent'} bg-gray-700 p-3 rounded-lg h-full cursor-pointer" data-day-index="${index}">
                            <h4 class="font-bold text-lg text-center ${isToday ? 'text-blue-400' : 'text-white'}">${item.day}</h4>
                            <p class="text-center font-semibold text-gray-300 mb-3">${item.type}</p>
                            <div class="flex-grow min-h-0">${exercisesHtml}</div>
                        </div>
                    `;
                }).join('');
            };

            function populateProgressSelect() {
                const exercisedNames = [...new Set(workoutHistory.map(log => log.name))].sort();
                const options = '<option value="">Select an exercise...</option>' + exercisedNames.map(name => `<option value="${name}">${name}</option>`).join('');
                progressExerciseSelect.innerHTML = options;
                aiAdviceExerciseSelect.innerHTML = options;
            };
            function renderProgressionChart(exerciseName) {
                if (!exerciseName) {
                    progressChart.data.labels = [];
                    progressChart.data.datasets = [];
                    progressChart.update();
                    return;
                }
                const exerciseLogs = workoutHistory.filter(log => log.name === exerciseName)
                                                 .sort((a,b) => new Date(a.date) - new Date(b.date));
                
                const labels = exerciseLogs.map(log => new Date(log.date).toLocaleDateString());
                const maxWeightData = exerciseLogs.map(log => Math.max(...log.sets.flatMap(set => set.map(s => s.weight || 0))));
                const volumeData = exerciseLogs.map(log => log.sets.flat().reduce((total, s) => total + (s.weight * s.reps), 0));

                progressChart.data.labels = labels;
                progressChart.data.datasets = [
                    {
                        label: 'Max Weight (kg)',
                        data: maxWeightData,
                        borderColor: '#60a5fa',
                        backgroundColor: '#60a5fa',
                        tension: 0.1
                    },
                    {
                        label: 'Total Volume (kg)',
                        data: volumeData,
                        borderColor: '#4ade80',
                        backgroundColor: '#4ade80',
                        tension: 0.1
                    }
                ];
                progressChart.update();
            };
            function renderWeightChart() {
                if (!userProfile.weightHistory || userProfile.weightHistory.length === 0) {
                    weightChart.data.labels = [];
                    weightChart.data.datasets = [];
                    weightChart.update();
                    return;
                }
                const sortedHistory = [...userProfile.weightHistory].sort((a,b) => new Date(a.date) - new Date(b.date));
                const labels = sortedHistory.map(entry => new Date(entry.date).toLocaleDateString());
                const data = sortedHistory.map(entry => entry.weight);
                
                weightChart.data.labels = labels;
                weightChart.data.datasets = [{
                    label: 'Weight (kg)',
                    data: data,
                    borderColor: '#a78bfa', // purple-400
                    backgroundColor: '#a78bfa',
                    tension: 0.1,
                    fill: false
                }];
                weightChart.update();
            };
            
            function renderSmmBfmCharts() {
                if (!userProfile.inbodyHistory || userProfile.inbodyHistory.length === 0) {
                    smmChart.data.labels = [];
                    smmChart.data.datasets = [];
                    bfmChart.data.labels = [];
                    bfmChart.data.datasets = [];
                } else {
                    const sortedHistory = [...userProfile.inbodyHistory].sort((a, b) => new Date(a.date) - new Date(b.date));
                    const labels = sortedHistory.map(entry => new Date(entry.date).toLocaleDateString());
                    const smmData = sortedHistory.map(entry => entry.smm);
                    const bfmData = sortedHistory.map(entry => entry.bfm);

                    smmChart.data.labels = labels;
                    smmChart.data.datasets = [{
                        label: 'SMM (kg)',
                        data: smmData,
                        borderColor: '#34d399', // emerald-400
                        backgroundColor: '#34d399',
                        tension: 0.1,
                        fill: false
                    }];

                    bfmChart.data.labels = labels;
                    bfmChart.data.datasets = [{
                        label: 'BFM (kg)',
                        data: bfmData,
                        borderColor: '#fbbf24', // amber-400
                        backgroundColor: '#fbbf24',
                        tension: 0.1,
                        fill: false
                    }];
                }
                smmChart.update();
                bfmChart.update();
            }

            function populateProfileForm() {
                const recompDeficitContainer = document.getElementById('recomp-deficit-container');
                const recompDeficitInput = document.getElementById('recomp-deficit-input');

                if (userProfile.age) {
                    profileForm.age.value = userProfile.age;
                    profileForm.gender.value = userProfile.gender;
                    profileForm.height.value = userProfile.height;
                    profileForm.weight.value = userProfile.weight;
                    profileForm['body-fat'].value = userProfile.bodyFat || '';
                    profileForm['smm'].value = userProfile.smm || '';
                    profileForm['bfm'].value = userProfile.bfm || '';
                    profileForm['activity-level'].value = userProfile.activityLevel;
                    profileForm['user-goal'].value = userProfile.goal;
                    if(userProfile.bmr) bmrInput.value = userProfile.bmr;
                    else bmrInput.placeholder = 'Auto';
                    if(userProfile.bmi) bmiInput.value = userProfile.bmi.toFixed(1);
                    recompDeficitInput.value = userProfile.recompDeficit || 500;
                }
                
                if (profileForm['user-goal'].value === 'recomposition') {
                    recompDeficitContainer.classList.remove('hidden');
                } else {
                    recompDeficitContainer.classList.add('hidden');
                }
            };
            function generateCalorieCycle() {
                 if(!userProfile.calorieTarget) {
                    caloriePlanOutput.innerHTML = '<p>Please fill out your profile to generate a plan.</p>';
                    return;
                }
                goals.calories = userProfile.calorieTarget; // This is the key integration point
                const { calorieTarget, tdee, goal } = userProfile;

                let planHtml = `<p class="mb-2">Your estimated maintenance is <strong class="text-blue-400">${Math.round(tdee)} kcal</strong>. Based on your goal to <strong class="text-blue-400">${goal}</strong>, here is your adaptive plan:</p>`;
                
                let proteinGoal, carbGoal, fatGoal;

                
                proteinGoal = userProfile.weight * 2.2;
                fatGoal = userProfile.weight * 0.8;
                carbGoal = (calorieTarget - (proteinGoal * 4 + fatGoal * 9)) / 4;

                goals.protein = proteinGoal;
                goals.carbs = carbGoal;
                goals.fat = fatGoal;

                if (goal === 'recomposition') {
                    planHtml += `<ul class="list-disc list-inside space-y-1">
                        <li><strong>Daily Calories:</strong> ${Math.round(calorieTarget)} kcal</li>
                        <li><strong>Protein:</strong> ~${Math.round(proteinGoal)}g</li>
                        <li><strong>Carbs:</strong> ~${Math.round(carbGoal)}g</li>
                        <li><strong>Fat:</strong> ~${Math.round(fatGoal)}g</li>
                    </ul>`;
                } else {
                     const highDay = calorieTarget + 150;
                     const lowDay = calorieTarget - 150;
                     planHtml += `<ul class="list-disc list-inside space-y-1">
                        <li><strong>Average Daily Target:</strong> ${Math.round(calorieTarget)} kcal</li>
                        <li><strong>Workout Days (Higher Calorie):</strong> ${Math.round(highDay)} kcal</li>
                        <li><strong>Rest Days (Lower Calorie):</strong> ${Math.round(lowDay)} kcal</li>
                    </ul>`;
                }
                planHtml += `<p class="text-sm text-gray-400 mt-3">This plan will adapt based on your daily check-ins.</p>`;
                
                caloriePlanOutput.innerHTML = planHtml;
                updateSummary();
            };
            function calculateAndSaveGoals(showFeedback = true) {
                const btn = profileForm.querySelector('button[type="submit"]');
                userProfile.age = parseInt(profileForm.age.value);
                userProfile.gender = profileForm.gender.value;
                userProfile.height = parseInt(profileForm.height.value);
                userProfile.weight = parseFloat(profileForm.weight.value);
                userProfile.bodyFat = parseFloat(profileForm['body-fat'].value) || null;
                userProfile.smm = parseFloat(profileForm['smm'].value) || null;
                userProfile.bfm = parseFloat(profileForm['bfm'].value) || null;
                userProfile.activityLevel = parseFloat(profileForm['activity-level'].value);
                userProfile.goal = profileForm['user-goal'].value;
                userProfile.recompDeficit = parseInt(document.getElementById('recomp-deficit-input').value) || 500;
                
                const today = new Date().toISOString().split('T')[0];
                const lastWeightEntry = userProfile.weightHistory.find(entry => entry.date === today);

                if(!lastWeightEntry) {
                     userProfile.weightHistory.push({ date: today, weight: userProfile.weight });
                } else {
                    lastWeightEntry.weight = userProfile.weight;
                }

                if (userProfile.smm && userProfile.bfm) {
                    const todayInBodyIndex = userProfile.inbodyHistory.findIndex(entry => entry.date === today);
                    if (todayInBodyIndex > -1) {
                        userProfile.inbodyHistory[todayInBodyIndex].smm = userProfile.smm;
                        userProfile.inbodyHistory[todayInBodyIndex].bfm = userProfile.bfm;
                    } else {
                        userProfile.inbodyHistory.push({ date: today, smm: userProfile.smm, bfm: userProfile.bfm });
                    }
                }
                
                let bmr;
                const manualBMR = parseFloat(bmrInput.value);
                if (manualBMR && manualBMR > 0) {
                    bmr = manualBMR;
                } else {
                    if (userProfile.gender === 'male') bmr = 10 * userProfile.weight + 6.25 * userProfile.height - 5 * userProfile.age + 5;
                    else bmr = 10 * userProfile.weight + 6.25 * userProfile.height - 5 * userProfile.age - 161;
                    bmrInput.placeholder = Math.round(bmr);
                }
                userProfile.bmr = bmr;
                
                const bmi = userProfile.weight / ((userProfile.height / 100) ** 2);
                userProfile.bmi = bmi;
                bmiInput.value = bmi.toFixed(1);

                const tdee = bmr * userProfile.activityLevel;
                userProfile.tdee = tdee;

                let calorieTarget = tdee;
                if(userProfile.goal === 'lose') calorieTarget -= 400;
                if(userProfile.goal === 'gain') calorieTarget += 300;
                if(userProfile.goal === 'recomposition') calorieTarget = tdee - userProfile.recompDeficit; 
                
                userProfile.calorieTarget = Math.round((calorieTarget)/100) * 100;

                generateCalorieCycle();
                saveData();
                renderSmmBfmCharts();
                renderWeightChart();

                if (showFeedback) {
                    btn.textContent = "Saved!";
                    setTimeout(() => {
                        btn.textContent = "Save & Calculate Goals";
                    }, 2000);
                }
            };

            function openExerciseDetailModal(itemName, itemType, dayType = null) {
                let item;
                if (itemType === 'warmup') {
                    if (!dayType || !warmups[dayType]) return;
                    item = warmups[dayType].find(w => w.name === itemName);
                } else {
                    item = exerciseDB.find(ex => ex.name === itemName);
                }

                if (!item) return;

                currentlyLoggingExercise = item.name;

                exerciseDetailTitle.textContent = item.name;
                exerciseDetailVideo.src = item.videoPlaceholder || "https://placehold.co/400x225/374151/FFFFFF?text=No+Video";
                
                const instructions = Array.isArray(item.instructions) ? item.instructions : (item.instructions || "").split('\n');
                exerciseDetailInstructions.innerHTML = instructions.map(step => `<li>${step}</li>`).join('');

                exerciseDetailRepRange.textContent = item.repRange ? `Aim for ${item.repRange}.` : 'No specific rep range.';
                exerciseDetailNotes.value = item.notes || '';
                
                logFromDetailBtn.style.display = itemType === 'warmup' ? 'none' : 'block';
                
                exerciseDetailModal.style.display = 'flex';
            }
            
            function openWorkoutModal(exerciseName) {
                editingWorkoutLogIndex = null;
                currentlyLoggingExercise = exerciseName;
                modalTitle.textContent = `Log: ${exerciseName}`;
                saveWorkoutBtn.textContent = 'Save Workout';
                setsContainer.innerHTML = '';
                addSetRow();
                addSetRow();
                addSetRow();
                workoutModal.style.display = 'flex';
            };
            function openEditWorkoutModal(index) {
                editingWorkoutLogIndex = index;
                const logEntry = workoutHistory[index];
                currentlyLoggingExercise = logEntry.name;
                modalTitle.textContent = `Edit: ${logEntry.name}`;
                saveWorkoutBtn.textContent = 'Update Workout';
                setsContainer.innerHTML = '';
                logEntry.sets.forEach(set => addSetRow(set));
                workoutModal.style.display = 'flex';
            };
            function closeWorkoutModal() {
                workoutModal.style.display = 'none';
                editingWorkoutLogIndex = null;
            };
            function addSetRow(setParts = [{weight: '', reps: '', partial: false}]) {
                const setNumber = setsContainer.children.length + 1;
                const row = document.createElement('div');
                row.className = 'set-row border border-gray-600 p-3 rounded-lg space-y-2';
                
                let content = `<div class="flex justify-between items-center">
                    <label class="font-bold text-lg">Set ${setNumber}</label>
                    <div>
                        <button type="button" class="add-part-btn text-blue-400 hover:text-blue-300 p-1" title="Add drop set / pyramid">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                        </button>
                        <button type="button" class="remove-set-btn text-red-500 hover:text-red-400 p-1" title="Delete set">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </div>
                </div>
                <div class="parts-container space-y-2"></div>`;

                row.innerHTML = content;
                setsContainer.appendChild(row);
                
                const partsContainer = row.querySelector('.parts-container');
                setParts.forEach(part => addWeightRepPart(partsContainer, part.weight, part.reps, part.partial));

                row.querySelector('.add-part-btn').addEventListener('click', () => addWeightRepPart(partsContainer));
            };

            function addWeightRepPart(container, weight='', reps='', isPartial=false) {
                const partHtml = `
                    <div class="set-part-row grid grid-cols-12 gap-2 items-center">
                        <input type="number" step="0.25" placeholder="Weight (kg)" value="${weight}" class="w-full bg-gray-600 border border-gray-500 rounded-md p-2 col-span-5 set-weight">
                        <span class="text-center col-span-1">x</span>
                        <input type="number" placeholder="Reps" value="${reps}" class="w-full bg-gray-600 border border-gray-500 rounded-md p-2 col-span-2 set-reps">
                        <div class="col-span-3 flex items-center justify-center">
                            <input type="checkbox" ${isPartial ? 'checked' : ''} class="form-checkbox h-5 w-5 bg-gray-600 border-gray-500 rounded text-blue-500 focus:ring-blue-500 set-partial">
                            <label class="ml-2 text-sm">Partial</label>
                        </div>
                        <button type="button" class="remove-part-btn text-gray-500 hover:text-red-400 p-1 col-span-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                        </button>
                    </div>`;
                container.insertAdjacentHTML('beforeend', partHtml);
            };


             function renderWorkoutHistory() {
                if (workoutHistory.length === 0) {
                    workoutHistoryDiv.innerHTML = '<p class="text-gray-500 text-center">No workouts logged yet.</p>';
                    return;
                }
                workoutHistoryDiv.innerHTML = workoutHistory.map((log, index) => ({...log, originalIndex: index}))
                .reverse()
                .map(log => {
                    const setsHtml = log.sets.map((setParts, i) => {
                        const partsHtml = setParts.map(part => `${part.weight} kg x ${part.reps} reps ${part.partial ? '<span class="text-yellow-400">(P)</span>' : ''}`).join(', ');
                        return `<span><strong>Set ${i+1}:</strong> ${partsHtml}</span>`;
                    }).join('<br>');
                    
                    return `
                    <div class="bg-gray-700 p-4 rounded-md">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-lg text-blue-400">${log.name}</h4>
                                <span class="text-sm text-gray-400">${new Date(log.date).toLocaleDateString()}</span>
                            </div>
                            <div class="flex gap-2">
                                <button class="edit-log-btn p-1 hover:bg-gray-600 rounded" data-index="${log.originalIndex}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><line x1="18" y1="2" x2="22" y2="6"/><path d="M7.5 20.5 19 9l-4-4L3.5 16.5 2 22z"/></svg>
                                </button>
                                <button class="delete-log-btn p-1 hover:bg-gray-600 rounded" data-index="${log.originalIndex}">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="text-sm space-y-1">
                           ${setsHtml}
                        </div>
                    </div>
                `}).join('');
            };
            function showConfirmModal(title, text, onConfirm) {
                confirmModalTitle.textContent = title;
                confirmModalText.textContent = text;
                confirmCallback = onConfirm;
                confirmModal.style.display = 'flex';
            };
            function showCustomAlert(title, text) {
                alertModalTitle.textContent = title;
                alertModalText.textContent = text;
                alertModal.style.display = 'flex';
            };

            function showPromptModal(title, text, defaultValue, onConfirm) {
                promptModalTitle.textContent = title;
                promptModalText.textContent = text;
                promptModalInput.value = defaultValue;
                promptCallback = onConfirm;
                promptModal.style.display = 'flex';
                promptModalInput.focus();
                promptModalInput.select();
            }

            function hideConfirmModal() {
                confirmModal.style.display = 'none';
                confirmCallback = null;
            };

            function populateExerciseModal(exercise = null) {
                const groupSelect = document.getElementById('exercise-group');
                const muscleGroups = [...new Set(defaultExerciseDB.map(ex => ex.group))].sort();
                groupSelect.innerHTML = muscleGroups.map(g => `<option value="${g}">${g}</option>`).join('');

                
                if (exercise) {
                    exerciseModalTitle.textContent = "Edit Exercise";
                    document.getElementById('exercise-name').value = exercise.name;
                    groupSelect.value = exercise.group;
                    document.getElementById('exercise-type').value = exercise.type;
                    editingExerciseName = exercise.name;
                } else {
                    exerciseModalTitle.textContent = "Add New Exercise";
                    exerciseForm.reset();
                    editingExerciseName = null;
                }
                exerciseModal.style.display = 'flex';
            };
            
            function renderAIWorkoutAnalysis(){
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

                const recentWorkouts = workoutHistory.filter(log => new Date(log.date) >= oneWeekAgo);
                
                const volumeByGroup = {};

                recentWorkouts.forEach(log => {
                    const exercise = exerciseDB.find(ex => ex.name === log.name);
                    if(exercise) {
                        if(!volumeByGroup[exercise.group]) {
                            volumeByGroup[exercise.group] = 0;
                        }
                        volumeByGroup[exercise.group] += log.sets.length;
                    }
                });

                const recommendations = {
                    'Chest': {min: 10, max: 20},
                    'Back': {min: 10, max: 20},
                    'Quads': {min: 8, max: 20},
                    'Hamstrings': {min: 6, max: 16},
                    'Shoulders': {min: 8, max: 20},
                    'Biceps': {min: 8, max: 20},
                    'Triceps': {min: 6, max: 16},
                    'Glutes': {min: 4, max: 12},
                    'Calves': {min: 8, max: 16},
                    'Abs': {min: 8, max: 20},
                    'Forearms': {min: 4, max: 12},
                };
                
                let analysisHtml = '';
                const allGroups = [...new Set(exerciseDB.map(e => e.group))].sort();

                allGroups.forEach(group => {
                    const volume = volumeByGroup[group] || 0;
                    const rec = recommendations[group] || {min: 0, max: 0};
                    let statusColor = 'text-gray-400';
                    let statusText = 'Not trained';

                    if (volume > 0) {
                        if (volume < rec.min) {
                            statusColor = 'text-yellow-400';
                            statusText = 'Low Volume';
                        } else if (volume > rec.max) {
                            statusColor = 'text-red-400';
                            statusText = 'High Volume (Risk of overtraining)';
                        } else {
                            statusColor = 'text-green-400';
                            statusText = 'Good Volume';
                        }
                    }

                    analysisHtml += `
                    <div class="flex justify-between items-center text-sm">
                        <span class="font-bold">${group}</span>
                        <div class="flex items-center gap-3">
                           <span>${volume} sets / week</span>
                           <span class="${statusColor}">${statusText}</span>
                        </div>
                    </div>
                    `;
                });
                
                volumeAnalysisDiv.innerHTML = analysisHtml;
            }

            function switchPage(pageToShow) {
                [pageNutrition, pageWorkouts, pageGoals, pageSleep].forEach(page => page.classList.remove('page-active'));
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('nav-active'));

                const pageMap = { nutrition: pageNutrition, workouts: pageWorkouts, goals: pageGoals, sleep: pageSleep };
                const navMap = { nutrition: navNutrition, workouts: navWorkouts, goals: navGoals, sleep: navSleep };

                if (pageMap[pageToShow]) pageMap[pageToShow].classList.add('page-active');
                if (navMap[pageToShow]) navMap[pageToShow].classList.add('nav-active');
            };

            function renderWarmupManagementList() {
                const dayType = warmupDaySelect.value;
                const currentWarmups = warmups[dayType] || [];
                warmupListDiv.innerHTML = currentWarmups.map((warmup, index) => `
                    <div class="flex justify-between items-center bg-gray-600 p-2 rounded-md">
                        <span>${warmup.name}</span>
                        <div class="flex gap-2">
                             <button class="edit-warmup-btn p-1" data-index="${index}" data-day-type="${dayType}" title="Edit Warmup"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil text-gray-400 hover:text-yellow-400 pointer-events-none"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>
                            <button class="delete-warmup-btn p-1" data-index="${index}" data-day-type="${dayType}" title="Delete Warmup"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 text-gray-400 hover:text-red-500 pointer-events-none"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg></button>
                        </div>
                    </div>
                `).join('');
            }


            // --- INITIALIZATION ---
            function fullRender() {
                populateFavoritesDatalist();
                renderFavoritesList();
                renderSavedRecipesList();
                populateProfileForm();
                if(userProfile.age) generateCalorieCycle();
                updateSummary();
                renderDailyLog();
                renderWorkoutPlanner();
                renderWorkoutHistory();
                populateProgressSelect();
                renderProgressionChart(progressExerciseSelect.value);
                renderWeightChart();
                renderSmmBfmCharts();
                calculateWakeUpTimes();
                renderSleepHistory();
                renderAIWorkoutAnalysis();
                lucide.createIcons();
            }
            
            loadData();
            fullRender();

             // --- ALL EVENT LISTENERS ---
            foodNameInput.addEventListener('input', autoPopulateFromFavorites);
            foodGramsInput.addEventListener('input', autoPopulateFromFavorites);
            addFoodBtn.addEventListener('click', () => {
                addFoodError.textContent = '';
                const foodName = foodNameInput.value.trim();
                let grams = parseFloat(foodGramsInput.value);
                const servings = parseFloat(document.getElementById('food-servings-input').value);
                const calories = parseFloat(document.getElementById('food-calories-input').value);
                const protein = parseFloat(document.getElementById('food-protein-input').value);
                const carbs = parseFloat(document.getElementById('food-carbs-input').value);
                const fat = parseFloat(document.getElementById('food-fat-input').value);

                if (!foodName || isNaN(servings) || servings <= 0 || isNaN(calories) || isNaN(protein) || isNaN(carbs) || isNaN(fat)) {
                    addFoodError.textContent = "Please fill in food name, servings, and all macro fields.";
                    return;
                }

                if (foodGramsInput.value.trim() !== '' && (isNaN(grams) || grams <= 0)) {
                    addFoodError.textContent = "If you enter grams, it must be a positive number.";
                    return;
                }
                
                if (isNaN(grams)) {
                    grams = 0;
                }
                
                const totalGrams = grams * servings;
                const foodItem = { 
                    name: foodName, 
                    grams: totalGrams, 
                    calories: calories * servings, 
                    protein: protein * servings, 
                    carbs: carbs * servings, 
                    fat: fat * servings 
                };

                if (editingFoodLogIndex !== null) {
                    dailyLog[editingFoodLogIndex] = foodItem;
                } else {
                    dailyLog.push(foodItem);
                }

                editingFoodLogIndex = null;
                addFoodBtn.querySelector('.btn-text').textContent = "Add Food to Log";

                logMealForm.reset();
                // foodGramsInput.value = 100; // Removed this to keep it optional
                document.getElementById('food-servings-input').value = 1;
                saveData();
                fullRender();
            });
            dailyLogDiv.addEventListener('click', (e) => {
                 const removeBtn = e.target.closest('.remove-item-btn');
                 const editBtn = e.target.closest('.edit-food-btn');
                 const favoriteBtn = e.target.closest('.favorite-food-btn');

                if (removeBtn) {
                    const index = parseInt(removeBtn.dataset.index, 10);
                    dailyLog.splice(index, 1);
                    saveData();
                    fullRender();
                }

                if(editBtn) {
                    const index = parseInt(editBtn.dataset.index, 10);
                    openEditFoodModal(index);
                }

                if(favoriteBtn) {
                    const index = parseInt(favoriteBtn.dataset.index, 10);
                    toggleFavorite(index);
                }
            });
            aiSuggestionBtn.addEventListener('click', async () => {
                 const btnText = aiSuggestionBtn.querySelector('.btn-text');
                const loader = aiSuggestionBtn.querySelector('.loader');
                const ingredients = document.getElementById('ai-ingredients').value.trim();

                if (!ingredients) {
                    aiSuggestionsOutput.innerHTML = `<p class="text-yellow-400">Please enter some ingredients you have.</p>`;
                    return;
                }
                
                btnText.textContent = 'Generating...';
                loader.classList.remove('hidden');
                aiSuggestionsOutput.innerHTML = '';

                const totals = dailyLog.reduce((acc, item) => ({
                    calories: acc.calories + item.calories, protein: acc.protein + item.protein, carbs: acc.carbs + item.carbs, fat: acc.fat + item.fat
                }), { calories: 0, protein: 0, carbs: 0, fat: 0 });

                const remainingCalories = Math.max(0, goals.calories - totals.calories);

                const prompt = `I have the following ingredients: ${ingredients}. I have about ${remainingCalories} calories left for the day. My primary goal is ${userProfile.goal || 'maintain weight'}. Suggest one simple, healthy, and easy-to-prepare meal idea that uses some of these ingredients. Provide the meal name, estimated prep and cook time, and a simple numbered list of step-by-step instructions. Format the output with clear headings for 'Time' and 'Instructions'.`;

                const apiUrl = getApiUrl('gemini-2.5-flash-preview-05-20');
                
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    let text = result.candidates[0].content.parts[0].text;

                    text = text.replace(/\*\*(.*?)\*\*/g, '<h3>$1</h3>'); 
                    text = text.replace(/\*/g, '');
                    text = text.replace(/(\d+\.)/g, '<br>$1');

                    aiSuggestionsOutput.innerHTML = `<div class="bg-gray-700 p-4 rounded-md prose prose-invert max-w-none text-gray-300">${text}</div>`;
                } catch (error) {
                    console.error("AI Suggestion Error:", error);
                    aiSuggestionsOutput.innerHTML = `<p class="text-red-400">Sorry, couldn't get a suggestion right now.</p>`;
                } finally {
                    btnText.textContent = 'Generate Ideas';
                    loader.classList.add('hidden');
                }
            });
            aiGetMacrosBtn.addEventListener('click', async () => {
                const foodName = foodNameInput.value.trim();
                const grams = parseFloat(foodGramsInput.value);
                if (!foodName || isNaN(grams) || grams <= 0) {
                    addFoodError.textContent = "Please enter a valid food and gram amount first.";
                    return;
                }
                addFoodError.textContent = "";

                const btn = aiGetMacrosBtn;
                btn.disabled = true;
                btn.querySelector('.btn-text').textContent = "Analyzing...";
                btn.querySelector('.loader').classList.remove('hidden');

                const prompt = `Calculate the nutritional information (calories, protein, carbs, fat) for ${grams}g of ${foodName}. Respond with only the JSON object.`;
                const apiUrl = getApiUrl('gemini-2.5-flash-preview-05-20');
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                calories: { type: "NUMBER" },
                                protein: { type: "NUMBER" },
                                carbs: { type: "NUMBER" },
                                fat: { type: "NUMBER" }
                            }
                        }
                    }
                };
                
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    if (!result.candidates || !result.candidates[0].content.parts[0].text) throw new Error("Invalid API response.");

                    const data = JSON.parse(result.candidates[0].content.parts[0].text);
                    document.getElementById('food-calories-input').value = data.calories.toFixed(1);
                    document.getElementById('food-protein-input').value = data.protein.toFixed(1);
                    document.getElementById('food-carbs-input').value = data.carbs.toFixed(1);
                    document.getElementById('food-fat-input').value = data.fat.toFixed(1);

                } catch (error) {
                    console.error("AI Get Macros Error:", error);
                    addFoodError.textContent = "Could not fetch nutrition data.";
                } finally {
                    btn.disabled = false;
                    btn.querySelector('.btn-text').textContent = "Get Macros with AI";
                    btn.querySelector('.loader').classList.add('hidden');
                }
            });
            
            // --- New Food Scanner Listeners ---
            function fileToGenerativePart(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64Data = reader.result.split(',')[1];
                        resolve({
                            inlineData: {
                                mimeType: file.type,
                                data: base64Data
                            }
                        });
                    };
                    reader.onerror = (err) => reject(err);
                    reader.readAsDataURL(file);
                });
            }

            function handleImageSelection(file) {
                if (file) {
                    scannedImageData = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        imagePreview.classList.remove('hidden');
                        imagePlaceholder.classList.add('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            scanFoodBtn.addEventListener('click', () => {
                // Reset modal state
                scannedImageData = null;
                imagePreview.src = '';
                imagePreview.classList.add('hidden');
                imagePlaceholder.classList.remove('hidden');
                document.getElementById('scanner-food-name').value = '';
                document.getElementById('scanner-food-details').value = '';
                foodScannerStatus.textContent = '';
                foodScannerModal.style.display = 'flex';
            });

            closeFoodScannerModalBtn.addEventListener('click', () => {
                foodScannerModal.style.display = 'none';
            });

            uploadPhotoInput.addEventListener('change', (e) => handleImageSelection(e.target.files[0]));
            takePictureInput.addEventListener('change', (e) => handleImageSelection(e.target.files[0]));
            
            aiGetMacrosFromImageBtn.addEventListener('click', async () => {
                const foodName = document.getElementById('scanner-food-name').value.trim();
                const foodDetails = document.getElementById('scanner-food-details').value.trim();
                const foodGrams = document.getElementById('scanner-food-grams').value.trim();

                if (!scannedImageData) {
                    foodScannerStatus.textContent = 'Please upload or take a photo.';
                    return;
                }
                if (!foodName) {
                    foodScannerStatus.textContent = 'Please enter a food name to help the AI.';
                    return;
                }

                const btn = aiGetMacrosFromImageBtn;
                btn.disabled = true;
                btn.querySelector('.btn-text').style.display = 'none';
                btn.querySelector('.loader').classList.remove('hidden');
                foodScannerStatus.textContent = 'Analyzing image...';

                try {
                    const imagePart = await fileToGenerativePart(scannedImageData);
                    let prompt;

                    if (foodGrams && !isNaN(parseFloat(foodGrams)) && parseFloat(foodGrams) > 0) {
                        prompt = `Analyze the food in this image. The user has identified it as "${foodName}" and specified the portion is ${foodGrams}g. Additional details: "${foodDetails}". Calculate the nutritional information (calories, protein, carbs, fat) for this ${foodGrams}g portion. Respond ONLY with a valid JSON object with the keys "grams", "calories", "protein", "carbs", and "fat". The "grams" key in your response should be ${foodGrams}.`;
                    } else {
                        prompt = `Analyze the food in this image. The user has identified it as "${foodName}". Additional details: "${foodDetails}". Estimate the total grams and the nutritional information (calories, protein, carbs, fat) for the entire portion shown. Respond ONLY with a valid JSON object with the keys "grams", "calories", "protein", "carbs", and "fat".`;
                    }
                    

                    const apiUrl = getApiUrl('gemini-2.5-flash-preview-05-20');
                    const payload = {
                        contents: [{
                            parts: [{ text: prompt }, imagePart]
                        }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    grams: { type: "NUMBER" },
                                    calories: { type: "NUMBER" },
                                    protein: { type: "NUMBER" },
                                    carbs: { type: "NUMBER" },
                                    fat: { type: "NUMBER" }
                                }
                            }
                        }
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.status} ${await response.text()}`);
                    const result = await response.json();
                    
                    if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                        throw new Error("Invalid API response format.");
                    }
                    
                    const data = JSON.parse(result.candidates[0].content.parts[0].text);

                    // Populate the main form
                    foodNameInput.value = foodName;
                    foodGramsInput.value = data.grams.toFixed(0);
                    document.getElementById('food-servings-input').value = 1; // It's for the whole portion
                    document.getElementById('food-calories-input').value = data.calories.toFixed(1);
                    document.getElementById('food-protein-input').value = data.protein.toFixed(1);
                    document.getElementById('food-carbs-input').value = data.carbs.toFixed(1);
                    document.getElementById('food-fat-input').value = data.fat.toFixed(1);
                    
                    foodScannerModal.style.display = 'none';
                    showCustomAlert('Success!', 'Macros have been estimated and populated in the form.');

                } catch (error) {
                    console.error("AI Image Scan Error:", error);
                    foodScannerStatus.textContent = "Error analyzing image. Please try again.";
                } finally {
                    btn.disabled = false;
                    btn.querySelector('.btn-text').style.display = 'inline';
                    btn.querySelector('.loader').classList.add('hidden');
                }
            });


            document.getElementById('sleep-start-time').addEventListener('change', (e) => {
                const startTime = e.target.value;
                if(startTime) {
                    const [hours, minutes] = startTime.split(':').map(Number);
                    const startDate = new Date();
                    startDate.setHours(hours, minutes, 0, 0);
                    const wakeUpDate = new Date(startDate.getTime() + (8 * 60 * 60 * 1000)); // Suggest 8 hours later
                    const wakeHours = wakeUpDate.getHours().toString().padStart(2, '0');
                    const wakeMinutes = wakeUpDate.getMinutes().toString().padStart(2, '0');
                    document.getElementById('sleep-end-time').value = `${wakeHours}:${wakeMinutes}`;
                }
            });
            sleepLogForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const startTime = document.getElementById('sleep-start-time').value;
                const endTime = document.getElementById('sleep-end-time').value;
                const notes = document.getElementById('sleep-notes').value;
                if (!startTime || !endTime || currentSleepQuality === 0) {
                    showCustomAlert('Missing Info', 'Please fill in sleep/wake times and select a quality rating.');
                    return;
                }
                const today = new Date().toISOString().split('T')[0];
                const sleepLog = { date: today, startTime, endTime, quality: currentSleepQuality, notes };
                userProfile.sleepHistory.push(sleepLog);
                saveData();
                renderSleepHistory();
                sleepLogForm.reset();
                currentSleepQuality = 0;
                Array.from(sleepQualityRatingDiv.children).forEach(span => span.classList.remove('selected'));
            });
            editSleepLogForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const updatedLog = {
                    date: userProfile.sleepHistory[editingSleepLogIndex].date,
                    startTime: document.getElementById('edit-sleep-start-time').value,
                    endTime: document.getElementById('edit-sleep-end-time').value,
                    notes: document.getElementById('edit-sleep-notes').value,
                    quality: currentEditSleepQuality
                };
                userProfile.sleepHistory[editingSleepLogIndex] = updatedLog;
                saveData();
                renderSleepHistory();
                editSleepModal.style.display = 'none';
            });
            sleepQualityRatingDiv.addEventListener('click', (e) => {
                if (e.target.tagName === 'SPAN') {
                    currentSleepQuality = parseInt(e.target.dataset.value, 10);
                    Array.from(sleepQualityRatingDiv.children).forEach(span => {
                        span.classList.toggle('selected', parseInt(span.dataset.value, 10) <= currentSleepQuality);
                    });
                }
            });
            editSleepQualityRatingDiv.addEventListener('click', (e) => {
                if (e.target.tagName === 'SPAN') {
                    currentEditSleepQuality = parseInt(e.target.dataset.value, 10);
                    Array.from(editSleepQualityRatingDiv.children).forEach(span => {
                        span.classList.toggle('selected', parseInt(span.dataset.value, 10) <= currentEditSleepQuality);
                    });
                }
            });
            sleepHistoryDiv.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-sleep-btn');
                const deleteBtn = e.target.closest('.delete-sleep-btn');
                if (editBtn) openEditSleepModal(parseInt(editBtn.dataset.index));
                if (deleteBtn) {
                     const indexToDelete = parseInt(deleteBtn.dataset.index);
                     showConfirmModal('Delete Sleep Log?', 'Are you sure?', () => {
                        userProfile.sleepHistory.splice(indexToDelete, 1);
                        saveData();
                        renderSleepHistory();
                    });
                }
            });
            closeEditSleepModalBtn.addEventListener('click', () => editSleepModal.style.display = 'none');
            progressExerciseSelect.addEventListener('change', (e) => renderProgressionChart(e.target.value));
            
            profileForm.addEventListener('submit', (e) => { 
                e.preventDefault(); 
                if(!profileForm.age.value || !profileForm.height.value || !profileForm.weight.value){
                    showCustomAlert('Missing Information', 'Please fill in Age, Height, and Weight to calculate your goals.');
                    return;
                }
                calculateAndSaveGoals(); 
            });

            ['user-goal', 'activity-level', 'recomp-deficit-input', 'bmr-input'].forEach(id => {
                 document.getElementById(id).addEventListener('change', () => {
                    if (userProfile.age) { // Only auto-recalculate if a profile is set up
                        calculateAndSaveGoals(false);
                    }
                    if(id === 'user-goal') {
                        populateProfileForm();
                    }
                });
            });
            
            bmiInput.addEventListener('change', (e) => { userProfile.bmi = parseFloat(e.target.value); saveData(); });
            
            closeModalBtn.addEventListener('click', closeWorkoutModal);
            addSetBtn.addEventListener('click', () => addSetRow());
            alertModalOkBtn.addEventListener('click', () => { alertModal.style.display = 'none'; });

            promptModalOkBtn.addEventListener('click', () => {
                if (promptCallback) {
                    promptCallback(promptModalInput.value);
                }
                promptModal.style.display = 'none';
                promptCallback = null;
            });

            promptModalCancelBtn.addEventListener('click', () => {
                promptModal.style.display = 'none';
                promptCallback = null;
            });

            promptModalInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    promptModalOkBtn.click();
                }
            });

            addExerciseBtn.addEventListener('click', () => populateExerciseModal());
            closeExerciseModalBtn.addEventListener('click', () => exerciseModal.style.display = 'none');
            getAIAdviceBtn.addEventListener('click', getAIWorkoutAdvice);
            backupDataBtn.addEventListener('click', () => {
                const dataToBackup = {
                    dailyLog, userProfile, workoutHistory, exerciseDB,
                    favoriteFoods, savedRecipes, goals, warmups
                };
                const dataStr = JSON.stringify(dataToBackup, null, 2);
                const blob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fittrack_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showCustomAlert('Success', 'Your data has been backed up.');
            });
            restoreDataInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const restoredData = JSON.parse(event.target.result);
                        dailyLog = restoredData.dailyLog || [];
                        userProfile = restoredData.userProfile || { weightHistory: [], inbodyHistory: [], sleepHistory: [] };
                        workoutHistory = restoredData.workoutHistory || [];
                        exerciseDB = restoredData.exerciseDB || defaultExerciseDB;
                        warmups = restoredData.warmups || defaultWarmups;
                        favoriteFoods = restoredData.favoriteFoods || [];
                        savedRecipes = restoredData.savedRecipes || [];
                        goals = restoredData.goals || { calories: 2000, protein: 150, carbs: 225, fat: 60 };
                        saveData();
                        fullRender();
                        showCustomAlert('Success', 'Your data has been restored.');
                    } catch (err) {
                        showCustomAlert('Error', 'Could not read the backup file. It may be corrupted.');
                        console.error("Restore error: ", err);
                    }
                };
                reader.readAsText(file);
                e.target.value = ''; // Reset input
            });

            deleteAllDataBtn.addEventListener('click', () => {
                showConfirmModal('Delete All Data?', 'This will permanently erase all your saved food, workout, and profile data. This action cannot be undone.', () => {
                    localStorage.clear();
                    location.reload();
                });
            });

            navNutrition.addEventListener('click', () => switchPage('nutrition'));
            navWorkouts.addEventListener('click', () => switchPage('workouts'));
            navGoals.addEventListener('click', () => switchPage('goals'));
            navSleep.addEventListener('click', () => switchPage('sleep'));
            
            // --- WORKOUTS PAGE EVENT LISTENERS (REFACTORED & FIXED) ---

            workoutPlannerDiv.addEventListener('click', (e) => {
                const logBtn = e.target.closest('.log-workout-btn');
                const editBtn = e.target.closest('.edit-exercise-btn');
                const deleteBtn = e.target.closest('.delete-exercise-btn');
                const warmupBtn = e.target.closest('.warmup-detail-btn');
                const closeBtn = e.target.closest('.close-expanded-day-btn');
                const dayCard = e.target.closest('.workout-day-card');
                const editWarmupBtn = e.target.closest('.edit-warmup-btn');
                const deleteWarmupBtn = e.target.closest('.delete-warmup-btn');

                if (logBtn || editBtn || deleteBtn || warmupBtn || closeBtn || editWarmupBtn || deleteWarmupBtn) {
                    e.stopPropagation();
                }

                if (logBtn) {
                    openExerciseDetailModal(logBtn.dataset.name, 'exercise');
                } else if (warmupBtn) {
                    openExerciseDetailModal(warmupBtn.dataset.name, 'warmup', warmupBtn.dataset.dayType);
                } else if (editBtn) {
                    const exercise = exerciseDB.find(ex => ex.name === editBtn.dataset.name);
                    if (exercise) populateExerciseModal(exercise);
                } else if (deleteBtn) {
                    const exerciseName = deleteBtn.dataset.name;
                    showConfirmModal('Delete Exercise?', `This will remove "${exerciseName}" from the planner, but not from your past workout history.`, () => {
                        const indexToDelete = exerciseDB.findIndex(ex => ex.name === exerciseName);
                        if (indexToDelete > -1) {
                            exerciseDB.splice(indexToDelete, 1);
                            saveData();
                            fullRender();
                        }
                    });
                } else if (editWarmupBtn) {
                    const dayType = editWarmupBtn.dataset.dayType;
                    const warmupName = editWarmupBtn.dataset.name;
                    const warmupIndex = warmups[dayType]?.findIndex(w => w.name === warmupName);

                    if (warmupIndex > -1) {
                        const warmup = warmups[dayType][warmupIndex];
                        
                        warmupManageModal.style.display = 'flex';
                        warmupDaySelect.value = dayType;
                        renderWarmupManagementList();
                        
                        editingWarmupIndex = warmupIndex;
                        warmupNameInput.value = warmup.name;
                        warmupInstructionsInput.value = Array.isArray(warmup.instructions) ? warmup.instructions.join('\n') : '';
                        warmupFormTitle.textContent = "Edit Warm-up";
                        saveWarmupBtn.textContent = "Update Warm-up";
                    }
                } else if (deleteWarmupBtn) {
                    const dayType = deleteWarmupBtn.dataset.dayType;
                    const warmupName = deleteWarmupBtn.dataset.name;
                    
                    showConfirmModal('Delete Warm-up?', `Are you sure you want to delete "${warmupName}"?`, () => {
                        if (warmups[dayType]) {
                            const indexToDelete = warmups[dayType].findIndex(w => w.name === warmupName);
                            if (indexToDelete > -1) {
                                warmups[dayType].splice(indexToDelete, 1);
                                saveData();
                                fullRender();
                            }
                        }
                    });
                } else if (closeBtn) {
                    const expandedCard = e.target.closest('.workout-day-card.expanded');
                    if (expandedCard) {
                        expandedCard.classList.remove('expanded');
                        const existingCloseBtn = expandedCard.querySelector('.close-expanded-day-btn');
                        if (existingCloseBtn) existingCloseBtn.remove();
                        document.querySelectorAll('#workout-planner .workout-day-card').forEach(card => card.classList.remove('hidden'));
                    }
                } else if (dayCard && !dayCard.classList.contains('expanded')) {
                    document.querySelectorAll('#workout-planner .workout-day-card').forEach(card => {
                        if (card !== dayCard) card.classList.add('hidden');
                    });
                    dayCard.classList.add('expanded');
                    const closeButton = document.createElement('button');
                    closeButton.innerHTML = '&times;';
                    closeButton.className = 'close-expanded-day-btn text-gray-400 hover:text-white text-5xl absolute top-4 right-6 z-10';
                    dayCard.prepend(closeButton);
                }
            });

             workoutHistoryDiv.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-log-btn');
                const deleteBtn = e.target.closest('.delete-log-btn');

                if(editBtn) {
                    openEditWorkoutModal(parseInt(editBtn.dataset.index));
                }
                if(deleteBtn) {
                    const indexToDelete = parseInt(deleteBtn.dataset.index);
                    showConfirmModal('Delete Log?', 'Are you sure you want to delete this workout log?', () => {
                        workoutHistory.splice(indexToDelete, 1);
                        saveData();
                        fullRender();
                    });
                }
            });

            closeExerciseDetailModalBtn.addEventListener('click', () => {
                exerciseDetailModal.style.display = 'none';
            });

            logFromDetailBtn.addEventListener('click', () => {
                exerciseDetailModal.style.display = 'none';
                openWorkoutModal(currentlyLoggingExercise);
            });

            saveExerciseNotesBtn.addEventListener('click', () => {
                const exercise = exerciseDB.find(ex => ex.name === currentlyLoggingExercise);
                 if (exercise) {
                    exercise.notes = exerciseDetailNotes.value;
                    saveData();
                    const btn = saveExerciseNotesBtn;
                    btn.textContent = 'Notes Saved!';
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btn.classList.add('bg-blue-600');
                    setTimeout(() => {
                        btn.textContent = 'Save Notes';
                        btn.classList.add('bg-green-600', 'hover:bg-green-700');
                        btn.classList.remove('bg-blue-600');
                    }, 2000);
                }
            });
            
            // --- Warmup Management Listeners ---
            manageWarmupsBtn.addEventListener('click', () => {
                editingWarmupIndex = null;
                warmupForm.reset();
                warmupFormTitle.textContent = "Add New Warm-up";
                saveWarmupBtn.textContent = "Add Warm-up";
                renderWarmupManagementList();
                warmupManageModal.style.display = 'flex';
            });

            closeWarmupManageModalBtn.addEventListener('click', () => {
                warmupManageModal.style.display = 'none';
            });

            warmupDaySelect.addEventListener('change', () => {
                editingWarmupIndex = null;
                warmupForm.reset();
                warmupFormTitle.textContent = "Add New Warm-up";
                saveWarmupBtn.textContent = "Add Warm-up";
                renderWarmupManagementList();
            });

            warmupListDiv.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-warmup-btn');
                const deleteBtn = e.target.closest('.delete-warmup-btn');
                
                if (editBtn) {
                    const dayType = editBtn.dataset.dayType;
                    const index = parseInt(editBtn.dataset.index);
                    const warmup = warmups[dayType]?.[index];
                    if(!warmup) return;

                    editingWarmupIndex = index;
                    warmupNameInput.value = warmup.name;
                    warmupInstructionsInput.value = Array.isArray(warmup.instructions) ? warmup.instructions.join('\n') : '';
                    warmupFormTitle.textContent = "Edit Warm-up";
                    saveWarmupBtn.textContent = "Update Warm-up";
                } else if (deleteBtn) {
                    const dayType = deleteBtn.dataset.dayType;
                    const index = parseInt(deleteBtn.dataset.index);
                    const warmupName = warmups[dayType]?.[index]?.name || 'this item';
                    showConfirmModal('Delete Warm-up?', `Are you sure you want to delete "${warmupName}"?`, () => {
                        if (warmups[dayType]) {
                           warmups[dayType].splice(index, 1);
                           saveData();
                           renderWarmupManagementList();
                           renderWorkoutPlanner(); 
                        }
                    });
                }
            });

            warmupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const dayType = warmupDaySelect.value;
                const name = warmupNameInput.value.trim();
                const instructions = warmupInstructionsInput.value.split('\n').filter(line => line.trim() !== '');

                if (!name) return;

                const newWarmup = {
                    name,
                    instructions,
                    repRange: "As needed",
                    videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=Warm-up"
                };

                if (!warmups[dayType]) warmups[dayType] = [];

                if (editingWarmupIndex !== null) {
                    warmups[dayType][editingWarmupIndex] = newWarmup;
                } else {
                    warmups[dayType].push(newWarmup);
                }
                
                saveData();
                renderWarmupManagementList();
                renderWorkoutPlanner();
                warmupForm.reset();
                warmupFormTitle.textContent = "Add New Warm-up";
                saveWarmupBtn.textContent = "Add Warm-up";
                editingWarmupIndex = null;
            });

            exerciseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('exercise-name').value.trim();
                const group = document.getElementById('exercise-group').value;
                const type = document.getElementById('exercise-type').value;

                if (!name || !group) {
                    showCustomAlert('Error', 'Please enter an exercise name and muscle group.');
                    return;
                }

                if (editingExerciseName) {
                    const exerciseIndex = exerciseDB.findIndex(ex => ex.name === editingExerciseName);
                    if (exerciseIndex > -1) {
                        if (name.toLowerCase() !== editingExerciseName.toLowerCase() && exerciseDB.some(ex => ex.name.toLowerCase() === name.toLowerCase())) {
                             showCustomAlert('Error', 'An exercise with this name already exists.');
                             return;
                        }
                        exerciseDB[exerciseIndex] = { ...exerciseDB[exerciseIndex], name, group, type };
                    }
                } else {
                    if (exerciseDB.some(ex => ex.name.toLowerCase() === name.toLowerCase())) {
                        showCustomAlert('Error', 'An exercise with this name already exists.');
                        return;
                    }
                    exerciseDB.push({
                        name,
                        group,
                        type,
                        instructions: ["No instructions added yet."],
                        repRange: "N/A",
                        videoPlaceholder: "https://placehold.co/400x225/374151/FFFFFF?text=No+Video",
                        notes: ""
                    });
                }

                editingExerciseName = null;
                exerciseModal.style.display = 'none';
                saveData();
                fullRender();
            });

            checkInForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const btn = checkInBtn;
                const weightInput = document.getElementById('check-in-weight');
                const newWeight = parseFloat(weightInput.value);

                if (!newWeight || newWeight <= 0) {
                    checkInFeedback.textContent = "Please enter a valid weight.";
                    checkInFeedback.className = 'mt-4 text-sm text-red-400';
                    return;
                }
                if (!userProfile.age) {
                     checkInFeedback.textContent = "Please fill out your profile before checking in.";
                     checkInFeedback.className = 'mt-4 text-sm text-red-400';
                     return;
                }

                btn.disabled = true;
                btn.querySelector('.btn-text').style.display = 'none';
                btn.querySelector('.loader').classList.remove('hidden');

                const today = new Date().toISOString().split('T')[0];
                const todayEntryIndex = userProfile.weightHistory.findIndex(entry => entry.date === today);

                if (todayEntryIndex > -1) {
                    userProfile.weightHistory[todayEntryIndex].weight = newWeight;
                } else {
                    userProfile.weightHistory.push({ date: today, weight: newWeight });
                }

                userProfile.weight = newWeight;
                profileForm.weight.value = newWeight; 

                saveData();
                renderWeightChart();
                
                if (userProfile.age) {
                    calculateAndSaveGoals(false); 
                }

                setTimeout(() => {
                    checkInFeedback.textContent = `Weight for ${today} logged as ${newWeight} kg. Your goals have been updated.`;
                    checkInFeedback.className = 'mt-4 text-sm text-green-400';
                    weightInput.value = '';
                    btn.disabled = false;
                    btn.querySelector('.btn-text').style.display = 'inline';
                    btn.querySelector('.loader').classList.add('hidden');
                }, 500);
            });

            // --- COMPOUND FOOD/RECIPE LISTENERS ---
            createRecipeBtn.addEventListener('click', () => {
                editingRecipeIndex = null; // Ensure we are in "create" mode
                compoundFoodModal.querySelector('h2').textContent = "Create a Recipe";
                saveRecipeBtn.textContent = "Save & Log Recipe";
                compoundFoodForm.reset();
                ingredientListContainer.innerHTML = '';
                addIngredientRow();
                addIngredientRow();
                updateRecipeTotals();
                compoundFoodModal.style.display = 'flex';
                recipeNameInput.focus();
            });
            closeCompoundFoodModalBtn.addEventListener('click', () => compoundFoodModal.style.display = 'none');
            addIngredientBtn.addEventListener('click', addIngredientRow);
            
            ingredientListContainer.addEventListener('input', updateRecipeTotals);
            
            compoundFoodForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = recipeNameInput.value.trim();
                if (!name) {
                    showCustomAlert('Missing Name', 'Please give your recipe a name.');
                    return;
                }
                
                // Check for name conflict only if it's a new recipe or the name has changed
                if (editingRecipeIndex === null || savedRecipes[editingRecipeIndex].name.toLowerCase() !== name.toLowerCase()) {
                    if (savedRecipes.some(r => r.name.toLowerCase() === name.toLowerCase()) || favoriteFoods.some(f => f.name.toLowerCase() === name.toLowerCase())) {
                        showCustomAlert('Name Exists', 'A favorite food or another recipe with this name already exists.');
                        return;
                    }
                }
                
                let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0, totalGrams = 0;
                const ingredients = [];
                
                const rows = document.querySelectorAll('.ingredient-row');
                if (rows.length === 0) {
                    showCustomAlert('No Ingredients', 'Please add at least one ingredient.');
                    return;
                }

                let hasValidIngredient = false;
                rows.forEach(row => {
                    const ingredient = {
                        name: row.querySelector('.ingredient-name').value.trim(),
                        grams: parseFloat(row.querySelector('.ingredient-grams').value) || 0,
                        calories: parseFloat(row.querySelector('.ingredient-calories').value) || 0,
                        protein: parseFloat(row.querySelector('.ingredient-protein').value) || 0,
                        carbs: parseFloat(row.querySelector('.ingredient-carbs').value) || 0,
                        fat: parseFloat(row.querySelector('.ingredient-fat').value) || 0,
                    };

                    if (ingredient.name && ingredient.grams > 0) {
                        hasValidIngredient = true;
                        totalGrams += ingredient.grams;
                        totalCalories += ingredient.calories;
                        totalProtein += ingredient.protein;
                        totalCarbs += ingredient.carbs;
                        totalFat += ingredient.fat;
                        ingredients.push(ingredient);
                    }
                });

                if (!hasValidIngredient) {
                    showCustomAlert('No Valid Ingredients', 'Please add at least one valid ingredient with its name and weight.');
                    return;
                }

                const newRecipe = {
                    name,
                    ingredients,
                    totalGrams,
                    calories: totalCalories,
                    protein: totalProtein,
                    carbs: totalCarbs,
                    fat: totalFat
                };
                
                if (editingRecipeIndex !== null) {
                    // Update existing recipe
                    savedRecipes[editingRecipeIndex] = newRecipe;
                    showCustomAlert('Success!', `Recipe "${name}" has been updated.`);
                } else {
                    // Save new recipe and log it
                    savedRecipes.push(newRecipe);
                    dailyLog.push({
                        name: newRecipe.name,
                        grams: newRecipe.totalGrams,
                        calories: newRecipe.calories,
                        protein: newRecipe.protein,
                        carbs: newRecipe.carbs,
                        fat: newRecipe.fat
                    });
                    showCustomAlert('Success!', `Recipe "${name}" has been saved and added to your log.`);
                }
                
                editingRecipeIndex = null;
                saveData();
                fullRender();
                compoundFoodModal.style.display = 'none';
            });


            // --- MISCELLANEOUS EVENT LISTENERS ---
            confirmModalConfirmBtn.addEventListener('click', () => {
                if(confirmCallback) confirmCallback();
                hideConfirmModal();
            });
            confirmModalCancelBtn.addEventListener('click', hideConfirmModal);
            
            workoutLogForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const sets = [];
                document.querySelectorAll('.set-row').forEach(row => {
                    const setParts = [];
                     row.querySelectorAll('.set-part-row').forEach(partRow => {
                        const weight = parseFloat(partRow.querySelector('.set-weight').value) || 0;
                        const reps = parseInt(partRow.querySelector('.set-reps').value) || 0;
                        const partial = partRow.querySelector('.set-partial').checked;
                        if(reps > 0) {
                            setParts.push({ weight, reps, partial });
                        }
                    });
                    if (setParts.length > 0) {
                        sets.push(setParts);
                    }
                });

                if(sets.length === 0) {
                    showCustomAlert('Empty Workout', 'Please log at least one set with reps.');
                    return;
                }

                const newLog = {
                    name: currentlyLoggingExercise,
                    date: new Date().toISOString(),
                    sets: sets
                };

                if(editingWorkoutLogIndex !== null) {
                    workoutHistory[editingWorkoutLogIndex] = newLog;
                } else {
                    workoutHistory.push(newLog);
                }

                saveData();
                fullRender();
                closeWorkoutModal();
            });

            setsContainer.addEventListener('click', (e) => {
                const removeSetBtn = e.target.closest('.remove-set-btn');
                const removePartBtn = e.target.closest('.remove-part-btn');

                if (removeSetBtn) {
                    removeSetBtn.closest('.set-row').remove();
                    document.querySelectorAll('.set-row').forEach((row, index) => {
                        row.querySelector('label').textContent = `Set ${index + 1}`;
                    });
                } else if (removePartBtn) {
                    const partRow = removePartBtn.closest('.set-part-row');
                    const partsContainer = partRow.parentElement;
                    if (partsContainer.children.length > 1) {
                        partRow.remove();
                    } else {
                        showCustomAlert("Action blocked", "A set must have at least one part. Delete the whole set instead.");
                    }
                }
            });

            function addIngredientRow(ingredient = null) {
                const ingredientRow = document.createElement('div');
                ingredientRow.className = 'ingredient-row space-y-2 border-t border-gray-700 pt-2';
                ingredientRow.innerHTML = `
                    <div class="grid grid-cols-12 gap-2 items-center">
                        <input type="text" list="favorite-foods-datalist" placeholder="Ingredient Name" class="col-span-12 sm:col-span-5 bg-gray-600 border border-gray-500 rounded-md p-2 ingredient-name" value="${ingredient ? ingredient.name : ''}">
                        <input type="number" placeholder="g" class="col-span-4 sm:col-span-2 bg-gray-600 border border-gray-500 rounded-md p-2 ingredient-grams" value="${ingredient ? ingredient.grams : ''}">
                        <div class="col-span-6 sm:col-span-4 flex items-center gap-2">
                             <button type="button" class="recipe-ai-btn p-2 bg-indigo-600 hover:bg-indigo-700 rounded-md" title="Get Macros with AI">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles pointer-events-none text-white"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                            </button>
                             <button type="button" class="remove-ingredient-btn text-red-500 hover:text-red-400 p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle pointer-events-none"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                        <input type="number" step="0.1" placeholder="kcal" class="bg-gray-700 border border-gray-600 rounded-md p-2 ingredient-calories" title="Calories" value="${ingredient ? ingredient.calories : ''}">
                        <input type="number" step="0.1" placeholder="protein" class="bg-gray-700 border border-gray-600 rounded-md p-2 ingredient-protein" title="Protein (g)" value="${ingredient ? ingredient.protein : ''}">
                        <input type="number" step="0.1" placeholder="carbs" class="bg-gray-700 border border-gray-600 rounded-md p-2 ingredient-carbs" title="Carbs (g)" value="${ingredient ? ingredient.carbs : ''}">
                        <input type="number" step="0.1" placeholder="fat" class="bg-gray-700 border border-gray-600 rounded-md p-2 ingredient-fat" title="Fat (g)" value="${ingredient ? ingredient.fat : ''}">
                    </div>
                `;
                ingredientListContainer.appendChild(ingredientRow);
            }


            function updateRecipeTotals() {
                let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0, totalGrams = 0;

                document.querySelectorAll('.ingredient-row').forEach(row => {
                    const grams = parseFloat(row.querySelector('.ingredient-grams').value) || 0;
                    const calories = parseFloat(row.querySelector('.ingredient-calories').value) || 0;
                    const protein = parseFloat(row.querySelector('.ingredient-protein').value) || 0;
                    const carbs = parseFloat(row.querySelector('.ingredient-carbs').value) || 0;
                    const fat = parseFloat(row.querySelector('.ingredient-fat').value) || 0;

                    if (grams > 0) {
                         totalGrams += grams;
                         totalCalories += calories;
                         totalProtein += protein;
                         totalCarbs += carbs;
                         totalFat += fat;
                    }
                });

                document.getElementById('recipe-total-calories').textContent = Math.round(totalCalories);
                document.getElementById('recipe-total-protein').textContent = totalProtein.toFixed(1);
                document.getElementById('recipe-total-carbs').textContent = totalCarbs.toFixed(1);
                document.getElementById('recipe-total-fat').textContent = totalFat.toFixed(1);
                document.getElementById('recipe-total-grams').textContent = totalGrams.toFixed(1);
            }
            
            ingredientListContainer.addEventListener('click', async (e) => {
                const aiBtn = e.target.closest('.recipe-ai-btn');
                const removeBtn = e.target.closest('.remove-ingredient-btn');
                
                if (removeBtn) {
                    removeBtn.closest('.ingredient-row').remove();
                    updateRecipeTotals();
                }

                if (aiBtn) {
                    const row = aiBtn.closest('.ingredient-row');
                    const nameInput = row.querySelector('.ingredient-name');
                    const gramsInput = row.querySelector('.ingredient-grams');
                    const foodName = nameInput.value.trim();
                    const grams = parseFloat(gramsInput.value);

                    if (!foodName || isNaN(grams) || grams <= 0) {
                        showCustomAlert('Missing Info', 'Please enter an ingredient name and gram amount first.');
                        return;
                    }
                    
                    const originalIcon = aiBtn.innerHTML;
                    aiBtn.innerHTML = '<div class="loader w-5 h-5"></div>';
                    aiBtn.disabled = true;

                    const prompt = `Calculate the nutritional information (calories, protein, carbs, fat) for ${grams}g of ${foodName}. Respond with only the JSON object.`;
                    const apiUrl = getApiUrl('gemini-2.5-flash-preview-05-20');
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT", properties: {
                                    calories: { type: "NUMBER" }, protein: { type: "NUMBER" },
                                    carbs: { type: "NUMBER" }, fat: { type: "NUMBER" }
                                }
                            }
                        }
                    };
                    
                    try {
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!response.ok) throw new Error(`API Error: ${response.status}`);
                        const result = await response.json();
                        if (!result.candidates) throw new Error("Invalid API response.");

                        const data = JSON.parse(result.candidates[0].content.parts[0].text);
                        row.querySelector('.ingredient-calories').value = data.calories.toFixed(1);
                        row.querySelector('.ingredient-protein').value = data.protein.toFixed(1);
                        row.querySelector('.ingredient-carbs').value = data.carbs.toFixed(1);
                        row.querySelector('.ingredient-fat').value = data.fat.toFixed(1);
                        updateRecipeTotals();
                    } catch (error) {
                        console.error("Recipe AI Error:", error);
                        showCustomAlert('Error', 'Could not fetch nutrition data for this ingredient.');
                    } finally {
                        aiBtn.innerHTML = originalIcon;
                        aiBtn.disabled = false;
                    }
                }
            });

            function toggleFavorite(logIndex) {
                const loggedItem = dailyLog[logIndex];
                if (!loggedItem || savedRecipes.some(r => r.name.toLowerCase() === loggedItem.name.toLowerCase())) return;

                const favIndex = favoriteFoods.findIndex(fav => fav.name.toLowerCase() === loggedItem.name.toLowerCase());

                if (favIndex > -1) { 
                    favoriteFoods.splice(favIndex, 1);
                } else { 
                    const grams = loggedItem.grams;
                    if (grams > 0) {
                        favoriteFoods.push({
                            name: loggedItem.name,
                            calories: (loggedItem.calories / grams) * 100, // Normalize to per 100g
                            protein: (loggedItem.protein / grams) * 100,
                            carbs: (loggedItem.carbs / grams) * 100,
                            fat: (loggedItem.fat / grams) * 100,
                        });
                    }
                }
                saveData();
                fullRender();
            }

            function renderFavoritesList() {
                if (favoriteFoods.length === 0) {
                    favoriteFoodsListDiv.innerHTML = '<p class="text-gray-500 text-center">No favorite foods yet.</p>';
                    return;
                }
                favoriteFoodsListDiv.innerHTML = favoriteFoods.map(food => `
                    <div class="flex justify-between items-center bg-gray-700 p-2 rounded-md">
                        <span class="font-medium">${food.name}</span>
                        <div class="flex items-center gap-2">
                             <button class="edit-favorite-btn p-1 hover:bg-gray-600 rounded" data-name="${food.name}" title="Edit Favorite">
                               <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil text-yellow-400"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                            </button>
                            <button class="log-favorite-btn p-1 hover:bg-gray-600 rounded" data-name="${food.name}" title="Log this food">
                               <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle text-green-400"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                            </button>
                            <button class="delete-favorite-btn p-1 hover:bg-gray-600 rounded" data-name="${food.name}" title="Delete Favorite">
                               <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 text-red-500"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            function renderSavedRecipesList() {
                if(savedRecipes.length === 0) {
                    savedRecipesListDiv.innerHTML = '<p class="text-gray-500 text-center">No recipes saved yet.</p>';
                    return;
                }
                savedRecipesListDiv.innerHTML = savedRecipes.map((recipe, index) => `
                    <div class="bg-gray-700 rounded-md">
                        <div class="flex justify-between items-center p-2">
                            <span class="font-medium">${recipe.name}</span>
                            <div class="flex items-center gap-2">
                                <button class="edit-recipe-btn p-1 hover:bg-gray-600 rounded" data-index="${index}" title="Edit Recipe">
                                   <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil text-yellow-400"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                                </button>
                                <button class="log-recipe-btn p-1 hover:bg-gray-600 rounded" data-index="${index}" title="Log this recipe">
                                   <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle text-green-400"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                                </button>
                                <button class="toggle-recipe-details-btn p-1 hover:bg-gray-600 rounded" data-index="${index}" title="View Ingredients">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down text-gray-400 transition-transform"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                </button>
                            </div>
                        </div>
                        <div class="recipe-ingredients-details mt-2 border-t border-gray-600 p-3 text-sm">
                           <ul class="space-y-1">
                            ${recipe.ingredients.map(ing => `<li><strong>${ing.name}</strong> (${ing.grams}g): ${Math.round(ing.calories)}kcal, ${ing.protein.toFixed(1)}p, ${ing.carbs.toFixed(1)}c, ${ing.fat.toFixed(1)}f</li>`).join('')}
                           </ul>
                           <button class="delete-recipe-btn w-full text-center mt-3 text-sm text-red-500 hover:text-red-400 p-1" data-index="${index}">Delete Recipe</button>
                        </div>
                    </div>
                `).join('');
            }
            
            favoriteFoodsListDiv.addEventListener('click', (e) => {
                const logBtn = e.target.closest('.log-favorite-btn');
                const editBtn = e.target.closest('.edit-favorite-btn');
                const deleteBtn = e.target.closest('.delete-favorite-btn');

                if (logBtn) {
                    const foodName = logBtn.dataset.name;
                    const food = favoriteFoods.find(f => f.name === foodName);
                    if (!food) return;

                    showPromptModal(`Log Food: ${food.name}`, `How many grams of ${food.name}?`, "100", (weightStr) => {
                        if (weightStr === null) return; 

                        const grams = parseFloat(weightStr);
                        if (isNaN(grams) || grams <= 0) {
                            showCustomAlert('Invalid Input', 'Please enter a valid number for grams.');
                            return;
                        }

                        const caloriesPer100g = food.calories;
                        const proteinPer100g = food.protein;
                        const carbsPer100g = food.carbs;
                        const fatPer100g = food.fat;

                        const foodItem = {
                            name: food.name,
                            grams: grams,
                            calories: (caloriesPer100g / 100) * grams,
                            protein: (proteinPer100g / 100) * grams,
                            carbs: (carbsPer100g / 100) * grams,
                            fat: (fatPer100g / 100) * grams
                        };

                        dailyLog.push(foodItem);
                        saveData();
                        fullRender();
                        showCustomAlert('Success', `${grams}g of ${food.name} added to today's log.`);
                    });
                }
                
                if (editBtn) {
                    const foodName = editBtn.dataset.name;
                    const food = favoriteFoods.find(f => f.name === foodName);
                    if (!food) return;

                    editingFavoriteFoodName = food.name;
                    document.getElementById('edit-fav-food-name').value = food.name;
                    document.getElementById('edit-fav-food-calories').value = food.calories;
                    document.getElementById('edit-fav-food-protein').value = food.protein;
                    document.getElementById('edit-fav-food-carbs').value = food.carbs;
                    document.getElementById('edit-fav-food-fat').value = food.fat;
                    editFavoriteModal.style.display = 'flex';
                }
                
                if (deleteBtn) {
                    const foodName = deleteBtn.dataset.name;
                    showConfirmModal('Delete Favorite?', `Are you sure you want to delete "${foodName}"? This cannot be undone.`, () => {
                        const indexToDelete = favoriteFoods.findIndex(f => f.name === foodName);
                        if (indexToDelete > -1) {
                            favoriteFoods.splice(indexToDelete, 1);
                            saveData();
                            fullRender();
                        }
                    });
                }
            });

            savedRecipesListDiv.addEventListener('click', (e) => {
                const logBtn = e.target.closest('.log-recipe-btn');
                const toggleBtn = e.target.closest('.toggle-recipe-details-btn');
                const deleteBtn = e.target.closest('.delete-recipe-btn');
                const editBtn = e.target.closest('.edit-recipe-btn');

                if (logBtn) {
                    const index = parseInt(logBtn.dataset.index);
                    const recipe = savedRecipes[index];
                    if (!recipe) return;

                    showPromptModal(`Log Recipe: ${recipe.name}`, `How many grams of ${recipe.name}?`, recipe.totalGrams.toFixed(0), (weightStr) => {
                        if (weightStr === null) return;

                        const grams = parseFloat(weightStr);
                        if (isNaN(grams) || grams <= 0) {
                            showCustomAlert('Invalid Input', 'Please enter a valid number for grams.');
                            return;
                        }
                        
                        const ratio = recipe.totalGrams > 0 ? grams / recipe.totalGrams : 0;
                        const foodItem = {
                            name: recipe.name,
                            grams: grams,
                            calories: recipe.calories * ratio,
                            protein: recipe.protein * ratio,
                            carbs: recipe.carbs * ratio,
                            fat: recipe.fat * ratio,
                        };

                        dailyLog.push(foodItem);
                        saveData();
                        fullRender();
                        showCustomAlert('Success', `${grams}g of ${recipe.name} added to today's log.`);
                    });
                }
                
                if (toggleBtn) {
                    const details = toggleBtn.closest('.bg-gray-700').querySelector('.recipe-ingredients-details');
                    const icon = toggleBtn.querySelector('svg');
                    if (details.style.display === 'block') {
                        details.style.display = 'none';
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        details.style.display = 'block';
                        icon.style.transform = 'rotate(180deg)';
                    }
                }

                if (deleteBtn) {
                    const index = parseInt(deleteBtn.dataset.index);
                    const recipeName = savedRecipes[index]?.name || 'this recipe';
                    showConfirmModal('Delete Recipe?', `Are you sure you want to delete "${recipeName}"? This cannot be undone.`, () => {
                        savedRecipes.splice(index, 1);
                        saveData();
                        fullRender();
                    });
                }
                
                if (editBtn) {
                    const index = parseInt(editBtn.dataset.index);
                    const recipe = savedRecipes[index];
                    if (!recipe) return;
                    
                    editingRecipeIndex = index;
                    compoundFoodModal.querySelector('h2').textContent = "Edit Recipe";
                    saveRecipeBtn.textContent = "Update Recipe";
                    
                    recipeNameInput.value = recipe.name;
                    ingredientListContainer.innerHTML = '';
                    recipe.ingredients.forEach(ing => addIngredientRow(ing));
                    if (recipe.ingredients.length === 0) addIngredientRow();

                    updateRecipeTotals();
                    compoundFoodModal.style.display = 'flex';
                }
            });
            
            closeEditFavoriteModalBtn.addEventListener('click', () => editFavoriteModal.style.display = 'none');
            editFavoriteForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const favIndex = favoriteFoods.findIndex(f => f.name === editingFavoriteFoodName);
                if (favIndex === -1) return;

                const newName = document.getElementById('edit-fav-food-name').value.trim();
                
                if (newName.toLowerCase() !== editingFavoriteFoodName.toLowerCase() && (favoriteFoods.some(f => f.name.toLowerCase() === newName.toLowerCase()) || savedRecipes.some(r => r.name.toLowerCase() === newName.toLowerCase()))) {
                    showCustomAlert('Name Exists', 'A favorite food or recipe with this name already exists.');
                    return;
                }

                favoriteFoods[favIndex].name = newName;
                favoriteFoods[favIndex].calories = parseFloat(document.getElementById('edit-fav-food-calories').value);
                favoriteFoods[favIndex].protein = parseFloat(document.getElementById('edit-fav-food-protein').value);
                favoriteFoods[favIndex].carbs = parseFloat(document.getElementById('edit-fav-food-carbs').value);
                favoriteFoods[favIndex].fat = parseFloat(document.getElementById('edit-fav-food-fat').value);
                
                saveData();
                fullRender();
                editFavoriteModal.style.display = 'none';
            });


        });
    </script>
</body>
</html>
