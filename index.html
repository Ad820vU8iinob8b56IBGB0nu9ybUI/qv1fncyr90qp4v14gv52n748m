<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitTrack AI | Nutrition & Workout Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .nav-active {
            color: #3b82f6; /* blue-500 */
            border-bottom: 2px solid #3b82f6;
        }
        .page {
            display: none;
        }
        .page-active {
            display: block;
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal styles */
        .modal-backdrop {
            display: none;
            position: fixed;
            z-index: 50;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #1f2937; /* gray-800 */
            padding: 1.5rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        #total-calories:hover {
            cursor: pointer;
            background-color: #374151; /* gray-700 */
            border-radius: 0.375rem;
        }
        .water-reminder.active {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .star-rating > span {
            cursor: pointer;
            font-size: 2rem;
            color: #4b5563; /* gray-600 */
        }
         .star-rating > span.selected, .star-rating > span:hover, .star-rating > span:hover ~ span {
            color: #f59e0b; /* amber-500 */
        }
        #barcode-scanner-video {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div class="container mx-auto max-w-5xl p-4">
        <!-- Header -->
        <header class="flex items-center justify-center text-center my-6">
             <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dumbbell text-blue-500 mr-3"><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m6 2 4 4"/><path d="m3 10.5 4.5-4.5"/><path d="m13.5 21 4.5-4.5"/></svg>
            <h1 class="text-3xl font-bold text-white">FitTrack AI</h1>
        </header>

        <!-- Navigation -->
        <nav class="flex justify-center border-b border-gray-700 mb-8">
            <button id="nav-nutrition" class="nav-btn py-4 px-6 text-lg font-medium text-gray-400 hover:text-blue-500 transition-colors nav-active">Nutrition</button>
            <button id="nav-workouts" class="nav-btn py-4 px-6 text-lg font-medium text-gray-400 hover:text-blue-500 transition-colors">Workouts</button>
            <button id="nav-goals" class="nav-btn py-4 px-6 text-lg font-medium text-gray-400 hover:text-blue-500 transition-colors">Goals</button>
            <button id="nav-sleep" class="nav-btn py-4 px-6 text-lg font-medium text-gray-400 hover:text-blue-500 transition-colors">Sleep</button>
        </nav>

        <!-- Main Content -->
        <main>
            <!-- Nutrition Page -->
            <div id="page-nutrition" class="page page-active">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Left Column -->
                    <div class="space-y-8">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Log Your Meal</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="food-name-input" class="block text-sm font-medium text-gray-400">Food Name</label>
                                    <input type="text" id="food-name-input" placeholder="e.g., Oats" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1 focus:ring-blue-500 focus:border-blue-500 text-white">
                                </div>
                                <div>
                                    <label for="food-grams-input" class="block text-sm font-medium text-gray-400">Grams (g)</label>
                                    <input type="number" id="food-grams-input" placeholder="e.g., 100" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1 focus:ring-blue-500 focus:border-blue-500 text-white">
                                </div>
                                <div class="flex gap-2">
                                    <button id="add-food-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-all duration-300 flex items-center justify-center">
                                        <span class="btn-text">Add Food</span>
                                        <div class="loader hidden ml-2"></div>
                                    </button>
                                     <button id="scan-barcode-btn" class="p-2 bg-gray-600 hover:bg-gray-500 text-white rounded-md" title="Scan Barcode">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-scan-barcode"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M8 7v10"/><path d="M12 7v10"/><path d="M16 7v10"/></svg>
                                    </button>
                                </div>
                                <div id="add-food-error" class="text-red-400 text-sm mt-2 h-4"></div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg water-reminder" id="water-reminder-widget">
                             <div class="flex items-center justify-between">
                                <h2 class="text-2xl font-semibold">Hydration</h2>
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-glass-water text-blue-400"><path d="M15 2H9s-1 7-1 10c0 3.31 2.69 6 6 6s6-2.69 6-6c0-3-1-10-1-10z"/><path d="M9 20a1 1 0 0 1-1-1 1 1 0 0 1-1-1"/></svg>
                            </div>
                            <p class="text-gray-400 mt-2">Time until next reminder:</p>
                            <p id="water-timer" class="text-3xl font-bold text-center my-3">60:00</p>
                            <button id="drank-water-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">I Drank Water (Reset)</button>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="space-y-8">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Today's Log</h2>
                            <div id="daily-log" class="space-y-2 max-h-60 overflow-y-auto">
                                <p class="text-gray-500">No food logged yet.</p>
                            </div>
                        </div>

                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Daily Summary</h2>
                            <div class="w-full h-64 flex items-center justify-center">
                                <canvas id="macro-chart"></canvas>
                            </div>
                            <div id="total-calories" class="text-center text-2xl font-bold mt-4 p-1" title="Click to edit daily calorie goal">0 / 2000 kcal</div>
                            <div class="grid grid-cols-3 gap-4 text-center mt-4">
                                <div><p class="font-bold text-blue-400">Protein</p><p id="total-protein">0 g</p></div>
                                <div><p class="font-bold text-green-400">Carbs</p><p id="total-carbs">0 g</p></div>
                                <div><p class="font-bold text-red-400">Fat</p><p id="total-fat">0 g</p></div>
                            </div>
                        </div>

                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                             <div class="flex items-center justify-between">
                                <h2 class="text-2xl font-semibold">AI Meal Suggestions</h2>
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles text-yellow-400"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
                            </div>
                            <p class="text-gray-400 mb-4 mt-1 text-sm">Get ideas for your next meal based on your daily goals.</p>
                            <button id="ai-suggestion-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                                 <span class="btn-text">Generate Ideas</span>
                                 <div class="loader hidden ml-2"></div>
                            </button>
                            <div id="ai-suggestions-output" class="mt-4 space-y-3">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workouts Page -->
            <div id="page-workouts" class="page">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold">Exercise Library & Progress</h2>
                    <p class="text-gray-400 mt-2">Log sessions and track your strength progression.</p>
                </div>
                
                 <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
                    <h3 class="text-2xl font-semibold mb-4 text-center">Your Weekly Plan</h3>
                    <div id="workout-planner" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Planner will be injected here by JS -->
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                        <h3 class="text-2xl font-semibold mb-4 sm:mb-0">Progression Chart</h3>
                        <select id="progress-exercise-select" class="w-full sm:w-auto bg-gray-700 border border-gray-600 rounded-md p-2">
                            <option value="">Select an exercise to see progress</option>
                        </select>
                    </div>
                    <div class="w-full h-80 flex items-center justify-center">
                        <canvas id="progress-chart"></canvas>
                    </div>
                </div>

                <div id="workout-filters" class="flex flex-wrap justify-center gap-2 mb-8"></div>
                <div id="exercise-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <hr class="my-10 border-gray-700">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold">Workout History</h2>
                </div>
                <div id="workout-history" class="space-y-4 max-h-96 overflow-y-auto bg-gray-800 p-4 rounded-lg"></div>
            </div>
            
            <!-- Goals Page -->
            <div id="page-goals" class="page">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-semibold mb-4">Your Profile</h2>
                        <form id="profile-form" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="age" class="block text-sm font-medium text-gray-400">Age</label><input type="number" id="age" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                                <div><label for="gender" class="block text-sm font-medium text-gray-400">Gender</label><select id="gender" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"><option value="male">Male</option><option value="female">Female</option></select></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="height" class="block text-sm font-medium text-gray-400">Height (cm)</label><input type="number" id="height" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                                <div><label for="weight" class="block text-sm font-medium text-gray-400">Weight (kg)</label><input type="number" id="weight" step="0.1" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                            </div>
                             <div><label for="body-fat" class="block text-sm font-medium text-gray-400">Body Fat % (Optional)</label><input type="number" id="body-fat" step="0.1" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"></div>
                            <div>
                                <label for="activity-level" class="block text-sm font-medium text-gray-400">Activity Level</label>
                                <select id="activity-level" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                                    <option value="1.2">Sedentary</option><option value="1.375">Lightly active</option><option value="1.55">Moderately active</option><option value="1.725">Very active</option><option value="1.9">Extra active</option>
                                </select>
                            </div>
                            <div>
                                <label for="user-goal" class="block text-sm font-medium text-gray-400">Your Goal</label>
                                <select id="user-goal" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
                                    <option value="lose">Lose Fat</option>
                                    <option value="maintain">Maintain Weight</option>
                                    <option value="gain">Gain Muscle</option>
                                    <option value="recomposition" selected>Recomposition (Fat Loss, Muscle Gain)</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Save & Calculate Goals</button>
                        </form>
                        <div class="mt-6 space-y-2">
                             <div class="flex items-center justify-center gap-2">
                                <label for="bmr-input" class="font-bold text-gray-300">BMR:</label>
                                <input type="number" id="bmr-input" class="bg-gray-700 border border-gray-600 rounded-md p-1 w-24 text-center">
                                <span class="text-gray-400">kcal</span>
                            </div>
                             <div class="flex items-center justify-center gap-2 mt-2">
                                <label for="bmi-input" class="font-bold text-gray-300">BMI:</label>
                                <input type="number" step="0.1" id="bmi-input" class="bg-gray-700 border border-gray-600 rounded-md p-1 w-24 text-center">
                            </div>
                        </div>
                    </div>
                    <div class="space-y-8">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                             <h2 class="text-2xl font-semibold mb-4">Weight Progression</h2>
                            <div class="w-full h-64 flex items-center justify-center">
                                <canvas id="weight-chart"></canvas>
                            </div>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">AI Adaptive Calorie Plan</h2>
                            <div id="calorie-plan-output" class="text-gray-300"><p>Please fill out your profile to generate a plan.</p></div>
                        </div>
                         <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Daily Check-in</h2>
                            <p class="text-gray-400 text-sm mb-4">Log your weight daily to help the AI adapt your calorie goals for better results.</p>
                            <form id="check-in-form" class="flex gap-4">
                                <input type="number" step="0.1" id="check-in-weight" placeholder="Current weight (kg)" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" required>
                                <button type="submit" id="check-in-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center">
                                    <span class="btn-text">Check In</span>
                                    <div class="loader hidden ml-2"></div>
                                </button>
                            </form>
                            <div id="check-in-feedback" class="mt-4 text-sm"></div>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">InBody Scan Analysis</h2>
                            <p class="text-gray-400 text-sm mb-4">Enter your monthly InBody scan data for a deep AI analysis and plan adjustment.</p>
                            <button id="open-inbody-modal-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md">Enter InBody Scan Data</button>
                        </div>
                    </div>
                </div>
            </div>
            
             <!-- Sleep Page -->
            <div id="page-sleep" class="page">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-8">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Sleep Cycle Calculator</h2>
                            <p class="text-gray-400 mb-4">If you go to bed right now, you should aim to wake up at one of the following times for the best results:</p>
                            <div id="sleep-wake-times" class="grid grid-cols-2 sm:grid-cols-3 gap-3 text-center">
                                <!-- Wake up times will be injected here -->
                            </div>
                            <p class="text-xs text-gray-500 mt-4">Calculations are based on 90-minute sleep cycles and an average of 14 minutes to fall asleep.</p>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Log Your Sleep</h2>
                            <form id="sleep-log-form" class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="sleep-start-time" class="block text-sm font-medium text-gray-400">Went to bed</label><input type="time" id="sleep-start-time" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                                    <div><label for="sleep-end-time" class="block text-sm font-medium text-gray-400">Woke up</label><input type="time" id="sleep-end-time" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Sleep Quality</label>
                                    <div id="sleep-quality-rating" class="star-rating flex flex-row-reverse justify-end items-center">
                                        <span data-value="5">&starf;</span><span data-value="4">&starf;</span><span data-value="3">&starf;</span><span data-value="2">&starf;</span><span data-value="1">&starf;</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="sleep-notes" class="block text-sm font-medium text-gray-400">Notes</label>
                                    <textarea id="sleep-notes" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" placeholder="e.g., Meditated before bed, drank coffee late, etc."></textarea>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Log Sleep</button>
                            </form>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-semibold mb-4">Sleep History</h2>
                        <div id="sleep-history" class="space-y-4 max-h-[40rem] overflow-y-auto">
                            <p class="text-gray-500">No sleep logged yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="workout-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h2 id="modal-title" class="text-2xl font-bold">Log Exercise</h2><button id="close-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
            <form id="workout-log-form"><div class="space-y-4"><div id="sets-container"></div><button type="button" id="add-set-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Add Set</button><button type="submit" id="save-workout-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Save Workout</button></div></form>
        </div>
    </div>
    
    <div id="edit-sleep-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Edit Sleep Log</h2><button id="close-edit-sleep-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
            <form id="edit-sleep-log-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="edit-sleep-start-time" class="block text-sm font-medium text-gray-400">Went to bed</label><input type="time" id="edit-sleep-start-time" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                    <div><label for="edit-sleep-end-time" class="block text-sm font-medium text-gray-400">Woke up</label><input type="time" id="edit-sleep-end-time" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" required></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Sleep Quality</label>
                    <div id="edit-sleep-quality-rating" class="star-rating flex flex-row-reverse justify-end items-center">
                        <span data-value="5">&starf;</span><span data-value="4">&starf;</span><span data-value="3">&starf;</span><span data-value="2">&starf;</span><span data-value="1">&starf;</span>
                    </div>
                </div>
                <div>
                    <label for="edit-sleep-notes" class="block text-sm font-medium text-gray-400">Notes</label>
                    <textarea id="edit-sleep-notes" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Update Sleep</button>
            </form>
        </div>
    </div>

    <div id="inbody-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">InBody 570 Scan Data</h2><button id="close-inbody-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
            <form id="inbody-form" class="space-y-3">
                 <div class="grid grid-cols-2 gap-3">
                    <div><label for="inbody-weight" class="text-sm">Weight (kg)</label><input type="number" step="0.1" id="inbody-weight" class="w-full bg-gray-700 p-2 rounded-md mt-1" required></div>
                    <div><label for="inbody-smm" class="text-sm">Skeletal Muscle Mass (kg)</label><input type="number" step="0.1" id="inbody-smm" class="w-full bg-gray-700 p-2 rounded-md mt-1" required></div>
                    <div><label for="inbody-bfm" class="text-sm">Body Fat Mass (kg)</label><input type="number" step="0.1" id="inbody-bfm" class="w-full bg-gray-700 p-2 rounded-md mt-1" required></div>
                    <div><label for="inbody-pbf" class="text-sm">Percent Body Fat (%)</label><input type="number" step="0.1" id="inbody-pbf" class="w-full bg-gray-700 p-2 rounded-md mt-1" required></div>
                 </div>
                 <button type="submit" id="analyze-inbody-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center">
                    <span class="btn-text">Analyze & Update Plan</span>
                    <div class="loader hidden ml-2"></div>
                </button>
            </form>
        </div>
    </div>
    
     <div id="barcode-scanner-modal" class="modal-backdrop">
        <div class="modal-content">
             <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Scan Food Barcode</h2><button id="close-barcode-scanner-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
             <div id="barcode-scanner-container" class="w-full aspect-square bg-gray-900 rounded-lg overflow-hidden">
                <div id="barcode-reader" class="w-full h-full"></div>
             </div>
             <p id="barcode-scanner-status" class="text-center text-sm text-gray-400 mt-3 h-5"></p>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 id="confirm-modal-title" class="text-xl font-bold mb-4">Are you sure?</h2>
            <p id="confirm-modal-text" class="text-gray-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Cancel</button>
                <button id="confirm-modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Delete</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let dailyLog = [];
            let goals = { calories: 2000, protein: 150, carbs: 225, fat: 60 };
            let userProfile = { weightHistory: [], inbodyHistory: [], sleepHistory: [] };
            let workoutHistory = [];
            let currentWorkoutFilter = 'all';
            let currentlyLoggingExercise = null;
            let editingWorkoutLogIndex = null;
            let editingSleepLogIndex = null;
            let waterTimerInterval = null;
            let waterTimeRemaining = 3600; // 60 minutes in seconds
            let currentSleepQuality = 0;
            let currentEditSleepQuality = 0;
            let barcodeScanner = null;
            
            // --- DATABASES ---
            const exerciseDB = [
                // Chest (Push)
                { name: "Barbell Flat Press", group: "Chest", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Barbell+Press" },
                { name: "Dumbbell Flat Press", group: "Chest", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=DB+Press" },
                { name: "Machine Chest Press", group: "Chest", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Machine+Press" },
                { name: "Barbell Incline Press", group: "Chest", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Incline+Barbell" },
                { name: "Dumbbell Incline Press", group: "Chest", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Incline+DB" },
                { name: "Machine Incline Press", group: "Chest", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Incline+Machine" },
                { name: "Cable Fly", group: "Chest", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Cable+Fly" },
                { name: "Dumbbell Fly", group: "Chest", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=DB+Fly" },
                { name: "Machine Fly (Pec Deck)", group: "Chest", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Pec+Deck" },
                
                // Shoulders (Push)
                { name: "Dumbbell Lateral Raises", group: "Shoulders", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Lateral+Raises" },
                { name: "Cable Lateral Raises", group: "Shoulders", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Cable+Laterals" },

                // Triceps (Push)
                { name: "Barbell Overhead Tricep Extension", group: "Triceps", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Overhead+Ext" },
                { name: "Dumbbell Overhead Tricep Extension", group: "Triceps", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=DB+Overhead+Ext" },
                { name: "Cable Overhead Tricep Extension", group: "Triceps", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Cable+Overhead" },
                { name: "Cable Pushdowns", group: "Triceps", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Pushdowns" },
                { name: "Dips", group: "Triceps", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Dips" },

                // Back (Pull)
                { name: "Pull-ups", group: "Back", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Pull-ups" },
                { name: "Lat Pulldowns", group: "Back", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Pulldowns" },
                { name: "Barbell Row", group: "Back", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Barbell+Row" },
                { name: "Dumbbell Row", group: "Back", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=DB+Row" },
                { name: "Seated Machine Row", group: "Back", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Machine+Row" },
                { name: "Seated Cable Row", group: "Back", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Cable+Row" },
                { name: "Deadlifts", group: "Back", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Deadlifts" },

                // Biceps (Pull)
                { name: "Bayesian Cable Curls", group: "Biceps", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Cable+Curls" },
                { name: "Incline Dumbbell Curls", group: "Biceps", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Incline+Curls" },
                { name: "Preacher Curls", group: "Biceps", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Preacher+Curls" },

                // Quads (Legs)
                { name: "Barbell Squats", group: "Quads", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Squats" },
                { name: "Leg Press", group: "Quads", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Leg+Press" },
                { name: "Leg Extensions", group: "Quads", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Leg+Extensions" },

                // Hamstrings (Legs)
                { name: "Stiff-legged Deadlift", group: "Hamstrings", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=SLDL" },
                { name: "Lying Leg Curls", group: "Hamstrings", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Leg+Curls" },

                // Glutes (Legs)
                { name: "Hip Thrust", group: "Glutes", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Hip+Thrust" },
                { name: "Deep Squats (Sumo)", group: "Glutes", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Sumo+Squat" },

                // Calves (Legs)
                { name: "Standing Calf Raises", group: "Calves", image: "https://placehold.co/600x400/1f2937/7dd3fc?text=Calf+Raises" },
            ];

            // --- UI ELEMENTS ---
            const navNutrition = document.getElementById('nav-nutrition'), navWorkouts = document.getElementById('nav-workouts'), navGoals = document.getElementById('nav-goals'), navSleep = document.getElementById('nav-sleep'),
                pageNutrition = document.getElementById('page-nutrition'), pageWorkouts = document.getElementById('page-workouts'), pageGoals = document.getElementById('page-goals'), pageSleep = document.getElementById('page-sleep'),
                foodNameInput = document.getElementById('food-name-input'), foodGramsInput = document.getElementById('food-grams-input'), addFoodBtn = document.getElementById('add-food-btn'),
                addFoodError = document.getElementById('add-food-error'), dailyLogDiv = document.getElementById('daily-log'), totalCaloriesEl = document.getElementById('total-calories'),
                totalProteinEl = document.getElementById('total-protein'), totalCarbsEl = document.getElementById('total-carbs'), totalFatEl = document.getElementById('total-fat'),
                aiSuggestionBtn = document.getElementById('ai-suggestion-btn'), aiSuggestionsOutput = document.getElementById('ai-suggestions-output'), workoutFiltersDiv = document.getElementById('workout-filters'),
                exerciseListDiv = document.getElementById('exercise-list'), workoutHistoryDiv = document.getElementById('workout-history'), profileForm = document.getElementById('profile-form'),
                caloriePlanOutput = document.getElementById('calorie-plan-output'), checkInForm = document.getElementById('check-in-form'), checkInBtn = document.getElementById('check-in-btn'), checkInFeedback = document.getElementById('check-in-feedback'),
                bmrInput = document.getElementById('bmr-input'), bmiInput = document.getElementById('bmi-input'), workoutModal = document.getElementById('workout-modal'),
                modalTitle = document.getElementById('modal-title'), closeModalBtn = document.getElementById('close-modal-btn'), workoutLogForm = document.getElementById('workout-log-form'),
                setsContainer = document.getElementById('sets-container'), addSetBtn = document.getElementById('add-set-btn'), saveWorkoutBtn = document.getElementById('save-workout-btn'),
                waterTimerEl = document.getElementById('water-timer'), drankWaterBtn = document.getElementById('drank-water-btn'), waterReminderWidget = document.getElementById('water-reminder-widget'),
                openInBodyModalBtn = document.getElementById('open-inbody-modal-btn'), inbodyModal = document.getElementById('inbody-modal'),
                closeInbodyModalBtn = document.getElementById('close-inbody-modal-btn'), inbodyForm = document.getElementById('inbody-form'), analyzeInbodyBtn = document.getElementById('analyze-inbody-btn'),
                confirmModal = document.getElementById('confirm-modal'), confirmModalTitle = document.getElementById('confirm-modal-title'), confirmModalText = document.getElementById('confirm-modal-text'),
                confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn'), confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn'),
                sleepWakeTimesDiv = document.getElementById('sleep-wake-times'), sleepLogForm = document.getElementById('sleep-log-form'), sleepQualityRatingDiv = document.getElementById('sleep-quality-rating'),
                sleepHistoryDiv = document.getElementById('sleep-history'), progressExerciseSelect = document.getElementById('progress-exercise-select'),
                editSleepModal = document.getElementById('edit-sleep-modal'), closeEditSleepModalBtn = document.getElementById('close-edit-sleep-modal-btn'), editSleepLogForm = document.getElementById('edit-sleep-log-form'), editSleepQualityRatingDiv = document.getElementById('edit-sleep-quality-rating'),
                closeBarcodeScannerModalBtn = document.getElementById('close-barcode-scanner-modal-btn'),
                barcodeReaderDiv = document.getElementById('barcode-reader'), barcodeScannerStatus = document.getElementById('barcode-scanner-status'),
                weightChartCanvas = document.getElementById('weight-chart'), workoutPlannerDiv = document.getElementById('workout-planner');


            let confirmCallback = null;
            
            // --- CHART.JS SETUP ---
            const macroCtx = document.getElementById('macro-chart').getContext('2d');
            let macroChart = new Chart(macroCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Protein', 'Carbs', 'Fat'],
                    datasets: [{
                        data: [1, 1, 1],
                        backgroundColor: ['#60a5fa', '#4ade80', '#f87171'],
                        borderColor: '#1f2937',
                        borderWidth: 4,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#d1d5db',
                                font: { size: 14 }
                            }
                        }
                    }
                }
            });

            const progressCtx = document.getElementById('progress-chart').getContext('2d');
            let progressChart = new Chart(progressCtx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#d1d5db' }, grid: { color: '#374151' } },
                        x: { ticks: { color: '#d1d5db' }, grid: { color: '#374151' } }
                    },
                    plugins: { legend: { labels: { color: '#d1d5db' } } }
                }
            });
            
            const weightCtx = weightChartCanvas.getContext('2d');
            let weightChart = new Chart(weightCtx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { ticks: { color: '#d1d5db' }, grid: { color: '#374151' } },
                        x: { ticks: { color: '#d1d5db' }, grid: { color: '#374151' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // --- LOCAL STORAGE & STATE ---
            const saveData = () => {
                localStorage.setItem('fitTrackAI_dailyLog', JSON.stringify(dailyLog));
                localStorage.setItem('fitTrackAI_userProfile', JSON.stringify(userProfile));
                localStorage.setItem('fitTrackAI_workoutHistory', JSON.stringify(workoutHistory));
            };
            const loadData = () => {
                const savedLog = localStorage.getItem('fitTrackAI_dailyLog');
                const savedProfile = localStorage.getItem('fitTrackAI_userProfile');
                const savedHistory = localStorage.getItem('fitTrackAI_workoutHistory');

                if (savedLog) dailyLog = JSON.parse(savedLog);
                if (savedProfile) {
                    userProfile = JSON.parse(savedProfile);
                    goals.calories = userProfile.calorieTarget || 2000;
                }
                if (savedHistory) workoutHistory = JSON.parse(savedHistory);
                
                if (!userProfile) userProfile = {};
                if (!userProfile.weightHistory) userProfile.weightHistory = [];
                if (!userProfile.inbodyHistory) userProfile.inbodyHistory = [];
                if (!userProfile.sleepHistory) userProfile.sleepHistory = [];
            };
            
            // --- NUTRITION FUNCTIONS ---
             const updateSummary = () => {
                 const totals = dailyLog.reduce((acc, item) => ({
                    calories: acc.calories + item.calories, protein: acc.protein + item.protein, carbs: acc.carbs + item.carbs, fat: acc.fat + item.fat
                }), { calories: 0, protein: 0, carbs: 0, fat: 0 });

                totalCaloriesEl.innerHTML = `<span id="current-cals">${Math.round(totals.calories)}</span> / <span id="goal-cals">${Math.round(goals.calories)}</span> kcal`;
                totalProteinEl.textContent = `${Math.round(totals.protein)} g`;
                totalCarbsEl.textContent = `${Math.round(totals.carbs)} g`;
                totalFatEl.textContent = `${Math.round(totals.fat)} g`;
                
                const macroSum = totals.protein + totals.carbs + totals.fat;
                if(macroSum > 0) {
                    macroChart.data.datasets[0].data = [totals.protein, totals.carbs, totals.fat];
                } else {
                    macroChart.data.datasets[0].data = [1, 1, 1]; // To show the chart structure even when empty
                }
                macroChart.update();
            };
            const renderDailyLog = () => {
                 if (dailyLog.length === 0) {
                    dailyLogDiv.innerHTML = '<p class="text-gray-500">No food logged yet.</p>';
                    return;
                }
                dailyLogDiv.innerHTML = dailyLog.map((item, index) => `
                    <div class="flex justify-between items-center bg-gray-700 p-2 rounded-md">
                        <div>
                            <span>${item.name}</span>
                            ${item.source ? `<a href="${item.source.uri}" target="_blank" class="text-xs text-blue-400 hover:underline block">Source: ${item.source.title}</a>` : ''}
                        </div>
                        <div class="flex items-center gap-4">
                           <span class="text-sm text-gray-400">${Math.round(item.calories)} kcal</span>
                           <button class="remove-item-btn text-red-500 hover:text-red-400" data-index="${index}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                           </button>
                        </div>
                    </div>
                `).join('');
            };
            
            async function getFoodNutritionFromAI(foodName, grams) {
                 const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const prompt = `Calculate the nutritional information (calories, protein, carbs, fat) for ${grams}g of ${foodName}. If the food is ambiguous, use the most common version. Respond with only the JSON object.`;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    tools: [{ "google_search": {} }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                name: { type: "STRING", description: `Name of the food including weight, e.g., '${grams}g of ${foodName}'` },
                                calories: { type: "NUMBER" },
                                protein: { type: "NUMBER" },
                                carbs: { type: "NUMBER" },
                                fat: { type: "NUMBER" }
                            },
                             required: ["name", "calories", "protein", "carbs", "fat"]
                        }
                    }
                };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.status} ${await response.text()}`);
                    const result = await response.json();
                    if (!result.candidates || !result.candidates[0].content) {
                        throw new Error("Invalid API response structure");
                    }
                    const candidate = result.candidates[0];
                    const jsonText = candidate.content.parts[0].text;
                    const parsedData = JSON.parse(jsonText);
                    
                    const citation = candidate.groundingMetadata?.groundingAttributions?.[0]?.web;
                    if (citation) parsedData.source = { title: citation.title, uri: citation.uri };
                    
                    return parsedData;
                } catch (error) {
                    console.error("AI Nutrition Fetch Error:", error);
                    return null;
                }
            }

            addFoodBtn.addEventListener('click', async () => {
                addFoodError.textContent = '';
                const foodName = foodNameInput.value.trim();
                const grams = parseFloat(foodGramsInput.value);

                if (!foodName || isNaN(grams) || grams <= 0) {
                    addFoodError.textContent = "Please enter a valid food and gram amount.";
                    return;
                }
                
                addFoodBtn.disabled = true;
                addFoodBtn.querySelector('.btn-text').textContent = 'Analyzing...';
                addFoodBtn.querySelector('.loader').classList.remove('hidden');

                const aiFoodData = await getFoodNutritionFromAI(foodName, grams);
                
                addFoodBtn.disabled = false;
                addFoodBtn.querySelector('.btn-text').textContent = 'Add Food';
                addFoodBtn.querySelector('.loader').classList.add('hidden');

                if (aiFoodData && aiFoodData.calories !== undefined) {
                    dailyLog.push(aiFoodData);
                    renderDailyLog();
                    updateSummary();
                    saveData();
                    foodNameInput.value = '';
                    foodGramsInput.value = '';
                } else {
                    addFoodError.textContent = "Could not find nutrition data for that food.";
                }
            });
            
            dailyLogDiv.addEventListener('click', (e) => {
                 const removeBtn = e.target.closest('.remove-item-btn');
                if (removeBtn) {
                    const index = parseInt(removeBtn.dataset.index, 10);
                    dailyLog.splice(index, 1);
                    renderDailyLog();
                    updateSummary();
                    saveData();
                }
            });

             aiSuggestionBtn.addEventListener('click', async () => {
                 const btnText = aiSuggestionBtn.querySelector('.btn-text');
                const loader = aiSuggestionBtn.querySelector('.loader');
                
                aiSuggestionBtn.disabled = true;
                btnText.textContent = 'Generating...';
                loader.classList.remove('hidden');
                aiSuggestionsOutput.innerHTML = '';

                const totals = dailyLog.reduce((acc, item) => ({
                    calories: acc.calories + item.calories, protein: acc.protein + item.protein, carbs: acc.carbs + item.carbs, fat: acc.fat + item.fat
                }), { calories: 0, protein: 0, carbs: 0, fat: 0 });

                const remainingCalories = Math.max(0, goals.calories - totals.calories);

                const prompt = `I have ${remainingCalories} calories left for the day. My goal is ${userProfile.goal || 'maintain'} weight. Suggest one simple, healthy meal idea (like breakfast, lunch, or dinner) to help me reach my goal. Provide the meal name and a very brief description.`;

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    const text = result.candidates[0].content.parts[0].text;
                    aiSuggestionsOutput.innerHTML = `<p class="bg-gray-700 p-3 rounded-md">${text.replace(/\n/g, '<br>')}</p>`;
                } catch (error) {
                    console.error("AI Suggestion Error:", error);
                    aiSuggestionsOutput.innerHTML = `<p class="text-red-400">Sorry, couldn't get a suggestion right now.</p>`;
                } finally {
                    aiSuggestionBtn.disabled = false;
                    btnText.textContent = 'Generate Ideas';
                    loader.classList.add('hidden');
                }
            });

            // --- BARCODE SCANNER ---
            const onBarcodeSuccess = async (decodedText, decodedResult) => {
                barcodeScannerStatus.textContent = `Found barcode: ${decodedText}. Fetching data...`;
                await barcodeScanner.stop();
                
                try {
                    const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${decodedText}.json`);
                    if (!response.ok) throw new Error('Product not found in Open Food Facts database.');
                    
                    const data = await response.json();
                    if (data.status === 0) throw new Error(data.status_verbose);

                    const product = data.product;
                    const nutriments = product.nutriments;
                    const servingSize = parseFloat(product.serving_quantity) || 100;

                    const foodItem = {
                        name: `${product.product_name} (${servingSize}g)`,
                        calories: nutriments['energy-kcal_serving'] || (nutriments['energy-kcal_100g'] / 100 * servingSize) || 0,
                        protein: nutriments.proteins_serving || (nutriments.proteins_100g / 100 * servingSize) || 0,
                        carbs: nutriments.carbohydrates_serving || (nutriments.carbohydrates_100g / 100 * servingSize) || 0,
                        fat: nutriments.fat_serving || (nutriments.fat_100g / 100 * servingSize) || 0,
                        source: { title: 'Open Food Facts', uri: `https://world.openfoodfacts.org/product/${decodedText}` }
                    };

                    dailyLog.push(foodItem);
                    renderDailyLog();
                    updateSummary();
                    saveData();
                    barcodeScannerModal.style.display = 'none';

                } catch (error) {
                    console.error("Barcode Fetch Error:", error);
                    barcodeScannerStatus.textContent = `Error: ${error.message}`;
                    setTimeout(() => {
                         barcodeScannerModal.style.display = 'none';
                    }, 2000);
                }
            };
            scanBarcodeBtn.addEventListener('click', () => {
                barcodeScannerModal.style.display = 'flex';
                barcodeScannerStatus.textContent = 'Starting camera...';
                if (!barcodeScanner) {
                    barcodeScanner = new Html5Qrcode("barcode-reader");
                }
                barcodeScanner.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    onBarcodeSuccess,
                    (errorMessage) => { /* console.log(errorMessage) */ }
                ).catch((err) => {
                    barcodeScannerStatus.textContent = "Could not start camera.";
                });
            });
            closeBarcodeScannerModalBtn.addEventListener('click', async () => {
                if(barcodeScanner && barcodeScanner.isScanning) {
                   await barcodeScanner.stop();
                }
                barcodeScannerModal.style.display = 'none';
            });

            // --- SLEEP FUNCTIONS ---
            const calculateWakeUpTimes = () => {
                const now = new Date();
                const fallAsleepTime = 14 * 60 * 1000; // 14 minutes in ms
                sleepWakeTimesDiv.innerHTML = '';

                for(let i = 1; i <= 6; i++) {
                    const cycleDuration = (90 * i * 60 * 1000) + fallAsleepTime;
                    const wakeUpDate = new Date(now.getTime() + cycleDuration);
                    const timeString = wakeUpDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const timeEl = document.createElement('div');
                    timeEl.className = 'bg-gray-700 p-2 rounded-md font-bold text-lg';
                    timeEl.textContent = timeString;
                    sleepWakeTimesDiv.appendChild(timeEl);
                }
            };
            
            sleepQualityRatingDiv.addEventListener('click', (e) => {
                if (e.target.tagName === 'SPAN') {
                    currentSleepQuality = parseInt(e.target.dataset.value, 10);
                    Array.from(sleepQualityRatingDiv.children).forEach(span => {
                        span.classList.toggle('selected', parseInt(span.dataset.value, 10) <= currentSleepQuality);
                    });
                }
            });
            editSleepQualityRatingDiv.addEventListener('click', (e) => {
                if (e.target.tagName === 'SPAN') {
                    currentEditSleepQuality = parseInt(e.target.dataset.value, 10);
                    Array.from(editSleepQualityRatingDiv.children).forEach(span => {
                        span.classList.toggle('selected', parseInt(span.dataset.value, 10) <= currentEditSleepQuality);
                    });
                }
            });
            
            sleepLogForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const startTime = document.getElementById('sleep-start-time').value;
                const endTime = document.getElementById('sleep-end-time').value;
                const notes = document.getElementById('sleep-notes').value;

                if (!startTime || !endTime || currentSleepQuality === 0) {
                    alert('Please fill in sleep/wake times and select a quality rating.');
                    return;
                }
                
                const today = new Date().toISOString().split('T')[0];
                const sleepLog = {
                    date: today,
                    startTime,
                    endTime,
                    quality: currentSleepQuality,
                    notes
                };
                userProfile.sleepHistory.push(sleepLog);
                saveData();
                renderSleepHistory();
                sleepLogForm.reset();
                currentSleepQuality = 0;
                 Array.from(sleepQualityRatingDiv.children).forEach(span => span.classList.remove('selected'));
            });
             editSleepLogForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const updatedLog = {
                    date: userProfile.sleepHistory[editingSleepLogIndex].date,
                    startTime: document.getElementById('edit-sleep-start-time').value,
                    endTime: document.getElementById('edit-sleep-end-time').value,
                    notes: document.getElementById('edit-sleep-notes').value,
                    quality: currentEditSleepQuality
                };
                 userProfile.sleepHistory[editingSleepLogIndex] = updatedLog;
                 saveData();
                 renderSleepHistory();
                 editSleepModal.style.display = 'none';
            });

            const renderSleepHistory = () => {
                 if (!userProfile.sleepHistory || userProfile.sleepHistory.length === 0) {
                    sleepHistoryDiv.innerHTML = '<p class="text-gray-500">No sleep logged yet.</p>';
                    return;
                }
                sleepHistoryDiv.innerHTML = [...userProfile.sleepHistory].map((log, index) => {
                    const startDate = new Date(`1970-01-01T${log.startTime}`);
                    const endDate = new Date(`1970-01-01T${log.endTime}`);
                    if(endDate < startDate) endDate.setDate(endDate.getDate() + 1);
                    const durationMs = endDate - startDate;
                    const hours = Math.floor(durationMs / (1000 * 60 * 60));
                    const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
                    
                    return `
                    <div class="bg-gray-700 p-4 rounded-md">
                        <div class="flex justify-between items-start mb-2">
                             <div>
                                <h4 class="font-bold text-lg text-blue-400">${new Date(log.date).toLocaleDateString()}</h4>
                                <div class="flex items-center gap-1 mt-1">${'&#9733;'.repeat(log.quality)}<span class="text-gray-400">${'&#9734;'.repeat(5 - log.quality)}</span></div>
                            </div>
                             <div class="flex gap-2">
                                <button class="edit-sleep-btn p-1 hover:bg-gray-600 rounded" data-index="${index}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><line x1="18" y1="2" x2="22" y2="6"/><path d="M7.5 20.5 19 9l-4-4L3.5 16.5 2 22z"/></svg>
                                </button>
                                <button class="delete-sleep-btn p-1 hover:bg-gray-600 rounded" data-index="${index}">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                </button>
                            </div>
                        </div>
                        <p class="text-sm"><strong>Duration:</strong> ${hours}h ${minutes}m</p>
                        <p class="text-sm"><strong>Time:</strong> ${log.startTime} - ${log.endTime}</p>
                        ${log.notes ? `<p class="text-sm mt-2 pt-2 border-t border-gray-600"><strong>Notes:</strong> ${log.notes}</p>` : ''}
                    </div>
                `}).reverse().join('');
            };
            const openEditSleepModal = (index) => {
                const log = userProfile.sleepHistory[index];
                editingSleepLogIndex = index;
                document.getElementById('edit-sleep-start-time').value = log.startTime;
                document.getElementById('edit-sleep-end-time').value = log.endTime;
                document.getElementById('edit-sleep-notes').value = log.notes;
                currentEditSleepQuality = log.quality;
                Array.from(editSleepQualityRatingDiv.children).forEach(span => {
                    span.classList.toggle('selected', parseInt(span.dataset.value, 10) <= currentEditSleepQuality);
                });
                editSleepModal.style.display = 'flex';
            };
            closeEditSleepModalBtn.addEventListener('click', () => editSleepModal.style.display = 'none');
             sleepHistoryDiv.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-sleep-btn');
                const deleteBtn = e.target.closest('.delete-sleep-btn');
                if (editBtn) openEditSleepModal(parseInt(editBtn.dataset.index));
                if (deleteBtn) {
                     const indexToDelete = parseInt(deleteBtn.dataset.index);
                     showConfirmModal('Delete Sleep Log?', 'Are you sure?', () => {
                        userProfile.sleepHistory.splice(indexToDelete, 1);
                        saveData();
                        renderSleepHistory();
                    });
                }
            });

            // --- WORKOUT PLANNER & PROGRESSION ---
             const renderWorkoutPlanner = () => {
                const schedule = [
                    { day: "Sunday", type: "Push" },
                    { day: "Monday", type: "Pull" },
                    { day: "Tuesday", type: "Legs" },
                    { day: "Wednesday", type: "Rest" },
                    { day: "Thursday", type: "Push" },
                    { day: "Friday", type: "Pull" },
                    { day: "Saturday", type: "Legs" },
                ];
                
                const exerciseGroups = {
                    "Push": ['Chest', 'Shoulders', 'Triceps'],
                    "Pull": ['Back', 'Biceps'],
                    "Legs": ['Quads', 'Hamstrings', 'Glutes', 'Calves']
                };
                
                const today = new Date().toLocaleString('en-us', {  weekday: 'long' });

                workoutPlannerDiv.innerHTML = schedule.map(item => {
                    const isToday = item.day === today;
                    let exercisesHtml = '';
                    if (item.type === 'Rest') {
                        exercisesHtml = '<p class="text-gray-400 italic mt-2">Take a well-deserved rest!</p>';
                    } else {
                        const groupsForDay = exerciseGroups[item.type];
                        exercisesHtml = `
                            <ul class="list-disc list-inside space-y-1 mt-2 max-h-32 overflow-y-auto">
                                ${exerciseDB
                                    .filter(ex => groupsForDay.includes(ex.group))
                                    .map(ex => `<li class="text-sm text-gray-300 hover:text-white">${ex.name}</li>`)
                                    .join('')}
                            </ul>
                        `;
                    }
                    
                    return `
                        <div class="col-span-1 md:col-span-1 lg:col-span-2">
                            <div class="${isToday ? 'border-2 border-blue-500' : ''} bg-gray-700 p-4 rounded-lg h-full">
                                <h4 class="font-bold text-lg ${isToday ? 'text-blue-400' : 'text-white'}">${item.day} - <span class="font-semibold">${item.type}</span></h4>
                                ${exercisesHtml}
                            </div>
                        </div>
                    `;
                }).join('');
            };
            const populateProgressSelect = () => {
                const exercisedNames = [...new Set(workoutHistory.map(log => log.name))];
                progressExerciseSelect.innerHTML = '<option value="">Select an exercise to see progress</option>';
                exercisedNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    progressExerciseSelect.appendChild(option);
                });
            };
            const renderProgressionChart = (exerciseName) => {
                if (!exerciseName) {
                    progressChart.data.labels = [];
                    progressChart.data.datasets = [];
                    progressChart.update();
                    return;
                }
                const exerciseLogs = workoutHistory.filter(log => log.name === exerciseName)
                                                  .sort((a,b) => new Date(a.date) - new Date(b.date));
                
                const labels = exerciseLogs.map(log => new Date(log.date).toLocaleDateString());
                const maxWeightData = exerciseLogs.map(log => Math.max(...log.sets.map(set => set.weight || 0)));
                const volumeData = exerciseLogs.map(log => log.sets.reduce((total, set) => total + (set.weight * set.reps), 0));

                progressChart.data.labels = labels;
                progressChart.data.datasets = [
                    {
                        label: 'Max Weight (kg)',
                        data: maxWeightData,
                        borderColor: '#60a5fa',
                        backgroundColor: '#60a5fa',
                        tension: 0.1
                    },
                    {
                        label: 'Total Volume (kg)',
                        data: volumeData,
                        borderColor: '#4ade80',
                        backgroundColor: '#4ade80',
                        tension: 0.1
                    }
                ];
                progressChart.update();
            };
            progressExerciseSelect.addEventListener('change', (e) => renderProgressionChart(e.target.value));
            
            // --- GOALS/INBODY/ETC FUNCTIONS ---
            const renderWeightChart = () => {
                if (!userProfile.weightHistory || userProfile.weightHistory.length === 0) {
                    weightChart.data.labels = [];
                    weightChart.data.datasets = [];
                    weightChart.update();
                    return;
                }
                const sortedHistory = [...userProfile.weightHistory].sort((a,b) => new Date(a.date) - new Date(b.date));
                const labels = sortedHistory.map(entry => new Date(entry.date).toLocaleDateString());
                const data = sortedHistory.map(entry => entry.weight);
                
                weightChart.data.labels = labels;
                weightChart.data.datasets = [{
                    label: 'Weight (kg)',
                    data: data,
                    borderColor: '#a78bfa', // purple-400
                    backgroundColor: '#a78bfa',
                    tension: 0.1,
                    fill: false
                }];
                weightChart.update();
            };
            const populateProfileForm = () => {
                if (userProfile.age) {
                    profileForm.age.value = userProfile.age;
                    profileForm.gender.value = userProfile.gender;
                    profileForm.height.value = userProfile.height;
                    profileForm.weight.value = userProfile.weight;
                    profileForm['body-fat'].value = userProfile.bodyFat || '';
                    profileForm['activity-level'].value = userProfile.activityLevel;
                    profileForm['user-goal'].value = userProfile.goal;
                    if(userProfile.bmr) bmrInput.value = Math.round(userProfile.bmr);
                    if(userProfile.bmi) bmiInput.value = userProfile.bmi.toFixed(1);
                }
            };
            const generateCalorieCycle = () => {
                 if(!userProfile.calorieTarget) {
                    caloriePlanOutput.innerHTML = '<p>Please fill out your profile to generate a plan.</p>';
                    return;
                }
                goals.calories = userProfile.calorieTarget;
                const { calorieTarget, tdee, goal } = userProfile;

                let planHtml = `<p class="mb-2">Your estimated maintenance is <strong class="text-blue-400">${Math.round(tdee)} kcal</strong>. Based on your goal to <strong class="text-blue-400">${goal}</strong>, here is your adaptive plan:</p>`;
                
                let proteinGoal, carbGoal, fatGoal;

                if (goal === 'recomposition') {
                    proteinGoal = userProfile.weight * 2.2;
                    fatGoal = userProfile.weight * 0.8;
                    carbGoal = (calorieTarget - (proteinGoal * 4 + fatGoal * 9)) / 4;
                    planHtml += `<ul class="list-disc list-inside space-y-1">
                        <li><strong>Daily Calories:</strong> ${Math.round(calorieTarget)} kcal</li>
                        <li><strong>Protein:</strong> ~${Math.round(proteinGoal)}g</li>
                        <li><strong>Carbs:</strong> ~${Math.round(carbGoal)}g</li>
                        <li><strong>Fat:</strong> ~${Math.round(fatGoal)}g</li>
                    </ul>`;
                } else {
                     const highDay = calorieTarget + 150;
                     const lowDay = calorieTarget - 150;
                     planHtml += `<ul class="list-disc list-inside space-y-1">
                        <li><strong>Average Daily Target:</strong> ${Math.round(calorieTarget)} kcal</li>
                        <li><strong>Workout Days (Higher Calorie):</strong> ${Math.round(highDay)} kcal</li>
                        <li><strong>Rest Days (Lower Calorie):</strong> ${Math.round(lowDay)} kcal</li>
                    </ul>`;
                }
                planHtml += `<p class="text-sm text-gray-400 mt-3">This plan will adapt based on your daily check-ins and InBody scans.</p>`;
                
                caloriePlanOutput.innerHTML = planHtml;
                updateSummary();
                saveData();
            };
             const calculateAndSaveGoals = () => {
                userProfile.age = parseInt(profileForm.age.value);
                userProfile.gender = profileForm.gender.value;
                userProfile.height = parseInt(profileForm.height.value);
                userProfile.weight = parseFloat(profileForm.weight.value);
                userProfile.bodyFat = parseFloat(profileForm['body-fat'].value) || null;
                userProfile.activityLevel = parseFloat(profileForm['activity-level'].value);
                userProfile.goal = profileForm['user-goal'].value;
                
                const today = new Date().toISOString().split('T')[0];
                const lastWeightEntry = userProfile.weightHistory[userProfile.weightHistory.length - 1];
                if(!lastWeightEntry || lastWeightEntry.date !== today) {
                     userProfile.weightHistory.push({ date: today, weight: userProfile.weight });
                } else {
                    lastWeightEntry.weight = userProfile.weight;
                }
                renderWeightChart();

                let bmr;
                if (userProfile.gender === 'male') bmr = 10 * userProfile.weight + 6.25 * userProfile.height - 5 * userProfile.age + 5;
                else bmr = 10 * userProfile.weight + 6.25 * userProfile.height - 5 * userProfile.age - 161;
                userProfile.bmr = bmr;
                
                const bmi = userProfile.weight / ((userProfile.height / 100) ** 2);
                userProfile.bmi = bmi;

                bmrInput.value = Math.round(bmr);
                bmiInput.value = bmi.toFixed(1);

                const tdee = bmr * userProfile.activityLevel;
                userProfile.tdee = tdee;

                let calorieTarget = tdee;
                if(userProfile.goal === 'lose') calorieTarget -= 400;
                if(userProfile.goal === 'gain') calorieTarget += 300;
                if(userProfile.goal === 'recomposition') calorieTarget = tdee; // Start at maintenance
                
                userProfile.calorieTarget = calorieTarget;

                generateCalorieCycle();
                saveData();
            };
            
             checkInForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const currentWeight = parseFloat(document.getElementById('check-in-weight').value);
                if (!currentWeight) return;

                const today = new Date().toISOString().split('T')[0];
                userProfile.weightHistory.push({ date: today, weight: currentWeight });
                renderWeightChart();
                
                if (userProfile.weightHistory.length < 7) {
                    checkInFeedback.innerHTML = `<p class="text-green-400">Weight logged! Keep logging for a week to enable AI adjustments.</p>`;
                    saveData();
                    return;
                }

                checkInBtn.disabled = true;
                checkInBtn.querySelector('.btn-text').textContent = 'Analyzing...';
                checkInBtn.querySelector('.loader').classList.remove('hidden');

                const recentWeights = userProfile.weightHistory.slice(-7).map(entry => entry.weight);
                const averageWeight = recentWeights.reduce((a, b) => a + b, 0) / recentWeights.length;
                
                const prompt = `A user's goal is to "${userProfile.goal}". Their average weight over the last 7 days is ${averageWeight.toFixed(2)} kg. Their current daily calorie target is ${Math.round(userProfile.calorieTarget)} kcal. Based on this progress and their goal, suggest a new daily calorie target. Adjust by 50-150 calories if progress is too slow or fast. If progress is good, keep it the same. Respond with ONLY a JSON object like {"newCalories": 2250, "reasoning": "Your weight is trending correctly."}`;

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { newCalories: { type: "NUMBER" }, reasoning: { type: "STRING" } } } } };

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error('AI check-in analysis failed');
                    const result = await response.json();
                    if (!result.candidates || !result.candidates[0].content) throw new Error("Invalid API response structure.");
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const jsonResponse = JSON.parse(jsonText);

                    userProfile.calorieTarget = jsonResponse.newCalories;
                    generateCalorieCycle();
                    checkInFeedback.innerHTML = `<p class="text-green-400"><strong>AI Adjustment:</strong> ${jsonResponse.reasoning} New target: ${Math.round(jsonResponse.newCalories)} kcal.</p>`;
                } catch(error) {
                     console.error("AI Check-in Error:", error);
                    checkInFeedback.innerHTML = `<p class="text-red-400">Could not get AI adjustment. Weight still logged.</p>`;
                } finally {
                    checkInBtn.disabled = false;
                    checkInBtn.querySelector('.btn-text').textContent = 'Check In';
                    checkInBtn.querySelector('.loader').classList.add('hidden');
                    saveData();
                }
             });

            inbodyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const inbodyData = {
                    date: new Date().toISOString().split('T')[0],
                    weight: parseFloat(document.getElementById('inbody-weight').value),
                    smm: parseFloat(document.getElementById('inbody-smm').value),
                    bfm: parseFloat(document.getElementById('inbody-bfm').value),
                    pbf: parseFloat(document.getElementById('inbody-pbf').value)
                };
                if (!inbodyData.weight || !inbodyData.smm || !inbodyData.bfm || !inbodyData.pbf) return;

                analyzeInbodyBtn.disabled = true;
                analyzeInbodyBtn.querySelector('.btn-text').textContent = 'Analyzing...';
                analyzeInbodyBtn.querySelector('.loader').classList.remove('hidden');

                const lastInbody = userProfile.inbodyHistory[userProfile.inbodyHistory.length - 1];
                let prompt;
                 if(lastInbody) {
                    prompt = `Analyze InBody Scan data for a user whose goal is ${userProfile.goal}. 
                    Previous Scan (${lastInbody.date}): SMM: ${lastInbody.smm}kg, BFM: ${lastInbody.bfm}kg, PBF: ${lastInbody.pbf}%.
                    Current Scan (${inbodyData.date}): SMM: ${inbodyData.smm}kg, BFM: ${inbodyData.bfm}kg, PBF: ${inbodyData.pbf}%.
                    Current avg calories: ${Math.round(userProfile.calorieTarget)} kcal.
                    Based on the changes in body composition, suggest a new calorie target and new macros (protein, carbs, fat in grams).
                    Return ONLY a JSON object like {"newCalories": 2300, "newProtein": 180, "newCarbs": 250, "newFat": 60}.`;
                } else {
                    prompt = `Set initial macros based on InBody Scan data for a user whose goal is ${userProfile.goal}.
                    Current Scan (${inbodyData.date}): Weight: ${inbodyData.weight}kg, SMM: ${inbodyData.smm}kg, PBF: ${inbodyData.pbf}%.
                    Current avg calories: ${Math.round(userProfile.calorieTarget)} kcal.
                    Calculate and suggest macros (protein, carbs, fat in grams).
                    Return ONLY a JSON object like {"newCalories": ${userProfile.calorieTarget}, "newProtein": 180, "newCarbs": 250, "newFat": 60}.`;
                }

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { newCalories: { type: "NUMBER" }, newProtein: { type: "NUMBER" }, newCarbs: { type: "NUMBER" }, newFat: { type: "NUMBER" } } } } };

                try {
                     const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error('AI InBody analysis failed');
                    const result = await response.json();
                     if (!result.candidates || !result.candidates[0].content) {
                        throw new Error("Invalid API response structure from Gemini.");
                    }
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const jsonResponse = JSON.parse(jsonText);
                    
                    userProfile.calorieTarget = jsonResponse.newCalories;
                    
                    caloriePlanOutput.innerHTML = `<p class="text-green-400 font-bold">InBody Plan Updated!</p>
                    <p>Based on your scan, your plan is now:</p>
                    <ul class="list-disc list-inside space-y-1 mt-2">
                        <li><strong>Calories:</strong> ${Math.round(jsonResponse.newCalories)} kcal</li>
                        <li><strong>Protein:</strong> ${Math.round(jsonResponse.newProtein)}g</li>
                        <li><strong>Carbs:</strong> ${Math.round(jsonResponse.newCarbs)}g</li>
                        <li><strong>Fat:</strong> ${Math.round(jsonResponse.newFat)}g</li>
                    </ul>`;
                } catch (error) {
                    console.error("AI InBody Error:", error);
                    caloriePlanOutput.innerHTML += `<p class="text-red-400 mt-2"><strong>Error:</strong> Could not analyze scan data. The AI returned an unexpected format.</p>`;
                }

                userProfile.inbodyHistory.push(inbodyData);
                saveData();
                
                analyzeInbodyBtn.disabled = false;
                analyzeInbodyBtn.querySelector('.btn-text').textContent = 'Analyze & Update Plan';
                analyzeInbodyBtn.querySelector('.loader').classList.add('hidden');
                inbodyModal.style.display = 'none';
                inbodyForm.reset();
            });
             const startWaterTimer = () => {
                if(waterTimerInterval) clearInterval(waterTimerInterval);
                waterTimerInterval = setInterval(() => {
                    waterTimeRemaining--;
                    if(waterTimeRemaining < 0) waterTimeRemaining = 0;
                    updateWaterTimerDisplay();
                }, 1000);
            };
            const updateWaterTimerDisplay = () => {
                const minutes = Math.floor(waterTimeRemaining / 60).toString().padStart(2, '0');
                const seconds = (waterTimeRemaining % 60).toString().padStart(2, '0');
                waterTimerEl.textContent = `${minutes}:${seconds}`;
                if(waterTimeRemaining <= 0) {
                    waterReminderWidget.classList.add('active');
                } else {
                    waterReminderWidget.classList.remove('active');
                }
            };

            // --- NAVIGATION ---
            const switchPage = (pageToShow) => {
                [pageNutrition, pageWorkouts, pageGoals, pageSleep].forEach(page => page.classList.remove('page-active'));
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('nav-active'));

                const pageMap = { nutrition: pageNutrition, workouts: pageWorkouts, goals: pageGoals, sleep: pageSleep };
                const navMap = { nutrition: navNutrition, workouts: navWorkouts, goals: navGoals, sleep: navSleep };

                if (pageMap[pageToShow]) pageMap[pageToShow].classList.add('page-active');
                if (navMap[pageToShow]) navMap[pageToShow].classList.add('nav-active');
            };
            navSleep.addEventListener('click', () => switchPage('sleep'));
            navNutrition.addEventListener('click', () => switchPage('nutrition'));
            navWorkouts.addEventListener('click', () => switchPage('workouts'));
            navGoals.addEventListener('click', () => switchPage('goals'));

            // --- ALL OTHER FUNCTIONS ---
             const setupWorkoutFilters = () => {
                const groups = ['All', ...new Set(exerciseDB.map(ex => ex.group))];
                workoutFiltersDiv.innerHTML = groups.map(group =>
                    `<button class="filter-btn py-2 px-5 rounded-full text-sm font-semibold transition-colors ${group.toLowerCase() === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}" data-group="${group.toLowerCase()}">${group}</button>`
                ).join('');
            };
             const renderWorkouts = () => {
                 const filteredExercises = currentWorkoutFilter === 'all'
                    ? exerciseDB
                    : exerciseDB.filter(ex => ex.group.toLowerCase() === currentWorkoutFilter);
                
                exerciseListDiv.innerHTML = filteredExercises.map(ex => `
                    <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden flex flex-col justify-between">
                        <div>
                           <img src="${ex.image}" alt="${ex.name}" class="w-full h-48 object-cover">
                            <div class="p-4">
                                <h3 class="text-xl font-bold text-white">${ex.name}</h3>
                                <p class="text-blue-400 font-semibold mt-1">${ex.group}</p>
                            </div>
                        </div>
                        <div class="p-4 pt-0">
                             <button class="log-workout-btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md" data-name="${ex.name}">Log Workout</button>
                        </div>
                    </div>
                `).join('');
            };
            const openWorkoutModal = (exerciseName) => {
                editingWorkoutLogIndex = null;
                currentlyLoggingExercise = exerciseName;
                modalTitle.textContent = `Log: ${exerciseName}`;
                saveWorkoutBtn.textContent = 'Save Workout';
                setsContainer.innerHTML = '';
                addSetRow();
                workoutModal.style.display = 'flex';
            };
            const openEditWorkoutModal = (index) => {
                editingWorkoutLogIndex = index;
                const logEntry = workoutHistory[index];
                currentlyLoggingExercise = logEntry.name;
                modalTitle.textContent = `Edit: ${logEntry.name}`;
                saveWorkoutBtn.textContent = 'Update Workout';
                setsContainer.innerHTML = '';
                logEntry.sets.forEach(set => addSetRow(set.weight, set.reps, set.partial));
                workoutModal.style.display = 'flex';
            };
            const closeWorkoutModal = () => {
                workoutModal.style.display = 'none';
                editingWorkoutLogIndex = null;
            };
            const addSetRow = (weight = '', reps = '', isPartial = false) => {
                const setNumber = setsContainer.children.length + 1;
                const setHtml = `
                    <div class="set-row grid grid-cols-12 gap-2 items-center">
                        <label class="font-bold col-span-2 text-center">Set ${setNumber}</label>
                        <input type="number" step="0.25" placeholder="Weight (kg)" value="${weight}" class="w-full bg-gray-600 border border-gray-500 rounded-md p-2 col-span-4 set-weight">
                        <input type="number" placeholder="Reps" value="${reps}" class="w-full bg-gray-600 border border-gray-500 rounded-md p-2 col-span-2 set-reps">
                        <div class="col-span-3 flex items-center justify-center">
                            <input type="checkbox" ${isPartial ? 'checked' : ''} class="form-checkbox h-5 w-5 bg-gray-600 border-gray-500 rounded text-blue-500 focus:ring-blue-500 set-partial">
                            <label class="ml-2 text-sm">Partial</label>
                        </div>
                        <button type="button" class="remove-set-btn text-red-500 hover:text-red-400 p-2 col-span-1">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 mx-auto"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </div>
                `;
                setsContainer.insertAdjacentHTML('beforeend', setHtml);
            };
             const renderWorkoutHistory = () => {
                if (workoutHistory.length === 0) {
                    workoutHistoryDiv.innerHTML = '<p class="text-gray-500 text-center">No workouts logged yet.</p>';
                    return;
                }
                workoutHistoryDiv.innerHTML = workoutHistory.map((log, index) => ({...log, originalIndex: index}))
                .reverse()
                .map(log => `
                    <div class="bg-gray-700 p-4 rounded-md">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-lg text-blue-400">${log.name}</h4>
                                <span class="text-sm text-gray-400">${new Date(log.date).toLocaleDateString()}</span>
                            </div>
                            <div class="flex gap-2">
                                <button class="edit-log-btn p-1 hover:bg-gray-600 rounded" data-index="${log.originalIndex}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><line x1="18" y1="2" x2="22" y2="6"/><path d="M7.5 20.5 19 9l-4-4L3.5 16.5 2 22z"/></svg>
                                </button>
                                <button class="delete-log-btn p-1 hover:bg-gray-600 rounded" data-index="${log.originalIndex}">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="text-sm space-y-1">
                            ${log.sets.map((set, i) => `<span><strong>Set ${i+1}:</strong> ${set.weight} kg x ${set.reps} reps ${set.partial ? '(Partial)' : ''}</span>`).join('<br>')}
                        </div>
                    </div>
                `).join('');
            };
            const showConfirmModal = (title, text, onConfirm) => {
                confirmModalTitle.textContent = title;
                confirmModalText.textContent = text;
                confirmCallback = onConfirm;
                confirmModal.style.display = 'flex';
            };
            const hideConfirmModal = () => {
                confirmModal.style.display = 'none';
                confirmCallback = null;
            };

            // Add event listeners that were missing
            profileForm.addEventListener('submit', (e) => { e.preventDefault(); calculateAndSaveGoals(); });
            bmrInput.addEventListener('change', (e) => {
                userProfile.bmr = parseFloat(e.target.value);
                saveData();
            });
            bmiInput.addEventListener('change', (e) => {
                userProfile.bmi = parseFloat(e.target.value);
                saveData();
            });

            drankWaterBtn.addEventListener('click', () => { waterTimeRemaining = 3600; updateWaterTimerDisplay(); });
            openInBodyModalBtn.addEventListener('click', () => inbodyModal.style.display = 'flex');
            closeInbodyModalBtn.addEventListener('click', () => inbodyModal.style.display = 'none');
            closeModalBtn.addEventListener('click', closeWorkoutModal);
            addSetBtn.addEventListener('click', () => addSetRow());
            workoutLogForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const setsData = [];
                document.querySelectorAll('.set-row').forEach(row => {
                    const weight = row.querySelector('.set-weight').value;
                    const reps = row.querySelector('.set-reps').value;
                    const partial = row.querySelector('.set-partial').checked;
                    if (weight && reps) setsData.push({ weight: parseFloat(weight), reps: parseInt(reps), partial: partial });
                });
                if (setsData.length > 0) {
                    const newLog = {
                        name: currentlyLoggingExercise,
                        date: editingWorkoutLogIndex !== null ? workoutHistory[editingWorkoutLogIndex].date : new Date().toISOString(),
                        sets: setsData
                    };
                    if(editingWorkoutLogIndex !== null) workoutHistory[editingWorkoutLogIndex] = newLog;
                    else workoutHistory.push(newLog);
                    renderWorkoutHistory();
                    populateProgressSelect();
                    saveData();
                }
                closeWorkoutModal();
            });
            workoutHistoryDiv.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-log-btn');
                const deleteBtn = e.target.closest('.delete-log-btn');
                if (editBtn) openEditWorkoutModal(parseInt(editBtn.dataset.index, 10));
                if (deleteBtn) {
                    const indexToDelete = parseInt(deleteBtn.dataset.index, 10);
                    showConfirmModal('Delete Workout Log?', 'Are you sure?', () => {
                        workoutHistory.splice(indexToDelete, 1);
                        saveData();
                        renderWorkoutHistory();
                        populateProgressSelect();
                    });
                }
            });
            confirmModalCancelBtn.addEventListener('click', hideConfirmModal);
            confirmModalConfirmBtn.addEventListener('click', () => {
                if (confirmCallback) confirmCallback();
                hideConfirmModal();
            });
            exerciseListDiv.addEventListener('click', (e) => {
                const logBtn = e.target.closest('.log-workout-btn');
                if (logBtn) openWorkoutModal(logBtn.dataset.name);
            });
            workoutFiltersDiv.addEventListener('click', (e) => {
                 const target = e.target.closest('.filter-btn');
                if (!target) return;
                currentWorkoutFilter = target.dataset.group;
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-700', 'text-gray-300');
                });
                target.classList.add('bg-blue-600', 'text-white');
                target.classList.remove('bg-gray-700', 'text-gray-300');
                renderWorkouts();
            });


            // --- INITIALIZATION ---
            const init = () => {
                loadData();
                populateProfileForm();
                if(userProfile.calorieTarget) generateCalorieCycle();
                updateSummary();
                renderDailyLog();
                setupWorkoutFilters();
                renderWorkoutPlanner();
                renderWorkouts();
                renderWorkoutHistory();
                populateProgressSelect();
                renderWeightChart();
                renderWorkoutPlanner();
                startWaterTimer();
                calculateWakeUpTimes();
                renderSleepHistory();
                lucide.createIcons();
            };

            init();
        });
    </script>
</body>
</html>


